import{d as vh,e as Ih,f as Bt,o as Th,p as Eh,q as Ah,r as Sh,s as bh,t as Rh,u as Ph,v as Vh,w as xh,x as Ch,y as Dh,z as Nh}from"./chunk-EIRGDIWM.js";import{b as hh,d as dh,e as Fr,f as Ko,g as fh,h as mh,j as $o,k as lt,l as zi,m as Xt,n as gh,o as ph,p as _h,q as yh,s as wh,u as Qo,x as Wo}from"./chunk-6PY2TZSN.js";import{F as oh,K as Bi,L as ji,N as Gi,U as ah,Vb as lh,X as kr,Z as Tt,c as ih,h as sh,m as Nr,n as Go,r as $t,sa as uh,z as zo,za as ch}from"./chunk-UIUK56GT.js";import{a as Ui,b as Bo,e as jo,f as V}from"./chunk-2F6QYXKT.js";var kh=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{},Fh={};var be,Ho;(function(){var r;function t(v,p){function w(){}w.prototype=p.prototype,v.D=p.prototype,v.prototype=new w,v.prototype.constructor=v,v.C=function(I,T,A){for(var y=Array(arguments.length-2),ce=2;ce<arguments.length;ce++)y[ce-2]=arguments[ce];return p.prototype[T].apply(I,y)}}function e(){this.blockSize=-1}function n(){this.blockSize=-1,this.blockSize=64,this.g=Array(4),this.B=Array(this.blockSize),this.o=this.h=0,this.s()}t(n,e),n.prototype.s=function(){this.g[0]=1732584193,this.g[1]=4023233417,this.g[2]=2562383102,this.g[3]=271733878,this.o=this.h=0};function i(v,p,w){w||(w=0);var I=Array(16);if(typeof p=="string")for(var T=0;16>T;++T)I[T]=p.charCodeAt(w++)|p.charCodeAt(w++)<<8|p.charCodeAt(w++)<<16|p.charCodeAt(w++)<<24;else for(T=0;16>T;++T)I[T]=p[w++]|p[w++]<<8|p[w++]<<16|p[w++]<<24;p=v.g[0],w=v.g[1],T=v.g[2];var A=v.g[3],y=p+(A^w&(T^A))+I[0]+3614090360&4294967295;p=w+(y<<7&4294967295|y>>>25),y=A+(T^p&(w^T))+I[1]+3905402710&4294967295,A=p+(y<<12&4294967295|y>>>20),y=T+(w^A&(p^w))+I[2]+606105819&4294967295,T=A+(y<<17&4294967295|y>>>15),y=w+(p^T&(A^p))+I[3]+3250441966&4294967295,w=T+(y<<22&4294967295|y>>>10),y=p+(A^w&(T^A))+I[4]+4118548399&4294967295,p=w+(y<<7&4294967295|y>>>25),y=A+(T^p&(w^T))+I[5]+1200080426&4294967295,A=p+(y<<12&4294967295|y>>>20),y=T+(w^A&(p^w))+I[6]+2821735955&4294967295,T=A+(y<<17&4294967295|y>>>15),y=w+(p^T&(A^p))+I[7]+4249261313&4294967295,w=T+(y<<22&4294967295|y>>>10),y=p+(A^w&(T^A))+I[8]+1770035416&4294967295,p=w+(y<<7&4294967295|y>>>25),y=A+(T^p&(w^T))+I[9]+2336552879&4294967295,A=p+(y<<12&4294967295|y>>>20),y=T+(w^A&(p^w))+I[10]+4294925233&4294967295,T=A+(y<<17&4294967295|y>>>15),y=w+(p^T&(A^p))+I[11]+2304563134&4294967295,w=T+(y<<22&4294967295|y>>>10),y=p+(A^w&(T^A))+I[12]+1804603682&4294967295,p=w+(y<<7&4294967295|y>>>25),y=A+(T^p&(w^T))+I[13]+4254626195&4294967295,A=p+(y<<12&4294967295|y>>>20),y=T+(w^A&(p^w))+I[14]+2792965006&4294967295,T=A+(y<<17&4294967295|y>>>15),y=w+(p^T&(A^p))+I[15]+1236535329&4294967295,w=T+(y<<22&4294967295|y>>>10),y=p+(T^A&(w^T))+I[1]+4129170786&4294967295,p=w+(y<<5&4294967295|y>>>27),y=A+(w^T&(p^w))+I[6]+3225465664&4294967295,A=p+(y<<9&4294967295|y>>>23),y=T+(p^w&(A^p))+I[11]+643717713&4294967295,T=A+(y<<14&4294967295|y>>>18),y=w+(A^p&(T^A))+I[0]+3921069994&4294967295,w=T+(y<<20&4294967295|y>>>12),y=p+(T^A&(w^T))+I[5]+3593408605&4294967295,p=w+(y<<5&4294967295|y>>>27),y=A+(w^T&(p^w))+I[10]+38016083&4294967295,A=p+(y<<9&4294967295|y>>>23),y=T+(p^w&(A^p))+I[15]+3634488961&4294967295,T=A+(y<<14&4294967295|y>>>18),y=w+(A^p&(T^A))+I[4]+3889429448&4294967295,w=T+(y<<20&4294967295|y>>>12),y=p+(T^A&(w^T))+I[9]+568446438&4294967295,p=w+(y<<5&4294967295|y>>>27),y=A+(w^T&(p^w))+I[14]+3275163606&4294967295,A=p+(y<<9&4294967295|y>>>23),y=T+(p^w&(A^p))+I[3]+4107603335&4294967295,T=A+(y<<14&4294967295|y>>>18),y=w+(A^p&(T^A))+I[8]+1163531501&4294967295,w=T+(y<<20&4294967295|y>>>12),y=p+(T^A&(w^T))+I[13]+2850285829&4294967295,p=w+(y<<5&4294967295|y>>>27),y=A+(w^T&(p^w))+I[2]+4243563512&4294967295,A=p+(y<<9&4294967295|y>>>23),y=T+(p^w&(A^p))+I[7]+1735328473&4294967295,T=A+(y<<14&4294967295|y>>>18),y=w+(A^p&(T^A))+I[12]+2368359562&4294967295,w=T+(y<<20&4294967295|y>>>12),y=p+(w^T^A)+I[5]+4294588738&4294967295,p=w+(y<<4&4294967295|y>>>28),y=A+(p^w^T)+I[8]+2272392833&4294967295,A=p+(y<<11&4294967295|y>>>21),y=T+(A^p^w)+I[11]+1839030562&4294967295,T=A+(y<<16&4294967295|y>>>16),y=w+(T^A^p)+I[14]+4259657740&4294967295,w=T+(y<<23&4294967295|y>>>9),y=p+(w^T^A)+I[1]+2763975236&4294967295,p=w+(y<<4&4294967295|y>>>28),y=A+(p^w^T)+I[4]+1272893353&4294967295,A=p+(y<<11&4294967295|y>>>21),y=T+(A^p^w)+I[7]+4139469664&4294967295,T=A+(y<<16&4294967295|y>>>16),y=w+(T^A^p)+I[10]+3200236656&4294967295,w=T+(y<<23&4294967295|y>>>9),y=p+(w^T^A)+I[13]+681279174&4294967295,p=w+(y<<4&4294967295|y>>>28),y=A+(p^w^T)+I[0]+3936430074&4294967295,A=p+(y<<11&4294967295|y>>>21),y=T+(A^p^w)+I[3]+3572445317&4294967295,T=A+(y<<16&4294967295|y>>>16),y=w+(T^A^p)+I[6]+76029189&4294967295,w=T+(y<<23&4294967295|y>>>9),y=p+(w^T^A)+I[9]+3654602809&4294967295,p=w+(y<<4&4294967295|y>>>28),y=A+(p^w^T)+I[12]+3873151461&4294967295,A=p+(y<<11&4294967295|y>>>21),y=T+(A^p^w)+I[15]+530742520&4294967295,T=A+(y<<16&4294967295|y>>>16),y=w+(T^A^p)+I[2]+3299628645&4294967295,w=T+(y<<23&4294967295|y>>>9),y=p+(T^(w|~A))+I[0]+4096336452&4294967295,p=w+(y<<6&4294967295|y>>>26),y=A+(w^(p|~T))+I[7]+1126891415&4294967295,A=p+(y<<10&4294967295|y>>>22),y=T+(p^(A|~w))+I[14]+2878612391&4294967295,T=A+(y<<15&4294967295|y>>>17),y=w+(A^(T|~p))+I[5]+4237533241&4294967295,w=T+(y<<21&4294967295|y>>>11),y=p+(T^(w|~A))+I[12]+1700485571&4294967295,p=w+(y<<6&4294967295|y>>>26),y=A+(w^(p|~T))+I[3]+2399980690&4294967295,A=p+(y<<10&4294967295|y>>>22),y=T+(p^(A|~w))+I[10]+4293915773&4294967295,T=A+(y<<15&4294967295|y>>>17),y=w+(A^(T|~p))+I[1]+2240044497&4294967295,w=T+(y<<21&4294967295|y>>>11),y=p+(T^(w|~A))+I[8]+1873313359&4294967295,p=w+(y<<6&4294967295|y>>>26),y=A+(w^(p|~T))+I[15]+4264355552&4294967295,A=p+(y<<10&4294967295|y>>>22),y=T+(p^(A|~w))+I[6]+2734768916&4294967295,T=A+(y<<15&4294967295|y>>>17),y=w+(A^(T|~p))+I[13]+1309151649&4294967295,w=T+(y<<21&4294967295|y>>>11),y=p+(T^(w|~A))+I[4]+4149444226&4294967295,p=w+(y<<6&4294967295|y>>>26),y=A+(w^(p|~T))+I[11]+3174756917&4294967295,A=p+(y<<10&4294967295|y>>>22),y=T+(p^(A|~w))+I[2]+718787259&4294967295,T=A+(y<<15&4294967295|y>>>17),y=w+(A^(T|~p))+I[9]+3951481745&4294967295,v.g[0]=v.g[0]+p&4294967295,v.g[1]=v.g[1]+(T+(y<<21&4294967295|y>>>11))&4294967295,v.g[2]=v.g[2]+T&4294967295,v.g[3]=v.g[3]+A&4294967295}n.prototype.u=function(v,p){p===void 0&&(p=v.length);for(var w=p-this.blockSize,I=this.B,T=this.h,A=0;A<p;){if(T==0)for(;A<=w;)i(this,v,A),A+=this.blockSize;if(typeof v=="string"){for(;A<p;)if(I[T++]=v.charCodeAt(A++),T==this.blockSize){i(this,I),T=0;break}}else for(;A<p;)if(I[T++]=v[A++],T==this.blockSize){i(this,I),T=0;break}}this.h=T,this.o+=p},n.prototype.v=function(){var v=Array((56>this.h?this.blockSize:2*this.blockSize)-this.h);v[0]=128;for(var p=1;p<v.length-8;++p)v[p]=0;var w=8*this.o;for(p=v.length-8;p<v.length;++p)v[p]=w&255,w/=256;for(this.u(v),v=Array(16),p=w=0;4>p;++p)for(var I=0;32>I;I+=8)v[w++]=this.g[p]>>>I&255;return v};function s(v,p){var w=u;return Object.prototype.hasOwnProperty.call(w,v)?w[v]:w[v]=p(v)}function a(v,p){this.h=p;for(var w=[],I=!0,T=v.length-1;0<=T;T--){var A=v[T]|0;I&&A==p||(w[T]=A,I=!1)}this.g=w}var u={};function l(v){return-128<=v&&128>v?s(v,function(p){return new a([p|0],0>p?-1:0)}):new a([v|0],0>v?-1:0)}function d(v){if(isNaN(v)||!isFinite(v))return g;if(0>v)return D(d(-v));for(var p=[],w=1,I=0;v>=w;I++)p[I]=v/w|0,w*=4294967296;return new a(p,0)}function f(v,p){if(v.length==0)throw Error("number format error: empty string");if(p=p||10,2>p||36<p)throw Error("radix out of range: "+p);if(v.charAt(0)=="-")return D(f(v.substring(1),p));if(0<=v.indexOf("-"))throw Error('number format error: interior "-" character');for(var w=d(Math.pow(p,8)),I=g,T=0;T<v.length;T+=8){var A=Math.min(8,v.length-T),y=parseInt(v.substring(T,T+A),p);8>A?(A=d(Math.pow(p,A)),I=I.j(A).add(d(y))):(I=I.j(w),I=I.add(d(y)))}return I}var g=l(0),_=l(1),S=l(16777216);r=a.prototype,r.m=function(){if(k(this))return-D(this).m();for(var v=0,p=1,w=0;w<this.g.length;w++){var I=this.i(w);v+=(0<=I?I:4294967296+I)*p,p*=4294967296}return v},r.toString=function(v){if(v=v||10,2>v||36<v)throw Error("radix out of range: "+v);if(N(this))return"0";if(k(this))return"-"+D(this).toString(v);for(var p=d(Math.pow(v,6)),w=this,I="";;){var T=Q(w,p).g;w=j(w,T.j(p));var A=((0<w.g.length?w.g[0]:w.h)>>>0).toString(v);if(w=T,N(w))return A+I;for(;6>A.length;)A="0"+A;I=A+I}},r.i=function(v){return 0>v?0:v<this.g.length?this.g[v]:this.h};function N(v){if(v.h!=0)return!1;for(var p=0;p<v.g.length;p++)if(v.g[p]!=0)return!1;return!0}function k(v){return v.h==-1}r.l=function(v){return v=j(this,v),k(v)?-1:N(v)?0:1};function D(v){for(var p=v.g.length,w=[],I=0;I<p;I++)w[I]=~v.g[I];return new a(w,~v.h).add(_)}r.abs=function(){return k(this)?D(this):this},r.add=function(v){for(var p=Math.max(this.g.length,v.g.length),w=[],I=0,T=0;T<=p;T++){var A=I+(this.i(T)&65535)+(v.i(T)&65535),y=(A>>>16)+(this.i(T)>>>16)+(v.i(T)>>>16);I=y>>>16,A&=65535,y&=65535,w[T]=y<<16|A}return new a(w,w[w.length-1]&-2147483648?-1:0)};function j(v,p){return v.add(D(p))}r.j=function(v){if(N(this)||N(v))return g;if(k(this))return k(v)?D(this).j(D(v)):D(D(this).j(v));if(k(v))return D(this.j(D(v)));if(0>this.l(S)&&0>v.l(S))return d(this.m()*v.m());for(var p=this.g.length+v.g.length,w=[],I=0;I<2*p;I++)w[I]=0;for(I=0;I<this.g.length;I++)for(var T=0;T<v.g.length;T++){var A=this.i(I)>>>16,y=this.i(I)&65535,ce=v.i(T)>>>16,mr=v.i(T)&65535;w[2*I+2*T]+=y*mr,G(w,2*I+2*T),w[2*I+2*T+1]+=A*mr,G(w,2*I+2*T+1),w[2*I+2*T+1]+=y*ce,G(w,2*I+2*T+1),w[2*I+2*T+2]+=A*ce,G(w,2*I+2*T+2)}for(I=0;I<p;I++)w[I]=w[2*I+1]<<16|w[2*I];for(I=p;I<2*p;I++)w[I]=0;return new a(w,0)};function G(v,p){for(;(v[p]&65535)!=v[p];)v[p+1]+=v[p]>>>16,v[p]&=65535,p++}function U(v,p){this.g=v,this.h=p}function Q(v,p){if(N(p))throw Error("division by zero");if(N(v))return new U(g,g);if(k(v))return p=Q(D(v),p),new U(D(p.g),D(p.h));if(k(p))return p=Q(v,D(p)),new U(D(p.g),p.h);if(30<v.g.length){if(k(v)||k(p))throw Error("slowDivide_ only works with positive integers.");for(var w=_,I=p;0>=I.l(v);)w=H(w),I=H(I);var T=K(w,1),A=K(I,1);for(I=K(I,2),w=K(w,2);!N(I);){var y=A.add(I);0>=y.l(v)&&(T=T.add(w),A=y),I=K(I,1),w=K(w,1)}return p=j(v,T.j(p)),new U(T,p)}for(T=g;0<=v.l(p);){for(w=Math.max(1,Math.floor(v.m()/p.m())),I=Math.ceil(Math.log(w)/Math.LN2),I=48>=I?1:Math.pow(2,I-48),A=d(w),y=A.j(p);k(y)||0<y.l(v);)w-=I,A=d(w),y=A.j(p);N(A)&&(A=_),T=T.add(A),v=j(v,y)}return new U(T,v)}r.A=function(v){return Q(this,v).h},r.and=function(v){for(var p=Math.max(this.g.length,v.g.length),w=[],I=0;I<p;I++)w[I]=this.i(I)&v.i(I);return new a(w,this.h&v.h)},r.or=function(v){for(var p=Math.max(this.g.length,v.g.length),w=[],I=0;I<p;I++)w[I]=this.i(I)|v.i(I);return new a(w,this.h|v.h)},r.xor=function(v){for(var p=Math.max(this.g.length,v.g.length),w=[],I=0;I<p;I++)w[I]=this.i(I)^v.i(I);return new a(w,this.h^v.h)};function H(v){for(var p=v.g.length+1,w=[],I=0;I<p;I++)w[I]=v.i(I)<<1|v.i(I-1)>>>31;return new a(w,v.h)}function K(v,p){var w=p>>5;p%=32;for(var I=v.g.length-w,T=[],A=0;A<I;A++)T[A]=0<p?v.i(A+w)>>>p|v.i(A+w+1)<<32-p:v.i(A+w);return new a(T,v.h)}n.prototype.digest=n.prototype.v,n.prototype.reset=n.prototype.s,n.prototype.update=n.prototype.u,Ho=Fh.Md5=n,a.prototype.add=a.prototype.add,a.prototype.multiply=a.prototype.j,a.prototype.modulo=a.prototype.A,a.prototype.compare=a.prototype.l,a.prototype.toNumber=a.prototype.m,a.prototype.toString=a.prototype.toString,a.prototype.getBits=a.prototype.i,a.fromNumber=d,a.fromString=f,be=Fh.Integer=a}).apply(typeof kh<"u"?kh:typeof self<"u"?self:typeof window<"u"?window:{});var Ki=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{},de={};var Jo,Qg,Rn,Yo,Or,$i,Xo,Zo,ta;(function(){var r,t=typeof Object.defineProperties=="function"?Object.defineProperty:function(o,c,h){return o==Array.prototype||o==Object.prototype||(o[c]=h.value),o};function e(o){o=[typeof globalThis=="object"&&globalThis,o,typeof window=="object"&&window,typeof self=="object"&&self,typeof Ki=="object"&&Ki];for(var c=0;c<o.length;++c){var h=o[c];if(h&&h.Math==Math)return h}throw Error("Cannot find global object")}var n=e(this);function i(o,c){if(c)t:{var h=n;o=o.split(".");for(var m=0;m<o.length-1;m++){var E=o[m];if(!(E in h))break t;h=h[E]}o=o[o.length-1],m=h[o],c=c(m),c!=m&&c!=null&&t(h,o,{configurable:!0,writable:!0,value:c})}}function s(o,c){o instanceof String&&(o+="");var h=0,m=!1,E={next:function(){if(!m&&h<o.length){var R=h++;return{value:c(R,o[R]),done:!1}}return m=!0,{done:!0,value:void 0}}};return E[Symbol.iterator]=function(){return E},E}i("Array.prototype.values",function(o){return o||function(){return s(this,function(c,h){return h})}});var a=a||{},u=this||self;function l(o){var c=typeof o;return c=c!="object"?c:o?Array.isArray(o)?"array":c:"null",c=="array"||c=="object"&&typeof o.length=="number"}function d(o){var c=typeof o;return c=="object"&&o!=null||c=="function"}function f(o,c,h){return o.call.apply(o.bind,arguments)}function g(o,c,h){if(!o)throw Error();if(2<arguments.length){var m=Array.prototype.slice.call(arguments,2);return function(){var E=Array.prototype.slice.call(arguments);return Array.prototype.unshift.apply(E,m),o.apply(c,E)}}return function(){return o.apply(c,arguments)}}function _(o,c,h){return _=Function.prototype.bind&&Function.prototype.bind.toString().indexOf("native code")!=-1?f:g,_.apply(null,arguments)}function S(o,c){var h=Array.prototype.slice.call(arguments,1);return function(){var m=h.slice();return m.push.apply(m,arguments),o.apply(this,m)}}function N(o,c){function h(){}h.prototype=c.prototype,o.aa=c.prototype,o.prototype=new h,o.prototype.constructor=o,o.Qb=function(m,E,R){for(var F=Array(arguments.length-2),et=2;et<arguments.length;et++)F[et-2]=arguments[et];return c.prototype[E].apply(m,F)}}function k(o){let c=o.length;if(0<c){let h=Array(c);for(let m=0;m<c;m++)h[m]=o[m];return h}return[]}function D(o,c){for(let h=1;h<arguments.length;h++){let m=arguments[h];if(l(m)){let E=o.length||0,R=m.length||0;o.length=E+R;for(let F=0;F<R;F++)o[E+F]=m[F]}else o.push(m)}}class j{constructor(c,h){this.i=c,this.j=h,this.h=0,this.g=null}get(){let c;return 0<this.h?(this.h--,c=this.g,this.g=c.next,c.next=null):c=this.i(),c}}function G(o){return/^[\s\xa0]*$/.test(o)}function U(){var o=u.navigator;return o&&(o=o.userAgent)?o:""}function Q(o){return Q[" "](o),o}Q[" "]=function(){};var H=U().indexOf("Gecko")!=-1&&!(U().toLowerCase().indexOf("webkit")!=-1&&U().indexOf("Edge")==-1)&&!(U().indexOf("Trident")!=-1||U().indexOf("MSIE")!=-1)&&U().indexOf("Edge")==-1;function K(o,c,h){for(let m in o)c.call(h,o[m],m,o)}function v(o,c){for(let h in o)c.call(void 0,o[h],h,o)}function p(o){let c={};for(let h in o)c[h]=o[h];return c}let w="constructor hasOwnProperty isPrototypeOf propertyIsEnumerable toLocaleString toString valueOf".split(" ");function I(o,c){let h,m;for(let E=1;E<arguments.length;E++){m=arguments[E];for(h in m)o[h]=m[h];for(let R=0;R<w.length;R++)h=w[R],Object.prototype.hasOwnProperty.call(m,h)&&(o[h]=m[h])}}function T(o){var c=1;o=o.split(":");let h=[];for(;0<c&&o.length;)h.push(o.shift()),c--;return o.length&&h.push(o.join(":")),h}function A(o){u.setTimeout(()=>{throw o},0)}function y(){var o=po;let c=null;return o.g&&(c=o.g,o.g=o.g.next,o.g||(o.h=null),c.next=null),c}class ce{constructor(){this.h=this.g=null}add(c,h){let m=mr.get();m.set(c,h),this.h?this.h.next=m:this.g=m,this.h=m}}var mr=new j(()=>new fg,o=>o.reset());class fg{constructor(){this.next=this.g=this.h=null}set(c,h){this.h=c,this.g=h,this.next=null}reset(){this.next=this.g=this.h=null}}let gr,pr=!1,po=new ce,rl=()=>{let o=u.Promise.resolve(void 0);gr=()=>{o.then(mg)}};var mg=()=>{for(var o;o=y();){try{o.h.call(o.g)}catch(h){A(h)}var c=mr;c.j(o),100>c.h&&(c.h++,o.next=c.g,c.g=o)}pr=!1};function Te(){this.s=this.s,this.C=this.C}Te.prototype.s=!1,Te.prototype.ma=function(){this.s||(this.s=!0,this.N())},Te.prototype.N=function(){if(this.C)for(;this.C.length;)this.C.shift()()};function bt(o,c){this.type=o,this.g=this.target=c,this.defaultPrevented=!1}bt.prototype.h=function(){this.defaultPrevented=!0};var gg=function(){if(!u.addEventListener||!Object.defineProperty)return!1;var o=!1,c=Object.defineProperty({},"passive",{get:function(){o=!0}});try{let h=()=>{};u.addEventListener("test",h,c),u.removeEventListener("test",h,c)}catch{}return o}();function _r(o,c){if(bt.call(this,o?o.type:""),this.relatedTarget=this.g=this.target=null,this.button=this.screenY=this.screenX=this.clientY=this.clientX=0,this.key="",this.metaKey=this.shiftKey=this.altKey=this.ctrlKey=!1,this.state=null,this.pointerId=0,this.pointerType="",this.i=null,o){var h=this.type=o.type,m=o.changedTouches&&o.changedTouches.length?o.changedTouches[0]:null;if(this.target=o.target||o.srcElement,this.g=c,c=o.relatedTarget){if(H){t:{try{Q(c.nodeName);var E=!0;break t}catch{}E=!1}E||(c=null)}}else h=="mouseover"?c=o.fromElement:h=="mouseout"&&(c=o.toElement);this.relatedTarget=c,m?(this.clientX=m.clientX!==void 0?m.clientX:m.pageX,this.clientY=m.clientY!==void 0?m.clientY:m.pageY,this.screenX=m.screenX||0,this.screenY=m.screenY||0):(this.clientX=o.clientX!==void 0?o.clientX:o.pageX,this.clientY=o.clientY!==void 0?o.clientY:o.pageY,this.screenX=o.screenX||0,this.screenY=o.screenY||0),this.button=o.button,this.key=o.key||"",this.ctrlKey=o.ctrlKey,this.altKey=o.altKey,this.shiftKey=o.shiftKey,this.metaKey=o.metaKey,this.pointerId=o.pointerId||0,this.pointerType=typeof o.pointerType=="string"?o.pointerType:pg[o.pointerType]||"",this.state=o.state,this.i=o,o.defaultPrevented&&_r.aa.h.call(this)}}N(_r,bt);var pg={2:"touch",3:"pen",4:"mouse"};_r.prototype.h=function(){_r.aa.h.call(this);var o=this.i;o.preventDefault?o.preventDefault():o.returnValue=!1};var yr="closure_listenable_"+(1e6*Math.random()|0),_g=0;function yg(o,c,h,m,E){this.listener=o,this.proxy=null,this.src=c,this.type=h,this.capture=!!m,this.ha=E,this.key=++_g,this.da=this.fa=!1}function Ei(o){o.da=!0,o.listener=null,o.proxy=null,o.src=null,o.ha=null}function Ai(o){this.src=o,this.g={},this.h=0}Ai.prototype.add=function(o,c,h,m,E){var R=o.toString();o=this.g[R],o||(o=this.g[R]=[],this.h++);var F=yo(o,c,m,E);return-1<F?(c=o[F],h||(c.fa=!1)):(c=new yg(c,this.src,R,!!m,E),c.fa=h,o.push(c)),c};function _o(o,c){var h=c.type;if(h in o.g){var m=o.g[h],E=Array.prototype.indexOf.call(m,c,void 0),R;(R=0<=E)&&Array.prototype.splice.call(m,E,1),R&&(Ei(c),o.g[h].length==0&&(delete o.g[h],o.h--))}}function yo(o,c,h,m){for(var E=0;E<o.length;++E){var R=o[E];if(!R.da&&R.listener==c&&R.capture==!!h&&R.ha==m)return E}return-1}var wo="closure_lm_"+(1e6*Math.random()|0),vo={};function il(o,c,h,m,E){if(m&&m.once)return ol(o,c,h,m,E);if(Array.isArray(c)){for(var R=0;R<c.length;R++)il(o,c[R],h,m,E);return null}return h=Ao(h),o&&o[yr]?o.K(c,h,d(m)?!!m.capture:!!m,E):sl(o,c,h,!1,m,E)}function sl(o,c,h,m,E,R){if(!c)throw Error("Invalid event type");var F=d(E)?!!E.capture:!!E,et=To(o);if(et||(o[wo]=et=new Ai(o)),h=et.add(c,h,m,F,R),h.proxy)return h;if(m=wg(),h.proxy=m,m.src=o,m.listener=h,o.addEventListener)gg||(E=F),E===void 0&&(E=!1),o.addEventListener(c.toString(),m,E);else if(o.attachEvent)o.attachEvent(ul(c.toString()),m);else if(o.addListener&&o.removeListener)o.addListener(m);else throw Error("addEventListener and attachEvent are unavailable.");return h}function wg(){function o(h){return c.call(o.src,o.listener,h)}let c=vg;return o}function ol(o,c,h,m,E){if(Array.isArray(c)){for(var R=0;R<c.length;R++)ol(o,c[R],h,m,E);return null}return h=Ao(h),o&&o[yr]?o.L(c,h,d(m)?!!m.capture:!!m,E):sl(o,c,h,!0,m,E)}function al(o,c,h,m,E){if(Array.isArray(c))for(var R=0;R<c.length;R++)al(o,c[R],h,m,E);else m=d(m)?!!m.capture:!!m,h=Ao(h),o&&o[yr]?(o=o.i,c=String(c).toString(),c in o.g&&(R=o.g[c],h=yo(R,h,m,E),-1<h&&(Ei(R[h]),Array.prototype.splice.call(R,h,1),R.length==0&&(delete o.g[c],o.h--)))):o&&(o=To(o))&&(c=o.g[c.toString()],o=-1,c&&(o=yo(c,h,m,E)),(h=-1<o?c[o]:null)&&Io(h))}function Io(o){if(typeof o!="number"&&o&&!o.da){var c=o.src;if(c&&c[yr])_o(c.i,o);else{var h=o.type,m=o.proxy;c.removeEventListener?c.removeEventListener(h,m,o.capture):c.detachEvent?c.detachEvent(ul(h),m):c.addListener&&c.removeListener&&c.removeListener(m),(h=To(c))?(_o(h,o),h.h==0&&(h.src=null,c[wo]=null)):Ei(o)}}}function ul(o){return o in vo?vo[o]:vo[o]="on"+o}function vg(o,c){if(o.da)o=!0;else{c=new _r(c,this);var h=o.listener,m=o.ha||o.src;o.fa&&Io(o),o=h.call(m,c)}return o}function To(o){return o=o[wo],o instanceof Ai?o:null}var Eo="__closure_events_fn_"+(1e9*Math.random()>>>0);function Ao(o){return typeof o=="function"?o:(o[Eo]||(o[Eo]=function(c){return o.handleEvent(c)}),o[Eo])}function Rt(){Te.call(this),this.i=new Ai(this),this.M=this,this.F=null}N(Rt,Te),Rt.prototype[yr]=!0,Rt.prototype.removeEventListener=function(o,c,h,m){al(this,o,c,h,m)};function Dt(o,c){var h,m=o.F;if(m)for(h=[];m;m=m.F)h.push(m);if(o=o.M,m=c.type||c,typeof c=="string")c=new bt(c,o);else if(c instanceof bt)c.target=c.target||o;else{var E=c;c=new bt(m,o),I(c,E)}if(E=!0,h)for(var R=h.length-1;0<=R;R--){var F=c.g=h[R];E=Si(F,m,!0,c)&&E}if(F=c.g=o,E=Si(F,m,!0,c)&&E,E=Si(F,m,!1,c)&&E,h)for(R=0;R<h.length;R++)F=c.g=h[R],E=Si(F,m,!1,c)&&E}Rt.prototype.N=function(){if(Rt.aa.N.call(this),this.i){var o=this.i,c;for(c in o.g){for(var h=o.g[c],m=0;m<h.length;m++)Ei(h[m]);delete o.g[c],o.h--}}this.F=null},Rt.prototype.K=function(o,c,h,m){return this.i.add(String(o),c,!1,h,m)},Rt.prototype.L=function(o,c,h,m){return this.i.add(String(o),c,!0,h,m)};function Si(o,c,h,m){if(c=o.i.g[String(c)],!c)return!0;c=c.concat();for(var E=!0,R=0;R<c.length;++R){var F=c[R];if(F&&!F.da&&F.capture==h){var et=F.listener,Et=F.ha||F.src;F.fa&&_o(o.i,F),E=et.call(Et,m)!==!1&&E}}return E&&!m.defaultPrevented}function cl(o,c,h){if(typeof o=="function")h&&(o=_(o,h));else if(o&&typeof o.handleEvent=="function")o=_(o.handleEvent,o);else throw Error("Invalid listener argument");return 2147483647<Number(c)?-1:u.setTimeout(o,c||0)}function ll(o){o.g=cl(()=>{o.g=null,o.i&&(o.i=!1,ll(o))},o.l);let c=o.h;o.h=null,o.m.apply(null,c)}class Ig extends Te{constructor(c,h){super(),this.m=c,this.l=h,this.h=null,this.i=!1,this.g=null}j(c){this.h=arguments,this.g?this.i=!0:ll(this)}N(){super.N(),this.g&&(u.clearTimeout(this.g),this.g=null,this.i=!1,this.h=null)}}function wr(o){Te.call(this),this.h=o,this.g={}}N(wr,Te);var hl=[];function dl(o){K(o.g,function(c,h){this.g.hasOwnProperty(h)&&Io(c)},o),o.g={}}wr.prototype.N=function(){wr.aa.N.call(this),dl(this)},wr.prototype.handleEvent=function(){throw Error("EventHandler.handleEvent not implemented")};var So=u.JSON.stringify,Tg=u.JSON.parse,Eg=class{stringify(o){return u.JSON.stringify(o,void 0)}parse(o){return u.JSON.parse(o,void 0)}};function bo(){}bo.prototype.h=null;function fl(o){return o.h||(o.h=o.i())}function ml(){}var vr={OPEN:"a",kb:"b",Ja:"c",wb:"d"};function Ro(){bt.call(this,"d")}N(Ro,bt);function Po(){bt.call(this,"c")}N(Po,bt);var $e={},gl=null;function bi(){return gl=gl||new Rt}$e.La="serverreachability";function pl(o){bt.call(this,$e.La,o)}N(pl,bt);function Ir(o){let c=bi();Dt(c,new pl(c))}$e.STAT_EVENT="statevent";function _l(o,c){bt.call(this,$e.STAT_EVENT,o),this.stat=c}N(_l,bt);function Nt(o){let c=bi();Dt(c,new _l(c,o))}$e.Ma="timingevent";function yl(o,c){bt.call(this,$e.Ma,o),this.size=c}N(yl,bt);function Tr(o,c){if(typeof o!="function")throw Error("Fn must not be null and must be a function");return u.setTimeout(function(){o()},c)}function Er(){this.g=!0}Er.prototype.xa=function(){this.g=!1};function Ag(o,c,h,m,E,R){o.info(function(){if(o.g)if(R)for(var F="",et=R.split("&"),Et=0;Et<et.length;Et++){var Z=et[Et].split("=");if(1<Z.length){var Pt=Z[0];Z=Z[1];var Vt=Pt.split("_");F=2<=Vt.length&&Vt[1]=="type"?F+(Pt+"="+Z+"&"):F+(Pt+"=redacted&")}}else F=null;else F=R;return"XMLHTTP REQ ("+m+") [attempt "+E+"]: "+c+`
`+h+`
`+F})}function Sg(o,c,h,m,E,R,F){o.info(function(){return"XMLHTTP RESP ("+m+") [ attempt "+E+"]: "+c+`
`+h+`
`+R+" "+F})}function En(o,c,h,m){o.info(function(){return"XMLHTTP TEXT ("+c+"): "+Rg(o,h)+(m?" "+m:"")})}function bg(o,c){o.info(function(){return"TIMEOUT: "+c})}Er.prototype.info=function(){};function Rg(o,c){if(!o.g)return c;if(!c)return null;try{var h=JSON.parse(c);if(h){for(o=0;o<h.length;o++)if(Array.isArray(h[o])){var m=h[o];if(!(2>m.length)){var E=m[1];if(Array.isArray(E)&&!(1>E.length)){var R=E[0];if(R!="noop"&&R!="stop"&&R!="close")for(var F=1;F<E.length;F++)E[F]=""}}}}return So(h)}catch{return c}}var Ri={NO_ERROR:0,gb:1,tb:2,sb:3,nb:4,rb:5,ub:6,Ia:7,TIMEOUT:8,xb:9},wl={lb:"complete",Hb:"success",Ja:"error",Ia:"abort",zb:"ready",Ab:"readystatechange",TIMEOUT:"timeout",vb:"incrementaldata",yb:"progress",ob:"downloadprogress",Pb:"uploadprogress"},Vo;function Pi(){}N(Pi,bo),Pi.prototype.g=function(){return new XMLHttpRequest},Pi.prototype.i=function(){return{}},Vo=new Pi;function Ee(o,c,h,m){this.j=o,this.i=c,this.l=h,this.R=m||1,this.U=new wr(this),this.I=45e3,this.H=null,this.o=!1,this.m=this.A=this.v=this.L=this.F=this.S=this.B=null,this.D=[],this.g=null,this.C=0,this.s=this.u=null,this.X=-1,this.J=!1,this.O=0,this.M=null,this.W=this.K=this.T=this.P=!1,this.h=new vl}function vl(){this.i=null,this.g="",this.h=!1}var Il={},xo={};function Co(o,c,h){o.L=1,o.v=Di(le(c)),o.m=h,o.P=!0,Tl(o,null)}function Tl(o,c){o.F=Date.now(),Vi(o),o.A=le(o.v);var h=o.A,m=o.R;Array.isArray(m)||(m=[String(m)]),Ol(h.i,"t",m),o.C=0,h=o.j.J,o.h=new vl,o.g=th(o.j,h?c:null,!o.m),0<o.O&&(o.M=new Ig(_(o.Y,o,o.g),o.O)),c=o.U,h=o.g,m=o.ca;var E="readystatechange";Array.isArray(E)||(E&&(hl[0]=E.toString()),E=hl);for(var R=0;R<E.length;R++){var F=il(h,E[R],m||c.handleEvent,!1,c.h||c);if(!F)break;c.g[F.key]=F}c=o.H?p(o.H):{},o.m?(o.u||(o.u="POST"),c["Content-Type"]="application/x-www-form-urlencoded",o.g.ea(o.A,o.u,o.m,c)):(o.u="GET",o.g.ea(o.A,o.u,null,c)),Ir(),Ag(o.i,o.u,o.A,o.l,o.R,o.m)}Ee.prototype.ca=function(o){o=o.target;let c=this.M;c&&he(o)==3?c.j():this.Y(o)},Ee.prototype.Y=function(o){try{if(o==this.g)t:{let Vt=he(this.g);var c=this.g.Ba();let bn=this.g.Z();if(!(3>Vt)&&(Vt!=3||this.g&&(this.h.h||this.g.oa()||Gl(this.g)))){this.J||Vt!=4||c==7||(c==8||0>=bn?Ir(3):Ir(2)),Do(this);var h=this.g.Z();this.X=h;e:if(El(this)){var m=Gl(this.g);o="";var E=m.length,R=he(this.g)==4;if(!this.h.i){if(typeof TextDecoder>"u"){Qe(this),Ar(this);var F="";break e}this.h.i=new u.TextDecoder}for(c=0;c<E;c++)this.h.h=!0,o+=this.h.i.decode(m[c],{stream:!(R&&c==E-1)});m.length=0,this.h.g+=o,this.C=0,F=this.h.g}else F=this.g.oa();if(this.o=h==200,Sg(this.i,this.u,this.A,this.l,this.R,Vt,h),this.o){if(this.T&&!this.K){e:{if(this.g){var et,Et=this.g;if((et=Et.g?Et.g.getResponseHeader("X-HTTP-Initial-Response"):null)&&!G(et)){var Z=et;break e}}Z=null}if(h=Z)En(this.i,this.l,h,"Initial handshake response via X-HTTP-Initial-Response"),this.K=!0,No(this,h);else{this.o=!1,this.s=3,Nt(12),Qe(this),Ar(this);break t}}if(this.P){h=!0;let Kt;for(;!this.J&&this.C<F.length;)if(Kt=Pg(this,F),Kt==xo){Vt==4&&(this.s=4,Nt(14),h=!1),En(this.i,this.l,null,"[Incomplete Response]");break}else if(Kt==Il){this.s=4,Nt(15),En(this.i,this.l,F,"[Invalid Chunk]"),h=!1;break}else En(this.i,this.l,Kt,null),No(this,Kt);if(El(this)&&this.C!=0&&(this.h.g=this.h.g.slice(this.C),this.C=0),Vt!=4||F.length!=0||this.h.h||(this.s=1,Nt(16),h=!1),this.o=this.o&&h,!h)En(this.i,this.l,F,"[Invalid Chunked Response]"),Qe(this),Ar(this);else if(0<F.length&&!this.W){this.W=!0;var Pt=this.j;Pt.g==this&&Pt.ba&&!Pt.M&&(Pt.j.info("Great, no buffering proxy detected. Bytes received: "+F.length),qo(Pt),Pt.M=!0,Nt(11))}}else En(this.i,this.l,F,null),No(this,F);Vt==4&&Qe(this),this.o&&!this.J&&(Vt==4?Jl(this.j,this):(this.o=!1,Vi(this)))}else Kg(this.g),h==400&&0<F.indexOf("Unknown SID")?(this.s=3,Nt(12)):(this.s=0,Nt(13)),Qe(this),Ar(this)}}}catch{}finally{}};function El(o){return o.g?o.u=="GET"&&o.L!=2&&o.j.Ca:!1}function Pg(o,c){var h=o.C,m=c.indexOf(`
`,h);return m==-1?xo:(h=Number(c.substring(h,m)),isNaN(h)?Il:(m+=1,m+h>c.length?xo:(c=c.slice(m,m+h),o.C=m+h,c)))}Ee.prototype.cancel=function(){this.J=!0,Qe(this)};function Vi(o){o.S=Date.now()+o.I,Al(o,o.I)}function Al(o,c){if(o.B!=null)throw Error("WatchDog timer not null");o.B=Tr(_(o.ba,o),c)}function Do(o){o.B&&(u.clearTimeout(o.B),o.B=null)}Ee.prototype.ba=function(){this.B=null;let o=Date.now();0<=o-this.S?(bg(this.i,this.A),this.L!=2&&(Ir(),Nt(17)),Qe(this),this.s=2,Ar(this)):Al(this,this.S-o)};function Ar(o){o.j.G==0||o.J||Jl(o.j,o)}function Qe(o){Do(o);var c=o.M;c&&typeof c.ma=="function"&&c.ma(),o.M=null,dl(o.U),o.g&&(c=o.g,o.g=null,c.abort(),c.ma())}function No(o,c){try{var h=o.j;if(h.G!=0&&(h.g==o||ko(h.h,o))){if(!o.K&&ko(h.h,o)&&h.G==3){try{var m=h.Da.g.parse(c)}catch{m=null}if(Array.isArray(m)&&m.length==3){var E=m;if(E[0]==0){t:if(!h.u){if(h.g)if(h.g.F+3e3<o.F)Mi(h),Fi(h);else break t;Lo(h),Nt(18)}}else h.za=E[1],0<h.za-h.T&&37500>E[2]&&h.F&&h.v==0&&!h.C&&(h.C=Tr(_(h.Za,h),6e3));if(1>=Rl(h.h)&&h.ca){try{h.ca()}catch{}h.ca=void 0}}else He(h,11)}else if((o.K||h.g==o)&&Mi(h),!G(c))for(E=h.Da.g.parse(c),c=0;c<E.length;c++){let Z=E[c];if(h.T=Z[0],Z=Z[1],h.G==2)if(Z[0]=="c"){h.K=Z[1],h.ia=Z[2];let Pt=Z[3];Pt!=null&&(h.la=Pt,h.j.info("VER="+h.la));let Vt=Z[4];Vt!=null&&(h.Aa=Vt,h.j.info("SVER="+h.Aa));let bn=Z[5];bn!=null&&typeof bn=="number"&&0<bn&&(m=1.5*bn,h.L=m,h.j.info("backChannelRequestTimeoutMs_="+m)),m=h;let Kt=o.g;if(Kt){let qi=Kt.g?Kt.g.getResponseHeader("X-Client-Wire-Protocol"):null;if(qi){var R=m.h;R.g||qi.indexOf("spdy")==-1&&qi.indexOf("quic")==-1&&qi.indexOf("h2")==-1||(R.j=R.l,R.g=new Set,R.h&&(Fo(R,R.h),R.h=null))}if(m.D){let Uo=Kt.g?Kt.g.getResponseHeader("X-HTTP-Session-Id"):null;Uo&&(m.ya=Uo,it(m.I,m.D,Uo))}}h.G=3,h.l&&h.l.ua(),h.ba&&(h.R=Date.now()-o.F,h.j.info("Handshake RTT: "+h.R+"ms")),m=h;var F=o;if(m.qa=Zl(m,m.J?m.ia:null,m.W),F.K){Pl(m.h,F);var et=F,Et=m.L;Et&&(et.I=Et),et.B&&(Do(et),Vi(et)),m.g=F}else Wl(m);0<h.i.length&&Oi(h)}else Z[0]!="stop"&&Z[0]!="close"||He(h,7);else h.G==3&&(Z[0]=="stop"||Z[0]=="close"?Z[0]=="stop"?He(h,7):Mo(h):Z[0]!="noop"&&h.l&&h.l.ta(Z),h.v=0)}}Ir(4)}catch{}}var Vg=class{constructor(o,c){this.g=o,this.map=c}};function Sl(o){this.l=o||10,u.PerformanceNavigationTiming?(o=u.performance.getEntriesByType("navigation"),o=0<o.length&&(o[0].nextHopProtocol=="hq"||o[0].nextHopProtocol=="h2")):o=!!(u.chrome&&u.chrome.loadTimes&&u.chrome.loadTimes()&&u.chrome.loadTimes().wasFetchedViaSpdy),this.j=o?this.l:1,this.g=null,1<this.j&&(this.g=new Set),this.h=null,this.i=[]}function bl(o){return o.h?!0:o.g?o.g.size>=o.j:!1}function Rl(o){return o.h?1:o.g?o.g.size:0}function ko(o,c){return o.h?o.h==c:o.g?o.g.has(c):!1}function Fo(o,c){o.g?o.g.add(c):o.h=c}function Pl(o,c){o.h&&o.h==c?o.h=null:o.g&&o.g.has(c)&&o.g.delete(c)}Sl.prototype.cancel=function(){if(this.i=Vl(this),this.h)this.h.cancel(),this.h=null;else if(this.g&&this.g.size!==0){for(let o of this.g.values())o.cancel();this.g.clear()}};function Vl(o){if(o.h!=null)return o.i.concat(o.h.D);if(o.g!=null&&o.g.size!==0){let c=o.i;for(let h of o.g.values())c=c.concat(h.D);return c}return k(o.i)}function xg(o){if(o.V&&typeof o.V=="function")return o.V();if(typeof Map<"u"&&o instanceof Map||typeof Set<"u"&&o instanceof Set)return Array.from(o.values());if(typeof o=="string")return o.split("");if(l(o)){for(var c=[],h=o.length,m=0;m<h;m++)c.push(o[m]);return c}c=[],h=0;for(m in o)c[h++]=o[m];return c}function Cg(o){if(o.na&&typeof o.na=="function")return o.na();if(!o.V||typeof o.V!="function"){if(typeof Map<"u"&&o instanceof Map)return Array.from(o.keys());if(!(typeof Set<"u"&&o instanceof Set)){if(l(o)||typeof o=="string"){var c=[];o=o.length;for(var h=0;h<o;h++)c.push(h);return c}c=[],h=0;for(let m in o)c[h++]=m;return c}}}function xl(o,c){if(o.forEach&&typeof o.forEach=="function")o.forEach(c,void 0);else if(l(o)||typeof o=="string")Array.prototype.forEach.call(o,c,void 0);else for(var h=Cg(o),m=xg(o),E=m.length,R=0;R<E;R++)c.call(void 0,m[R],h&&h[R],o)}var Cl=RegExp("^(?:([^:/?#.]+):)?(?://(?:([^\\\\/?#]*)@)?([^\\\\/?#]*?)(?::([0-9]+))?(?=[\\\\/?#]|$))?([^?#]+)?(?:\\?([^#]*))?(?:#([\\s\\S]*))?$");function Dg(o,c){if(o){o=o.split("&");for(var h=0;h<o.length;h++){var m=o[h].indexOf("="),E=null;if(0<=m){var R=o[h].substring(0,m);E=o[h].substring(m+1)}else R=o[h];c(R,E?decodeURIComponent(E.replace(/\+/g," ")):"")}}}function We(o){if(this.g=this.o=this.j="",this.s=null,this.m=this.l="",this.h=!1,o instanceof We){this.h=o.h,xi(this,o.j),this.o=o.o,this.g=o.g,Ci(this,o.s),this.l=o.l;var c=o.i,h=new Rr;h.i=c.i,c.g&&(h.g=new Map(c.g),h.h=c.h),Dl(this,h),this.m=o.m}else o&&(c=String(o).match(Cl))?(this.h=!1,xi(this,c[1]||"",!0),this.o=Sr(c[2]||""),this.g=Sr(c[3]||"",!0),Ci(this,c[4]),this.l=Sr(c[5]||"",!0),Dl(this,c[6]||"",!0),this.m=Sr(c[7]||"")):(this.h=!1,this.i=new Rr(null,this.h))}We.prototype.toString=function(){var o=[],c=this.j;c&&o.push(br(c,Nl,!0),":");var h=this.g;return(h||c=="file")&&(o.push("//"),(c=this.o)&&o.push(br(c,Nl,!0),"@"),o.push(encodeURIComponent(String(h)).replace(/%25([0-9a-fA-F]{2})/g,"%$1")),h=this.s,h!=null&&o.push(":",String(h))),(h=this.l)&&(this.g&&h.charAt(0)!="/"&&o.push("/"),o.push(br(h,h.charAt(0)=="/"?Fg:kg,!0))),(h=this.i.toString())&&o.push("?",h),(h=this.m)&&o.push("#",br(h,Mg)),o.join("")};function le(o){return new We(o)}function xi(o,c,h){o.j=h?Sr(c,!0):c,o.j&&(o.j=o.j.replace(/:$/,""))}function Ci(o,c){if(c){if(c=Number(c),isNaN(c)||0>c)throw Error("Bad port number "+c);o.s=c}else o.s=null}function Dl(o,c,h){c instanceof Rr?(o.i=c,Lg(o.i,o.h)):(h||(c=br(c,Og)),o.i=new Rr(c,o.h))}function it(o,c,h){o.i.set(c,h)}function Di(o){return it(o,"zx",Math.floor(2147483648*Math.random()).toString(36)+Math.abs(Math.floor(2147483648*Math.random())^Date.now()).toString(36)),o}function Sr(o,c){return o?c?decodeURI(o.replace(/%25/g,"%2525")):decodeURIComponent(o):""}function br(o,c,h){return typeof o=="string"?(o=encodeURI(o).replace(c,Ng),h&&(o=o.replace(/%25([0-9a-fA-F]{2})/g,"%$1")),o):null}function Ng(o){return o=o.charCodeAt(0),"%"+(o>>4&15).toString(16)+(o&15).toString(16)}var Nl=/[#\/\?@]/g,kg=/[#\?:]/g,Fg=/[#\?]/g,Og=/[#\?@]/g,Mg=/#/g;function Rr(o,c){this.h=this.g=null,this.i=o||null,this.j=!!c}function Ae(o){o.g||(o.g=new Map,o.h=0,o.i&&Dg(o.i,function(c,h){o.add(decodeURIComponent(c.replace(/\+/g," ")),h)}))}r=Rr.prototype,r.add=function(o,c){Ae(this),this.i=null,o=An(this,o);var h=this.g.get(o);return h||this.g.set(o,h=[]),h.push(c),this.h+=1,this};function kl(o,c){Ae(o),c=An(o,c),o.g.has(c)&&(o.i=null,o.h-=o.g.get(c).length,o.g.delete(c))}function Fl(o,c){return Ae(o),c=An(o,c),o.g.has(c)}r.forEach=function(o,c){Ae(this),this.g.forEach(function(h,m){h.forEach(function(E){o.call(c,E,m,this)},this)},this)},r.na=function(){Ae(this);let o=Array.from(this.g.values()),c=Array.from(this.g.keys()),h=[];for(let m=0;m<c.length;m++){let E=o[m];for(let R=0;R<E.length;R++)h.push(c[m])}return h},r.V=function(o){Ae(this);let c=[];if(typeof o=="string")Fl(this,o)&&(c=c.concat(this.g.get(An(this,o))));else{o=Array.from(this.g.values());for(let h=0;h<o.length;h++)c=c.concat(o[h])}return c},r.set=function(o,c){return Ae(this),this.i=null,o=An(this,o),Fl(this,o)&&(this.h-=this.g.get(o).length),this.g.set(o,[c]),this.h+=1,this},r.get=function(o,c){return o?(o=this.V(o),0<o.length?String(o[0]):c):c};function Ol(o,c,h){kl(o,c),0<h.length&&(o.i=null,o.g.set(An(o,c),k(h)),o.h+=h.length)}r.toString=function(){if(this.i)return this.i;if(!this.g)return"";let o=[],c=Array.from(this.g.keys());for(var h=0;h<c.length;h++){var m=c[h];let R=encodeURIComponent(String(m)),F=this.V(m);for(m=0;m<F.length;m++){var E=R;F[m]!==""&&(E+="="+encodeURIComponent(String(F[m]))),o.push(E)}}return this.i=o.join("&")};function An(o,c){return c=String(c),o.j&&(c=c.toLowerCase()),c}function Lg(o,c){c&&!o.j&&(Ae(o),o.i=null,o.g.forEach(function(h,m){var E=m.toLowerCase();m!=E&&(kl(this,m),Ol(this,E,h))},o)),o.j=c}function qg(o,c){let h=new Er;if(u.Image){let m=new Image;m.onload=S(Se,h,"TestLoadImage: loaded",!0,c,m),m.onerror=S(Se,h,"TestLoadImage: error",!1,c,m),m.onabort=S(Se,h,"TestLoadImage: abort",!1,c,m),m.ontimeout=S(Se,h,"TestLoadImage: timeout",!1,c,m),u.setTimeout(function(){m.ontimeout&&m.ontimeout()},1e4),m.src=o}else c(!1)}function Ug(o,c){let h=new Er,m=new AbortController,E=setTimeout(()=>{m.abort(),Se(h,"TestPingServer: timeout",!1,c)},1e4);fetch(o,{signal:m.signal}).then(R=>{clearTimeout(E),R.ok?Se(h,"TestPingServer: ok",!0,c):Se(h,"TestPingServer: server error",!1,c)}).catch(()=>{clearTimeout(E),Se(h,"TestPingServer: error",!1,c)})}function Se(o,c,h,m,E){try{E&&(E.onload=null,E.onerror=null,E.onabort=null,E.ontimeout=null),m(h)}catch{}}function Bg(){this.g=new Eg}function jg(o,c,h){let m=h||"";try{xl(o,function(E,R){let F=E;d(E)&&(F=So(E)),c.push(m+R+"="+encodeURIComponent(F))})}catch(E){throw c.push(m+"type="+encodeURIComponent("_badmap")),E}}function Pr(o){this.l=o.Ub||null,this.j=o.eb||!1}N(Pr,bo),Pr.prototype.g=function(){return new Ni(this.l,this.j)},Pr.prototype.i=function(o){return function(){return o}}({});function Ni(o,c){Rt.call(this),this.D=o,this.o=c,this.m=void 0,this.status=this.readyState=0,this.responseType=this.responseText=this.response=this.statusText="",this.onreadystatechange=null,this.u=new Headers,this.h=null,this.B="GET",this.A="",this.g=!1,this.v=this.j=this.l=null}N(Ni,Rt),r=Ni.prototype,r.open=function(o,c){if(this.readyState!=0)throw this.abort(),Error("Error reopening a connection");this.B=o,this.A=c,this.readyState=1,xr(this)},r.send=function(o){if(this.readyState!=1)throw this.abort(),Error("need to call open() first. ");this.g=!0;let c={headers:this.u,method:this.B,credentials:this.m,cache:void 0};o&&(c.body=o),(this.D||u).fetch(new Request(this.A,c)).then(this.Sa.bind(this),this.ga.bind(this))},r.abort=function(){this.response=this.responseText="",this.u=new Headers,this.status=0,this.j&&this.j.cancel("Request was aborted.").catch(()=>{}),1<=this.readyState&&this.g&&this.readyState!=4&&(this.g=!1,Vr(this)),this.readyState=0},r.Sa=function(o){if(this.g&&(this.l=o,this.h||(this.status=this.l.status,this.statusText=this.l.statusText,this.h=o.headers,this.readyState=2,xr(this)),this.g&&(this.readyState=3,xr(this),this.g)))if(this.responseType==="arraybuffer")o.arrayBuffer().then(this.Qa.bind(this),this.ga.bind(this));else if(typeof u.ReadableStream<"u"&&"body"in o){if(this.j=o.body.getReader(),this.o){if(this.responseType)throw Error('responseType must be empty for "streamBinaryChunks" mode responses.');this.response=[]}else this.response=this.responseText="",this.v=new TextDecoder;Ml(this)}else o.text().then(this.Ra.bind(this),this.ga.bind(this))};function Ml(o){o.j.read().then(o.Pa.bind(o)).catch(o.ga.bind(o))}r.Pa=function(o){if(this.g){if(this.o&&o.value)this.response.push(o.value);else if(!this.o){var c=o.value?o.value:new Uint8Array(0);(c=this.v.decode(c,{stream:!o.done}))&&(this.response=this.responseText+=c)}o.done?Vr(this):xr(this),this.readyState==3&&Ml(this)}},r.Ra=function(o){this.g&&(this.response=this.responseText=o,Vr(this))},r.Qa=function(o){this.g&&(this.response=o,Vr(this))},r.ga=function(){this.g&&Vr(this)};function Vr(o){o.readyState=4,o.l=null,o.j=null,o.v=null,xr(o)}r.setRequestHeader=function(o,c){this.u.append(o,c)},r.getResponseHeader=function(o){return this.h&&this.h.get(o.toLowerCase())||""},r.getAllResponseHeaders=function(){if(!this.h)return"";let o=[],c=this.h.entries();for(var h=c.next();!h.done;)h=h.value,o.push(h[0]+": "+h[1]),h=c.next();return o.join(`\r
`)};function xr(o){o.onreadystatechange&&o.onreadystatechange.call(o)}Object.defineProperty(Ni.prototype,"withCredentials",{get:function(){return this.m==="include"},set:function(o){this.m=o?"include":"same-origin"}});function Ll(o){let c="";return K(o,function(h,m){c+=m,c+=":",c+=h,c+=`\r
`}),c}function Oo(o,c,h){t:{for(m in h){var m=!1;break t}m=!0}m||(h=Ll(h),typeof o=="string"?h!=null&&encodeURIComponent(String(h)):it(o,c,h))}function ct(o){Rt.call(this),this.headers=new Map,this.o=o||null,this.h=!1,this.v=this.g=null,this.D="",this.m=0,this.l="",this.j=this.B=this.u=this.A=!1,this.I=null,this.H="",this.J=!1}N(ct,Rt);var Gg=/^https?$/i,zg=["POST","PUT"];r=ct.prototype,r.Ha=function(o){this.J=o},r.ea=function(o,c,h,m){if(this.g)throw Error("[goog.net.XhrIo] Object is active with another request="+this.D+"; newUri="+o);c=c?c.toUpperCase():"GET",this.D=o,this.l="",this.m=0,this.A=!1,this.h=!0,this.g=this.o?this.o.g():Vo.g(),this.v=this.o?fl(this.o):fl(Vo),this.g.onreadystatechange=_(this.Ea,this);try{this.B=!0,this.g.open(c,String(o),!0),this.B=!1}catch(R){ql(this,R);return}if(o=h||"",h=new Map(this.headers),m)if(Object.getPrototypeOf(m)===Object.prototype)for(var E in m)h.set(E,m[E]);else if(typeof m.keys=="function"&&typeof m.get=="function")for(let R of m.keys())h.set(R,m.get(R));else throw Error("Unknown input type for opt_headers: "+String(m));m=Array.from(h.keys()).find(R=>R.toLowerCase()=="content-type"),E=u.FormData&&o instanceof u.FormData,!(0<=Array.prototype.indexOf.call(zg,c,void 0))||m||E||h.set("Content-Type","application/x-www-form-urlencoded;charset=utf-8");for(let[R,F]of h)this.g.setRequestHeader(R,F);this.H&&(this.g.responseType=this.H),"withCredentials"in this.g&&this.g.withCredentials!==this.J&&(this.g.withCredentials=this.J);try{jl(this),this.u=!0,this.g.send(o),this.u=!1}catch(R){ql(this,R)}};function ql(o,c){o.h=!1,o.g&&(o.j=!0,o.g.abort(),o.j=!1),o.l=c,o.m=5,Ul(o),ki(o)}function Ul(o){o.A||(o.A=!0,Dt(o,"complete"),Dt(o,"error"))}r.abort=function(o){this.g&&this.h&&(this.h=!1,this.j=!0,this.g.abort(),this.j=!1,this.m=o||7,Dt(this,"complete"),Dt(this,"abort"),ki(this))},r.N=function(){this.g&&(this.h&&(this.h=!1,this.j=!0,this.g.abort(),this.j=!1),ki(this,!0)),ct.aa.N.call(this)},r.Ea=function(){this.s||(this.B||this.u||this.j?Bl(this):this.bb())},r.bb=function(){Bl(this)};function Bl(o){if(o.h&&typeof a<"u"&&(!o.v[1]||he(o)!=4||o.Z()!=2)){if(o.u&&he(o)==4)cl(o.Ea,0,o);else if(Dt(o,"readystatechange"),he(o)==4){o.h=!1;try{let F=o.Z();t:switch(F){case 200:case 201:case 202:case 204:case 206:case 304:case 1223:var c=!0;break t;default:c=!1}var h;if(!(h=c)){var m;if(m=F===0){var E=String(o.D).match(Cl)[1]||null;!E&&u.self&&u.self.location&&(E=u.self.location.protocol.slice(0,-1)),m=!Gg.test(E?E.toLowerCase():"")}h=m}if(h)Dt(o,"complete"),Dt(o,"success");else{o.m=6;try{var R=2<he(o)?o.g.statusText:""}catch{R=""}o.l=R+" ["+o.Z()+"]",Ul(o)}}finally{ki(o)}}}}function ki(o,c){if(o.g){jl(o);let h=o.g,m=o.v[0]?()=>{}:null;o.g=null,o.v=null,c||Dt(o,"ready");try{h.onreadystatechange=m}catch{}}}function jl(o){o.I&&(u.clearTimeout(o.I),o.I=null)}r.isActive=function(){return!!this.g};function he(o){return o.g?o.g.readyState:0}r.Z=function(){try{return 2<he(this)?this.g.status:-1}catch{return-1}},r.oa=function(){try{return this.g?this.g.responseText:""}catch{return""}},r.Oa=function(o){if(this.g){var c=this.g.responseText;return o&&c.indexOf(o)==0&&(c=c.substring(o.length)),Tg(c)}};function Gl(o){try{if(!o.g)return null;if("response"in o.g)return o.g.response;switch(o.H){case"":case"text":return o.g.responseText;case"arraybuffer":if("mozResponseArrayBuffer"in o.g)return o.g.mozResponseArrayBuffer}return null}catch{return null}}function Kg(o){let c={};o=(o.g&&2<=he(o)&&o.g.getAllResponseHeaders()||"").split(`\r
`);for(let m=0;m<o.length;m++){if(G(o[m]))continue;var h=T(o[m]);let E=h[0];if(h=h[1],typeof h!="string")continue;h=h.trim();let R=c[E]||[];c[E]=R,R.push(h)}v(c,function(m){return m.join(", ")})}r.Ba=function(){return this.m},r.Ka=function(){return typeof this.l=="string"?this.l:String(this.l)};function Cr(o,c,h){return h&&h.internalChannelParams&&h.internalChannelParams[o]||c}function zl(o){this.Aa=0,this.i=[],this.j=new Er,this.ia=this.qa=this.I=this.W=this.g=this.ya=this.D=this.H=this.m=this.S=this.o=null,this.Ya=this.U=0,this.Va=Cr("failFast",!1,o),this.F=this.C=this.u=this.s=this.l=null,this.X=!0,this.za=this.T=-1,this.Y=this.v=this.B=0,this.Ta=Cr("baseRetryDelayMs",5e3,o),this.cb=Cr("retryDelaySeedMs",1e4,o),this.Wa=Cr("forwardChannelMaxRetries",2,o),this.wa=Cr("forwardChannelRequestTimeoutMs",2e4,o),this.pa=o&&o.xmlHttpFactory||void 0,this.Xa=o&&o.Tb||void 0,this.Ca=o&&o.useFetchStreams||!1,this.L=void 0,this.J=o&&o.supportsCrossDomainXhr||!1,this.K="",this.h=new Sl(o&&o.concurrentRequestLimit),this.Da=new Bg,this.P=o&&o.fastHandshake||!1,this.O=o&&o.encodeInitMessageHeaders||!1,this.P&&this.O&&(this.O=!1),this.Ua=o&&o.Rb||!1,o&&o.xa&&this.j.xa(),o&&o.forceLongPolling&&(this.X=!1),this.ba=!this.P&&this.X&&o&&o.detectBufferingProxy||!1,this.ja=void 0,o&&o.longPollingTimeout&&0<o.longPollingTimeout&&(this.ja=o.longPollingTimeout),this.ca=void 0,this.R=0,this.M=!1,this.ka=this.A=null}r=zl.prototype,r.la=8,r.G=1,r.connect=function(o,c,h,m){Nt(0),this.W=o,this.H=c||{},h&&m!==void 0&&(this.H.OSID=h,this.H.OAID=m),this.F=this.X,this.I=Zl(this,null,this.W),Oi(this)};function Mo(o){if(Kl(o),o.G==3){var c=o.U++,h=le(o.I);if(it(h,"SID",o.K),it(h,"RID",c),it(h,"TYPE","terminate"),Dr(o,h),c=new Ee(o,o.j,c),c.L=2,c.v=Di(le(h)),h=!1,u.navigator&&u.navigator.sendBeacon)try{h=u.navigator.sendBeacon(c.v.toString(),"")}catch{}!h&&u.Image&&(new Image().src=c.v,h=!0),h||(c.g=th(c.j,null),c.g.ea(c.v)),c.F=Date.now(),Vi(c)}Xl(o)}function Fi(o){o.g&&(qo(o),o.g.cancel(),o.g=null)}function Kl(o){Fi(o),o.u&&(u.clearTimeout(o.u),o.u=null),Mi(o),o.h.cancel(),o.s&&(typeof o.s=="number"&&u.clearTimeout(o.s),o.s=null)}function Oi(o){if(!bl(o.h)&&!o.s){o.s=!0;var c=o.Ga;gr||rl(),pr||(gr(),pr=!0),po.add(c,o),o.B=0}}function $g(o,c){return Rl(o.h)>=o.h.j-(o.s?1:0)?!1:o.s?(o.i=c.D.concat(o.i),!0):o.G==1||o.G==2||o.B>=(o.Va?0:o.Wa)?!1:(o.s=Tr(_(o.Ga,o,c),Yl(o,o.B)),o.B++,!0)}r.Ga=function(o){if(this.s)if(this.s=null,this.G==1){if(!o){this.U=Math.floor(1e5*Math.random()),o=this.U++;let E=new Ee(this,this.j,o),R=this.o;if(this.S&&(R?(R=p(R),I(R,this.S)):R=this.S),this.m!==null||this.O||(E.H=R,R=null),this.P)t:{for(var c=0,h=0;h<this.i.length;h++){e:{var m=this.i[h];if("__data__"in m.map&&(m=m.map.__data__,typeof m=="string")){m=m.length;break e}m=void 0}if(m===void 0)break;if(c+=m,4096<c){c=h;break t}if(c===4096||h===this.i.length-1){c=h+1;break t}}c=1e3}else c=1e3;c=Ql(this,E,c),h=le(this.I),it(h,"RID",o),it(h,"CVER",22),this.D&&it(h,"X-HTTP-Session-Id",this.D),Dr(this,h),R&&(this.O?c="headers="+encodeURIComponent(String(Ll(R)))+"&"+c:this.m&&Oo(h,this.m,R)),Fo(this.h,E),this.Ua&&it(h,"TYPE","init"),this.P?(it(h,"$req",c),it(h,"SID","null"),E.T=!0,Co(E,h,null)):Co(E,h,c),this.G=2}}else this.G==3&&(o?$l(this,o):this.i.length==0||bl(this.h)||$l(this))};function $l(o,c){var h;c?h=c.l:h=o.U++;let m=le(o.I);it(m,"SID",o.K),it(m,"RID",h),it(m,"AID",o.T),Dr(o,m),o.m&&o.o&&Oo(m,o.m,o.o),h=new Ee(o,o.j,h,o.B+1),o.m===null&&(h.H=o.o),c&&(o.i=c.D.concat(o.i)),c=Ql(o,h,1e3),h.I=Math.round(.5*o.wa)+Math.round(.5*o.wa*Math.random()),Fo(o.h,h),Co(h,m,c)}function Dr(o,c){o.H&&K(o.H,function(h,m){it(c,m,h)}),o.l&&xl({},function(h,m){it(c,m,h)})}function Ql(o,c,h){h=Math.min(o.i.length,h);var m=o.l?_(o.l.Na,o.l,o):null;t:{var E=o.i;let R=-1;for(;;){let F=["count="+h];R==-1?0<h?(R=E[0].g,F.push("ofs="+R)):R=0:F.push("ofs="+R);let et=!0;for(let Et=0;Et<h;Et++){let Z=E[Et].g,Pt=E[Et].map;if(Z-=R,0>Z)R=Math.max(0,E[Et].g-100),et=!1;else try{jg(Pt,F,"req"+Z+"_")}catch{m&&m(Pt)}}if(et){m=F.join("&");break t}}}return o=o.i.splice(0,h),c.D=o,m}function Wl(o){if(!o.g&&!o.u){o.Y=1;var c=o.Fa;gr||rl(),pr||(gr(),pr=!0),po.add(c,o),o.v=0}}function Lo(o){return o.g||o.u||3<=o.v?!1:(o.Y++,o.u=Tr(_(o.Fa,o),Yl(o,o.v)),o.v++,!0)}r.Fa=function(){if(this.u=null,Hl(this),this.ba&&!(this.M||this.g==null||0>=this.R)){var o=2*this.R;this.j.info("BP detection timer enabled: "+o),this.A=Tr(_(this.ab,this),o)}},r.ab=function(){this.A&&(this.A=null,this.j.info("BP detection timeout reached."),this.j.info("Buffering proxy detected and switch to long-polling!"),this.F=!1,this.M=!0,Nt(10),Fi(this),Hl(this))};function qo(o){o.A!=null&&(u.clearTimeout(o.A),o.A=null)}function Hl(o){o.g=new Ee(o,o.j,"rpc",o.Y),o.m===null&&(o.g.H=o.o),o.g.O=0;var c=le(o.qa);it(c,"RID","rpc"),it(c,"SID",o.K),it(c,"AID",o.T),it(c,"CI",o.F?"0":"1"),!o.F&&o.ja&&it(c,"TO",o.ja),it(c,"TYPE","xmlhttp"),Dr(o,c),o.m&&o.o&&Oo(c,o.m,o.o),o.L&&(o.g.I=o.L);var h=o.g;o=o.ia,h.L=1,h.v=Di(le(c)),h.m=null,h.P=!0,Tl(h,o)}r.Za=function(){this.C!=null&&(this.C=null,Fi(this),Lo(this),Nt(19))};function Mi(o){o.C!=null&&(u.clearTimeout(o.C),o.C=null)}function Jl(o,c){var h=null;if(o.g==c){Mi(o),qo(o),o.g=null;var m=2}else if(ko(o.h,c))h=c.D,Pl(o.h,c),m=1;else return;if(o.G!=0){if(c.o)if(m==1){h=c.m?c.m.length:0,c=Date.now()-c.F;var E=o.B;m=bi(),Dt(m,new yl(m,h)),Oi(o)}else Wl(o);else if(E=c.s,E==3||E==0&&0<c.X||!(m==1&&$g(o,c)||m==2&&Lo(o)))switch(h&&0<h.length&&(c=o.h,c.i=c.i.concat(h)),E){case 1:He(o,5);break;case 4:He(o,10);break;case 3:He(o,6);break;default:He(o,2)}}}function Yl(o,c){let h=o.Ta+Math.floor(Math.random()*o.cb);return o.isActive()||(h*=2),h*c}function He(o,c){if(o.j.info("Error code "+c),c==2){var h=_(o.fb,o),m=o.Xa;let E=!m;m=new We(m||"//www.google.com/images/cleardot.gif"),u.location&&u.location.protocol=="http"||xi(m,"https"),Di(m),E?qg(m.toString(),h):Ug(m.toString(),h)}else Nt(2);o.G=0,o.l&&o.l.sa(c),Xl(o),Kl(o)}r.fb=function(o){o?(this.j.info("Successfully pinged google.com"),Nt(2)):(this.j.info("Failed to ping google.com"),Nt(1))};function Xl(o){if(o.G=0,o.ka=[],o.l){let c=Vl(o.h);(c.length!=0||o.i.length!=0)&&(D(o.ka,c),D(o.ka,o.i),o.h.i.length=0,k(o.i),o.i.length=0),o.l.ra()}}function Zl(o,c,h){var m=h instanceof We?le(h):new We(h);if(m.g!="")c&&(m.g=c+"."+m.g),Ci(m,m.s);else{var E=u.location;m=E.protocol,c=c?c+"."+E.hostname:E.hostname,E=+E.port;var R=new We(null);m&&xi(R,m),c&&(R.g=c),E&&Ci(R,E),h&&(R.l=h),m=R}return h=o.D,c=o.ya,h&&c&&it(m,h,c),it(m,"VER",o.la),Dr(o,m),m}function th(o,c,h){if(c&&!o.J)throw Error("Can't create secondary domain capable XhrIo object.");return c=o.Ca&&!o.pa?new ct(new Pr({eb:h})):new ct(o.pa),c.Ha(o.J),c}r.isActive=function(){return!!this.l&&this.l.isActive(this)};function eh(){}r=eh.prototype,r.ua=function(){},r.ta=function(){},r.sa=function(){},r.ra=function(){},r.isActive=function(){return!0},r.Na=function(){};function Li(){}Li.prototype.g=function(o,c){return new Lt(o,c)};function Lt(o,c){Rt.call(this),this.g=new zl(c),this.l=o,this.h=c&&c.messageUrlParams||null,o=c&&c.messageHeaders||null,c&&c.clientProtocolHeaderRequired&&(o?o["X-Client-Protocol"]="webchannel":o={"X-Client-Protocol":"webchannel"}),this.g.o=o,o=c&&c.initMessageHeaders||null,c&&c.messageContentType&&(o?o["X-WebChannel-Content-Type"]=c.messageContentType:o={"X-WebChannel-Content-Type":c.messageContentType}),c&&c.va&&(o?o["X-WebChannel-Client-Profile"]=c.va:o={"X-WebChannel-Client-Profile":c.va}),this.g.S=o,(o=c&&c.Sb)&&!G(o)&&(this.g.m=o),this.v=c&&c.supportsCrossDomainXhr||!1,this.u=c&&c.sendRawJson||!1,(c=c&&c.httpSessionIdParam)&&!G(c)&&(this.g.D=c,o=this.h,o!==null&&c in o&&(o=this.h,c in o&&delete o[c])),this.j=new Sn(this)}N(Lt,Rt),Lt.prototype.m=function(){this.g.l=this.j,this.v&&(this.g.J=!0),this.g.connect(this.l,this.h||void 0)},Lt.prototype.close=function(){Mo(this.g)},Lt.prototype.o=function(o){var c=this.g;if(typeof o=="string"){var h={};h.__data__=o,o=h}else this.u&&(h={},h.__data__=So(o),o=h);c.i.push(new Vg(c.Ya++,o)),c.G==3&&Oi(c)},Lt.prototype.N=function(){this.g.l=null,delete this.j,Mo(this.g),delete this.g,Lt.aa.N.call(this)};function nh(o){Ro.call(this),o.__headers__&&(this.headers=o.__headers__,this.statusCode=o.__status__,delete o.__headers__,delete o.__status__);var c=o.__sm__;if(c){t:{for(let h in c){o=h;break t}o=void 0}(this.i=o)&&(o=this.i,c=c!==null&&o in c?c[o]:void 0),this.data=c}else this.data=o}N(nh,Ro);function rh(){Po.call(this),this.status=1}N(rh,Po);function Sn(o){this.g=o}N(Sn,eh),Sn.prototype.ua=function(){Dt(this.g,"a")},Sn.prototype.ta=function(o){Dt(this.g,new nh(o))},Sn.prototype.sa=function(o){Dt(this.g,new rh)},Sn.prototype.ra=function(){Dt(this.g,"b")},Li.prototype.createWebChannel=Li.prototype.g,Lt.prototype.send=Lt.prototype.o,Lt.prototype.open=Lt.prototype.m,Lt.prototype.close=Lt.prototype.close,ta=de.createWebChannelTransport=function(){return new Li},Zo=de.getStatEventTarget=function(){return bi()},Xo=de.Event=$e,$i=de.Stat={mb:0,pb:1,qb:2,Jb:3,Ob:4,Lb:5,Mb:6,Kb:7,Ib:8,Nb:9,PROXY:10,NOPROXY:11,Gb:12,Cb:13,Db:14,Bb:15,Eb:16,Fb:17,ib:18,hb:19,jb:20},Ri.NO_ERROR=0,Ri.TIMEOUT=8,Ri.HTTP_ERROR=6,Or=de.ErrorCode=Ri,wl.COMPLETE="complete",Yo=de.EventType=wl,ml.EventType=vr,vr.OPEN="a",vr.CLOSE="b",vr.ERROR="c",vr.MESSAGE="d",Rt.prototype.listen=Rt.prototype.K,Rn=de.WebChannel=ml,Qg=de.FetchXmlHttpFactory=Pr,ct.prototype.listenOnce=ct.prototype.L,ct.prototype.getLastError=ct.prototype.Ka,ct.prototype.getLastErrorCode=ct.prototype.Ba,ct.prototype.getStatus=ct.prototype.Z,ct.prototype.getResponseJson=ct.prototype.Oa,ct.prototype.getResponseText=ct.prototype.oa,ct.prototype.send=ct.prototype.ea,ct.prototype.setWithCredentials=ct.prototype.Ha,Jo=de.XhrIo=ct}).apply(typeof Ki<"u"?Ki:typeof self<"u"?self:typeof window<"u"?window:{});var Oh="@firebase/firestore";var yt=class{constructor(t){this.uid=t}isAuthenticated(){return this.uid!=null}toKey(){return this.isAuthenticated()?"uid:"+this.uid:"anonymous-user"}isEqual(t){return t.uid===this.uid}};yt.UNAUTHENTICATED=new yt(null),yt.GOOGLE_CREDENTIALS=new yt("google-credentials-uid"),yt.FIRST_PARTY=new yt("first-party-uid"),yt.MOCK_USER=new yt("mock-user");var ir="10.14.0";var Ne=new gh("@firebase/firestore");function Dn(){return Ne.logLevel}function qd(r){Ne.setLogLevel(r)}function C(r,...t){if(Ne.logLevel<=Xt.DEBUG){let e=t.map(sc);Ne.debug(`Firestore (${ir}): ${r}`,...e)}}function dt(r,...t){if(Ne.logLevel<=Xt.ERROR){let e=t.map(sc);Ne.error(`Firestore (${ir}): ${r}`,...e)}}function Qt(r,...t){if(Ne.logLevel<=Xt.WARN){let e=t.map(sc);Ne.warn(`Firestore (${ir}): ${r}`,...e)}}function sc(r){if(typeof r=="string")return r;try{return function(e){return JSON.stringify(e)}(r)}catch{return r}}function L(r="Unexpected state"){let t=`FIRESTORE (${ir}) INTERNAL ASSERTION FAILED: `+r;throw dt(t),new Error(t)}function q(r,t){r||L()}function Ud(r,t){r||L()}function O(r,t){return r}var P={OK:"ok",CANCELLED:"cancelled",UNKNOWN:"unknown",INVALID_ARGUMENT:"invalid-argument",DEADLINE_EXCEEDED:"deadline-exceeded",NOT_FOUND:"not-found",ALREADY_EXISTS:"already-exists",PERMISSION_DENIED:"permission-denied",UNAUTHENTICATED:"unauthenticated",RESOURCE_EXHAUSTED:"resource-exhausted",FAILED_PRECONDITION:"failed-precondition",ABORTED:"aborted",OUT_OF_RANGE:"out-of-range",UNIMPLEMENTED:"unimplemented",INTERNAL:"internal",UNAVAILABLE:"unavailable",DATA_LOSS:"data-loss"},x=class extends mh{constructor(t,e){super(t,e),this.code=t,this.message=e,this.toString=()=>`${this.name}: [code=${this.code}]: ${this.message}`}};var vt=class{constructor(){this.promise=new Promise((t,e)=>{this.resolve=t,this.reject=e})}};var ns=class{constructor(t,e){this.user=e,this.type="OAuth",this.headers=new Map,this.headers.set("Authorization",`Bearer ${t}`)}},oa=class{getToken(){return Promise.resolve(null)}invalidateToken(){}start(t,e){t.enqueueRetryable(()=>e(yt.UNAUTHENTICATED))}shutdown(){}},aa=class{constructor(t){this.token=t,this.changeListener=null}getToken(){return Promise.resolve(this.token)}invalidateToken(){}start(t,e){this.changeListener=e,t.enqueueRetryable(()=>e(this.token.user))}shutdown(){this.changeListener=null}},ua=class{constructor(t){this.t=t,this.currentUser=yt.UNAUTHENTICATED,this.i=0,this.forceRefresh=!1,this.auth=null}start(t,e){q(this.o===void 0);let n=this.i,i=l=>this.i!==n?(n=this.i,e(l)):Promise.resolve(),s=new vt;this.o=()=>{this.i++,this.currentUser=this.u(),s.resolve(),s=new vt,t.enqueueRetryable(()=>i(this.currentUser))};let a=()=>{let l=s;t.enqueueRetryable(()=>V(this,null,function*(){yield l.promise,yield i(this.currentUser)}))},u=l=>{C("FirebaseAuthCredentialsProvider","Auth detected"),this.auth=l,this.o&&(this.auth.addAuthTokenListener(this.o),a())};this.t.onInit(l=>u(l)),setTimeout(()=>{if(!this.auth){let l=this.t.getImmediate({optional:!0});l?u(l):(C("FirebaseAuthCredentialsProvider","Auth not yet detected"),s.resolve(),s=new vt)}},0),a()}getToken(){let t=this.i,e=this.forceRefresh;return this.forceRefresh=!1,this.auth?this.auth.getToken(e).then(n=>this.i!==t?(C("FirebaseAuthCredentialsProvider","getToken aborted due to token change."),this.getToken()):n?(q(typeof n.accessToken=="string"),new ns(n.accessToken,this.currentUser)):null):Promise.resolve(null)}invalidateToken(){this.forceRefresh=!0}shutdown(){this.auth&&this.o&&this.auth.removeAuthTokenListener(this.o),this.o=void 0}u(){let t=this.auth&&this.auth.getUid();return q(t===null||typeof t=="string"),new yt(t)}},ca=class{constructor(t,e,n){this.l=t,this.h=e,this.P=n,this.type="FirstParty",this.user=yt.FIRST_PARTY,this.I=new Map}T(){return this.P?this.P():null}get headers(){this.I.set("X-Goog-AuthUser",this.l);let t=this.T();return t&&this.I.set("Authorization",t),this.h&&this.I.set("X-Goog-Iam-Authorization-Token",this.h),this.I}},la=class{constructor(t,e,n){this.l=t,this.h=e,this.P=n}getToken(){return Promise.resolve(new ca(this.l,this.h,this.P))}start(t,e){t.enqueueRetryable(()=>e(yt.FIRST_PARTY))}shutdown(){}invalidateToken(){}},ha=class{constructor(t){this.value=t,this.type="AppCheck",this.headers=new Map,t&&t.length>0&&this.headers.set("x-firebase-appcheck",this.value)}},da=class{constructor(t){this.A=t,this.forceRefresh=!1,this.appCheck=null,this.R=null}start(t,e){q(this.o===void 0);let n=s=>{s.error!=null&&C("FirebaseAppCheckTokenProvider",`Error getting App Check token; using placeholder token instead. Error: ${s.error.message}`);let a=s.token!==this.R;return this.R=s.token,C("FirebaseAppCheckTokenProvider",`Received ${a?"new":"existing"} token.`),a?e(s.token):Promise.resolve()};this.o=s=>{t.enqueueRetryable(()=>n(s))};let i=s=>{C("FirebaseAppCheckTokenProvider","AppCheck detected"),this.appCheck=s,this.o&&this.appCheck.addTokenListener(this.o)};this.A.onInit(s=>i(s)),setTimeout(()=>{if(!this.appCheck){let s=this.A.getImmediate({optional:!0});s?i(s):C("FirebaseAppCheckTokenProvider","AppCheck not yet detected")}},0)}getToken(){let t=this.forceRefresh;return this.forceRefresh=!1,this.appCheck?this.appCheck.getToken(t).then(e=>e?(q(typeof e.token=="string"),this.R=e.token,new ha(e.token)):null):Promise.resolve(null)}invalidateToken(){this.forceRefresh=!0}shutdown(){this.appCheck&&this.o&&this.appCheck.removeTokenListener(this.o),this.o=void 0}};function Wg(r){let t=typeof self<"u"&&(self.crypto||self.msCrypto),e=new Uint8Array(r);if(t&&typeof t.getRandomValues=="function")t.getRandomValues(e);else for(let n=0;n<r;n++)e[n]=Math.floor(256*Math.random());return e}var rs=class{static newId(){let t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",e=Math.floor(256/t.length)*t.length,n="";for(;n.length<20;){let i=Wg(40);for(let s=0;s<i.length;++s)n.length<20&&i[s]<e&&(n+=t.charAt(i[s]%t.length))}return n}};function z(r,t){return r<t?-1:r>t?1:0}function Bn(r,t,e){return r.length===t.length&&r.every((n,i)=>e(n,t[i]))}function Bd(r){return r+"\0"}var at=class r{constructor(t,e){if(this.seconds=t,this.nanoseconds=e,e<0)throw new x(P.INVALID_ARGUMENT,"Timestamp nanoseconds out of range: "+e);if(e>=1e9)throw new x(P.INVALID_ARGUMENT,"Timestamp nanoseconds out of range: "+e);if(t<-62135596800)throw new x(P.INVALID_ARGUMENT,"Timestamp seconds out of range: "+t);if(t>=253402300800)throw new x(P.INVALID_ARGUMENT,"Timestamp seconds out of range: "+t)}static now(){return r.fromMillis(Date.now())}static fromDate(t){return r.fromMillis(t.getTime())}static fromMillis(t){let e=Math.floor(t/1e3),n=Math.floor(1e6*(t-1e3*e));return new r(e,n)}toDate(){return new Date(this.toMillis())}toMillis(){return 1e3*this.seconds+this.nanoseconds/1e6}_compareTo(t){return this.seconds===t.seconds?z(this.nanoseconds,t.nanoseconds):z(this.seconds,t.seconds)}isEqual(t){return t.seconds===this.seconds&&t.nanoseconds===this.nanoseconds}toString(){return"Timestamp(seconds="+this.seconds+", nanoseconds="+this.nanoseconds+")"}toJSON(){return{seconds:this.seconds,nanoseconds:this.nanoseconds}}valueOf(){let t=this.seconds- -62135596800;return String(t).padStart(12,"0")+"."+String(this.nanoseconds).padStart(9,"0")}};var B=class r{constructor(t){this.timestamp=t}static fromTimestamp(t){return new r(t)}static min(){return new r(new at(0,0))}static max(){return new r(new at(253402300799,999999999))}compareTo(t){return this.timestamp._compareTo(t.timestamp)}isEqual(t){return this.timestamp.isEqual(t.timestamp)}toMicroseconds(){return 1e6*this.timestamp.seconds+this.timestamp.nanoseconds/1e3}toString(){return"SnapshotVersion("+this.timestamp.toString()+")"}toTimestamp(){return this.timestamp}};var is=class r{constructor(t,e,n){e===void 0?e=0:e>t.length&&L(),n===void 0?n=t.length-e:n>t.length-e&&L(),this.segments=t,this.offset=e,this.len=n}get length(){return this.len}isEqual(t){return r.comparator(this,t)===0}child(t){let e=this.segments.slice(this.offset,this.limit());return t instanceof r?t.forEach(n=>{e.push(n)}):e.push(t),this.construct(e)}limit(){return this.offset+this.length}popFirst(t){return t=t===void 0?1:t,this.construct(this.segments,this.offset+t,this.length-t)}popLast(){return this.construct(this.segments,this.offset,this.length-1)}firstSegment(){return this.segments[this.offset]}lastSegment(){return this.get(this.length-1)}get(t){return this.segments[this.offset+t]}isEmpty(){return this.length===0}isPrefixOf(t){if(t.length<this.length)return!1;for(let e=0;e<this.length;e++)if(this.get(e)!==t.get(e))return!1;return!0}isImmediateParentOf(t){if(this.length+1!==t.length)return!1;for(let e=0;e<this.length;e++)if(this.get(e)!==t.get(e))return!1;return!0}forEach(t){for(let e=this.offset,n=this.limit();e<n;e++)t(this.segments[e])}toArray(){return this.segments.slice(this.offset,this.limit())}static comparator(t,e){let n=Math.min(t.length,e.length);for(let i=0;i<n;i++){let s=t.get(i),a=e.get(i);if(s<a)return-1;if(s>a)return 1}return t.length<e.length?-1:t.length>e.length?1:0}},Y=class r extends is{construct(t,e,n){return new r(t,e,n)}canonicalString(){return this.toArray().join("/")}toString(){return this.canonicalString()}toUriEncodedString(){return this.toArray().map(encodeURIComponent).join("/")}static fromString(...t){let e=[];for(let n of t){if(n.indexOf("//")>=0)throw new x(P.INVALID_ARGUMENT,`Invalid segment (${n}). Paths must not contain // in them.`);e.push(...n.split("/").filter(i=>i.length>0))}return new r(e)}static emptyPath(){return new r([])}},Hg=/^[_a-zA-Z][_a-zA-Z0-9]*$/,ft=class r extends is{construct(t,e,n){return new r(t,e,n)}static isValidIdentifier(t){return Hg.test(t)}canonicalString(){return this.toArray().map(t=>(t=t.replace(/\\/g,"\\\\").replace(/`/g,"\\`"),r.isValidIdentifier(t)||(t="`"+t+"`"),t)).join(".")}toString(){return this.canonicalString()}isKeyField(){return this.length===1&&this.get(0)==="__name__"}static keyField(){return new r(["__name__"])}static fromServerFormat(t){let e=[],n="",i=0,s=()=>{if(n.length===0)throw new x(P.INVALID_ARGUMENT,`Invalid field path (${t}). Paths must not be empty, begin with '.', end with '.', or contain '..'`);e.push(n),n=""},a=!1;for(;i<t.length;){let u=t[i];if(u==="\\"){if(i+1===t.length)throw new x(P.INVALID_ARGUMENT,"Path has trailing escape character: "+t);let l=t[i+1];if(l!=="\\"&&l!=="."&&l!=="`")throw new x(P.INVALID_ARGUMENT,"Path has invalid escape sequence: "+t);n+=l,i+=2}else u==="`"?(a=!a,i++):u!=="."||a?(n+=u,i++):(s(),i++)}if(s(),a)throw new x(P.INVALID_ARGUMENT,"Unterminated ` in path: "+t);return new r(e)}static emptyPath(){return new r([])}};var M=class r{constructor(t){this.path=t}static fromPath(t){return new r(Y.fromString(t))}static fromName(t){return new r(Y.fromString(t).popFirst(5))}static empty(){return new r(Y.emptyPath())}get collectionGroup(){return this.path.popLast().lastSegment()}hasCollectionId(t){return this.path.length>=2&&this.path.get(this.path.length-2)===t}getCollectionGroup(){return this.path.get(this.path.length-2)}getCollectionPath(){return this.path.popLast()}isEqual(t){return t!==null&&Y.comparator(this.path,t.path)===0}toString(){return this.path.toString()}static comparator(t,e){return Y.comparator(t.path,e.path)}static isDocumentKey(t){return t.length%2==0}static fromSegments(t){return new r(new Y(t.slice()))}};var jn=class{constructor(t,e,n,i){this.indexId=t,this.collectionGroup=e,this.fields=n,this.indexState=i}};function fa(r){return r.fields.find(t=>t.kind===2)}function Ye(r){return r.fields.filter(t=>t.kind!==2)}jn.UNKNOWN_ID=-1;var Ln=class{constructor(t,e){this.fieldPath=t,this.kind=e}};var Wr=class r{constructor(t,e){this.sequenceNumber=t,this.offset=e}static empty(){return new r(0,Gt.min())}};function jd(r,t){let e=r.toTimestamp().seconds,n=r.toTimestamp().nanoseconds+1,i=B.fromTimestamp(n===1e9?new at(e+1,0):new at(e,n));return new Gt(i,M.empty(),t)}function Gd(r){return new Gt(r.readTime,r.key,-1)}var Gt=class r{constructor(t,e,n){this.readTime=t,this.documentKey=e,this.largestBatchId=n}static min(){return new r(B.min(),M.empty(),-1)}static max(){return new r(B.max(),M.empty(),-1)}};function oc(r,t){let e=r.readTime.compareTo(t.readTime);return e!==0?e:(e=M.comparator(r.documentKey,t.documentKey),e!==0?e:z(r.largestBatchId,t.largestBatchId))}var zd="The current tab is not in the required state to perform this operation. It might be necessary to refresh the browser tab.",ss=class{constructor(){this.onCommittedListeners=[]}addOnCommittedListener(t){this.onCommittedListeners.push(t)}raiseOnCommittedEvent(){this.onCommittedListeners.forEach(t=>t())}};function Ge(r){return V(this,null,function*(){if(r.code!==P.FAILED_PRECONDITION||r.message!==zd)throw r;C("LocalStore","Unexpectedly lost primary lease")})}var b=class r{constructor(t){this.nextCallback=null,this.catchCallback=null,this.result=void 0,this.error=void 0,this.isDone=!1,this.callbackAttached=!1,t(e=>{this.isDone=!0,this.result=e,this.nextCallback&&this.nextCallback(e)},e=>{this.isDone=!0,this.error=e,this.catchCallback&&this.catchCallback(e)})}catch(t){return this.next(void 0,t)}next(t,e){return this.callbackAttached&&L(),this.callbackAttached=!0,this.isDone?this.error?this.wrapFailure(e,this.error):this.wrapSuccess(t,this.result):new r((n,i)=>{this.nextCallback=s=>{this.wrapSuccess(t,s).next(n,i)},this.catchCallback=s=>{this.wrapFailure(e,s).next(n,i)}})}toPromise(){return new Promise((t,e)=>{this.next(t,e)})}wrapUserFunction(t){try{let e=t();return e instanceof r?e:r.resolve(e)}catch(e){return r.reject(e)}}wrapSuccess(t,e){return t?this.wrapUserFunction(()=>t(e)):r.resolve(e)}wrapFailure(t,e){return t?this.wrapUserFunction(()=>t(e)):r.reject(e)}static resolve(t){return new r((e,n)=>{e(t)})}static reject(t){return new r((e,n)=>{n(t)})}static waitFor(t){return new r((e,n)=>{let i=0,s=0,a=!1;t.forEach(u=>{++i,u.next(()=>{++s,a&&s===i&&e()},l=>n(l))}),a=!0,s===i&&e()})}static or(t){let e=r.resolve(!1);for(let n of t)e=e.next(i=>i?r.resolve(i):n());return e}static forEach(t,e){let n=[];return t.forEach((i,s)=>{n.push(e.call(this,i,s))}),this.waitFor(n)}static mapArray(t,e){return new r((n,i)=>{let s=t.length,a=new Array(s),u=0;for(let l=0;l<s;l++){let d=l;e(t[d]).next(f=>{a[d]=f,++u,u===s&&n(a)},f=>i(f))}})}static doWhile(t,e){return new r((n,i)=>{let s=()=>{t()===!0?e().next(()=>{s()},i):n()};s()})}};var os=class r{constructor(t,e){this.action=t,this.transaction=e,this.aborted=!1,this.V=new vt,this.transaction.oncomplete=()=>{this.V.resolve()},this.transaction.onabort=()=>{e.error?this.V.reject(new rn(t,e.error)):this.V.resolve()},this.transaction.onerror=n=>{let i=ac(n.target.error);this.V.reject(new rn(t,i))}}static open(t,e,n,i){try{return new r(e,t.transaction(i,n))}catch(s){throw new rn(e,s)}}get m(){return this.V.promise}abort(t){t&&this.V.reject(t),this.aborted||(C("SimpleDb","Aborting transaction:",t?t.message:"Client-initiated abort"),this.aborted=!0,this.transaction.abort())}g(){let t=this.transaction;this.aborted||typeof t.commit!="function"||t.commit()}store(t){let e=this.transaction.objectStore(t);return new ga(e)}},ke=class r{constructor(t,e,n){this.name=t,this.version=e,this.p=n,r.S(Fr())===12.2&&dt("Firestore persistence suffers from a bug in iOS 12.2 Safari that may cause your app to stop working. See https://stackoverflow.com/q/56496296/110915 for details and a potential workaround.")}static delete(t){return C("SimpleDb","Removing database:",t),Xe(window.indexedDB.deleteDatabase(t)).toPromise()}static D(){if(!fh())return!1;if(r.v())return!0;let t=Fr(),e=r.S(t),n=0<e&&e<10,i=Kd(t),s=0<i&&i<4.5;return!(t.indexOf("MSIE ")>0||t.indexOf("Trident/")>0||t.indexOf("Edge/")>0||n||s)}static v(){var t;return typeof process<"u"&&((t=process.__PRIVATE_env)===null||t===void 0?void 0:t.C)==="YES"}static F(t,e){return t.store(e)}static S(t){let e=t.match(/i(?:phone|pad|pod) os ([\d_]+)/i),n=e?e[1].split("_").slice(0,2).join("."):"-1";return Number(n)}M(t){return V(this,null,function*(){return this.db||(C("SimpleDb","Opening database:",this.name),this.db=yield new Promise((e,n)=>{let i=indexedDB.open(this.name,this.version);i.onsuccess=s=>{let a=s.target.result;e(a)},i.onblocked=()=>{n(new rn(t,"Cannot upgrade IndexedDB schema while another tab is open. Close all tabs that access Firestore and reload this page to proceed."))},i.onerror=s=>{let a=s.target.error;a.name==="VersionError"?n(new x(P.FAILED_PRECONDITION,"A newer version of the Firestore SDK was previously used and so the persisted data is not compatible with the version of the SDK you are now using. The SDK will operate with persistence disabled. If you need persistence, please re-upgrade to a newer version of the SDK or else clear the persisted IndexedDB data for your app to start fresh.")):a.name==="InvalidStateError"?n(new x(P.FAILED_PRECONDITION,"Unable to open an IndexedDB connection. This could be due to running in a private browsing session on a browser whose private browsing sessions do not support IndexedDB: "+a)):n(new rn(t,a))},i.onupgradeneeded=s=>{C("SimpleDb",'Database "'+this.name+'" requires upgrade from version:',s.oldVersion);let a=s.target.result;this.p.O(a,i.transaction,s.oldVersion,this.version).next(()=>{C("SimpleDb","Database upgrade to version "+this.version+" complete")})}})),this.N&&(this.db.onversionchange=e=>this.N(e)),this.db})}L(t){this.N=t,this.db&&(this.db.onversionchange=e=>t(e))}runTransaction(t,e,n,i){return V(this,null,function*(){let s=e==="readonly",a=0;for(;;){++a;try{this.db=yield this.M(t);let u=os.open(this.db,t,s?"readonly":"readwrite",n),l=i(u).next(d=>(u.g(),d)).catch(d=>(u.abort(d),b.reject(d))).toPromise();return l.catch(()=>{}),yield u.m,l}catch(u){let l=u,d=l.name!=="FirebaseError"&&a<3;if(C("SimpleDb","Transaction failed with error:",l.message,"Retrying:",d),this.close(),!d)return Promise.reject(l)}}})}close(){this.db&&this.db.close(),this.db=void 0}};function Kd(r){let t=r.match(/Android ([\d.]+)/i),e=t?t[1].split(".").slice(0,2).join("."):"-1";return Number(e)}var ma=class{constructor(t){this.B=t,this.k=!1,this.q=null}get isDone(){return this.k}get K(){return this.q}set cursor(t){this.B=t}done(){this.k=!0}$(t){this.q=t}delete(){return Xe(this.B.delete())}},rn=class extends x{constructor(t,e){super(P.UNAVAILABLE,`IndexedDB transaction '${t}' failed: ${e}`),this.name="IndexedDbTransactionError"}};function ze(r){return r.name==="IndexedDbTransactionError"}var ga=class{constructor(t){this.store=t}put(t,e){let n;return e!==void 0?(C("SimpleDb","PUT",this.store.name,t,e),n=this.store.put(e,t)):(C("SimpleDb","PUT",this.store.name,"<auto-key>",t),n=this.store.put(t)),Xe(n)}add(t){return C("SimpleDb","ADD",this.store.name,t,t),Xe(this.store.add(t))}get(t){return Xe(this.store.get(t)).next(e=>(e===void 0&&(e=null),C("SimpleDb","GET",this.store.name,t,e),e))}delete(t){return C("SimpleDb","DELETE",this.store.name,t),Xe(this.store.delete(t))}count(){return C("SimpleDb","COUNT",this.store.name),Xe(this.store.count())}U(t,e){let n=this.options(t,e),i=n.index?this.store.index(n.index):this.store;if(typeof i.getAll=="function"){let s=i.getAll(n.range);return new b((a,u)=>{s.onerror=l=>{u(l.target.error)},s.onsuccess=l=>{a(l.target.result)}})}{let s=this.cursor(n),a=[];return this.W(s,(u,l)=>{a.push(l)}).next(()=>a)}}G(t,e){let n=this.store.getAll(t,e===null?void 0:e);return new b((i,s)=>{n.onerror=a=>{s(a.target.error)},n.onsuccess=a=>{i(a.target.result)}})}j(t,e){C("SimpleDb","DELETE ALL",this.store.name);let n=this.options(t,e);n.H=!1;let i=this.cursor(n);return this.W(i,(s,a,u)=>u.delete())}J(t,e){let n;e?n=t:(n={},e=t);let i=this.cursor(n);return this.W(i,e)}Y(t){let e=this.cursor({});return new b((n,i)=>{e.onerror=s=>{let a=ac(s.target.error);i(a)},e.onsuccess=s=>{let a=s.target.result;a?t(a.primaryKey,a.value).next(u=>{u?a.continue():n()}):n()}})}W(t,e){let n=[];return new b((i,s)=>{t.onerror=a=>{s(a.target.error)},t.onsuccess=a=>{let u=a.target.result;if(!u)return void i();let l=new ma(u),d=e(u.primaryKey,u.value,l);if(d instanceof b){let f=d.catch(g=>(l.done(),b.reject(g)));n.push(f)}l.isDone?i():l.K===null?u.continue():u.continue(l.K)}}).next(()=>b.waitFor(n))}options(t,e){let n;return t!==void 0&&(typeof t=="string"?n=t:e=t),{index:n,range:e}}cursor(t){let e="next";if(t.reverse&&(e="prev"),t.index){let n=this.store.index(t.index);return t.H?n.openKeyCursor(t.range,e):n.openCursor(t.range,e)}return this.store.openCursor(t.range,e)}};function Xe(r){return new b((t,e)=>{r.onsuccess=n=>{let i=n.target.result;t(i)},r.onerror=n=>{let i=ac(n.target.error);e(i)}})}var Mh=!1;function ac(r){let t=ke.S(Fr());if(t>=12.2&&t<13){let e="An internal error was encountered in the Indexed Database server";if(r.message.indexOf(e)>=0){let n=new x("internal",`IOS_INDEXEDDB_BUG1: IndexedDb has thrown '${e}'. This is likely due to an unavoidable bug in iOS. See https://stackoverflow.com/q/56496296/110915 for details and a potential workaround.`);return Mh||(Mh=!0,setTimeout(()=>{throw n},0)),n}}return r}var pa=class{constructor(t,e){this.asyncQueue=t,this.Z=e,this.task=null}start(){this.X(15e3)}stop(){this.task&&(this.task.cancel(),this.task=null)}get started(){return this.task!==null}X(t){C("IndexBackfiller",`Scheduled in ${t}ms`),this.task=this.asyncQueue.enqueueAfterDelay("index_backfill",t,()=>V(this,null,function*(){this.task=null;try{C("IndexBackfiller",`Documents written: ${yield this.Z.ee()}`)}catch(e){ze(e)?C("IndexBackfiller","Ignoring IndexedDB error during index backfill: ",e):yield Ge(e)}yield this.X(6e4)}))}},_a=class{constructor(t,e){this.localStore=t,this.persistence=e}ee(t=50){return V(this,null,function*(){return this.persistence.runTransaction("Backfill Indexes","readwrite-primary",e=>this.te(e,t))})}te(t,e){let n=new Set,i=e,s=!0;return b.doWhile(()=>s===!0&&i>0,()=>this.localStore.indexManager.getNextCollectionGroupToUpdate(t).next(a=>{if(a!==null&&!n.has(a))return C("IndexBackfiller",`Processing collection: ${a}`),this.ne(t,a,i).next(u=>{i-=u,n.add(a)});s=!1})).next(()=>e-i)}ne(t,e,n){return this.localStore.indexManager.getMinOffsetFromCollectionGroup(t,e).next(i=>this.localStore.localDocuments.getNextDocuments(t,e,i,n).next(s=>{let a=s.changes;return this.localStore.indexManager.updateIndexEntries(t,a).next(()=>this.re(i,s)).next(u=>(C("IndexBackfiller",`Updating offset: ${u}`),this.localStore.indexManager.updateCollectionGroup(t,e,u))).next(()=>a.size)}))}re(t,e){let n=t;return e.changes.forEach((i,s)=>{let a=Gd(s);oc(a,n)>0&&(n=a)}),new Gt(n.readTime,n.documentKey,Math.max(e.batchId,t.largestBatchId))}};var qt=(()=>{class r{constructor(e,n){this.previousValue=e,n&&(n.sequenceNumberHandler=i=>this.ie(i),this.se=i=>n.writeSequenceNumber(i))}ie(e){return this.previousValue=Math.max(e,this.previousValue),this.previousValue}next(){let e=++this.previousValue;return this.se&&this.se(e),e}}return r.oe=-1,r})();function gi(r){return r==null}function Hr(r){return r===0&&1/r==-1/0}function $d(r){return typeof r=="number"&&Number.isInteger(r)&&!Hr(r)&&r<=Number.MAX_SAFE_INTEGER&&r>=Number.MIN_SAFE_INTEGER}function kt(r){let t="";for(let e=0;e<r.length;e++)t.length>0&&(t=Lh(t)),t=Jg(r.get(e),t);return Lh(t)}function Jg(r,t){let e=t,n=r.length;for(let i=0;i<n;i++){let s=r.charAt(i);switch(s){case"\0":e+="";break;case"":e+="";break;default:e+=s}}return e}function Lh(r){return r+""}function Zt(r){let t=r.length;if(q(t>=2),t===2)return q(r.charAt(0)===""&&r.charAt(1)===""),Y.emptyPath();let e=t-2,n=[],i="";for(let s=0;s<t;){let a=r.indexOf("",s);switch((a<0||a>e)&&L(),r.charAt(a+1)){case"":let u=r.substring(s,a),l;i.length===0?l=u:(i+=u,l=i,i=""),n.push(l);break;case"":i+=r.substring(s,a),i+="\0";break;case"":i+=r.substring(s,a+1);break;default:L()}s=a+2}return new Y(n)}var qh=["userId","batchId"];function Yi(r,t){return[r,kt(t)]}function Qd(r,t,e){return[r,kt(t),e]}var Yg={},Xg=["prefixPath","collectionGroup","readTime","documentId"],Zg=["prefixPath","collectionGroup","documentId"],tp=["collectionGroup","readTime","prefixPath","documentId"],ep=["canonicalId","targetId"],np=["targetId","path"],rp=["path","targetId"],ip=["collectionId","parent"],sp=["indexId","uid"],op=["uid","sequenceNumber"],ap=["indexId","uid","arrayValue","directionalValue","orderedDocumentKey","documentKey"],up=["indexId","uid","orderedDocumentKey"],cp=["userId","collectionPath","documentId"],lp=["userId","collectionPath","largestBatchId"],hp=["userId","collectionGroup","largestBatchId"],Wd=["mutationQueues","mutations","documentMutations","remoteDocuments","targets","owner","targetGlobal","targetDocuments","clientMetadata","remoteDocumentGlobal","collectionParents","bundles","namedQueries"],dp=[...Wd,"documentOverlays"],Hd=["mutationQueues","mutations","documentMutations","remoteDocumentsV14","targets","owner","targetGlobal","targetDocuments","clientMetadata","remoteDocumentGlobal","collectionParents","bundles","namedQueries","documentOverlays"],Jd=Hd,uc=[...Jd,"indexConfiguration","indexState","indexEntries"],fp=uc,mp=[...uc,"globals"];var Jr=class extends ss{constructor(t,e){super(),this._e=t,this.currentSequenceNumber=e}};function It(r,t){let e=O(r);return ke.F(e._e,t)}function Uh(r){let t=0;for(let e in r)Object.prototype.hasOwnProperty.call(r,e)&&t++;return t}function pn(r,t){for(let e in r)Object.prototype.hasOwnProperty.call(r,e)&&t(e,r[e])}function Yd(r){for(let t in r)if(Object.prototype.hasOwnProperty.call(r,t))return!1;return!0}var st=class r{constructor(t,e){this.comparator=t,this.root=e||ee.EMPTY}insert(t,e){return new r(this.comparator,this.root.insert(t,e,this.comparator).copy(null,null,ee.BLACK,null,null))}remove(t){return new r(this.comparator,this.root.remove(t,this.comparator).copy(null,null,ee.BLACK,null,null))}get(t){let e=this.root;for(;!e.isEmpty();){let n=this.comparator(t,e.key);if(n===0)return e.value;n<0?e=e.left:n>0&&(e=e.right)}return null}indexOf(t){let e=0,n=this.root;for(;!n.isEmpty();){let i=this.comparator(t,n.key);if(i===0)return e+n.left.size;i<0?n=n.left:(e+=n.left.size+1,n=n.right)}return-1}isEmpty(){return this.root.isEmpty()}get size(){return this.root.size}minKey(){return this.root.minKey()}maxKey(){return this.root.maxKey()}inorderTraversal(t){return this.root.inorderTraversal(t)}forEach(t){this.inorderTraversal((e,n)=>(t(e,n),!1))}toString(){let t=[];return this.inorderTraversal((e,n)=>(t.push(`${e}:${n}`),!1)),`{${t.join(", ")}}`}reverseTraversal(t){return this.root.reverseTraversal(t)}getIterator(){return new Mn(this.root,null,this.comparator,!1)}getIteratorFrom(t){return new Mn(this.root,t,this.comparator,!1)}getReverseIterator(){return new Mn(this.root,null,this.comparator,!0)}getReverseIteratorFrom(t){return new Mn(this.root,t,this.comparator,!0)}},Mn=class{constructor(t,e,n,i){this.isReverse=i,this.nodeStack=[];let s=1;for(;!t.isEmpty();)if(s=e?n(t.key,e):1,e&&i&&(s*=-1),s<0)t=this.isReverse?t.left:t.right;else{if(s===0){this.nodeStack.push(t);break}this.nodeStack.push(t),t=this.isReverse?t.right:t.left}}getNext(){let t=this.nodeStack.pop(),e={key:t.key,value:t.value};if(this.isReverse)for(t=t.left;!t.isEmpty();)this.nodeStack.push(t),t=t.right;else for(t=t.right;!t.isEmpty();)this.nodeStack.push(t),t=t.left;return e}hasNext(){return this.nodeStack.length>0}peek(){if(this.nodeStack.length===0)return null;let t=this.nodeStack[this.nodeStack.length-1];return{key:t.key,value:t.value}}},ee=class r{constructor(t,e,n,i,s){this.key=t,this.value=e,this.color=n??r.RED,this.left=i??r.EMPTY,this.right=s??r.EMPTY,this.size=this.left.size+1+this.right.size}copy(t,e,n,i,s){return new r(t??this.key,e??this.value,n??this.color,i??this.left,s??this.right)}isEmpty(){return!1}inorderTraversal(t){return this.left.inorderTraversal(t)||t(this.key,this.value)||this.right.inorderTraversal(t)}reverseTraversal(t){return this.right.reverseTraversal(t)||t(this.key,this.value)||this.left.reverseTraversal(t)}min(){return this.left.isEmpty()?this:this.left.min()}minKey(){return this.min().key}maxKey(){return this.right.isEmpty()?this.key:this.right.maxKey()}insert(t,e,n){let i=this,s=n(t,i.key);return i=s<0?i.copy(null,null,null,i.left.insert(t,e,n),null):s===0?i.copy(null,e,null,null,null):i.copy(null,null,null,null,i.right.insert(t,e,n)),i.fixUp()}removeMin(){if(this.left.isEmpty())return r.EMPTY;let t=this;return t.left.isRed()||t.left.left.isRed()||(t=t.moveRedLeft()),t=t.copy(null,null,null,t.left.removeMin(),null),t.fixUp()}remove(t,e){let n,i=this;if(e(t,i.key)<0)i.left.isEmpty()||i.left.isRed()||i.left.left.isRed()||(i=i.moveRedLeft()),i=i.copy(null,null,null,i.left.remove(t,e),null);else{if(i.left.isRed()&&(i=i.rotateRight()),i.right.isEmpty()||i.right.isRed()||i.right.left.isRed()||(i=i.moveRedRight()),e(t,i.key)===0){if(i.right.isEmpty())return r.EMPTY;n=i.right.min(),i=i.copy(n.key,n.value,null,null,i.right.removeMin())}i=i.copy(null,null,null,null,i.right.remove(t,e))}return i.fixUp()}isRed(){return this.color}fixUp(){let t=this;return t.right.isRed()&&!t.left.isRed()&&(t=t.rotateLeft()),t.left.isRed()&&t.left.left.isRed()&&(t=t.rotateRight()),t.left.isRed()&&t.right.isRed()&&(t=t.colorFlip()),t}moveRedLeft(){let t=this.colorFlip();return t.right.left.isRed()&&(t=t.copy(null,null,null,null,t.right.rotateRight()),t=t.rotateLeft(),t=t.colorFlip()),t}moveRedRight(){let t=this.colorFlip();return t.left.left.isRed()&&(t=t.rotateRight(),t=t.colorFlip()),t}rotateLeft(){let t=this.copy(null,null,r.RED,null,this.right.left);return this.right.copy(null,null,this.color,t,null)}rotateRight(){let t=this.copy(null,null,r.RED,this.left.right,null);return this.left.copy(null,null,this.color,null,t)}colorFlip(){let t=this.left.copy(null,null,!this.left.color,null,null),e=this.right.copy(null,null,!this.right.color,null,null);return this.copy(null,null,!this.color,t,e)}checkMaxDepth(){let t=this.check();return Math.pow(2,t)<=this.size+1}check(){if(this.isRed()&&this.left.isRed()||this.right.isRed())throw L();let t=this.left.check();if(t!==this.right.check())throw L();return t+(this.isRed()?0:1)}};ee.EMPTY=null,ee.RED=!0,ee.BLACK=!1;ee.EMPTY=new class{constructor(){this.size=0}get key(){throw L()}get value(){throw L()}get color(){throw L()}get left(){throw L()}get right(){throw L()}copy(t,e,n,i,s){return this}insert(t,e,n){return new ee(t,e)}remove(t,e){return this}isEmpty(){return!0}inorderTraversal(t){return!1}reverseTraversal(t){return!1}minKey(){return null}maxKey(){return null}isRed(){return!1}checkMaxDepth(){return!0}check(){return 0}};var nt=class r{constructor(t){this.comparator=t,this.data=new st(this.comparator)}has(t){return this.data.get(t)!==null}first(){return this.data.minKey()}last(){return this.data.maxKey()}get size(){return this.data.size}indexOf(t){return this.data.indexOf(t)}forEach(t){this.data.inorderTraversal((e,n)=>(t(e),!1))}forEachInRange(t,e){let n=this.data.getIteratorFrom(t[0]);for(;n.hasNext();){let i=n.getNext();if(this.comparator(i.key,t[1])>=0)return;e(i.key)}}forEachWhile(t,e){let n;for(n=e!==void 0?this.data.getIteratorFrom(e):this.data.getIterator();n.hasNext();)if(!t(n.getNext().key))return}firstAfterOrEqual(t){let e=this.data.getIteratorFrom(t);return e.hasNext()?e.getNext().key:null}getIterator(){return new as(this.data.getIterator())}getIteratorFrom(t){return new as(this.data.getIteratorFrom(t))}add(t){return this.copy(this.data.remove(t).insert(t,!0))}delete(t){return this.has(t)?this.copy(this.data.remove(t)):this}isEmpty(){return this.data.isEmpty()}unionWith(t){let e=this;return e.size<t.size&&(e=t,t=this),t.forEach(n=>{e=e.add(n)}),e}isEqual(t){if(!(t instanceof r)||this.size!==t.size)return!1;let e=this.data.getIterator(),n=t.data.getIterator();for(;e.hasNext();){let i=e.getNext().key,s=n.getNext().key;if(this.comparator(i,s)!==0)return!1}return!0}toArray(){let t=[];return this.forEach(e=>{t.push(e)}),t}toString(){let t=[];return this.forEach(e=>t.push(e)),"SortedSet("+t.toString()+")"}copy(t){let e=new r(this.comparator);return e.data=t,e}},as=class{constructor(t){this.iter=t}getNext(){return this.iter.getNext().key}hasNext(){return this.iter.hasNext()}};function Pn(r){return r.hasNext()?r.getNext():void 0}var Ut=class r{constructor(t){this.fields=t,t.sort(ft.comparator)}static empty(){return new r([])}unionWith(t){let e=new nt(ft.comparator);for(let n of this.fields)e=e.add(n);for(let n of t)e=e.add(n);return new r(e.toArray())}covers(t){for(let e of this.fields)if(e.isPrefixOf(t))return!0;return!1}isEqual(t){return Bn(this.fields,t.fields,(e,n)=>e.isEqual(n))}};var us=class extends Error{constructor(){super(...arguments),this.name="Base64DecodeError"}};function Xd(){return typeof atob<"u"}var gt=class r{constructor(t){this.binaryString=t}static fromBase64String(t){let e=function(i){try{return atob(i)}catch(s){throw typeof DOMException<"u"&&s instanceof DOMException?new us("Invalid base64 string: "+s):s}}(t);return new r(e)}static fromUint8Array(t){let e=function(i){let s="";for(let a=0;a<i.length;++a)s+=String.fromCharCode(i[a]);return s}(t);return new r(e)}[Symbol.iterator](){let t=0;return{next:()=>t<this.binaryString.length?{value:this.binaryString.charCodeAt(t++),done:!1}:{value:void 0,done:!0}}}toBase64(){return function(e){return btoa(e)}(this.binaryString)}toUint8Array(){return function(e){let n=new Uint8Array(e.length);for(let i=0;i<e.length;i++)n[i]=e.charCodeAt(i);return n}(this.binaryString)}approximateByteSize(){return 2*this.binaryString.length}compareTo(t){return z(this.binaryString,t.binaryString)}isEqual(t){return this.binaryString===t.binaryString}};gt.EMPTY_BYTE_STRING=new gt("");var gp=new RegExp(/^\d{4}-\d\d-\d\dT\d\d:\d\d:\d\d(?:\.(\d+))?Z$/);function ge(r){if(q(!!r),typeof r=="string"){let t=0,e=gp.exec(r);if(q(!!e),e[1]){let i=e[1];i=(i+"000000000").substr(0,9),t=Number(i)}let n=new Date(r);return{seconds:Math.floor(n.getTime()/1e3),nanos:t}}return{seconds:ot(r.seconds),nanos:ot(r.nanos)}}function ot(r){return typeof r=="number"?r:typeof r=="string"?Number(r):0}function Fe(r){return typeof r=="string"?gt.fromBase64String(r):gt.fromUint8Array(r)}function Zs(r){var t,e;return((e=(((t=r?.mapValue)===null||t===void 0?void 0:t.fields)||{}).__type__)===null||e===void 0?void 0:e.stringValue)==="server_timestamp"}function cc(r){let t=r.mapValue.fields.__previous_value__;return Zs(t)?cc(t):t}function Yr(r){let t=ge(r.mapValue.fields.__local_write_time__.timestampValue);return new at(t.seconds,t.nanos)}var ya=class{constructor(t,e,n,i,s,a,u,l,d){this.databaseId=t,this.appId=e,this.persistenceKey=n,this.host=i,this.ssl=s,this.forceLongPolling=a,this.autoDetectLongPolling=u,this.longPollingOptions=l,this.useFetchStreams=d}},Oe=class r{constructor(t,e){this.projectId=t,this.database=e||"(default)"}static empty(){return new r("","")}get isDefaultDatabase(){return this.database==="(default)"}isEqual(t){return t instanceof r&&t.projectId===this.projectId&&t.database===this.database}};var Ce={mapValue:{fields:{__type__:{stringValue:"__max__"}}}},Xi={nullValue:"NULL_VALUE"};function sn(r){return"nullValue"in r?0:"booleanValue"in r?1:"integerValue"in r||"doubleValue"in r?2:"timestampValue"in r?3:"stringValue"in r?5:"bytesValue"in r?6:"referenceValue"in r?7:"geoPointValue"in r?8:"arrayValue"in r?9:"mapValue"in r?Zs(r)?4:Zd(r)?9007199254740991:to(r)?10:11:L()}function ie(r,t){if(r===t)return!0;let e=sn(r);if(e!==sn(t))return!1;switch(e){case 0:case 9007199254740991:return!0;case 1:return r.booleanValue===t.booleanValue;case 4:return Yr(r).isEqual(Yr(t));case 3:return function(i,s){if(typeof i.timestampValue=="string"&&typeof s.timestampValue=="string"&&i.timestampValue.length===s.timestampValue.length)return i.timestampValue===s.timestampValue;let a=ge(i.timestampValue),u=ge(s.timestampValue);return a.seconds===u.seconds&&a.nanos===u.nanos}(r,t);case 5:return r.stringValue===t.stringValue;case 6:return function(i,s){return Fe(i.bytesValue).isEqual(Fe(s.bytesValue))}(r,t);case 7:return r.referenceValue===t.referenceValue;case 8:return function(i,s){return ot(i.geoPointValue.latitude)===ot(s.geoPointValue.latitude)&&ot(i.geoPointValue.longitude)===ot(s.geoPointValue.longitude)}(r,t);case 2:return function(i,s){if("integerValue"in i&&"integerValue"in s)return ot(i.integerValue)===ot(s.integerValue);if("doubleValue"in i&&"doubleValue"in s){let a=ot(i.doubleValue),u=ot(s.doubleValue);return a===u?Hr(a)===Hr(u):isNaN(a)&&isNaN(u)}return!1}(r,t);case 9:return Bn(r.arrayValue.values||[],t.arrayValue.values||[],ie);case 10:case 11:return function(i,s){let a=i.mapValue.fields||{},u=s.mapValue.fields||{};if(Uh(a)!==Uh(u))return!1;for(let l in a)if(a.hasOwnProperty(l)&&(u[l]===void 0||!ie(a[l],u[l])))return!1;return!0}(r,t);default:return L()}}function Xr(r,t){return(r.values||[]).find(e=>ie(e,t))!==void 0}function Me(r,t){if(r===t)return 0;let e=sn(r),n=sn(t);if(e!==n)return z(e,n);switch(e){case 0:case 9007199254740991:return 0;case 1:return z(r.booleanValue,t.booleanValue);case 2:return function(s,a){let u=ot(s.integerValue||s.doubleValue),l=ot(a.integerValue||a.doubleValue);return u<l?-1:u>l?1:u===l?0:isNaN(u)?isNaN(l)?0:-1:1}(r,t);case 3:return Bh(r.timestampValue,t.timestampValue);case 4:return Bh(Yr(r),Yr(t));case 5:return z(r.stringValue,t.stringValue);case 6:return function(s,a){let u=Fe(s),l=Fe(a);return u.compareTo(l)}(r.bytesValue,t.bytesValue);case 7:return function(s,a){let u=s.split("/"),l=a.split("/");for(let d=0;d<u.length&&d<l.length;d++){let f=z(u[d],l[d]);if(f!==0)return f}return z(u.length,l.length)}(r.referenceValue,t.referenceValue);case 8:return function(s,a){let u=z(ot(s.latitude),ot(a.latitude));return u!==0?u:z(ot(s.longitude),ot(a.longitude))}(r.geoPointValue,t.geoPointValue);case 9:return jh(r.arrayValue,t.arrayValue);case 10:return function(s,a){var u,l,d,f;let g=s.fields||{},_=a.fields||{},S=(u=g.value)===null||u===void 0?void 0:u.arrayValue,N=(l=_.value)===null||l===void 0?void 0:l.arrayValue,k=z(((d=S?.values)===null||d===void 0?void 0:d.length)||0,((f=N?.values)===null||f===void 0?void 0:f.length)||0);return k!==0?k:jh(S,N)}(r.mapValue,t.mapValue);case 11:return function(s,a){if(s===Ce.mapValue&&a===Ce.mapValue)return 0;if(s===Ce.mapValue)return 1;if(a===Ce.mapValue)return-1;let u=s.fields||{},l=Object.keys(u),d=a.fields||{},f=Object.keys(d);l.sort(),f.sort();for(let g=0;g<l.length&&g<f.length;++g){let _=z(l[g],f[g]);if(_!==0)return _;let S=Me(u[l[g]],d[f[g]]);if(S!==0)return S}return z(l.length,f.length)}(r.mapValue,t.mapValue);default:throw L()}}function Bh(r,t){if(typeof r=="string"&&typeof t=="string"&&r.length===t.length)return z(r,t);let e=ge(r),n=ge(t),i=z(e.seconds,n.seconds);return i!==0?i:z(e.nanos,n.nanos)}function jh(r,t){let e=r.values||[],n=t.values||[];for(let i=0;i<e.length&&i<n.length;++i){let s=Me(e[i],n[i]);if(s)return s}return z(e.length,n.length)}function Gn(r){return wa(r)}function wa(r){return"nullValue"in r?"null":"booleanValue"in r?""+r.booleanValue:"integerValue"in r?""+r.integerValue:"doubleValue"in r?""+r.doubleValue:"timestampValue"in r?function(e){let n=ge(e);return`time(${n.seconds},${n.nanos})`}(r.timestampValue):"stringValue"in r?r.stringValue:"bytesValue"in r?function(e){return Fe(e).toBase64()}(r.bytesValue):"referenceValue"in r?function(e){return M.fromName(e).toString()}(r.referenceValue):"geoPointValue"in r?function(e){return`geo(${e.latitude},${e.longitude})`}(r.geoPointValue):"arrayValue"in r?function(e){let n="[",i=!0;for(let s of e.values||[])i?i=!1:n+=",",n+=wa(s);return n+"]"}(r.arrayValue):"mapValue"in r?function(e){let n=Object.keys(e.fields||{}).sort(),i="{",s=!0;for(let a of n)s?s=!1:i+=",",i+=`${a}:${wa(e.fields[a])}`;return i+"}"}(r.mapValue):L()}function on(r,t){return{referenceValue:`projects/${r.projectId}/databases/${r.database}/documents/${t.path.canonicalString()}`}}function va(r){return!!r&&"integerValue"in r}function Zr(r){return!!r&&"arrayValue"in r}function Gh(r){return!!r&&"nullValue"in r}function zh(r){return!!r&&"doubleValue"in r&&isNaN(Number(r.doubleValue))}function Zi(r){return!!r&&"mapValue"in r}function to(r){var t,e;return((e=(((t=r?.mapValue)===null||t===void 0?void 0:t.fields)||{}).__type__)===null||e===void 0?void 0:e.stringValue)==="__vector__"}function Gr(r){if(r.geoPointValue)return{geoPointValue:Object.assign({},r.geoPointValue)};if(r.timestampValue&&typeof r.timestampValue=="object")return{timestampValue:Object.assign({},r.timestampValue)};if(r.mapValue){let t={mapValue:{fields:{}}};return pn(r.mapValue.fields,(e,n)=>t.mapValue.fields[e]=Gr(n)),t}if(r.arrayValue){let t={arrayValue:{values:[]}};for(let e=0;e<(r.arrayValue.values||[]).length;++e)t.arrayValue.values[e]=Gr(r.arrayValue.values[e]);return t}return Object.assign({},r)}function Zd(r){return(((r.mapValue||{}).fields||{}).__type__||{}).stringValue==="__max__"}var tf={mapValue:{fields:{__type__:{stringValue:"__vector__"},value:{arrayValue:{}}}}};function pp(r){return"nullValue"in r?Xi:"booleanValue"in r?{booleanValue:!1}:"integerValue"in r||"doubleValue"in r?{doubleValue:NaN}:"timestampValue"in r?{timestampValue:{seconds:Number.MIN_SAFE_INTEGER}}:"stringValue"in r?{stringValue:""}:"bytesValue"in r?{bytesValue:""}:"referenceValue"in r?on(Oe.empty(),M.empty()):"geoPointValue"in r?{geoPointValue:{latitude:-90,longitude:-180}}:"arrayValue"in r?{arrayValue:{}}:"mapValue"in r?to(r)?tf:{mapValue:{}}:L()}function _p(r){return"nullValue"in r?{booleanValue:!1}:"booleanValue"in r?{doubleValue:NaN}:"integerValue"in r||"doubleValue"in r?{timestampValue:{seconds:Number.MIN_SAFE_INTEGER}}:"timestampValue"in r?{stringValue:""}:"stringValue"in r?{bytesValue:""}:"bytesValue"in r?on(Oe.empty(),M.empty()):"referenceValue"in r?{geoPointValue:{latitude:-90,longitude:-180}}:"geoPointValue"in r?{arrayValue:{}}:"arrayValue"in r?tf:"mapValue"in r?to(r)?{mapValue:{}}:Ce:L()}function Kh(r,t){let e=Me(r.value,t.value);return e!==0?e:r.inclusive&&!t.inclusive?-1:!r.inclusive&&t.inclusive?1:0}function $h(r,t){let e=Me(r.value,t.value);return e!==0?e:r.inclusive&&!t.inclusive?1:!r.inclusive&&t.inclusive?-1:0}var Ct=class r{constructor(t){this.value=t}static empty(){return new r({mapValue:{}})}field(t){if(t.isEmpty())return this.value;{let e=this.value;for(let n=0;n<t.length-1;++n)if(e=(e.mapValue.fields||{})[t.get(n)],!Zi(e))return null;return e=(e.mapValue.fields||{})[t.lastSegment()],e||null}}set(t,e){this.getFieldsMap(t.popLast())[t.lastSegment()]=Gr(e)}setAll(t){let e=ft.emptyPath(),n={},i=[];t.forEach((a,u)=>{if(!e.isImmediateParentOf(u)){let l=this.getFieldsMap(e);this.applyChanges(l,n,i),n={},i=[],e=u.popLast()}a?n[u.lastSegment()]=Gr(a):i.push(u.lastSegment())});let s=this.getFieldsMap(e);this.applyChanges(s,n,i)}delete(t){let e=this.field(t.popLast());Zi(e)&&e.mapValue.fields&&delete e.mapValue.fields[t.lastSegment()]}isEqual(t){return ie(this.value,t.value)}getFieldsMap(t){let e=this.value;e.mapValue.fields||(e.mapValue={fields:{}});for(let n=0;n<t.length;++n){let i=e.mapValue.fields[t.get(n)];Zi(i)&&i.mapValue.fields||(i={mapValue:{fields:{}}},e.mapValue.fields[t.get(n)]=i),e=i}return e.mapValue.fields}applyChanges(t,e,n){pn(e,(i,s)=>t[i]=s);for(let i of n)delete t[i]}clone(){return new r(Gr(this.value))}};function ef(r){let t=[];return pn(r.fields,(e,n)=>{let i=new ft([e]);if(Zi(n)){let s=ef(n.mapValue).fields;if(s.length===0)t.push(i);else for(let a of s)t.push(i.child(a))}else t.push(i)}),new Ut(t)}var wt=class r{constructor(t,e,n,i,s,a,u){this.key=t,this.documentType=e,this.version=n,this.readTime=i,this.createTime=s,this.data=a,this.documentState=u}static newInvalidDocument(t){return new r(t,0,B.min(),B.min(),B.min(),Ct.empty(),0)}static newFoundDocument(t,e,n,i){return new r(t,1,e,B.min(),n,i,0)}static newNoDocument(t,e){return new r(t,2,e,B.min(),B.min(),Ct.empty(),0)}static newUnknownDocument(t,e){return new r(t,3,e,B.min(),B.min(),Ct.empty(),2)}convertToFoundDocument(t,e){return!this.createTime.isEqual(B.min())||this.documentType!==2&&this.documentType!==0||(this.createTime=t),this.version=t,this.documentType=1,this.data=e,this.documentState=0,this}convertToNoDocument(t){return this.version=t,this.documentType=2,this.data=Ct.empty(),this.documentState=0,this}convertToUnknownDocument(t){return this.version=t,this.documentType=3,this.data=Ct.empty(),this.documentState=2,this}setHasCommittedMutations(){return this.documentState=2,this}setHasLocalMutations(){return this.documentState=1,this.version=B.min(),this}setReadTime(t){return this.readTime=t,this}get hasLocalMutations(){return this.documentState===1}get hasCommittedMutations(){return this.documentState===2}get hasPendingWrites(){return this.hasLocalMutations||this.hasCommittedMutations}isValidDocument(){return this.documentType!==0}isFoundDocument(){return this.documentType===1}isNoDocument(){return this.documentType===2}isUnknownDocument(){return this.documentType===3}isEqual(t){return t instanceof r&&this.key.isEqual(t.key)&&this.version.isEqual(t.version)&&this.documentType===t.documentType&&this.documentState===t.documentState&&this.data.isEqual(t.data)}mutableCopy(){return new r(this.key,this.documentType,this.version,this.readTime,this.createTime,this.data.clone(),this.documentState)}toString(){return`Document(${this.key}, ${this.version}, ${JSON.stringify(this.data.value)}, {createTime: ${this.createTime}}), {documentType: ${this.documentType}}), {documentState: ${this.documentState}})`}};var se=class{constructor(t,e){this.position=t,this.inclusive=e}};function Qh(r,t,e){let n=0;for(let i=0;i<r.position.length;i++){let s=t[i],a=r.position[i];if(s.field.isKeyField()?n=M.comparator(M.fromName(a.referenceValue),e.key):n=Me(a,e.data.field(s.field)),s.dir==="desc"&&(n*=-1),n!==0)break}return n}function Wh(r,t){if(r===null)return t===null;if(t===null||r.inclusive!==t.inclusive||r.position.length!==t.position.length)return!1;for(let e=0;e<r.position.length;e++)if(!ie(r.position[e],t.position[e]))return!1;return!0}var an=class{constructor(t,e="asc"){this.field=t,this.dir=e}};function yp(r,t){return r.dir===t.dir&&r.field.isEqual(t.field)}var cs=class{},W=class r extends cs{constructor(t,e,n){super(),this.field=t,this.op=e,this.value=n}static create(t,e,n){return t.isKeyField()?e==="in"||e==="not-in"?this.createKeyFieldInFilter(t,e,n):new Ea(t,e,n):e==="array-contains"?new ba(t,n):e==="in"?new ls(t,n):e==="not-in"?new Ra(t,n):e==="array-contains-any"?new Pa(t,n):new r(t,e,n)}static createKeyFieldInFilter(t,e,n){return e==="in"?new Aa(t,n):new Sa(t,n)}matches(t){let e=t.data.field(this.field);return this.op==="!="?e!==null&&this.matchesComparison(Me(e,this.value)):e!==null&&sn(this.value)===sn(e)&&this.matchesComparison(Me(e,this.value))}matchesComparison(t){switch(this.op){case"<":return t<0;case"<=":return t<=0;case"==":return t===0;case"!=":return t!==0;case">":return t>0;case">=":return t>=0;default:return L()}}isInequality(){return["<","<=",">",">=","!=","not-in"].indexOf(this.op)>=0}getFlattenedFilters(){return[this]}getFilters(){return[this]}},tt=class r extends cs{constructor(t,e){super(),this.filters=t,this.op=e,this.ae=null}static create(t,e){return new r(t,e)}matches(t){return zn(this)?this.filters.find(e=>!e.matches(t))===void 0:this.filters.find(e=>e.matches(t))!==void 0}getFlattenedFilters(){return this.ae!==null||(this.ae=this.filters.reduce((t,e)=>t.concat(e.getFlattenedFilters()),[])),this.ae}getFilters(){return Object.assign([],this.filters)}};function zn(r){return r.op==="and"}function Ia(r){return r.op==="or"}function lc(r){return nf(r)&&zn(r)}function nf(r){for(let t of r.filters)if(t instanceof tt)return!1;return!0}function Ta(r){if(r instanceof W)return r.field.canonicalString()+r.op.toString()+Gn(r.value);if(lc(r))return r.filters.map(t=>Ta(t)).join(",");{let t=r.filters.map(e=>Ta(e)).join(",");return`${r.op}(${t})`}}function rf(r,t){return r instanceof W?function(n,i){return i instanceof W&&n.op===i.op&&n.field.isEqual(i.field)&&ie(n.value,i.value)}(r,t):r instanceof tt?function(n,i){return i instanceof tt&&n.op===i.op&&n.filters.length===i.filters.length?n.filters.reduce((s,a,u)=>s&&rf(a,i.filters[u]),!0):!1}(r,t):void L()}function sf(r,t){let e=r.filters.concat(t);return tt.create(e,r.op)}function of(r){return r instanceof W?function(e){return`${e.field.canonicalString()} ${e.op} ${Gn(e.value)}`}(r):r instanceof tt?function(e){return e.op.toString()+" {"+e.getFilters().map(of).join(" ,")+"}"}(r):"Filter"}var Ea=class extends W{constructor(t,e,n){super(t,e,n),this.key=M.fromName(n.referenceValue)}matches(t){let e=M.comparator(t.key,this.key);return this.matchesComparison(e)}},Aa=class extends W{constructor(t,e){super(t,"in",e),this.keys=af("in",e)}matches(t){return this.keys.some(e=>e.isEqual(t.key))}},Sa=class extends W{constructor(t,e){super(t,"not-in",e),this.keys=af("not-in",e)}matches(t){return!this.keys.some(e=>e.isEqual(t.key))}};function af(r,t){var e;return(((e=t.arrayValue)===null||e===void 0?void 0:e.values)||[]).map(n=>M.fromName(n.referenceValue))}var ba=class extends W{constructor(t,e){super(t,"array-contains",e)}matches(t){let e=t.data.field(this.field);return Zr(e)&&Xr(e.arrayValue,this.value)}},ls=class extends W{constructor(t,e){super(t,"in",e)}matches(t){let e=t.data.field(this.field);return e!==null&&Xr(this.value.arrayValue,e)}},Ra=class extends W{constructor(t,e){super(t,"not-in",e)}matches(t){if(Xr(this.value.arrayValue,{nullValue:"NULL_VALUE"}))return!1;let e=t.data.field(this.field);return e!==null&&!Xr(this.value.arrayValue,e)}},Pa=class extends W{constructor(t,e){super(t,"array-contains-any",e)}matches(t){let e=t.data.field(this.field);return!(!Zr(e)||!e.arrayValue.values)&&e.arrayValue.values.some(n=>Xr(this.value.arrayValue,n))}};var Va=class{constructor(t,e=null,n=[],i=[],s=null,a=null,u=null){this.path=t,this.collectionGroup=e,this.orderBy=n,this.filters=i,this.limit=s,this.startAt=a,this.endAt=u,this.ue=null}};function xa(r,t=null,e=[],n=[],i=null,s=null,a=null){return new Va(r,t,e,n,i,s,a)}function un(r){let t=O(r);if(t.ue===null){let e=t.path.canonicalString();t.collectionGroup!==null&&(e+="|cg:"+t.collectionGroup),e+="|f:",e+=t.filters.map(n=>Ta(n)).join(","),e+="|ob:",e+=t.orderBy.map(n=>function(s){return s.field.canonicalString()+s.dir}(n)).join(","),gi(t.limit)||(e+="|l:",e+=t.limit),t.startAt&&(e+="|lb:",e+=t.startAt.inclusive?"b:":"a:",e+=t.startAt.position.map(n=>Gn(n)).join(",")),t.endAt&&(e+="|ub:",e+=t.endAt.inclusive?"a:":"b:",e+=t.endAt.position.map(n=>Gn(n)).join(",")),t.ue=e}return t.ue}function pi(r,t){if(r.limit!==t.limit||r.orderBy.length!==t.orderBy.length)return!1;for(let e=0;e<r.orderBy.length;e++)if(!yp(r.orderBy[e],t.orderBy[e]))return!1;if(r.filters.length!==t.filters.length)return!1;for(let e=0;e<r.filters.length;e++)if(!rf(r.filters[e],t.filters[e]))return!1;return r.collectionGroup===t.collectionGroup&&!!r.path.isEqual(t.path)&&!!Wh(r.startAt,t.startAt)&&Wh(r.endAt,t.endAt)}function hs(r){return M.isDocumentKey(r.path)&&r.collectionGroup===null&&r.filters.length===0}function ds(r,t){return r.filters.filter(e=>e instanceof W&&e.field.isEqual(t))}function Hh(r,t,e){let n=Xi,i=!0;for(let s of ds(r,t)){let a=Xi,u=!0;switch(s.op){case"<":case"<=":a=pp(s.value);break;case"==":case"in":case">=":a=s.value;break;case">":a=s.value,u=!1;break;case"!=":case"not-in":a=Xi}Kh({value:n,inclusive:i},{value:a,inclusive:u})<0&&(n=a,i=u)}if(e!==null){for(let s=0;s<r.orderBy.length;++s)if(r.orderBy[s].field.isEqual(t)){let a=e.position[s];Kh({value:n,inclusive:i},{value:a,inclusive:e.inclusive})<0&&(n=a,i=e.inclusive);break}}return{value:n,inclusive:i}}function Jh(r,t,e){let n=Ce,i=!0;for(let s of ds(r,t)){let a=Ce,u=!0;switch(s.op){case">=":case">":a=_p(s.value),u=!1;break;case"==":case"in":case"<=":a=s.value;break;case"<":a=s.value,u=!1;break;case"!=":case"not-in":a=Ce}$h({value:n,inclusive:i},{value:a,inclusive:u})>0&&(n=a,i=u)}if(e!==null){for(let s=0;s<r.orderBy.length;++s)if(r.orderBy[s].field.isEqual(t)){let a=e.position[s];$h({value:n,inclusive:i},{value:a,inclusive:e.inclusive})>0&&(n=a,i=e.inclusive);break}}return{value:n,inclusive:i}}var Wt=class{constructor(t,e=null,n=[],i=[],s=null,a="F",u=null,l=null){this.path=t,this.collectionGroup=e,this.explicitOrderBy=n,this.filters=i,this.limit=s,this.limitType=a,this.startAt=u,this.endAt=l,this.ce=null,this.le=null,this.he=null,this.startAt,this.endAt}};function uf(r,t,e,n,i,s,a,u){return new Wt(r,t,e,n,i,s,a,u)}function sr(r){return new Wt(r)}function Yh(r){return r.filters.length===0&&r.limit===null&&r.startAt==null&&r.endAt==null&&(r.explicitOrderBy.length===0||r.explicitOrderBy.length===1&&r.explicitOrderBy[0].field.isKeyField())}function hc(r){return r.collectionGroup!==null}function qn(r){let t=O(r);if(t.ce===null){t.ce=[];let e=new Set;for(let s of t.explicitOrderBy)t.ce.push(s),e.add(s.field.canonicalString());let n=t.explicitOrderBy.length>0?t.explicitOrderBy[t.explicitOrderBy.length-1].dir:"asc";(function(a){let u=new nt(ft.comparator);return a.filters.forEach(l=>{l.getFlattenedFilters().forEach(d=>{d.isInequality()&&(u=u.add(d.field))})}),u})(t).forEach(s=>{e.has(s.canonicalString())||s.isKeyField()||t.ce.push(new an(s,n))}),e.has(ft.keyField().canonicalString())||t.ce.push(new an(ft.keyField(),n))}return t.ce}function Ft(r){let t=O(r);return t.le||(t.le=wp(t,qn(r))),t.le}function wp(r,t){if(r.limitType==="F")return xa(r.path,r.collectionGroup,t,r.filters,r.limit,r.startAt,r.endAt);{t=t.map(i=>{let s=i.dir==="desc"?"asc":"desc";return new an(i.field,s)});let e=r.endAt?new se(r.endAt.position,r.endAt.inclusive):null,n=r.startAt?new se(r.startAt.position,r.startAt.inclusive):null;return xa(r.path,r.collectionGroup,t,r.filters,r.limit,e,n)}}function Ca(r,t){let e=r.filters.concat([t]);return new Wt(r.path,r.collectionGroup,r.explicitOrderBy.slice(),e,r.limit,r.limitType,r.startAt,r.endAt)}function fs(r,t,e){return new Wt(r.path,r.collectionGroup,r.explicitOrderBy.slice(),r.filters.slice(),t,e,r.startAt,r.endAt)}function _i(r,t){return pi(Ft(r),Ft(t))&&r.limitType===t.limitType}function cf(r){return`${un(Ft(r))}|lt:${r.limitType}`}function Nn(r){return`Query(target=${function(e){let n=e.path.canonicalString();return e.collectionGroup!==null&&(n+=" collectionGroup="+e.collectionGroup),e.filters.length>0&&(n+=`, filters: [${e.filters.map(i=>of(i)).join(", ")}]`),gi(e.limit)||(n+=", limit: "+e.limit),e.orderBy.length>0&&(n+=`, orderBy: [${e.orderBy.map(i=>function(a){return`${a.field.canonicalString()} (${a.dir})`}(i)).join(", ")}]`),e.startAt&&(n+=", startAt: ",n+=e.startAt.inclusive?"b:":"a:",n+=e.startAt.position.map(i=>Gn(i)).join(",")),e.endAt&&(n+=", endAt: ",n+=e.endAt.inclusive?"a:":"b:",n+=e.endAt.position.map(i=>Gn(i)).join(",")),`Target(${n})`}(Ft(r))}; limitType=${r.limitType})`}function yi(r,t){return t.isFoundDocument()&&function(n,i){let s=i.key.path;return n.collectionGroup!==null?i.key.hasCollectionId(n.collectionGroup)&&n.path.isPrefixOf(s):M.isDocumentKey(n.path)?n.path.isEqual(s):n.path.isImmediateParentOf(s)}(r,t)&&function(n,i){for(let s of qn(n))if(!s.field.isKeyField()&&i.data.field(s.field)===null)return!1;return!0}(r,t)&&function(n,i){for(let s of n.filters)if(!s.matches(i))return!1;return!0}(r,t)&&function(n,i){return!(n.startAt&&!function(a,u,l){let d=Qh(a,u,l);return a.inclusive?d<=0:d<0}(n.startAt,qn(n),i)||n.endAt&&!function(a,u,l){let d=Qh(a,u,l);return a.inclusive?d>=0:d>0}(n.endAt,qn(n),i))}(r,t)}function lf(r){return r.collectionGroup||(r.path.length%2==1?r.path.lastSegment():r.path.get(r.path.length-2))}function hf(r){return(t,e)=>{let n=!1;for(let i of qn(r)){let s=vp(i,t,e);if(s!==0)return s;n=n||i.field.isKeyField()}return 0}}function vp(r,t,e){let n=r.field.isKeyField()?M.comparator(t.key,e.key):function(s,a,u){let l=a.data.field(s),d=u.data.field(s);return l!==null&&d!==null?Me(l,d):L()}(r.field,t,e);switch(r.dir){case"asc":return n;case"desc":return-1*n;default:return L()}}var oe=class{constructor(t,e){this.mapKeyFn=t,this.equalsFn=e,this.inner={},this.innerSize=0}get(t){let e=this.mapKeyFn(t),n=this.inner[e];if(n!==void 0){for(let[i,s]of n)if(this.equalsFn(i,t))return s}}has(t){return this.get(t)!==void 0}set(t,e){let n=this.mapKeyFn(t),i=this.inner[n];if(i===void 0)return this.inner[n]=[[t,e]],void this.innerSize++;for(let s=0;s<i.length;s++)if(this.equalsFn(i[s][0],t))return void(i[s]=[t,e]);i.push([t,e]),this.innerSize++}delete(t){let e=this.mapKeyFn(t),n=this.inner[e];if(n===void 0)return!1;for(let i=0;i<n.length;i++)if(this.equalsFn(n[i][0],t))return n.length===1?delete this.inner[e]:n.splice(i,1),this.innerSize--,!0;return!1}forEach(t){pn(this.inner,(e,n)=>{for(let[i,s]of n)t(i,s)})}isEmpty(){return Yd(this.inner)}size(){return this.innerSize}};var Ip=new st(M.comparator);function Mt(){return Ip}var df=new st(M.comparator);function Br(...r){let t=df;for(let e of r)t=t.insert(e.key,e);return t}function ff(r){let t=df;return r.forEach((e,n)=>t=t.insert(e,n.overlayedDocument)),t}function te(){return zr()}function mf(){return zr()}function zr(){return new oe(r=>r.toString(),(r,t)=>r.isEqual(t))}var Tp=new st(M.comparator),Ep=new nt(M.comparator);function $(...r){let t=Ep;for(let e of r)t=t.add(e);return t}var Ap=new nt(z);function dc(){return Ap}function fc(r,t){if(r.useProto3Json){if(isNaN(t))return{doubleValue:"NaN"};if(t===1/0)return{doubleValue:"Infinity"};if(t===-1/0)return{doubleValue:"-Infinity"}}return{doubleValue:Hr(t)?"-0":t}}function gf(r){return{integerValue:""+r}}function pf(r,t){return $d(t)?gf(t):fc(r,t)}var Kn=class{constructor(){this._=void 0}};function Sp(r,t,e){return r instanceof Le?function(i,s){let a={fields:{__type__:{stringValue:"server_timestamp"},__local_write_time__:{timestampValue:{seconds:i.seconds,nanos:i.nanoseconds}}}};return s&&Zs(s)&&(s=cc(s)),s&&(a.fields.__previous_value__=s),{mapValue:a}}(e,t):r instanceof pe?yf(r,t):r instanceof _e?wf(r,t):function(i,s){let a=_f(i,s),u=Xh(a)+Xh(i.Pe);return va(a)&&va(i.Pe)?gf(u):fc(i.serializer,u)}(r,t)}function bp(r,t,e){return r instanceof pe?yf(r,t):r instanceof _e?wf(r,t):e}function _f(r,t){return r instanceof qe?function(n){return va(n)||function(s){return!!s&&"doubleValue"in s}(n)}(t)?t:{integerValue:0}:null}var Le=class extends Kn{},pe=class extends Kn{constructor(t){super(),this.elements=t}};function yf(r,t){let e=vf(t);for(let n of r.elements)e.some(i=>ie(i,n))||e.push(n);return{arrayValue:{values:e}}}var _e=class extends Kn{constructor(t){super(),this.elements=t}};function wf(r,t){let e=vf(t);for(let n of r.elements)e=e.filter(i=>!ie(i,n));return{arrayValue:{values:e}}}var qe=class extends Kn{constructor(t,e){super(),this.serializer=t,this.Pe=e}};function Xh(r){return ot(r.integerValue||r.doubleValue)}function vf(r){return Zr(r)&&r.arrayValue.values?r.arrayValue.values.slice():[]}var cn=class{constructor(t,e){this.field=t,this.transform=e}};function Rp(r,t){return r.field.isEqual(t.field)&&function(n,i){return n instanceof pe&&i instanceof pe||n instanceof _e&&i instanceof _e?Bn(n.elements,i.elements,ie):n instanceof qe&&i instanceof qe?ie(n.Pe,i.Pe):n instanceof Le&&i instanceof Le}(r.transform,t.transform)}var Da=class{constructor(t,e){this.version=t,this.transformResults=e}},ht=class r{constructor(t,e){this.updateTime=t,this.exists=e}static none(){return new r}static exists(t){return new r(void 0,t)}static updateTime(t){return new r(t)}get isNone(){return this.updateTime===void 0&&this.exists===void 0}isEqual(t){return this.exists===t.exists&&(this.updateTime?!!t.updateTime&&this.updateTime.isEqual(t.updateTime):!t.updateTime)}};function ts(r,t){return r.updateTime!==void 0?t.isFoundDocument()&&t.version.isEqual(r.updateTime):r.exists===void 0||r.exists===t.isFoundDocument()}var $n=class{};function If(r,t){if(!r.hasLocalMutations||t&&t.fields.length===0)return null;if(t===null)return r.isNoDocument()?new Be(r.key,ht.none()):new Ue(r.key,r.data,ht.none());{let e=r.data,n=Ct.empty(),i=new nt(ft.comparator);for(let s of t.fields)if(!i.has(s)){let a=e.field(s);a===null&&s.length>1&&(s=s.popLast(),a=e.field(s)),a===null?n.delete(s):n.set(s,a),i=i.add(s)}return new Ht(r.key,n,new Ut(i.toArray()),ht.none())}}function Pp(r,t,e){r instanceof Ue?function(i,s,a){let u=i.value.clone(),l=td(i.fieldTransforms,s,a.transformResults);u.setAll(l),s.convertToFoundDocument(a.version,u).setHasCommittedMutations()}(r,t,e):r instanceof Ht?function(i,s,a){if(!ts(i.precondition,s))return void s.convertToUnknownDocument(a.version);let u=td(i.fieldTransforms,s,a.transformResults),l=s.data;l.setAll(Tf(i)),l.setAll(u),s.convertToFoundDocument(a.version,l).setHasCommittedMutations()}(r,t,e):function(i,s,a){s.convertToNoDocument(a.version).setHasCommittedMutations()}(0,t,e)}function Kr(r,t,e,n){return r instanceof Ue?function(s,a,u,l){if(!ts(s.precondition,a))return u;let d=s.value.clone(),f=ed(s.fieldTransforms,l,a);return d.setAll(f),a.convertToFoundDocument(a.version,d).setHasLocalMutations(),null}(r,t,e,n):r instanceof Ht?function(s,a,u,l){if(!ts(s.precondition,a))return u;let d=ed(s.fieldTransforms,l,a),f=a.data;return f.setAll(Tf(s)),f.setAll(d),a.convertToFoundDocument(a.version,f).setHasLocalMutations(),u===null?null:u.unionWith(s.fieldMask.fields).unionWith(s.fieldTransforms.map(g=>g.field))}(r,t,e,n):function(s,a,u){return ts(s.precondition,a)?(a.convertToNoDocument(a.version).setHasLocalMutations(),null):u}(r,t,e)}function Vp(r,t){let e=null;for(let n of r.fieldTransforms){let i=t.data.field(n.field),s=_f(n.transform,i||null);s!=null&&(e===null&&(e=Ct.empty()),e.set(n.field,s))}return e||null}function Zh(r,t){return r.type===t.type&&!!r.key.isEqual(t.key)&&!!r.precondition.isEqual(t.precondition)&&!!function(n,i){return n===void 0&&i===void 0||!(!n||!i)&&Bn(n,i,(s,a)=>Rp(s,a))}(r.fieldTransforms,t.fieldTransforms)&&(r.type===0?r.value.isEqual(t.value):r.type!==1||r.data.isEqual(t.data)&&r.fieldMask.isEqual(t.fieldMask))}var Ue=class extends $n{constructor(t,e,n,i=[]){super(),this.key=t,this.value=e,this.precondition=n,this.fieldTransforms=i,this.type=0}getFieldMask(){return null}},Ht=class extends $n{constructor(t,e,n,i,s=[]){super(),this.key=t,this.data=e,this.fieldMask=n,this.precondition=i,this.fieldTransforms=s,this.type=1}getFieldMask(){return this.fieldMask}};function Tf(r){let t=new Map;return r.fieldMask.fields.forEach(e=>{if(!e.isEmpty()){let n=r.data.field(e);t.set(e,n)}}),t}function td(r,t,e){let n=new Map;q(r.length===e.length);for(let i=0;i<e.length;i++){let s=r[i],a=s.transform,u=t.data.field(s.field);n.set(s.field,bp(a,u,e[i]))}return n}function ed(r,t,e){let n=new Map;for(let i of r){let s=i.transform,a=e.data.field(i.field);n.set(i.field,Sp(s,a,t))}return n}var Be=class extends $n{constructor(t,e){super(),this.key=t,this.precondition=e,this.type=2,this.fieldTransforms=[]}getFieldMask(){return null}},ti=class extends $n{constructor(t,e){super(),this.key=t,this.precondition=e,this.type=3,this.fieldTransforms=[]}getFieldMask(){return null}};var ei=class{constructor(t,e,n,i){this.batchId=t,this.localWriteTime=e,this.baseMutations=n,this.mutations=i}applyToRemoteDocument(t,e){let n=e.mutationResults;for(let i=0;i<this.mutations.length;i++){let s=this.mutations[i];s.key.isEqual(t.key)&&Pp(s,t,n[i])}}applyToLocalView(t,e){for(let n of this.baseMutations)n.key.isEqual(t.key)&&(e=Kr(n,t,e,this.localWriteTime));for(let n of this.mutations)n.key.isEqual(t.key)&&(e=Kr(n,t,e,this.localWriteTime));return e}applyToLocalDocumentSet(t,e){let n=mf();return this.mutations.forEach(i=>{let s=t.get(i.key),a=s.overlayedDocument,u=this.applyToLocalView(a,s.mutatedFields);u=e.has(i.key)?null:u;let l=If(a,u);l!==null&&n.set(i.key,l),a.isValidDocument()||a.convertToNoDocument(B.min())}),n}keys(){return this.mutations.reduce((t,e)=>t.add(e.key),$())}isEqual(t){return this.batchId===t.batchId&&Bn(this.mutations,t.mutations,(e,n)=>Zh(e,n))&&Bn(this.baseMutations,t.baseMutations,(e,n)=>Zh(e,n))}},Na=class r{constructor(t,e,n,i){this.batch=t,this.commitVersion=e,this.mutationResults=n,this.docVersions=i}static from(t,e,n){q(t.mutations.length===n.length);let i=function(){return Tp}(),s=t.mutations;for(let a=0;a<s.length;a++)i=i.insert(s[a].key,n[a].version);return new r(t,e,n,i)}};var ni=class{constructor(t,e){this.largestBatchId=t,this.mutation=e}getKey(){return this.mutation.key}isEqual(t){return t!==null&&this.mutation===t.mutation}toString(){return`Overlay{
      largestBatchId: ${this.largestBatchId},
      mutation: ${this.mutation.toString()}
    }`}};var ka=class{constructor(t,e){this.count=t,this.unchangedNames=e}};var pt,J;function Ef(r){switch(r){default:return L();case P.CANCELLED:case P.UNKNOWN:case P.DEADLINE_EXCEEDED:case P.RESOURCE_EXHAUSTED:case P.INTERNAL:case P.UNAVAILABLE:case P.UNAUTHENTICATED:return!1;case P.INVALID_ARGUMENT:case P.NOT_FOUND:case P.ALREADY_EXISTS:case P.PERMISSION_DENIED:case P.FAILED_PRECONDITION:case P.ABORTED:case P.OUT_OF_RANGE:case P.UNIMPLEMENTED:case P.DATA_LOSS:return!0}}function Af(r){if(r===void 0)return dt("GRPC error has no .code"),P.UNKNOWN;switch(r){case pt.OK:return P.OK;case pt.CANCELLED:return P.CANCELLED;case pt.UNKNOWN:return P.UNKNOWN;case pt.DEADLINE_EXCEEDED:return P.DEADLINE_EXCEEDED;case pt.RESOURCE_EXHAUSTED:return P.RESOURCE_EXHAUSTED;case pt.INTERNAL:return P.INTERNAL;case pt.UNAVAILABLE:return P.UNAVAILABLE;case pt.UNAUTHENTICATED:return P.UNAUTHENTICATED;case pt.INVALID_ARGUMENT:return P.INVALID_ARGUMENT;case pt.NOT_FOUND:return P.NOT_FOUND;case pt.ALREADY_EXISTS:return P.ALREADY_EXISTS;case pt.PERMISSION_DENIED:return P.PERMISSION_DENIED;case pt.FAILED_PRECONDITION:return P.FAILED_PRECONDITION;case pt.ABORTED:return P.ABORTED;case pt.OUT_OF_RANGE:return P.OUT_OF_RANGE;case pt.UNIMPLEMENTED:return P.UNIMPLEMENTED;case pt.DATA_LOSS:return P.DATA_LOSS;default:return L()}}(J=pt||(pt={}))[J.OK=0]="OK",J[J.CANCELLED=1]="CANCELLED",J[J.UNKNOWN=2]="UNKNOWN",J[J.INVALID_ARGUMENT=3]="INVALID_ARGUMENT",J[J.DEADLINE_EXCEEDED=4]="DEADLINE_EXCEEDED",J[J.NOT_FOUND=5]="NOT_FOUND",J[J.ALREADY_EXISTS=6]="ALREADY_EXISTS",J[J.PERMISSION_DENIED=7]="PERMISSION_DENIED",J[J.UNAUTHENTICATED=16]="UNAUTHENTICATED",J[J.RESOURCE_EXHAUSTED=8]="RESOURCE_EXHAUSTED",J[J.FAILED_PRECONDITION=9]="FAILED_PRECONDITION",J[J.ABORTED=10]="ABORTED",J[J.OUT_OF_RANGE=11]="OUT_OF_RANGE",J[J.UNIMPLEMENTED=12]="UNIMPLEMENTED",J[J.INTERNAL=13]="INTERNAL",J[J.UNAVAILABLE=14]="UNAVAILABLE",J[J.DATA_LOSS=15]="DATA_LOSS";var nd=null;function Sf(){return new TextEncoder}var xp=new be([4294967295,4294967295],0);function rd(r){let t=Sf().encode(r),e=new Ho;return e.update(t),new Uint8Array(e.digest())}function id(r){let t=new DataView(r.buffer),e=t.getUint32(0,!0),n=t.getUint32(4,!0),i=t.getUint32(8,!0),s=t.getUint32(12,!0);return[new be([e,n],0),new be([i,s],0)]}var Fa=class r{constructor(t,e,n){if(this.bitmap=t,this.padding=e,this.hashCount=n,e<0||e>=8)throw new nn(`Invalid padding: ${e}`);if(n<0)throw new nn(`Invalid hash count: ${n}`);if(t.length>0&&this.hashCount===0)throw new nn(`Invalid hash count: ${n}`);if(t.length===0&&e!==0)throw new nn(`Invalid padding when bitmap length is 0: ${e}`);this.Ie=8*t.length-e,this.Te=be.fromNumber(this.Ie)}Ee(t,e,n){let i=t.add(e.multiply(be.fromNumber(n)));return i.compare(xp)===1&&(i=new be([i.getBits(0),i.getBits(1)],0)),i.modulo(this.Te).toNumber()}de(t){return(this.bitmap[Math.floor(t/8)]&1<<t%8)!=0}mightContain(t){if(this.Ie===0)return!1;let e=rd(t),[n,i]=id(e);for(let s=0;s<this.hashCount;s++){let a=this.Ee(n,i,s);if(!this.de(a))return!1}return!0}static create(t,e,n){let i=t%8==0?0:8-t%8,s=new Uint8Array(Math.ceil(t/8)),a=new r(s,i,e);return n.forEach(u=>a.insert(u)),a}insert(t){if(this.Ie===0)return;let e=rd(t),[n,i]=id(e);for(let s=0;s<this.hashCount;s++){let a=this.Ee(n,i,s);this.Ae(a)}}Ae(t){let e=Math.floor(t/8),n=t%8;this.bitmap[e]|=1<<n}},nn=class extends Error{constructor(){super(...arguments),this.name="BloomFilterError"}};var ri=class r{constructor(t,e,n,i,s){this.snapshotVersion=t,this.targetChanges=e,this.targetMismatches=n,this.documentUpdates=i,this.resolvedLimboDocuments=s}static createSynthesizedRemoteEventForCurrentChange(t,e,n){let i=new Map;return i.set(t,ii.createSynthesizedTargetChangeForCurrentChange(t,e,n)),new r(B.min(),i,new st(z),Mt(),$())}},ii=class r{constructor(t,e,n,i,s){this.resumeToken=t,this.current=e,this.addedDocuments=n,this.modifiedDocuments=i,this.removedDocuments=s}static createSynthesizedTargetChangeForCurrentChange(t,e,n){return new r(n,e,$(),$(),$())}};var Un=class{constructor(t,e,n,i){this.Re=t,this.removedTargetIds=e,this.key=n,this.Ve=i}},ms=class{constructor(t,e){this.targetId=t,this.me=e}},gs=class{constructor(t,e,n=gt.EMPTY_BYTE_STRING,i=null){this.state=t,this.targetIds=e,this.resumeToken=n,this.cause=i}},ps=class{constructor(){this.fe=0,this.ge=od(),this.pe=gt.EMPTY_BYTE_STRING,this.ye=!1,this.we=!0}get current(){return this.ye}get resumeToken(){return this.pe}get Se(){return this.fe!==0}get be(){return this.we}De(t){t.approximateByteSize()>0&&(this.we=!0,this.pe=t)}ve(){let t=$(),e=$(),n=$();return this.ge.forEach((i,s)=>{switch(s){case 0:t=t.add(i);break;case 2:e=e.add(i);break;case 1:n=n.add(i);break;default:L()}}),new ii(this.pe,this.ye,t,e,n)}Ce(){this.we=!1,this.ge=od()}Fe(t,e){this.we=!0,this.ge=this.ge.insert(t,e)}Me(t){this.we=!0,this.ge=this.ge.remove(t)}xe(){this.fe+=1}Oe(){this.fe-=1,q(this.fe>=0)}Ne(){this.we=!0,this.ye=!0}},Oa=class{constructor(t){this.Le=t,this.Be=new Map,this.ke=Mt(),this.qe=sd(),this.Qe=new st(z)}Ke(t){for(let e of t.Re)t.Ve&&t.Ve.isFoundDocument()?this.$e(e,t.Ve):this.Ue(e,t.key,t.Ve);for(let e of t.removedTargetIds)this.Ue(e,t.key,t.Ve)}We(t){this.forEachTarget(t,e=>{let n=this.Ge(e);switch(t.state){case 0:this.ze(e)&&n.De(t.resumeToken);break;case 1:n.Oe(),n.Se||n.Ce(),n.De(t.resumeToken);break;case 2:n.Oe(),n.Se||this.removeTarget(e);break;case 3:this.ze(e)&&(n.Ne(),n.De(t.resumeToken));break;case 4:this.ze(e)&&(this.je(e),n.De(t.resumeToken));break;default:L()}})}forEachTarget(t,e){t.targetIds.length>0?t.targetIds.forEach(e):this.Be.forEach((n,i)=>{this.ze(i)&&e(i)})}He(t){let e=t.targetId,n=t.me.count,i=this.Je(e);if(i){let s=i.target;if(hs(s))if(n===0){let a=new M(s.path);this.Ue(e,a,wt.newNoDocument(a,B.min()))}else q(n===1);else{let a=this.Ye(e);if(a!==n){let u=this.Ze(t),l=u?this.Xe(u,t,a):1;if(l!==0){this.je(e);let d=l===2?"TargetPurposeExistenceFilterMismatchBloom":"TargetPurposeExistenceFilterMismatch";this.Qe=this.Qe.insert(e,d)}nd?.et(function(f,g,_,S,N){var k,D,j,G,U,Q;let H={localCacheCount:f,existenceFilterCount:g.count,databaseId:_.database,projectId:_.projectId},K=g.unchangedNames;return K&&(H.bloomFilter={applied:N===0,hashCount:(k=K?.hashCount)!==null&&k!==void 0?k:0,bitmapLength:(G=(j=(D=K?.bits)===null||D===void 0?void 0:D.bitmap)===null||j===void 0?void 0:j.length)!==null&&G!==void 0?G:0,padding:(Q=(U=K?.bits)===null||U===void 0?void 0:U.padding)!==null&&Q!==void 0?Q:0,mightContain:v=>{var p;return(p=S?.mightContain(v))!==null&&p!==void 0&&p}}),H}(a,t.me,this.Le.tt(),u,l))}}}}Ze(t){let e=t.me.unchangedNames;if(!e||!e.bits)return null;let{bits:{bitmap:n="",padding:i=0},hashCount:s=0}=e,a,u;try{a=Fe(n).toUint8Array()}catch(l){if(l instanceof us)return Qt("Decoding the base64 bloom filter in existence filter failed ("+l.message+"); ignoring the bloom filter and falling back to full re-query."),null;throw l}try{u=new Fa(a,i,s)}catch(l){return Qt(l instanceof nn?"BloomFilter error: ":"Applying bloom filter failed: ",l),null}return u.Ie===0?null:u}Xe(t,e,n){return e.me.count===n-this.nt(t,e.targetId)?0:2}nt(t,e){let n=this.Le.getRemoteKeysForTarget(e),i=0;return n.forEach(s=>{let a=this.Le.tt(),u=`projects/${a.projectId}/databases/${a.database}/documents/${s.path.canonicalString()}`;t.mightContain(u)||(this.Ue(e,s,null),i++)}),i}rt(t){let e=new Map;this.Be.forEach((s,a)=>{let u=this.Je(a);if(u){if(s.current&&hs(u.target)){let l=new M(u.target.path);this.ke.get(l)!==null||this.it(a,l)||this.Ue(a,l,wt.newNoDocument(l,t))}s.be&&(e.set(a,s.ve()),s.Ce())}});let n=$();this.qe.forEach((s,a)=>{let u=!0;a.forEachWhile(l=>{let d=this.Je(l);return!d||d.purpose==="TargetPurposeLimboResolution"||(u=!1,!1)}),u&&(n=n.add(s))}),this.ke.forEach((s,a)=>a.setReadTime(t));let i=new ri(t,e,this.Qe,this.ke,n);return this.ke=Mt(),this.qe=sd(),this.Qe=new st(z),i}$e(t,e){if(!this.ze(t))return;let n=this.it(t,e.key)?2:0;this.Ge(t).Fe(e.key,n),this.ke=this.ke.insert(e.key,e),this.qe=this.qe.insert(e.key,this.st(e.key).add(t))}Ue(t,e,n){if(!this.ze(t))return;let i=this.Ge(t);this.it(t,e)?i.Fe(e,1):i.Me(e),this.qe=this.qe.insert(e,this.st(e).delete(t)),n&&(this.ke=this.ke.insert(e,n))}removeTarget(t){this.Be.delete(t)}Ye(t){let e=this.Ge(t).ve();return this.Le.getRemoteKeysForTarget(t).size+e.addedDocuments.size-e.removedDocuments.size}xe(t){this.Ge(t).xe()}Ge(t){let e=this.Be.get(t);return e||(e=new ps,this.Be.set(t,e)),e}st(t){let e=this.qe.get(t);return e||(e=new nt(z),this.qe=this.qe.insert(t,e)),e}ze(t){let e=this.Je(t)!==null;return e||C("WatchChangeAggregator","Detected inactive target",t),e}Je(t){let e=this.Be.get(t);return e&&e.Se?null:this.Le.ot(t)}je(t){this.Be.set(t,new ps),this.Le.getRemoteKeysForTarget(t).forEach(e=>{this.Ue(t,e,null)})}it(t,e){return this.Le.getRemoteKeysForTarget(t).has(e)}};function sd(){return new st(M.comparator)}function od(){return new st(M.comparator)}var Cp={asc:"ASCENDING",desc:"DESCENDING"},Dp={"<":"LESS_THAN","<=":"LESS_THAN_OR_EQUAL",">":"GREATER_THAN",">=":"GREATER_THAN_OR_EQUAL","==":"EQUAL","!=":"NOT_EQUAL","array-contains":"ARRAY_CONTAINS",in:"IN","not-in":"NOT_IN","array-contains-any":"ARRAY_CONTAINS_ANY"},Np={and:"AND",or:"OR"},Ma=class{constructor(t,e){this.databaseId=t,this.useProto3Json=e}};function La(r,t){return r.useProto3Json||gi(t)?t:{value:t}}function Qn(r,t){return r.useProto3Json?`${new Date(1e3*t.seconds).toISOString().replace(/\.\d*/,"").replace("Z","")}.${("000000000"+t.nanoseconds).slice(-9)}Z`:{seconds:""+t.seconds,nanos:t.nanoseconds}}function bf(r,t){return r.useProto3Json?t.toBase64():t.toUint8Array()}function kp(r,t){return Qn(r,t.toTimestamp())}function mt(r){return q(!!r),B.fromTimestamp(function(e){let n=ge(e);return new at(n.seconds,n.nanos)}(r))}function mc(r,t){return qa(r,t).canonicalString()}function qa(r,t){let e=function(i){return new Y(["projects",i.projectId,"databases",i.database])}(r).child("documents");return t===void 0?e:e.child(t)}function Rf(r){let t=Y.fromString(r);return q(Mf(t)),t}function si(r,t){return mc(r.databaseId,t.path)}function ne(r,t){let e=Rf(t);if(e.get(1)!==r.databaseId.projectId)throw new x(P.INVALID_ARGUMENT,"Tried to deserialize key from different project: "+e.get(1)+" vs "+r.databaseId.projectId);if(e.get(3)!==r.databaseId.database)throw new x(P.INVALID_ARGUMENT,"Tried to deserialize key from different database: "+e.get(3)+" vs "+r.databaseId.database);return new M(xf(e))}function Pf(r,t){return mc(r.databaseId,t)}function Vf(r){let t=Rf(r);return t.length===4?Y.emptyPath():xf(t)}function Ua(r){return new Y(["projects",r.databaseId.projectId,"databases",r.databaseId.database]).canonicalString()}function xf(r){return q(r.length>4&&r.get(4)==="documents"),r.popFirst(5)}function ad(r,t,e){return{name:si(r,t),fields:e.value.mapValue.fields}}function Cf(r,t,e){let n=ne(r,t.name),i=mt(t.updateTime),s=t.createTime?mt(t.createTime):B.min(),a=new Ct({mapValue:{fields:t.fields}}),u=wt.newFoundDocument(n,i,s,a);return e&&u.setHasCommittedMutations(),e?u.setHasCommittedMutations():u}function Fp(r,t){return"found"in t?function(n,i){q(!!i.found),i.found.name,i.found.updateTime;let s=ne(n,i.found.name),a=mt(i.found.updateTime),u=i.found.createTime?mt(i.found.createTime):B.min(),l=new Ct({mapValue:{fields:i.found.fields}});return wt.newFoundDocument(s,a,u,l)}(r,t):"missing"in t?function(n,i){q(!!i.missing),q(!!i.readTime);let s=ne(n,i.missing),a=mt(i.readTime);return wt.newNoDocument(s,a)}(r,t):L()}function Op(r,t){let e;if("targetChange"in t){t.targetChange;let n=function(d){return d==="NO_CHANGE"?0:d==="ADD"?1:d==="REMOVE"?2:d==="CURRENT"?3:d==="RESET"?4:L()}(t.targetChange.targetChangeType||"NO_CHANGE"),i=t.targetChange.targetIds||[],s=function(d,f){return d.useProto3Json?(q(f===void 0||typeof f=="string"),gt.fromBase64String(f||"")):(q(f===void 0||f instanceof Buffer||f instanceof Uint8Array),gt.fromUint8Array(f||new Uint8Array))}(r,t.targetChange.resumeToken),a=t.targetChange.cause,u=a&&function(d){let f=d.code===void 0?P.UNKNOWN:Af(d.code);return new x(f,d.message||"")}(a);e=new gs(n,i,s,u||null)}else if("documentChange"in t){t.documentChange;let n=t.documentChange;n.document,n.document.name,n.document.updateTime;let i=ne(r,n.document.name),s=mt(n.document.updateTime),a=n.document.createTime?mt(n.document.createTime):B.min(),u=new Ct({mapValue:{fields:n.document.fields}}),l=wt.newFoundDocument(i,s,a,u),d=n.targetIds||[],f=n.removedTargetIds||[];e=new Un(d,f,l.key,l)}else if("documentDelete"in t){t.documentDelete;let n=t.documentDelete;n.document;let i=ne(r,n.document),s=n.readTime?mt(n.readTime):B.min(),a=wt.newNoDocument(i,s),u=n.removedTargetIds||[];e=new Un([],u,a.key,a)}else if("documentRemove"in t){t.documentRemove;let n=t.documentRemove;n.document;let i=ne(r,n.document),s=n.removedTargetIds||[];e=new Un([],s,i,null)}else{if(!("filter"in t))return L();{t.filter;let n=t.filter;n.targetId;let{count:i=0,unchangedNames:s}=n,a=new ka(i,s),u=n.targetId;e=new ms(u,a)}}return e}function oi(r,t){let e;if(t instanceof Ue)e={update:ad(r,t.key,t.value)};else if(t instanceof Be)e={delete:si(r,t.key)};else if(t instanceof Ht)e={update:ad(r,t.key,t.data),updateMask:jp(t.fieldMask)};else{if(!(t instanceof ti))return L();e={verify:si(r,t.key)}}return t.fieldTransforms.length>0&&(e.updateTransforms=t.fieldTransforms.map(n=>function(s,a){let u=a.transform;if(u instanceof Le)return{fieldPath:a.field.canonicalString(),setToServerValue:"REQUEST_TIME"};if(u instanceof pe)return{fieldPath:a.field.canonicalString(),appendMissingElements:{values:u.elements}};if(u instanceof _e)return{fieldPath:a.field.canonicalString(),removeAllFromArray:{values:u.elements}};if(u instanceof qe)return{fieldPath:a.field.canonicalString(),increment:u.Pe};throw L()}(0,n))),t.precondition.isNone||(e.currentDocument=function(i,s){return s.updateTime!==void 0?{updateTime:kp(i,s.updateTime)}:s.exists!==void 0?{exists:s.exists}:L()}(r,t.precondition)),e}function Ba(r,t){let e=t.currentDocument?function(s){return s.updateTime!==void 0?ht.updateTime(mt(s.updateTime)):s.exists!==void 0?ht.exists(s.exists):ht.none()}(t.currentDocument):ht.none(),n=t.updateTransforms?t.updateTransforms.map(i=>function(a,u){let l=null;if("setToServerValue"in u)q(u.setToServerValue==="REQUEST_TIME"),l=new Le;else if("appendMissingElements"in u){let f=u.appendMissingElements.values||[];l=new pe(f)}else if("removeAllFromArray"in u){let f=u.removeAllFromArray.values||[];l=new _e(f)}else"increment"in u?l=new qe(a,u.increment):L();let d=ft.fromServerFormat(u.fieldPath);return new cn(d,l)}(r,i)):[];if(t.update){t.update.name;let i=ne(r,t.update.name),s=new Ct({mapValue:{fields:t.update.fields}});if(t.updateMask){let a=function(l){let d=l.fieldPaths||[];return new Ut(d.map(f=>ft.fromServerFormat(f)))}(t.updateMask);return new Ht(i,s,a,e,n)}return new Ue(i,s,e,n)}if(t.delete){let i=ne(r,t.delete);return new Be(i,e)}if(t.verify){let i=ne(r,t.verify);return new ti(i,e)}return L()}function Mp(r,t){return r&&r.length>0?(q(t!==void 0),r.map(e=>function(i,s){let a=i.updateTime?mt(i.updateTime):mt(s);return a.isEqual(B.min())&&(a=mt(s)),new Da(a,i.transformResults||[])}(e,t))):[]}function Df(r,t){return{documents:[Pf(r,t.path)]}}function Nf(r,t){let e={structuredQuery:{}},n=t.path,i;t.collectionGroup!==null?(i=n,e.structuredQuery.from=[{collectionId:t.collectionGroup,allDescendants:!0}]):(i=n.popLast(),e.structuredQuery.from=[{collectionId:n.lastSegment()}]),e.parent=Pf(r,i);let s=function(d){if(d.length!==0)return Of(tt.create(d,"and"))}(t.filters);s&&(e.structuredQuery.where=s);let a=function(d){if(d.length!==0)return d.map(f=>function(_){return{field:kn(_.field),direction:qp(_.dir)}}(f))}(t.orderBy);a&&(e.structuredQuery.orderBy=a);let u=La(r,t.limit);return u!==null&&(e.structuredQuery.limit=u),t.startAt&&(e.structuredQuery.startAt=function(d){return{before:d.inclusive,values:d.position}}(t.startAt)),t.endAt&&(e.structuredQuery.endAt=function(d){return{before:!d.inclusive,values:d.position}}(t.endAt)),{_t:e,parent:i}}function kf(r){let t=Vf(r.parent),e=r.structuredQuery,n=e.from?e.from.length:0,i=null;if(n>0){q(n===1);let f=e.from[0];f.allDescendants?i=f.collectionId:t=t.child(f.collectionId)}let s=[];e.where&&(s=function(g){let _=Ff(g);return _ instanceof tt&&lc(_)?_.getFilters():[_]}(e.where));let a=[];e.orderBy&&(a=function(g){return g.map(_=>function(N){return new an(Fn(N.field),function(D){switch(D){case"ASCENDING":return"asc";case"DESCENDING":return"desc";default:return}}(N.direction))}(_))}(e.orderBy));let u=null;e.limit&&(u=function(g){let _;return _=typeof g=="object"?g.value:g,gi(_)?null:_}(e.limit));let l=null;e.startAt&&(l=function(g){let _=!!g.before,S=g.values||[];return new se(S,_)}(e.startAt));let d=null;return e.endAt&&(d=function(g){let _=!g.before,S=g.values||[];return new se(S,_)}(e.endAt)),uf(t,i,a,s,u,"F",l,d)}function Lp(r,t){let e=function(i){switch(i){case"TargetPurposeListen":return null;case"TargetPurposeExistenceFilterMismatch":return"existence-filter-mismatch";case"TargetPurposeExistenceFilterMismatchBloom":return"existence-filter-mismatch-bloom";case"TargetPurposeLimboResolution":return"limbo-document";default:return L()}}(t.purpose);return e==null?null:{"goog-listen-tags":e}}function Ff(r){return r.unaryFilter!==void 0?function(e){switch(e.unaryFilter.op){case"IS_NAN":let n=Fn(e.unaryFilter.field);return W.create(n,"==",{doubleValue:NaN});case"IS_NULL":let i=Fn(e.unaryFilter.field);return W.create(i,"==",{nullValue:"NULL_VALUE"});case"IS_NOT_NAN":let s=Fn(e.unaryFilter.field);return W.create(s,"!=",{doubleValue:NaN});case"IS_NOT_NULL":let a=Fn(e.unaryFilter.field);return W.create(a,"!=",{nullValue:"NULL_VALUE"});default:return L()}}(r):r.fieldFilter!==void 0?function(e){return W.create(Fn(e.fieldFilter.field),function(i){switch(i){case"EQUAL":return"==";case"NOT_EQUAL":return"!=";case"GREATER_THAN":return">";case"GREATER_THAN_OR_EQUAL":return">=";case"LESS_THAN":return"<";case"LESS_THAN_OR_EQUAL":return"<=";case"ARRAY_CONTAINS":return"array-contains";case"IN":return"in";case"NOT_IN":return"not-in";case"ARRAY_CONTAINS_ANY":return"array-contains-any";default:return L()}}(e.fieldFilter.op),e.fieldFilter.value)}(r):r.compositeFilter!==void 0?function(e){return tt.create(e.compositeFilter.filters.map(n=>Ff(n)),function(i){switch(i){case"AND":return"and";case"OR":return"or";default:return L()}}(e.compositeFilter.op))}(r):L()}function qp(r){return Cp[r]}function Up(r){return Dp[r]}function Bp(r){return Np[r]}function kn(r){return{fieldPath:r.canonicalString()}}function Fn(r){return ft.fromServerFormat(r.fieldPath)}function Of(r){return r instanceof W?function(e){if(e.op==="=="){if(zh(e.value))return{unaryFilter:{field:kn(e.field),op:"IS_NAN"}};if(Gh(e.value))return{unaryFilter:{field:kn(e.field),op:"IS_NULL"}}}else if(e.op==="!="){if(zh(e.value))return{unaryFilter:{field:kn(e.field),op:"IS_NOT_NAN"}};if(Gh(e.value))return{unaryFilter:{field:kn(e.field),op:"IS_NOT_NULL"}}}return{fieldFilter:{field:kn(e.field),op:Up(e.op),value:e.value}}}(r):r instanceof tt?function(e){let n=e.getFilters().map(i=>Of(i));return n.length===1?n[0]:{compositeFilter:{op:Bp(e.op),filters:n}}}(r):L()}function jp(r){let t=[];return r.fields.forEach(e=>t.push(e.canonicalString())),{fieldPaths:t}}function Mf(r){return r.length>=4&&r.get(0)==="projects"&&r.get(2)==="databases"}var Wn=class r{constructor(t,e,n,i,s=B.min(),a=B.min(),u=gt.EMPTY_BYTE_STRING,l=null){this.target=t,this.targetId=e,this.purpose=n,this.sequenceNumber=i,this.snapshotVersion=s,this.lastLimboFreeSnapshotVersion=a,this.resumeToken=u,this.expectedCount=l}withSequenceNumber(t){return new r(this.target,this.targetId,this.purpose,t,this.snapshotVersion,this.lastLimboFreeSnapshotVersion,this.resumeToken,this.expectedCount)}withResumeToken(t,e){return new r(this.target,this.targetId,this.purpose,this.sequenceNumber,e,this.lastLimboFreeSnapshotVersion,t,null)}withExpectedCount(t){return new r(this.target,this.targetId,this.purpose,this.sequenceNumber,this.snapshotVersion,this.lastLimboFreeSnapshotVersion,this.resumeToken,t)}withLastLimboFreeSnapshotVersion(t){return new r(this.target,this.targetId,this.purpose,this.sequenceNumber,this.snapshotVersion,t,this.resumeToken,this.expectedCount)}};var _s=class{constructor(t){this.ct=t}};function Gp(r,t){let e;if(t.document)e=Cf(r.ct,t.document,!!t.hasCommittedMutations);else if(t.noDocument){let n=M.fromSegments(t.noDocument.path),i=hn(t.noDocument.readTime);e=wt.newNoDocument(n,i),t.hasCommittedMutations&&e.setHasCommittedMutations()}else{if(!t.unknownDocument)return L();{let n=M.fromSegments(t.unknownDocument.path),i=hn(t.unknownDocument.version);e=wt.newUnknownDocument(n,i)}}return t.readTime&&e.setReadTime(function(i){let s=new at(i[0],i[1]);return B.fromTimestamp(s)}(t.readTime)),e}function ud(r,t){let e=t.key,n={prefixPath:e.getCollectionPath().popLast().toArray(),collectionGroup:e.collectionGroup,documentId:e.path.lastSegment(),readTime:ys(t.readTime),hasCommittedMutations:t.hasCommittedMutations};if(t.isFoundDocument())n.document=function(s,a){return{name:si(s,a.key),fields:a.data.value.mapValue.fields,updateTime:Qn(s,a.version.toTimestamp()),createTime:Qn(s,a.createTime.toTimestamp())}}(r.ct,t);else if(t.isNoDocument())n.noDocument={path:e.path.toArray(),readTime:ln(t.version)};else{if(!t.isUnknownDocument())return L();n.unknownDocument={path:e.path.toArray(),version:ln(t.version)}}return n}function ys(r){let t=r.toTimestamp();return[t.seconds,t.nanoseconds]}function ln(r){let t=r.toTimestamp();return{seconds:t.seconds,nanoseconds:t.nanoseconds}}function hn(r){let t=new at(r.seconds,r.nanoseconds);return B.fromTimestamp(t)}function Ze(r,t){let e=(t.baseMutations||[]).map(s=>Ba(r.ct,s));for(let s=0;s<t.mutations.length-1;++s){let a=t.mutations[s];if(s+1<t.mutations.length&&t.mutations[s+1].transform!==void 0){let u=t.mutations[s+1];a.updateTransforms=u.transform.fieldTransforms,t.mutations.splice(s+1,1),++s}}let n=t.mutations.map(s=>Ba(r.ct,s)),i=at.fromMillis(t.localWriteTimeMs);return new ei(t.batchId,i,e,n)}function jr(r){let t=hn(r.readTime),e=r.lastLimboFreeSnapshotVersion!==void 0?hn(r.lastLimboFreeSnapshotVersion):B.min(),n;return n=function(s){return s.documents!==void 0}(r.query)?function(s){return q(s.documents.length===1),Ft(sr(Vf(s.documents[0])))}(r.query):function(s){return Ft(kf(s))}(r.query),new Wn(n,r.targetId,"TargetPurposeListen",r.lastListenSequenceNumber,t,e,gt.fromBase64String(r.resumeToken))}function Lf(r,t){let e=ln(t.snapshotVersion),n=ln(t.lastLimboFreeSnapshotVersion),i;i=hs(t.target)?Df(r.ct,t.target):Nf(r.ct,t.target)._t;let s=t.resumeToken.toBase64();return{targetId:t.targetId,canonicalId:un(t.target),readTime:e,resumeToken:s,lastListenSequenceNumber:t.sequenceNumber,lastLimboFreeSnapshotVersion:n,query:i}}function gc(r){let t=kf({parent:r.parent,structuredQuery:r.structuredQuery});return r.limitType==="LAST"?fs(t,t.limit,"L"):t}function ea(r,t){return new ni(t.largestBatchId,Ba(r.ct,t.overlayMutation))}function cd(r,t){let e=t.path.lastSegment();return[r,kt(t.path.popLast()),e]}function ld(r,t,e,n){return{indexId:r,uid:t,sequenceNumber:e,readTime:ln(n.readTime),documentKey:kt(n.documentKey.path),largestBatchId:n.largestBatchId}}var ja=class{getBundleMetadata(t,e){return hd(t).get(e).next(n=>{if(n)return function(s){return{id:s.bundleId,createTime:hn(s.createTime),version:s.version}}(n)})}saveBundleMetadata(t,e){return hd(t).put(function(i){return{bundleId:i.id,createTime:ln(mt(i.createTime)),version:i.version}}(e))}getNamedQuery(t,e){return dd(t).get(e).next(n=>{if(n)return function(s){return{name:s.name,query:gc(s.bundledQuery),readTime:hn(s.readTime)}}(n)})}saveNamedQuery(t,e){return dd(t).put(function(i){return{name:i.name,readTime:ln(mt(i.readTime)),bundledQuery:i.bundledQuery}}(e))}};function hd(r){return It(r,"bundles")}function dd(r){return It(r,"namedQueries")}var ws=class r{constructor(t,e){this.serializer=t,this.userId=e}static lt(t,e){let n=e.uid||"";return new r(t,n)}getOverlay(t,e){return Mr(t).get(cd(this.userId,e)).next(n=>n?ea(this.serializer,n):null)}getOverlays(t,e){let n=te();return b.forEach(e,i=>this.getOverlay(t,i).next(s=>{s!==null&&n.set(i,s)})).next(()=>n)}saveOverlays(t,e,n){let i=[];return n.forEach((s,a)=>{let u=new ni(e,a);i.push(this.ht(t,u))}),b.waitFor(i)}removeOverlaysForBatchId(t,e,n){let i=new Set;e.forEach(a=>i.add(kt(a.getCollectionPath())));let s=[];return i.forEach(a=>{let u=IDBKeyRange.bound([this.userId,a,n],[this.userId,a,n+1],!1,!0);s.push(Mr(t).j("collectionPathOverlayIndex",u))}),b.waitFor(s)}getOverlaysForCollection(t,e,n){let i=te(),s=kt(e),a=IDBKeyRange.bound([this.userId,s,n],[this.userId,s,Number.POSITIVE_INFINITY],!0);return Mr(t).U("collectionPathOverlayIndex",a).next(u=>{for(let l of u){let d=ea(this.serializer,l);i.set(d.getKey(),d)}return i})}getOverlaysForCollectionGroup(t,e,n,i){let s=te(),a,u=IDBKeyRange.bound([this.userId,e,n],[this.userId,e,Number.POSITIVE_INFINITY],!0);return Mr(t).J({index:"collectionGroupOverlayIndex",range:u},(l,d,f)=>{let g=ea(this.serializer,d);s.size()<i||g.largestBatchId===a?(s.set(g.getKey(),g),a=g.largestBatchId):f.done()}).next(()=>s)}ht(t,e){return Mr(t).put(function(i,s,a){let[u,l,d]=cd(s,a.mutation.key);return{userId:s,collectionPath:l,documentId:d,collectionGroup:a.mutation.key.getCollectionGroup(),largestBatchId:a.largestBatchId,overlayMutation:oi(i.ct,a.mutation)}}(this.serializer,this.userId,e))}};function Mr(r){return It(r,"documentOverlays")}var Ga=class{Pt(t){return It(t,"globals")}getSessionToken(t){return this.Pt(t).get("sessionToken").next(e=>{let n=e?.value;return n?gt.fromUint8Array(n):gt.EMPTY_BYTE_STRING})}setSessionToken(t,e){return this.Pt(t).put({name:"sessionToken",value:e.toUint8Array()})}};var fe=class{constructor(){}It(t,e){this.Tt(t,e),e.Et()}Tt(t,e){if("nullValue"in t)this.dt(e,5);else if("booleanValue"in t)this.dt(e,10),e.At(t.booleanValue?1:0);else if("integerValue"in t)this.dt(e,15),e.At(ot(t.integerValue));else if("doubleValue"in t){let n=ot(t.doubleValue);isNaN(n)?this.dt(e,13):(this.dt(e,15),Hr(n)?e.At(0):e.At(n))}else if("timestampValue"in t){let n=t.timestampValue;this.dt(e,20),typeof n=="string"&&(n=ge(n)),e.Rt(`${n.seconds||""}`),e.At(n.nanos||0)}else if("stringValue"in t)this.Vt(t.stringValue,e),this.ft(e);else if("bytesValue"in t)this.dt(e,30),e.gt(Fe(t.bytesValue)),this.ft(e);else if("referenceValue"in t)this.yt(t.referenceValue,e);else if("geoPointValue"in t){let n=t.geoPointValue;this.dt(e,45),e.At(n.latitude||0),e.At(n.longitude||0)}else"mapValue"in t?Zd(t)?this.dt(e,Number.MAX_SAFE_INTEGER):to(t)?this.wt(t.mapValue,e):(this.St(t.mapValue,e),this.ft(e)):"arrayValue"in t?(this.bt(t.arrayValue,e),this.ft(e)):L()}Vt(t,e){this.dt(e,25),this.Dt(t,e)}Dt(t,e){e.Rt(t)}St(t,e){let n=t.fields||{};this.dt(e,55);for(let i of Object.keys(n))this.Vt(i,e),this.Tt(n[i],e)}wt(t,e){var n,i;let s=t.fields||{};this.dt(e,53);let a="value",u=((i=(n=s[a].arrayValue)===null||n===void 0?void 0:n.values)===null||i===void 0?void 0:i.length)||0;this.dt(e,15),e.At(ot(u)),this.Vt(a,e),this.Tt(s[a],e)}bt(t,e){let n=t.values||[];this.dt(e,50);for(let i of n)this.Tt(i,e)}yt(t,e){this.dt(e,37),M.fromName(t).path.forEach(n=>{this.dt(e,60),this.Dt(n,e)})}dt(t,e){t.At(e)}ft(t){t.At(2)}};fe.vt=new fe;function zp(r){if(r===0)return 8;let t=0;return!(r>>4)&&(t+=4,r<<=4),!(r>>6)&&(t+=2,r<<=2),!(r>>7)&&(t+=1),t}function fd(r){let t=64-function(n){let i=0;for(let s=0;s<8;++s){let a=zp(255&n[s]);if(i+=a,a!==8)break}return i}(r);return Math.ceil(t/8)}var za=class{constructor(){this.buffer=new Uint8Array(1024),this.position=0}Ct(t){let e=t[Symbol.iterator](),n=e.next();for(;!n.done;)this.Ft(n.value),n=e.next();this.Mt()}xt(t){let e=t[Symbol.iterator](),n=e.next();for(;!n.done;)this.Ot(n.value),n=e.next();this.Nt()}Lt(t){for(let e of t){let n=e.charCodeAt(0);if(n<128)this.Ft(n);else if(n<2048)this.Ft(960|n>>>6),this.Ft(128|63&n);else if(e<"\uD800"||"\uDBFF"<e)this.Ft(480|n>>>12),this.Ft(128|63&n>>>6),this.Ft(128|63&n);else{let i=e.codePointAt(0);this.Ft(240|i>>>18),this.Ft(128|63&i>>>12),this.Ft(128|63&i>>>6),this.Ft(128|63&i)}}this.Mt()}Bt(t){for(let e of t){let n=e.charCodeAt(0);if(n<128)this.Ot(n);else if(n<2048)this.Ot(960|n>>>6),this.Ot(128|63&n);else if(e<"\uD800"||"\uDBFF"<e)this.Ot(480|n>>>12),this.Ot(128|63&n>>>6),this.Ot(128|63&n);else{let i=e.codePointAt(0);this.Ot(240|i>>>18),this.Ot(128|63&i>>>12),this.Ot(128|63&i>>>6),this.Ot(128|63&i)}}this.Nt()}kt(t){let e=this.qt(t),n=fd(e);this.Qt(1+n),this.buffer[this.position++]=255&n;for(let i=e.length-n;i<e.length;++i)this.buffer[this.position++]=255&e[i]}Kt(t){let e=this.qt(t),n=fd(e);this.Qt(1+n),this.buffer[this.position++]=~(255&n);for(let i=e.length-n;i<e.length;++i)this.buffer[this.position++]=~(255&e[i])}$t(){this.Ut(255),this.Ut(255)}Wt(){this.Gt(255),this.Gt(255)}reset(){this.position=0}seed(t){this.Qt(t.length),this.buffer.set(t,this.position),this.position+=t.length}zt(){return this.buffer.slice(0,this.position)}qt(t){let e=function(s){let a=new DataView(new ArrayBuffer(8));return a.setFloat64(0,s,!1),new Uint8Array(a.buffer)}(t),n=(128&e[0])!=0;e[0]^=n?255:128;for(let i=1;i<e.length;++i)e[i]^=n?255:0;return e}Ft(t){let e=255&t;e===0?(this.Ut(0),this.Ut(255)):e===255?(this.Ut(255),this.Ut(0)):this.Ut(e)}Ot(t){let e=255&t;e===0?(this.Gt(0),this.Gt(255)):e===255?(this.Gt(255),this.Gt(0)):this.Gt(t)}Mt(){this.Ut(0),this.Ut(1)}Nt(){this.Gt(0),this.Gt(1)}Ut(t){this.Qt(1),this.buffer[this.position++]=t}Gt(t){this.Qt(1),this.buffer[this.position++]=~t}Qt(t){let e=t+this.position;if(e<=this.buffer.length)return;let n=2*this.buffer.length;n<e&&(n=e);let i=new Uint8Array(n);i.set(this.buffer),this.buffer=i}},Ka=class{constructor(t){this.jt=t}gt(t){this.jt.Ct(t)}Rt(t){this.jt.Lt(t)}At(t){this.jt.kt(t)}Et(){this.jt.$t()}},$a=class{constructor(t){this.jt=t}gt(t){this.jt.xt(t)}Rt(t){this.jt.Bt(t)}At(t){this.jt.Kt(t)}Et(){this.jt.Wt()}},tn=class{constructor(){this.jt=new za,this.Ht=new Ka(this.jt),this.Jt=new $a(this.jt)}seed(t){this.jt.seed(t)}Yt(t){return t===0?this.Ht:this.Jt}zt(){return this.jt.zt()}reset(){this.jt.reset()}};var en=class r{constructor(t,e,n,i){this.indexId=t,this.documentKey=e,this.arrayValue=n,this.directionalValue=i}Zt(){let t=this.directionalValue.length,e=t===0||this.directionalValue[t-1]===255?t+1:t,n=new Uint8Array(e);return n.set(this.directionalValue,0),e!==t?n.set([0],this.directionalValue.length):++n[n.length-1],new r(this.indexId,this.documentKey,this.arrayValue,n)}};function Re(r,t){let e=r.indexId-t.indexId;return e!==0?e:(e=md(r.arrayValue,t.arrayValue),e!==0?e:(e=md(r.directionalValue,t.directionalValue),e!==0?e:M.comparator(r.documentKey,t.documentKey)))}function md(r,t){for(let e=0;e<r.length&&e<t.length;++e){let n=r[e]-t[e];if(n!==0)return n}return r.length-t.length}var vs=class{constructor(t){this.Xt=new nt((e,n)=>ft.comparator(e.field,n.field)),this.collectionId=t.collectionGroup!=null?t.collectionGroup:t.path.lastSegment(),this.en=t.orderBy,this.tn=[];for(let e of t.filters){let n=e;n.isInequality()?this.Xt=this.Xt.add(n):this.tn.push(n)}}get nn(){return this.Xt.size>1}rn(t){if(q(t.collectionGroup===this.collectionId),this.nn)return!1;let e=fa(t);if(e!==void 0&&!this.sn(e))return!1;let n=Ye(t),i=new Set,s=0,a=0;for(;s<n.length&&this.sn(n[s]);++s)i=i.add(n[s].fieldPath.canonicalString());if(s===n.length)return!0;if(this.Xt.size>0){let u=this.Xt.getIterator().getNext();if(!i.has(u.field.canonicalString())){let l=n[s];if(!this.on(u,l)||!this._n(this.en[a++],l))return!1}++s}for(;s<n.length;++s){let u=n[s];if(a>=this.en.length||!this._n(this.en[a++],u))return!1}return!0}an(){if(this.nn)return null;let t=new nt(ft.comparator),e=[];for(let n of this.tn)if(!n.field.isKeyField())if(n.op==="array-contains"||n.op==="array-contains-any")e.push(new Ln(n.field,2));else{if(t.has(n.field))continue;t=t.add(n.field),e.push(new Ln(n.field,0))}for(let n of this.en)n.field.isKeyField()||t.has(n.field)||(t=t.add(n.field),e.push(new Ln(n.field,n.dir==="asc"?0:1)));return new jn(jn.UNKNOWN_ID,this.collectionId,e,Wr.empty())}sn(t){for(let e of this.tn)if(this.on(e,t))return!0;return!1}on(t,e){if(t===void 0||!t.field.isEqual(e.fieldPath))return!1;let n=t.op==="array-contains"||t.op==="array-contains-any";return e.kind===2===n}_n(t,e){return!!t.field.isEqual(e.fieldPath)&&(e.kind===0&&t.dir==="asc"||e.kind===1&&t.dir==="desc")}};function qf(r){var t,e;if(q(r instanceof W||r instanceof tt),r instanceof W){if(r instanceof ls){let i=((e=(t=r.value.arrayValue)===null||t===void 0?void 0:t.values)===null||e===void 0?void 0:e.map(s=>W.create(r.field,"==",s)))||[];return tt.create(i,"or")}return r}let n=r.filters.map(i=>qf(i));return tt.create(n,r.op)}function Kp(r){if(r.getFilters().length===0)return[];let t=Ha(qf(r));return q(Uf(t)),Qa(t)||Wa(t)?[t]:t.getFilters()}function Qa(r){return r instanceof W}function Wa(r){return r instanceof tt&&lc(r)}function Uf(r){return Qa(r)||Wa(r)||function(e){if(e instanceof tt&&Ia(e)){for(let n of e.getFilters())if(!Qa(n)&&!Wa(n))return!1;return!0}return!1}(r)}function Ha(r){if(q(r instanceof W||r instanceof tt),r instanceof W)return r;if(r.filters.length===1)return Ha(r.filters[0]);let t=r.filters.map(n=>Ha(n)),e=tt.create(t,r.op);return e=Is(e),Uf(e)?e:(q(e instanceof tt),q(zn(e)),q(e.filters.length>1),e.filters.reduce((n,i)=>pc(n,i)))}function pc(r,t){let e;return q(r instanceof W||r instanceof tt),q(t instanceof W||t instanceof tt),e=r instanceof W?t instanceof W?function(i,s){return tt.create([i,s],"and")}(r,t):gd(r,t):t instanceof W?gd(t,r):function(i,s){if(q(i.filters.length>0&&s.filters.length>0),zn(i)&&zn(s))return sf(i,s.getFilters());let a=Ia(i)?i:s,u=Ia(i)?s:i,l=a.filters.map(d=>pc(d,u));return tt.create(l,"or")}(r,t),Is(e)}function gd(r,t){if(zn(t))return sf(t,r.getFilters());{let e=t.filters.map(n=>pc(r,n));return tt.create(e,"or")}}function Is(r){if(q(r instanceof W||r instanceof tt),r instanceof W)return r;let t=r.getFilters();if(t.length===1)return Is(t[0]);if(nf(r))return r;let e=t.map(i=>Is(i)),n=[];return e.forEach(i=>{i instanceof W?n.push(i):i instanceof tt&&(i.op===r.op?n.push(...i.filters):n.push(i))}),n.length===1?n[0]:tt.create(n,r.op)}var Ja=class{constructor(){this.un=new ai}addToCollectionParentIndex(t,e){return this.un.add(e),b.resolve()}getCollectionParents(t,e){return b.resolve(this.un.getEntries(e))}addFieldIndex(t,e){return b.resolve()}deleteFieldIndex(t,e){return b.resolve()}deleteAllFieldIndexes(t){return b.resolve()}createTargetIndexes(t,e){return b.resolve()}getDocumentsMatchingTarget(t,e){return b.resolve(null)}getIndexType(t,e){return b.resolve(0)}getFieldIndexes(t,e){return b.resolve([])}getNextCollectionGroupToUpdate(t){return b.resolve(null)}getMinOffset(t,e){return b.resolve(Gt.min())}getMinOffsetFromCollectionGroup(t,e){return b.resolve(Gt.min())}updateCollectionGroup(t,e,n){return b.resolve()}updateIndexEntries(t,e){return b.resolve()}},ai=class{constructor(){this.index={}}add(t){let e=t.lastSegment(),n=t.popLast(),i=this.index[e]||new nt(Y.comparator),s=!i.has(n);return this.index[e]=i.add(n),s}has(t){let e=t.lastSegment(),n=t.popLast(),i=this.index[e];return i&&i.has(n)}getEntries(t){return(this.index[t]||new nt(Y.comparator)).toArray()}};var Qi=new Uint8Array(0),Ya=class{constructor(t,e){this.databaseId=e,this.cn=new ai,this.ln=new oe(n=>un(n),(n,i)=>pi(n,i)),this.uid=t.uid||""}addToCollectionParentIndex(t,e){if(!this.cn.has(e)){let n=e.lastSegment(),i=e.popLast();t.addOnCommittedListener(()=>{this.cn.add(e)});let s={collectionId:n,parent:kt(i)};return pd(t).put(s)}return b.resolve()}getCollectionParents(t,e){let n=[],i=IDBKeyRange.bound([e,""],[Bd(e),""],!1,!0);return pd(t).U(i).next(s=>{for(let a of s){if(a.collectionId!==e)break;n.push(Zt(a.parent))}return n})}addFieldIndex(t,e){let n=Lr(t),i=function(u){return{indexId:u.indexId,collectionGroup:u.collectionGroup,fields:u.fields.map(l=>[l.fieldPath.canonicalString(),l.kind])}}(e);delete i.indexId;let s=n.add(i);if(e.indexState){let a=xn(t);return s.next(u=>{a.put(ld(u,this.uid,e.indexState.sequenceNumber,e.indexState.offset))})}return s.next()}deleteFieldIndex(t,e){let n=Lr(t),i=xn(t),s=Vn(t);return n.delete(e.indexId).next(()=>i.delete(IDBKeyRange.bound([e.indexId],[e.indexId+1],!1,!0))).next(()=>s.delete(IDBKeyRange.bound([e.indexId],[e.indexId+1],!1,!0)))}deleteAllFieldIndexes(t){let e=Lr(t),n=Vn(t),i=xn(t);return e.j().next(()=>n.j()).next(()=>i.j())}createTargetIndexes(t,e){return b.forEach(this.hn(e),n=>this.getIndexType(t,n).next(i=>{if(i===0||i===1){let s=new vs(n).an();if(s!=null)return this.addFieldIndex(t,s)}}))}getDocumentsMatchingTarget(t,e){let n=Vn(t),i=!0,s=new Map;return b.forEach(this.hn(e),a=>this.Pn(t,a).next(u=>{i&&(i=!!u),s.set(a,u)})).next(()=>{if(i){let a=$(),u=[];return b.forEach(s,(l,d)=>{C("IndexedDbIndexManager",`Using index ${function(U){return`id=${U.indexId}|cg=${U.collectionGroup}|f=${U.fields.map(Q=>`${Q.fieldPath}:${Q.kind}`).join(",")}`}(l)} to execute ${un(e)}`);let f=function(U,Q){let H=fa(Q);if(H===void 0)return null;for(let K of ds(U,H.fieldPath))switch(K.op){case"array-contains-any":return K.value.arrayValue.values||[];case"array-contains":return[K.value]}return null}(d,l),g=function(U,Q){let H=new Map;for(let K of Ye(Q))for(let v of ds(U,K.fieldPath))switch(v.op){case"==":case"in":H.set(K.fieldPath.canonicalString(),v.value);break;case"not-in":case"!=":return H.set(K.fieldPath.canonicalString(),v.value),Array.from(H.values())}return null}(d,l),_=function(U,Q){let H=[],K=!0;for(let v of Ye(Q)){let p=v.kind===0?Hh(U,v.fieldPath,U.startAt):Jh(U,v.fieldPath,U.startAt);H.push(p.value),K&&(K=p.inclusive)}return new se(H,K)}(d,l),S=function(U,Q){let H=[],K=!0;for(let v of Ye(Q)){let p=v.kind===0?Jh(U,v.fieldPath,U.endAt):Hh(U,v.fieldPath,U.endAt);H.push(p.value),K&&(K=p.inclusive)}return new se(H,K)}(d,l),N=this.In(l,d,_),k=this.In(l,d,S),D=this.Tn(l,d,g),j=this.En(l.indexId,f,N,_.inclusive,k,S.inclusive,D);return b.forEach(j,G=>n.G(G,e.limit).next(U=>{U.forEach(Q=>{let H=M.fromSegments(Q.documentKey);a.has(H)||(a=a.add(H),u.push(H))})}))}).next(()=>u)}return b.resolve(null)})}hn(t){let e=this.ln.get(t);return e||(t.filters.length===0?e=[t]:e=Kp(tt.create(t.filters,"and")).map(n=>xa(t.path,t.collectionGroup,t.orderBy,n.getFilters(),t.limit,t.startAt,t.endAt)),this.ln.set(t,e),e)}En(t,e,n,i,s,a,u){let l=(e!=null?e.length:1)*Math.max(n.length,s.length),d=l/(e!=null?e.length:1),f=[];for(let g=0;g<l;++g){let _=e?this.dn(e[g/d]):Qi,S=this.An(t,_,n[g%d],i),N=this.Rn(t,_,s[g%d],a),k=u.map(D=>this.An(t,_,D,!0));f.push(...this.createRange(S,N,k))}return f}An(t,e,n,i){let s=new en(t,M.empty(),e,n);return i?s:s.Zt()}Rn(t,e,n,i){let s=new en(t,M.empty(),e,n);return i?s.Zt():s}Pn(t,e){let n=new vs(e),i=e.collectionGroup!=null?e.collectionGroup:e.path.lastSegment();return this.getFieldIndexes(t,i).next(s=>{let a=null;for(let u of s)n.rn(u)&&(!a||u.fields.length>a.fields.length)&&(a=u);return a})}getIndexType(t,e){let n=2,i=this.hn(e);return b.forEach(i,s=>this.Pn(t,s).next(a=>{a?n!==0&&a.fields.length<function(l){let d=new nt(ft.comparator),f=!1;for(let g of l.filters)for(let _ of g.getFlattenedFilters())_.field.isKeyField()||(_.op==="array-contains"||_.op==="array-contains-any"?f=!0:d=d.add(_.field));for(let g of l.orderBy)g.field.isKeyField()||(d=d.add(g.field));return d.size+(f?1:0)}(s)&&(n=1):n=0})).next(()=>function(a){return a.limit!==null}(e)&&i.length>1&&n===2?1:n)}Vn(t,e){let n=new tn;for(let i of Ye(t)){let s=e.data.field(i.fieldPath);if(s==null)return null;let a=n.Yt(i.kind);fe.vt.It(s,a)}return n.zt()}dn(t){let e=new tn;return fe.vt.It(t,e.Yt(0)),e.zt()}mn(t,e){let n=new tn;return fe.vt.It(on(this.databaseId,e),n.Yt(function(s){let a=Ye(s);return a.length===0?0:a[a.length-1].kind}(t))),n.zt()}Tn(t,e,n){if(n===null)return[];let i=[];i.push(new tn);let s=0;for(let a of Ye(t)){let u=n[s++];for(let l of i)if(this.fn(e,a.fieldPath)&&Zr(u))i=this.gn(i,a,u);else{let d=l.Yt(a.kind);fe.vt.It(u,d)}}return this.pn(i)}In(t,e,n){return this.Tn(t,e,n.position)}pn(t){let e=[];for(let n=0;n<t.length;++n)e[n]=t[n].zt();return e}gn(t,e,n){let i=[...t],s=[];for(let a of n.arrayValue.values||[])for(let u of i){let l=new tn;l.seed(u.zt()),fe.vt.It(a,l.Yt(e.kind)),s.push(l)}return s}fn(t,e){return!!t.filters.find(n=>n instanceof W&&n.field.isEqual(e)&&(n.op==="in"||n.op==="not-in"))}getFieldIndexes(t,e){let n=Lr(t),i=xn(t);return(e?n.U("collectionGroupIndex",IDBKeyRange.bound(e,e)):n.U()).next(s=>{let a=[];return b.forEach(s,u=>i.get([u.indexId,this.uid]).next(l=>{a.push(function(f,g){let _=g?new Wr(g.sequenceNumber,new Gt(hn(g.readTime),new M(Zt(g.documentKey)),g.largestBatchId)):Wr.empty(),S=f.fields.map(([N,k])=>new Ln(ft.fromServerFormat(N),k));return new jn(f.indexId,f.collectionGroup,S,_)}(u,l))})).next(()=>a)})}getNextCollectionGroupToUpdate(t){return this.getFieldIndexes(t).next(e=>e.length===0?null:(e.sort((n,i)=>{let s=n.indexState.sequenceNumber-i.indexState.sequenceNumber;return s!==0?s:z(n.collectionGroup,i.collectionGroup)}),e[0].collectionGroup))}updateCollectionGroup(t,e,n){let i=Lr(t),s=xn(t);return this.yn(t).next(a=>i.U("collectionGroupIndex",IDBKeyRange.bound(e,e)).next(u=>b.forEach(u,l=>s.put(ld(l.indexId,this.uid,a,n)))))}updateIndexEntries(t,e){let n=new Map;return b.forEach(e,(i,s)=>{let a=n.get(i.collectionGroup);return(a?b.resolve(a):this.getFieldIndexes(t,i.collectionGroup)).next(u=>(n.set(i.collectionGroup,u),b.forEach(u,l=>this.wn(t,i,l).next(d=>{let f=this.Sn(s,l);return d.isEqual(f)?b.resolve():this.bn(t,s,l,d,f)}))))})}Dn(t,e,n,i){return Vn(t).put({indexId:i.indexId,uid:this.uid,arrayValue:i.arrayValue,directionalValue:i.directionalValue,orderedDocumentKey:this.mn(n,e.key),documentKey:e.key.path.toArray()})}vn(t,e,n,i){return Vn(t).delete([i.indexId,this.uid,i.arrayValue,i.directionalValue,this.mn(n,e.key),e.key.path.toArray()])}wn(t,e,n){let i=Vn(t),s=new nt(Re);return i.J({index:"documentKeyIndex",range:IDBKeyRange.only([n.indexId,this.uid,this.mn(n,e)])},(a,u)=>{s=s.add(new en(n.indexId,e,u.arrayValue,u.directionalValue))}).next(()=>s)}Sn(t,e){let n=new nt(Re),i=this.Vn(e,t);if(i==null)return n;let s=fa(e);if(s!=null){let a=t.data.field(s.fieldPath);if(Zr(a))for(let u of a.arrayValue.values||[])n=n.add(new en(e.indexId,t.key,this.dn(u),i))}else n=n.add(new en(e.indexId,t.key,Qi,i));return n}bn(t,e,n,i,s){C("IndexedDbIndexManager","Updating index entries for document '%s'",e.key);let a=[];return function(l,d,f,g,_){let S=l.getIterator(),N=d.getIterator(),k=Pn(S),D=Pn(N);for(;k||D;){let j=!1,G=!1;if(k&&D){let U=f(k,D);U<0?G=!0:U>0&&(j=!0)}else k!=null?G=!0:j=!0;j?(g(D),D=Pn(N)):G?(_(k),k=Pn(S)):(k=Pn(S),D=Pn(N))}}(i,s,Re,u=>{a.push(this.Dn(t,e,n,u))},u=>{a.push(this.vn(t,e,n,u))}),b.waitFor(a)}yn(t){let e=1;return xn(t).J({index:"sequenceNumberIndex",reverse:!0,range:IDBKeyRange.upperBound([this.uid,Number.MAX_SAFE_INTEGER])},(n,i,s)=>{s.done(),e=i.sequenceNumber+1}).next(()=>e)}createRange(t,e,n){n=n.sort((a,u)=>Re(a,u)).filter((a,u,l)=>!u||Re(a,l[u-1])!==0);let i=[];i.push(t);for(let a of n){let u=Re(a,t),l=Re(a,e);if(u===0)i[0]=t.Zt();else if(u>0&&l<0)i.push(a),i.push(a.Zt());else if(l>0)break}i.push(e);let s=[];for(let a=0;a<i.length;a+=2){if(this.Cn(i[a],i[a+1]))return[];let u=[i[a].indexId,this.uid,i[a].arrayValue,i[a].directionalValue,Qi,[]],l=[i[a+1].indexId,this.uid,i[a+1].arrayValue,i[a+1].directionalValue,Qi,[]];s.push(IDBKeyRange.bound(u,l))}return s}Cn(t,e){return Re(t,e)>0}getMinOffsetFromCollectionGroup(t,e){return this.getFieldIndexes(t,e).next(_d)}getMinOffset(t,e){return b.mapArray(this.hn(e),n=>this.Pn(t,n).next(i=>i||L())).next(_d)}};function pd(r){return It(r,"collectionParents")}function Vn(r){return It(r,"indexEntries")}function Lr(r){return It(r,"indexConfiguration")}function xn(r){return It(r,"indexState")}function _d(r){q(r.length!==0);let t=r[0].indexState.offset,e=t.largestBatchId;for(let n=1;n<r.length;n++){let i=r[n].indexState.offset;oc(i,t)<0&&(t=i),e<i.largestBatchId&&(e=i.largestBatchId)}return new Gt(t.readTime,t.documentKey,e)}var yd={didRun:!1,sequenceNumbersCollected:0,targetsRemoved:0,documentsRemoved:0},jt=class r{constructor(t,e,n){this.cacheSizeCollectionThreshold=t,this.percentileToCollect=e,this.maximumSequenceNumbersToCollect=n}static withCacheSize(t){return new r(t,r.DEFAULT_COLLECTION_PERCENTILE,r.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT)}};function Bf(r,t,e){let n=r.store("mutations"),i=r.store("documentMutations"),s=[],a=IDBKeyRange.only(e.batchId),u=0,l=n.J({range:a},(f,g,_)=>(u++,_.delete()));s.push(l.next(()=>{q(u===1)}));let d=[];for(let f of e.mutations){let g=Qd(t,f.key.path,e.batchId);s.push(i.delete(g)),d.push(f.key)}return b.waitFor(s).next(()=>d)}function Ts(r){if(!r)return 0;let t;if(r.document)t=r.document;else if(r.unknownDocument)t=r.unknownDocument;else{if(!r.noDocument)throw L();t=r.noDocument}return JSON.stringify(t).length}jt.DEFAULT_COLLECTION_PERCENTILE=10,jt.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT=1e3,jt.DEFAULT=new jt(41943040,jt.DEFAULT_COLLECTION_PERCENTILE,jt.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT),jt.DISABLED=new jt(-1,0,0);var Es=class r{constructor(t,e,n,i){this.userId=t,this.serializer=e,this.indexManager=n,this.referenceDelegate=i,this.Fn={}}static lt(t,e,n,i){q(t.uid!=="");let s=t.isAuthenticated()?t.uid:"";return new r(s,e,n,i)}checkEmpty(t){let e=!0,n=IDBKeyRange.bound([this.userId,Number.NEGATIVE_INFINITY],[this.userId,Number.POSITIVE_INFINITY]);return Pe(t).J({index:"userMutationsIndex",range:n},(i,s,a)=>{e=!1,a.done()}).next(()=>e)}addMutationBatch(t,e,n,i){let s=On(t),a=Pe(t);return a.add({}).next(u=>{q(typeof u=="number");let l=new ei(u,e,n,i),d=function(S,N,k){let D=k.baseMutations.map(G=>oi(S.ct,G)),j=k.mutations.map(G=>oi(S.ct,G));return{userId:N,batchId:k.batchId,localWriteTimeMs:k.localWriteTime.toMillis(),baseMutations:D,mutations:j}}(this.serializer,this.userId,l),f=[],g=new nt((_,S)=>z(_.canonicalString(),S.canonicalString()));for(let _ of i){let S=Qd(this.userId,_.key.path,u);g=g.add(_.key.path.popLast()),f.push(a.put(d)),f.push(s.put(S,Yg))}return g.forEach(_=>{f.push(this.indexManager.addToCollectionParentIndex(t,_))}),t.addOnCommittedListener(()=>{this.Fn[u]=l.keys()}),b.waitFor(f).next(()=>l)})}lookupMutationBatch(t,e){return Pe(t).get(e).next(n=>n?(q(n.userId===this.userId),Ze(this.serializer,n)):null)}Mn(t,e){return this.Fn[e]?b.resolve(this.Fn[e]):this.lookupMutationBatch(t,e).next(n=>{if(n){let i=n.keys();return this.Fn[e]=i,i}return null})}getNextMutationBatchAfterBatchId(t,e){let n=e+1,i=IDBKeyRange.lowerBound([this.userId,n]),s=null;return Pe(t).J({index:"userMutationsIndex",range:i},(a,u,l)=>{u.userId===this.userId&&(q(u.batchId>=n),s=Ze(this.serializer,u)),l.done()}).next(()=>s)}getHighestUnacknowledgedBatchId(t){let e=IDBKeyRange.upperBound([this.userId,Number.POSITIVE_INFINITY]),n=-1;return Pe(t).J({index:"userMutationsIndex",range:e,reverse:!0},(i,s,a)=>{n=s.batchId,a.done()}).next(()=>n)}getAllMutationBatches(t){let e=IDBKeyRange.bound([this.userId,-1],[this.userId,Number.POSITIVE_INFINITY]);return Pe(t).U("userMutationsIndex",e).next(n=>n.map(i=>Ze(this.serializer,i)))}getAllMutationBatchesAffectingDocumentKey(t,e){let n=Yi(this.userId,e.path),i=IDBKeyRange.lowerBound(n),s=[];return On(t).J({range:i},(a,u,l)=>{let[d,f,g]=a,_=Zt(f);if(d===this.userId&&e.path.isEqual(_))return Pe(t).get(g).next(S=>{if(!S)throw L();q(S.userId===this.userId),s.push(Ze(this.serializer,S))});l.done()}).next(()=>s)}getAllMutationBatchesAffectingDocumentKeys(t,e){let n=new nt(z),i=[];return e.forEach(s=>{let a=Yi(this.userId,s.path),u=IDBKeyRange.lowerBound(a),l=On(t).J({range:u},(d,f,g)=>{let[_,S,N]=d,k=Zt(S);_===this.userId&&s.path.isEqual(k)?n=n.add(N):g.done()});i.push(l)}),b.waitFor(i).next(()=>this.xn(t,n))}getAllMutationBatchesAffectingQuery(t,e){let n=e.path,i=n.length+1,s=Yi(this.userId,n),a=IDBKeyRange.lowerBound(s),u=new nt(z);return On(t).J({range:a},(l,d,f)=>{let[g,_,S]=l,N=Zt(_);g===this.userId&&n.isPrefixOf(N)?N.length===i&&(u=u.add(S)):f.done()}).next(()=>this.xn(t,u))}xn(t,e){let n=[],i=[];return e.forEach(s=>{i.push(Pe(t).get(s).next(a=>{if(a===null)throw L();q(a.userId===this.userId),n.push(Ze(this.serializer,a))}))}),b.waitFor(i).next(()=>n)}removeMutationBatch(t,e){return Bf(t._e,this.userId,e).next(n=>(t.addOnCommittedListener(()=>{this.On(e.batchId)}),b.forEach(n,i=>this.referenceDelegate.markPotentiallyOrphaned(t,i))))}On(t){delete this.Fn[t]}performConsistencyCheck(t){return this.checkEmpty(t).next(e=>{if(!e)return b.resolve();let n=IDBKeyRange.lowerBound(function(a){return[a]}(this.userId)),i=[];return On(t).J({range:n},(s,a,u)=>{if(s[0]===this.userId){let l=Zt(s[1]);i.push(l)}else u.done()}).next(()=>{q(i.length===0)})})}containsKey(t,e){return jf(t,this.userId,e)}Nn(t){return Gf(t).get(this.userId).next(e=>e||{userId:this.userId,lastAcknowledgedBatchId:-1,lastStreamToken:""})}};function jf(r,t,e){let n=Yi(t,e.path),i=n[1],s=IDBKeyRange.lowerBound(n),a=!1;return On(r).J({range:s,H:!0},(u,l,d)=>{let[f,g,_]=u;f===t&&g===i&&(a=!0),d.done()}).next(()=>a)}function Pe(r){return It(r,"mutations")}function On(r){return It(r,"documentMutations")}function Gf(r){return It(r,"mutationQueues")}var Hn=class r{constructor(t){this.Ln=t}next(){return this.Ln+=2,this.Ln}static Bn(){return new r(0)}static kn(){return new r(-1)}};var Xa=class{constructor(t,e){this.referenceDelegate=t,this.serializer=e}allocateTargetId(t){return this.qn(t).next(e=>{let n=new Hn(e.highestTargetId);return e.highestTargetId=n.next(),this.Qn(t,e).next(()=>e.highestTargetId)})}getLastRemoteSnapshotVersion(t){return this.qn(t).next(e=>B.fromTimestamp(new at(e.lastRemoteSnapshotVersion.seconds,e.lastRemoteSnapshotVersion.nanoseconds)))}getHighestSequenceNumber(t){return this.qn(t).next(e=>e.highestListenSequenceNumber)}setTargetsMetadata(t,e,n){return this.qn(t).next(i=>(i.highestListenSequenceNumber=e,n&&(i.lastRemoteSnapshotVersion=n.toTimestamp()),e>i.highestListenSequenceNumber&&(i.highestListenSequenceNumber=e),this.Qn(t,i)))}addTargetData(t,e){return this.Kn(t,e).next(()=>this.qn(t).next(n=>(n.targetCount+=1,this.$n(e,n),this.Qn(t,n))))}updateTargetData(t,e){return this.Kn(t,e)}removeTargetData(t,e){return this.removeMatchingKeysForTargetId(t,e.targetId).next(()=>Cn(t).delete(e.targetId)).next(()=>this.qn(t)).next(n=>(q(n.targetCount>0),n.targetCount-=1,this.Qn(t,n)))}removeTargets(t,e,n){let i=0,s=[];return Cn(t).J((a,u)=>{let l=jr(u);l.sequenceNumber<=e&&n.get(l.targetId)===null&&(i++,s.push(this.removeTargetData(t,l)))}).next(()=>b.waitFor(s)).next(()=>i)}forEachTarget(t,e){return Cn(t).J((n,i)=>{let s=jr(i);e(s)})}qn(t){return wd(t).get("targetGlobalKey").next(e=>(q(e!==null),e))}Qn(t,e){return wd(t).put("targetGlobalKey",e)}Kn(t,e){return Cn(t).put(Lf(this.serializer,e))}$n(t,e){let n=!1;return t.targetId>e.highestTargetId&&(e.highestTargetId=t.targetId,n=!0),t.sequenceNumber>e.highestListenSequenceNumber&&(e.highestListenSequenceNumber=t.sequenceNumber,n=!0),n}getTargetCount(t){return this.qn(t).next(e=>e.targetCount)}getTargetData(t,e){let n=un(e),i=IDBKeyRange.bound([n,Number.NEGATIVE_INFINITY],[n,Number.POSITIVE_INFINITY]),s=null;return Cn(t).J({range:i,index:"queryTargetsIndex"},(a,u,l)=>{let d=jr(u);pi(e,d.target)&&(s=d,l.done())}).next(()=>s)}addMatchingKeys(t,e,n){let i=[],s=Ve(t);return e.forEach(a=>{let u=kt(a.path);i.push(s.put({targetId:n,path:u})),i.push(this.referenceDelegate.addReference(t,n,a))}),b.waitFor(i)}removeMatchingKeys(t,e,n){let i=Ve(t);return b.forEach(e,s=>{let a=kt(s.path);return b.waitFor([i.delete([n,a]),this.referenceDelegate.removeReference(t,n,s)])})}removeMatchingKeysForTargetId(t,e){let n=Ve(t),i=IDBKeyRange.bound([e],[e+1],!1,!0);return n.delete(i)}getMatchingKeysForTargetId(t,e){let n=IDBKeyRange.bound([e],[e+1],!1,!0),i=Ve(t),s=$();return i.J({range:n,H:!0},(a,u,l)=>{let d=Zt(a[1]),f=new M(d);s=s.add(f)}).next(()=>s)}containsKey(t,e){let n=kt(e.path),i=IDBKeyRange.bound([n],[Bd(n)],!1,!0),s=0;return Ve(t).J({index:"documentTargetsIndex",H:!0,range:i},([a,u],l,d)=>{a!==0&&(s++,d.done())}).next(()=>s>0)}ot(t,e){return Cn(t).get(e).next(n=>n?jr(n):null)}};function Cn(r){return It(r,"targets")}function wd(r){return It(r,"targetGlobal")}function Ve(r){return It(r,"targetDocuments")}function vd([r,t],[e,n]){let i=z(r,e);return i===0?z(t,n):i}var Za=class{constructor(t){this.Un=t,this.buffer=new nt(vd),this.Wn=0}Gn(){return++this.Wn}zn(t){let e=[t,this.Gn()];if(this.buffer.size<this.Un)this.buffer=this.buffer.add(e);else{let n=this.buffer.last();vd(e,n)<0&&(this.buffer=this.buffer.delete(n).add(e))}}get maxValue(){return this.buffer.last()[0]}},tu=class{constructor(t,e,n){this.garbageCollector=t,this.asyncQueue=e,this.localStore=n,this.jn=null}start(){this.garbageCollector.params.cacheSizeCollectionThreshold!==-1&&this.Hn(6e4)}stop(){this.jn&&(this.jn.cancel(),this.jn=null)}get started(){return this.jn!==null}Hn(t){C("LruGarbageCollector",`Garbage collection scheduled in ${t}ms`),this.jn=this.asyncQueue.enqueueAfterDelay("lru_garbage_collection",t,()=>V(this,null,function*(){this.jn=null;try{yield this.localStore.collectGarbage(this.garbageCollector)}catch(e){ze(e)?C("LruGarbageCollector","Ignoring IndexedDB error during garbage collection: ",e):yield Ge(e)}yield this.Hn(3e5)}))}},eu=class{constructor(t,e){this.Jn=t,this.params=e}calculateTargetCount(t,e){return this.Jn.Yn(t).next(n=>Math.floor(e/100*n))}nthSequenceNumber(t,e){if(e===0)return b.resolve(qt.oe);let n=new Za(e);return this.Jn.forEachTarget(t,i=>n.zn(i.sequenceNumber)).next(()=>this.Jn.Zn(t,i=>n.zn(i))).next(()=>n.maxValue)}removeTargets(t,e,n){return this.Jn.removeTargets(t,e,n)}removeOrphanedDocuments(t,e){return this.Jn.removeOrphanedDocuments(t,e)}collect(t,e){return this.params.cacheSizeCollectionThreshold===-1?(C("LruGarbageCollector","Garbage collection skipped; disabled"),b.resolve(yd)):this.getCacheSize(t).next(n=>n<this.params.cacheSizeCollectionThreshold?(C("LruGarbageCollector",`Garbage collection skipped; Cache size ${n} is lower than threshold ${this.params.cacheSizeCollectionThreshold}`),yd):this.Xn(t,e))}getCacheSize(t){return this.Jn.getCacheSize(t)}Xn(t,e){let n,i,s,a,u,l,d,f=Date.now();return this.calculateTargetCount(t,this.params.percentileToCollect).next(g=>(g>this.params.maximumSequenceNumbersToCollect?(C("LruGarbageCollector",`Capping sequence numbers to collect down to the maximum of ${this.params.maximumSequenceNumbersToCollect} from ${g}`),i=this.params.maximumSequenceNumbersToCollect):i=g,a=Date.now(),this.nthSequenceNumber(t,i))).next(g=>(n=g,u=Date.now(),this.removeTargets(t,n,e))).next(g=>(s=g,l=Date.now(),this.removeOrphanedDocuments(t,n))).next(g=>(d=Date.now(),Dn()<=Xt.DEBUG&&C("LruGarbageCollector",`LRU Garbage Collection
	Counted targets in ${a-f}ms
	Determined least recently used ${i} in `+(u-a)+`ms
	Removed ${s} targets in `+(l-u)+`ms
	Removed ${g} documents in `+(d-l)+`ms
Total Duration: ${d-f}ms`),b.resolve({didRun:!0,sequenceNumbersCollected:i,targetsRemoved:s,documentsRemoved:g})))}};function $p(r,t){return new eu(r,t)}var nu=class{constructor(t,e){this.db=t,this.garbageCollector=$p(this,e)}Yn(t){let e=this.er(t);return this.db.getTargetCache().getTargetCount(t).next(n=>e.next(i=>n+i))}er(t){let e=0;return this.Zn(t,n=>{e++}).next(()=>e)}forEachTarget(t,e){return this.db.getTargetCache().forEachTarget(t,e)}Zn(t,e){return this.tr(t,(n,i)=>e(i))}addReference(t,e,n){return Wi(t,n)}removeReference(t,e,n){return Wi(t,n)}removeTargets(t,e,n){return this.db.getTargetCache().removeTargets(t,e,n)}markPotentiallyOrphaned(t,e){return Wi(t,e)}nr(t,e){return function(i,s){let a=!1;return Gf(i).Y(u=>jf(i,u,s).next(l=>(l&&(a=!0),b.resolve(!l)))).next(()=>a)}(t,e)}removeOrphanedDocuments(t,e){let n=this.db.getRemoteDocumentCache().newChangeBuffer(),i=[],s=0;return this.tr(t,(a,u)=>{if(u<=e){let l=this.nr(t,a).next(d=>{if(!d)return s++,n.getEntry(t,a).next(()=>(n.removeEntry(a,B.min()),Ve(t).delete(function(g){return[0,kt(g.path)]}(a))))});i.push(l)}}).next(()=>b.waitFor(i)).next(()=>n.apply(t)).next(()=>s)}removeTarget(t,e){let n=e.withSequenceNumber(t.currentSequenceNumber);return this.db.getTargetCache().updateTargetData(t,n)}updateLimboDocument(t,e){return Wi(t,e)}tr(t,e){let n=Ve(t),i,s=qt.oe;return n.J({index:"documentTargetsIndex"},([a,u],{path:l,sequenceNumber:d})=>{a===0?(s!==qt.oe&&e(new M(Zt(i)),s),s=d,i=l):s=qt.oe}).next(()=>{s!==qt.oe&&e(new M(Zt(i)),s)})}getCacheSize(t){return this.db.getRemoteDocumentCache().getSize(t)}};function Wi(r,t){return Ve(r).put(function(n,i){return{targetId:0,path:kt(n.path),sequenceNumber:i}}(t,r.currentSequenceNumber))}var As=class{constructor(){this.changes=new oe(t=>t.toString(),(t,e)=>t.isEqual(e)),this.changesApplied=!1}addEntry(t){this.assertNotApplied(),this.changes.set(t.key,t)}removeEntry(t,e){this.assertNotApplied(),this.changes.set(t,wt.newInvalidDocument(t).setReadTime(e))}getEntry(t,e){this.assertNotApplied();let n=this.changes.get(e);return n!==void 0?b.resolve(n):this.getFromCache(t,e)}getEntries(t,e){return this.getAllFromCache(t,e)}apply(t){return this.assertNotApplied(),this.changesApplied=!0,this.applyChanges(t)}assertNotApplied(){}};var ru=class{constructor(t){this.serializer=t}setIndexManager(t){this.indexManager=t}addEntry(t,e,n){return Je(t).put(n)}removeEntry(t,e,n){return Je(t).delete(function(s,a){let u=s.path.toArray();return[u.slice(0,u.length-2),u[u.length-2],ys(a),u[u.length-1]]}(e,n))}updateMetadata(t,e){return this.getMetadata(t).next(n=>(n.byteSize+=e,this.rr(t,n)))}getEntry(t,e){let n=wt.newInvalidDocument(e);return Je(t).J({index:"documentKeyIndex",range:IDBKeyRange.only(qr(e))},(i,s)=>{n=this.ir(e,s)}).next(()=>n)}sr(t,e){let n={size:0,document:wt.newInvalidDocument(e)};return Je(t).J({index:"documentKeyIndex",range:IDBKeyRange.only(qr(e))},(i,s)=>{n={document:this.ir(e,s),size:Ts(s)}}).next(()=>n)}getEntries(t,e){let n=Mt();return this._r(t,e,(i,s)=>{let a=this.ir(i,s);n=n.insert(i,a)}).next(()=>n)}ar(t,e){let n=Mt(),i=new st(M.comparator);return this._r(t,e,(s,a)=>{let u=this.ir(s,a);n=n.insert(s,u),i=i.insert(s,Ts(a))}).next(()=>({documents:n,ur:i}))}_r(t,e,n){if(e.isEmpty())return b.resolve();let i=new nt(Ed);e.forEach(l=>i=i.add(l));let s=IDBKeyRange.bound(qr(i.first()),qr(i.last())),a=i.getIterator(),u=a.getNext();return Je(t).J({index:"documentKeyIndex",range:s},(l,d,f)=>{let g=M.fromSegments([...d.prefixPath,d.collectionGroup,d.documentId]);for(;u&&Ed(u,g)<0;)n(u,null),u=a.getNext();u&&u.isEqual(g)&&(n(u,d),u=a.hasNext()?a.getNext():null),u?f.$(qr(u)):f.done()}).next(()=>{for(;u;)n(u,null),u=a.hasNext()?a.getNext():null})}getDocumentsMatchingQuery(t,e,n,i,s){let a=e.path,u=[a.popLast().toArray(),a.lastSegment(),ys(n.readTime),n.documentKey.path.isEmpty()?"":n.documentKey.path.lastSegment()],l=[a.popLast().toArray(),a.lastSegment(),[Number.MAX_SAFE_INTEGER,Number.MAX_SAFE_INTEGER],""];return Je(t).U(IDBKeyRange.bound(u,l,!0)).next(d=>{s?.incrementDocumentReadCount(d.length);let f=Mt();for(let g of d){let _=this.ir(M.fromSegments(g.prefixPath.concat(g.collectionGroup,g.documentId)),g);_.isFoundDocument()&&(yi(e,_)||i.has(_.key))&&(f=f.insert(_.key,_))}return f})}getAllFromCollectionGroup(t,e,n,i){let s=Mt(),a=Td(e,n),u=Td(e,Gt.max());return Je(t).J({index:"collectionGroupIndex",range:IDBKeyRange.bound(a,u,!0)},(l,d,f)=>{let g=this.ir(M.fromSegments(d.prefixPath.concat(d.collectionGroup,d.documentId)),d);s=s.insert(g.key,g),s.size===i&&f.done()}).next(()=>s)}newChangeBuffer(t){return new iu(this,!!t&&t.trackRemovals)}getSize(t){return this.getMetadata(t).next(e=>e.byteSize)}getMetadata(t){return Id(t).get("remoteDocumentGlobalKey").next(e=>(q(!!e),e))}rr(t,e){return Id(t).put("remoteDocumentGlobalKey",e)}ir(t,e){if(e){let n=Gp(this.serializer,e);if(!(n.isNoDocument()&&n.version.isEqual(B.min())))return n}return wt.newInvalidDocument(t)}};function zf(r){return new ru(r)}var iu=class extends As{constructor(t,e){super(),this.cr=t,this.trackRemovals=e,this.lr=new oe(n=>n.toString(),(n,i)=>n.isEqual(i))}applyChanges(t){let e=[],n=0,i=new nt((s,a)=>z(s.canonicalString(),a.canonicalString()));return this.changes.forEach((s,a)=>{let u=this.lr.get(s);if(e.push(this.cr.removeEntry(t,s,u.readTime)),a.isValidDocument()){let l=ud(this.cr.serializer,a);i=i.add(s.path.popLast());let d=Ts(l);n+=d-u.size,e.push(this.cr.addEntry(t,s,l))}else if(n-=u.size,this.trackRemovals){let l=ud(this.cr.serializer,a.convertToNoDocument(B.min()));e.push(this.cr.addEntry(t,s,l))}}),i.forEach(s=>{e.push(this.cr.indexManager.addToCollectionParentIndex(t,s))}),e.push(this.cr.updateMetadata(t,n)),b.waitFor(e)}getFromCache(t,e){return this.cr.sr(t,e).next(n=>(this.lr.set(e,{size:n.size,readTime:n.document.readTime}),n.document))}getAllFromCache(t,e){return this.cr.ar(t,e).next(({documents:n,ur:i})=>(i.forEach((s,a)=>{this.lr.set(s,{size:a,readTime:n.get(s).readTime})}),n))}};function Id(r){return It(r,"remoteDocumentGlobal")}function Je(r){return It(r,"remoteDocumentsV14")}function qr(r){let t=r.path.toArray();return[t.slice(0,t.length-2),t[t.length-2],t[t.length-1]]}function Td(r,t){let e=t.documentKey.path.toArray();return[r,ys(t.readTime),e.slice(0,e.length-2),e.length>0?e[e.length-1]:""]}function Ed(r,t){let e=r.path.toArray(),n=t.path.toArray(),i=0;for(let s=0;s<e.length-2&&s<n.length-2;++s)if(i=z(e[s],n[s]),i)return i;return i=z(e.length,n.length),i||(i=z(e[e.length-2],n[n.length-2]),i||z(e[e.length-1],n[n.length-1]))}var su=class{constructor(t,e){this.overlayedDocument=t,this.mutatedFields=e}};var Ss=class{constructor(t,e,n,i){this.remoteDocumentCache=t,this.mutationQueue=e,this.documentOverlayCache=n,this.indexManager=i}getDocument(t,e){let n=null;return this.documentOverlayCache.getOverlay(t,e).next(i=>(n=i,this.remoteDocumentCache.getEntry(t,e))).next(i=>(n!==null&&Kr(n.mutation,i,Ut.empty(),at.now()),i))}getDocuments(t,e){return this.remoteDocumentCache.getEntries(t,e).next(n=>this.getLocalViewOfDocuments(t,n,$()).next(()=>n))}getLocalViewOfDocuments(t,e,n=$()){let i=te();return this.populateOverlays(t,i,e).next(()=>this.computeViews(t,e,i,n).next(s=>{let a=Br();return s.forEach((u,l)=>{a=a.insert(u,l.overlayedDocument)}),a}))}getOverlayedDocuments(t,e){let n=te();return this.populateOverlays(t,n,e).next(()=>this.computeViews(t,e,n,$()))}populateOverlays(t,e,n){let i=[];return n.forEach(s=>{e.has(s)||i.push(s)}),this.documentOverlayCache.getOverlays(t,i).next(s=>{s.forEach((a,u)=>{e.set(a,u)})})}computeViews(t,e,n,i){let s=Mt(),a=zr(),u=function(){return zr()}();return e.forEach((l,d)=>{let f=n.get(d.key);i.has(d.key)&&(f===void 0||f.mutation instanceof Ht)?s=s.insert(d.key,d):f!==void 0?(a.set(d.key,f.mutation.getFieldMask()),Kr(f.mutation,d,f.mutation.getFieldMask(),at.now())):a.set(d.key,Ut.empty())}),this.recalculateAndSaveOverlays(t,s).next(l=>(l.forEach((d,f)=>a.set(d,f)),e.forEach((d,f)=>{var g;return u.set(d,new su(f,(g=a.get(d))!==null&&g!==void 0?g:null))}),u))}recalculateAndSaveOverlays(t,e){let n=zr(),i=new st((a,u)=>a-u),s=$();return this.mutationQueue.getAllMutationBatchesAffectingDocumentKeys(t,e).next(a=>{for(let u of a)u.keys().forEach(l=>{let d=e.get(l);if(d===null)return;let f=n.get(l)||Ut.empty();f=u.applyToLocalView(d,f),n.set(l,f);let g=(i.get(u.batchId)||$()).add(l);i=i.insert(u.batchId,g)})}).next(()=>{let a=[],u=i.getReverseIterator();for(;u.hasNext();){let l=u.getNext(),d=l.key,f=l.value,g=mf();f.forEach(_=>{if(!s.has(_)){let S=If(e.get(_),n.get(_));S!==null&&g.set(_,S),s=s.add(_)}}),a.push(this.documentOverlayCache.saveOverlays(t,d,g))}return b.waitFor(a)}).next(()=>n)}recalculateAndSaveOverlaysForDocumentKeys(t,e){return this.remoteDocumentCache.getEntries(t,e).next(n=>this.recalculateAndSaveOverlays(t,n))}getDocumentsMatchingQuery(t,e,n,i){return function(a){return M.isDocumentKey(a.path)&&a.collectionGroup===null&&a.filters.length===0}(e)?this.getDocumentsMatchingDocumentQuery(t,e.path):hc(e)?this.getDocumentsMatchingCollectionGroupQuery(t,e,n,i):this.getDocumentsMatchingCollectionQuery(t,e,n,i)}getNextDocuments(t,e,n,i){return this.remoteDocumentCache.getAllFromCollectionGroup(t,e,n,i).next(s=>{let a=i-s.size>0?this.documentOverlayCache.getOverlaysForCollectionGroup(t,e,n.largestBatchId,i-s.size):b.resolve(te()),u=-1,l=s;return a.next(d=>b.forEach(d,(f,g)=>(u<g.largestBatchId&&(u=g.largestBatchId),s.get(f)?b.resolve():this.remoteDocumentCache.getEntry(t,f).next(_=>{l=l.insert(f,_)}))).next(()=>this.populateOverlays(t,d,s)).next(()=>this.computeViews(t,l,d,$())).next(f=>({batchId:u,changes:ff(f)})))})}getDocumentsMatchingDocumentQuery(t,e){return this.getDocument(t,new M(e)).next(n=>{let i=Br();return n.isFoundDocument()&&(i=i.insert(n.key,n)),i})}getDocumentsMatchingCollectionGroupQuery(t,e,n,i){let s=e.collectionGroup,a=Br();return this.indexManager.getCollectionParents(t,s).next(u=>b.forEach(u,l=>{let d=function(g,_){return new Wt(_,null,g.explicitOrderBy.slice(),g.filters.slice(),g.limit,g.limitType,g.startAt,g.endAt)}(e,l.child(s));return this.getDocumentsMatchingCollectionQuery(t,d,n,i).next(f=>{f.forEach((g,_)=>{a=a.insert(g,_)})})}).next(()=>a))}getDocumentsMatchingCollectionQuery(t,e,n,i){let s;return this.documentOverlayCache.getOverlaysForCollection(t,e.path,n.largestBatchId).next(a=>(s=a,this.remoteDocumentCache.getDocumentsMatchingQuery(t,e,n,s,i))).next(a=>{s.forEach((l,d)=>{let f=d.getKey();a.get(f)===null&&(a=a.insert(f,wt.newInvalidDocument(f)))});let u=Br();return a.forEach((l,d)=>{let f=s.get(l);f!==void 0&&Kr(f.mutation,d,Ut.empty(),at.now()),yi(e,d)&&(u=u.insert(l,d))}),u})}};var ou=class{constructor(t){this.serializer=t,this.hr=new Map,this.Pr=new Map}getBundleMetadata(t,e){return b.resolve(this.hr.get(e))}saveBundleMetadata(t,e){return this.hr.set(e.id,function(i){return{id:i.id,version:i.version,createTime:mt(i.createTime)}}(e)),b.resolve()}getNamedQuery(t,e){return b.resolve(this.Pr.get(e))}saveNamedQuery(t,e){return this.Pr.set(e.name,function(i){return{name:i.name,query:gc(i.bundledQuery),readTime:mt(i.readTime)}}(e)),b.resolve()}};var au=class{constructor(){this.overlays=new st(M.comparator),this.Ir=new Map}getOverlay(t,e){return b.resolve(this.overlays.get(e))}getOverlays(t,e){let n=te();return b.forEach(e,i=>this.getOverlay(t,i).next(s=>{s!==null&&n.set(i,s)})).next(()=>n)}saveOverlays(t,e,n){return n.forEach((i,s)=>{this.ht(t,e,s)}),b.resolve()}removeOverlaysForBatchId(t,e,n){let i=this.Ir.get(n);return i!==void 0&&(i.forEach(s=>this.overlays=this.overlays.remove(s)),this.Ir.delete(n)),b.resolve()}getOverlaysForCollection(t,e,n){let i=te(),s=e.length+1,a=new M(e.child("")),u=this.overlays.getIteratorFrom(a);for(;u.hasNext();){let l=u.getNext().value,d=l.getKey();if(!e.isPrefixOf(d.path))break;d.path.length===s&&l.largestBatchId>n&&i.set(l.getKey(),l)}return b.resolve(i)}getOverlaysForCollectionGroup(t,e,n,i){let s=new st((d,f)=>d-f),a=this.overlays.getIterator();for(;a.hasNext();){let d=a.getNext().value;if(d.getKey().getCollectionGroup()===e&&d.largestBatchId>n){let f=s.get(d.largestBatchId);f===null&&(f=te(),s=s.insert(d.largestBatchId,f)),f.set(d.getKey(),d)}}let u=te(),l=s.getIterator();for(;l.hasNext()&&(l.getNext().value.forEach((d,f)=>u.set(d,f)),!(u.size()>=i)););return b.resolve(u)}ht(t,e,n){let i=this.overlays.get(n.key);if(i!==null){let a=this.Ir.get(i.largestBatchId).delete(n.key);this.Ir.set(i.largestBatchId,a)}this.overlays=this.overlays.insert(n.key,new ni(e,n));let s=this.Ir.get(e);s===void 0&&(s=$(),this.Ir.set(e,s)),this.Ir.set(e,s.add(n.key))}};var uu=class{constructor(){this.sessionToken=gt.EMPTY_BYTE_STRING}getSessionToken(t){return b.resolve(this.sessionToken)}setSessionToken(t,e){return this.sessionToken=e,b.resolve()}};var ui=class{constructor(){this.Tr=new nt(_t.Er),this.dr=new nt(_t.Ar)}isEmpty(){return this.Tr.isEmpty()}addReference(t,e){let n=new _t(t,e);this.Tr=this.Tr.add(n),this.dr=this.dr.add(n)}Rr(t,e){t.forEach(n=>this.addReference(n,e))}removeReference(t,e){this.Vr(new _t(t,e))}mr(t,e){t.forEach(n=>this.removeReference(n,e))}gr(t){let e=new M(new Y([])),n=new _t(e,t),i=new _t(e,t+1),s=[];return this.dr.forEachInRange([n,i],a=>{this.Vr(a),s.push(a.key)}),s}pr(){this.Tr.forEach(t=>this.Vr(t))}Vr(t){this.Tr=this.Tr.delete(t),this.dr=this.dr.delete(t)}yr(t){let e=new M(new Y([])),n=new _t(e,t),i=new _t(e,t+1),s=$();return this.dr.forEachInRange([n,i],a=>{s=s.add(a.key)}),s}containsKey(t){let e=new _t(t,0),n=this.Tr.firstAfterOrEqual(e);return n!==null&&t.isEqual(n.key)}},_t=class{constructor(t,e){this.key=t,this.wr=e}static Er(t,e){return M.comparator(t.key,e.key)||z(t.wr,e.wr)}static Ar(t,e){return z(t.wr,e.wr)||M.comparator(t.key,e.key)}};var cu=class{constructor(t,e){this.indexManager=t,this.referenceDelegate=e,this.mutationQueue=[],this.Sr=1,this.br=new nt(_t.Er)}checkEmpty(t){return b.resolve(this.mutationQueue.length===0)}addMutationBatch(t,e,n,i){let s=this.Sr;this.Sr++,this.mutationQueue.length>0&&this.mutationQueue[this.mutationQueue.length-1];let a=new ei(s,e,n,i);this.mutationQueue.push(a);for(let u of i)this.br=this.br.add(new _t(u.key,s)),this.indexManager.addToCollectionParentIndex(t,u.key.path.popLast());return b.resolve(a)}lookupMutationBatch(t,e){return b.resolve(this.Dr(e))}getNextMutationBatchAfterBatchId(t,e){let n=e+1,i=this.vr(n),s=i<0?0:i;return b.resolve(this.mutationQueue.length>s?this.mutationQueue[s]:null)}getHighestUnacknowledgedBatchId(){return b.resolve(this.mutationQueue.length===0?-1:this.Sr-1)}getAllMutationBatches(t){return b.resolve(this.mutationQueue.slice())}getAllMutationBatchesAffectingDocumentKey(t,e){let n=new _t(e,0),i=new _t(e,Number.POSITIVE_INFINITY),s=[];return this.br.forEachInRange([n,i],a=>{let u=this.Dr(a.wr);s.push(u)}),b.resolve(s)}getAllMutationBatchesAffectingDocumentKeys(t,e){let n=new nt(z);return e.forEach(i=>{let s=new _t(i,0),a=new _t(i,Number.POSITIVE_INFINITY);this.br.forEachInRange([s,a],u=>{n=n.add(u.wr)})}),b.resolve(this.Cr(n))}getAllMutationBatchesAffectingQuery(t,e){let n=e.path,i=n.length+1,s=n;M.isDocumentKey(s)||(s=s.child(""));let a=new _t(new M(s),0),u=new nt(z);return this.br.forEachWhile(l=>{let d=l.key.path;return!!n.isPrefixOf(d)&&(d.length===i&&(u=u.add(l.wr)),!0)},a),b.resolve(this.Cr(u))}Cr(t){let e=[];return t.forEach(n=>{let i=this.Dr(n);i!==null&&e.push(i)}),e}removeMutationBatch(t,e){q(this.Fr(e.batchId,"removed")===0),this.mutationQueue.shift();let n=this.br;return b.forEach(e.mutations,i=>{let s=new _t(i.key,e.batchId);return n=n.delete(s),this.referenceDelegate.markPotentiallyOrphaned(t,i.key)}).next(()=>{this.br=n})}On(t){}containsKey(t,e){let n=new _t(e,0),i=this.br.firstAfterOrEqual(n);return b.resolve(e.isEqual(i&&i.key))}performConsistencyCheck(t){return this.mutationQueue.length,b.resolve()}Fr(t,e){return this.vr(t)}vr(t){return this.mutationQueue.length===0?0:t-this.mutationQueue[0].batchId}Dr(t){let e=this.vr(t);return e<0||e>=this.mutationQueue.length?null:this.mutationQueue[e]}};var lu=class{constructor(t){this.Mr=t,this.docs=function(){return new st(M.comparator)}(),this.size=0}setIndexManager(t){this.indexManager=t}addEntry(t,e){let n=e.key,i=this.docs.get(n),s=i?i.size:0,a=this.Mr(e);return this.docs=this.docs.insert(n,{document:e.mutableCopy(),size:a}),this.size+=a-s,this.indexManager.addToCollectionParentIndex(t,n.path.popLast())}removeEntry(t){let e=this.docs.get(t);e&&(this.docs=this.docs.remove(t),this.size-=e.size)}getEntry(t,e){let n=this.docs.get(e);return b.resolve(n?n.document.mutableCopy():wt.newInvalidDocument(e))}getEntries(t,e){let n=Mt();return e.forEach(i=>{let s=this.docs.get(i);n=n.insert(i,s?s.document.mutableCopy():wt.newInvalidDocument(i))}),b.resolve(n)}getDocumentsMatchingQuery(t,e,n,i){let s=Mt(),a=e.path,u=new M(a.child("")),l=this.docs.getIteratorFrom(u);for(;l.hasNext();){let{key:d,value:{document:f}}=l.getNext();if(!a.isPrefixOf(d.path))break;d.path.length>a.length+1||oc(Gd(f),n)<=0||(i.has(f.key)||yi(e,f))&&(s=s.insert(f.key,f.mutableCopy()))}return b.resolve(s)}getAllFromCollectionGroup(t,e,n,i){L()}Or(t,e){return b.forEach(this.docs,n=>e(n))}newChangeBuffer(t){return new hu(this)}getSize(t){return b.resolve(this.size)}},hu=class extends As{constructor(t){super(),this.cr=t}applyChanges(t){let e=[];return this.changes.forEach((n,i)=>{i.isValidDocument()?e.push(this.cr.addEntry(t,i)):this.cr.removeEntry(n)}),b.waitFor(e)}getFromCache(t,e){return this.cr.getEntry(t,e)}getAllFromCache(t,e){return this.cr.getEntries(t,e)}};var du=class{constructor(t){this.persistence=t,this.Nr=new oe(e=>un(e),pi),this.lastRemoteSnapshotVersion=B.min(),this.highestTargetId=0,this.Lr=0,this.Br=new ui,this.targetCount=0,this.kr=Hn.Bn()}forEachTarget(t,e){return this.Nr.forEach((n,i)=>e(i)),b.resolve()}getLastRemoteSnapshotVersion(t){return b.resolve(this.lastRemoteSnapshotVersion)}getHighestSequenceNumber(t){return b.resolve(this.Lr)}allocateTargetId(t){return this.highestTargetId=this.kr.next(),b.resolve(this.highestTargetId)}setTargetsMetadata(t,e,n){return n&&(this.lastRemoteSnapshotVersion=n),e>this.Lr&&(this.Lr=e),b.resolve()}Kn(t){this.Nr.set(t.target,t);let e=t.targetId;e>this.highestTargetId&&(this.kr=new Hn(e),this.highestTargetId=e),t.sequenceNumber>this.Lr&&(this.Lr=t.sequenceNumber)}addTargetData(t,e){return this.Kn(e),this.targetCount+=1,b.resolve()}updateTargetData(t,e){return this.Kn(e),b.resolve()}removeTargetData(t,e){return this.Nr.delete(e.target),this.Br.gr(e.targetId),this.targetCount-=1,b.resolve()}removeTargets(t,e,n){let i=0,s=[];return this.Nr.forEach((a,u)=>{u.sequenceNumber<=e&&n.get(u.targetId)===null&&(this.Nr.delete(a),s.push(this.removeMatchingKeysForTargetId(t,u.targetId)),i++)}),b.waitFor(s).next(()=>i)}getTargetCount(t){return b.resolve(this.targetCount)}getTargetData(t,e){let n=this.Nr.get(e)||null;return b.resolve(n)}addMatchingKeys(t,e,n){return this.Br.Rr(e,n),b.resolve()}removeMatchingKeys(t,e,n){this.Br.mr(e,n);let i=this.persistence.referenceDelegate,s=[];return i&&e.forEach(a=>{s.push(i.markPotentiallyOrphaned(t,a))}),b.waitFor(s)}removeMatchingKeysForTargetId(t,e){return this.Br.gr(e),b.resolve()}getMatchingKeysForTargetId(t,e){let n=this.Br.yr(e);return b.resolve(n)}containsKey(t,e){return b.resolve(this.Br.containsKey(e))}};var bs=class{constructor(t,e){this.qr={},this.overlays={},this.Qr=new qt(0),this.Kr=!1,this.Kr=!0,this.$r=new uu,this.referenceDelegate=t(this),this.Ur=new du(this),this.indexManager=new Ja,this.remoteDocumentCache=function(i){return new lu(i)}(n=>this.referenceDelegate.Wr(n)),this.serializer=new _s(e),this.Gr=new ou(this.serializer)}start(){return Promise.resolve()}shutdown(){return this.Kr=!1,Promise.resolve()}get started(){return this.Kr}setDatabaseDeletedListener(){}setNetworkEnabled(){}getIndexManager(t){return this.indexManager}getDocumentOverlayCache(t){let e=this.overlays[t.toKey()];return e||(e=new au,this.overlays[t.toKey()]=e),e}getMutationQueue(t,e){let n=this.qr[t.toKey()];return n||(n=new cu(e,this.referenceDelegate),this.qr[t.toKey()]=n),n}getGlobalsCache(){return this.$r}getTargetCache(){return this.Ur}getRemoteDocumentCache(){return this.remoteDocumentCache}getBundleCache(){return this.Gr}runTransaction(t,e,n){C("MemoryPersistence","Starting transaction:",t);let i=new fu(this.Qr.next());return this.referenceDelegate.zr(),n(i).next(s=>this.referenceDelegate.jr(i).next(()=>s)).toPromise().then(s=>(i.raiseOnCommittedEvent(),s))}Hr(t,e){return b.or(Object.values(this.qr).map(n=>()=>n.containsKey(t,e)))}},fu=class extends ss{constructor(t){super(),this.currentSequenceNumber=t}},Rs=class r{constructor(t){this.persistence=t,this.Jr=new ui,this.Yr=null}static Zr(t){return new r(t)}get Xr(){if(this.Yr)return this.Yr;throw L()}addReference(t,e,n){return this.Jr.addReference(n,e),this.Xr.delete(n.toString()),b.resolve()}removeReference(t,e,n){return this.Jr.removeReference(n,e),this.Xr.add(n.toString()),b.resolve()}markPotentiallyOrphaned(t,e){return this.Xr.add(e.toString()),b.resolve()}removeTarget(t,e){this.Jr.gr(e.targetId).forEach(i=>this.Xr.add(i.toString()));let n=this.persistence.getTargetCache();return n.getMatchingKeysForTargetId(t,e.targetId).next(i=>{i.forEach(s=>this.Xr.add(s.toString()))}).next(()=>n.removeTargetData(t,e))}zr(){this.Yr=new Set}jr(t){let e=this.persistence.getRemoteDocumentCache().newChangeBuffer();return b.forEach(this.Xr,n=>{let i=M.fromPath(n);return this.ei(t,i).next(s=>{s||e.removeEntry(i,B.min())})}).next(()=>(this.Yr=null,e.apply(t)))}updateLimboDocument(t,e){return this.ei(t,e).next(n=>{n?this.Xr.delete(e.toString()):this.Xr.add(e.toString())})}Wr(t){return 0}ei(t,e){return b.or([()=>b.resolve(this.Jr.containsKey(e)),()=>this.persistence.getTargetCache().containsKey(t,e),()=>this.persistence.Hr(t,e)])}};var mu=class{constructor(t){this.serializer=t}O(t,e,n,i){let s=new os("createOrUpgrade",e);n<1&&i>=1&&(function(l){l.createObjectStore("owner")}(t),function(l){l.createObjectStore("mutationQueues",{keyPath:"userId"}),l.createObjectStore("mutations",{keyPath:"batchId",autoIncrement:!0}).createIndex("userMutationsIndex",qh,{unique:!0}),l.createObjectStore("documentMutations")}(t),Ad(t),function(l){l.createObjectStore("remoteDocuments")}(t));let a=b.resolve();return n<3&&i>=3&&(n!==0&&(function(l){l.deleteObjectStore("targetDocuments"),l.deleteObjectStore("targets"),l.deleteObjectStore("targetGlobal")}(t),Ad(t)),a=a.next(()=>function(l){let d=l.store("targetGlobal"),f={highestTargetId:0,highestListenSequenceNumber:0,lastRemoteSnapshotVersion:B.min().toTimestamp(),targetCount:0};return d.put("targetGlobalKey",f)}(s))),n<4&&i>=4&&(n!==0&&(a=a.next(()=>function(l,d){return d.store("mutations").U().next(f=>{l.deleteObjectStore("mutations"),l.createObjectStore("mutations",{keyPath:"batchId",autoIncrement:!0}).createIndex("userMutationsIndex",qh,{unique:!0});let g=d.store("mutations"),_=f.map(S=>g.put(S));return b.waitFor(_)})}(t,s))),a=a.next(()=>{(function(l){l.createObjectStore("clientMetadata",{keyPath:"clientId"})})(t)})),n<5&&i>=5&&(a=a.next(()=>this.ni(s))),n<6&&i>=6&&(a=a.next(()=>(function(l){l.createObjectStore("remoteDocumentGlobal")}(t),this.ri(s)))),n<7&&i>=7&&(a=a.next(()=>this.ii(s))),n<8&&i>=8&&(a=a.next(()=>this.si(t,s))),n<9&&i>=9&&(a=a.next(()=>{(function(l){l.objectStoreNames.contains("remoteDocumentChanges")&&l.deleteObjectStore("remoteDocumentChanges")})(t)})),n<10&&i>=10&&(a=a.next(()=>this.oi(s))),n<11&&i>=11&&(a=a.next(()=>{(function(l){l.createObjectStore("bundles",{keyPath:"bundleId"})})(t),function(l){l.createObjectStore("namedQueries",{keyPath:"name"})}(t)})),n<12&&i>=12&&(a=a.next(()=>{(function(l){let d=l.createObjectStore("documentOverlays",{keyPath:cp});d.createIndex("collectionPathOverlayIndex",lp,{unique:!1}),d.createIndex("collectionGroupOverlayIndex",hp,{unique:!1})})(t)})),n<13&&i>=13&&(a=a.next(()=>function(l){let d=l.createObjectStore("remoteDocumentsV14",{keyPath:Xg});d.createIndex("documentKeyIndex",Zg),d.createIndex("collectionGroupIndex",tp)}(t)).next(()=>this._i(t,s)).next(()=>t.deleteObjectStore("remoteDocuments"))),n<14&&i>=14&&(a=a.next(()=>this.ai(t,s))),n<15&&i>=15&&(a=a.next(()=>function(l){l.createObjectStore("indexConfiguration",{keyPath:"indexId",autoIncrement:!0}).createIndex("collectionGroupIndex","collectionGroup",{unique:!1}),l.createObjectStore("indexState",{keyPath:sp}).createIndex("sequenceNumberIndex",op,{unique:!1}),l.createObjectStore("indexEntries",{keyPath:ap}).createIndex("documentKeyIndex",up,{unique:!1})}(t))),n<16&&i>=16&&(a=a.next(()=>{e.objectStore("indexState").clear()}).next(()=>{e.objectStore("indexEntries").clear()})),n<17&&i>=17&&(a=a.next(()=>{(function(l){l.createObjectStore("globals",{keyPath:"name"})})(t)})),a}ri(t){let e=0;return t.store("remoteDocuments").J((n,i)=>{e+=Ts(i)}).next(()=>{let n={byteSize:e};return t.store("remoteDocumentGlobal").put("remoteDocumentGlobalKey",n)})}ni(t){let e=t.store("mutationQueues"),n=t.store("mutations");return e.U().next(i=>b.forEach(i,s=>{let a=IDBKeyRange.bound([s.userId,-1],[s.userId,s.lastAcknowledgedBatchId]);return n.U("userMutationsIndex",a).next(u=>b.forEach(u,l=>{q(l.userId===s.userId);let d=Ze(this.serializer,l);return Bf(t,s.userId,d).next(()=>{})}))}))}ii(t){let e=t.store("targetDocuments"),n=t.store("remoteDocuments");return t.store("targetGlobal").get("targetGlobalKey").next(i=>{let s=[];return n.J((a,u)=>{let l=new Y(a),d=function(g){return[0,kt(g)]}(l);s.push(e.get(d).next(f=>f?b.resolve():(g=>e.put({targetId:0,path:kt(g),sequenceNumber:i.highestListenSequenceNumber}))(l)))}).next(()=>b.waitFor(s))})}si(t,e){t.createObjectStore("collectionParents",{keyPath:ip});let n=e.store("collectionParents"),i=new ai,s=a=>{if(i.add(a)){let u=a.lastSegment(),l=a.popLast();return n.put({collectionId:u,parent:kt(l)})}};return e.store("remoteDocuments").J({H:!0},(a,u)=>{let l=new Y(a);return s(l.popLast())}).next(()=>e.store("documentMutations").J({H:!0},([a,u,l],d)=>{let f=Zt(u);return s(f.popLast())}))}oi(t){let e=t.store("targets");return e.J((n,i)=>{let s=jr(i),a=Lf(this.serializer,s);return e.put(a)})}_i(t,e){let n=e.store("remoteDocuments"),i=[];return n.J((s,a)=>{let u=e.store("remoteDocumentsV14"),l=function(g){return g.document?new M(Y.fromString(g.document.name).popFirst(5)):g.noDocument?M.fromSegments(g.noDocument.path):g.unknownDocument?M.fromSegments(g.unknownDocument.path):L()}(a).path.toArray(),d={prefixPath:l.slice(0,l.length-2),collectionGroup:l[l.length-2],documentId:l[l.length-1],readTime:a.readTime||[0,0],unknownDocument:a.unknownDocument,noDocument:a.noDocument,document:a.document,hasCommittedMutations:!!a.hasCommittedMutations};i.push(u.put(d))}).next(()=>b.waitFor(i))}ai(t,e){let n=e.store("mutations"),i=zf(this.serializer),s=new bs(Rs.Zr,this.serializer.ct);return n.U().next(a=>{let u=new Map;return a.forEach(l=>{var d;let f=(d=u.get(l.userId))!==null&&d!==void 0?d:$();Ze(this.serializer,l).keys().forEach(g=>f=f.add(g)),u.set(l.userId,f)}),b.forEach(u,(l,d)=>{let f=new yt(d),g=ws.lt(this.serializer,f),_=s.getIndexManager(f),S=Es.lt(f,this.serializer,_,s.referenceDelegate);return new Ss(i,S,g,_).recalculateAndSaveOverlaysForDocumentKeys(new Jr(e,qt.oe),l).next()})})}};function Ad(r){r.createObjectStore("targetDocuments",{keyPath:np}).createIndex("documentTargetsIndex",rp,{unique:!0}),r.createObjectStore("targets",{keyPath:"targetId"}).createIndex("queryTargetsIndex",ep,{unique:!0}),r.createObjectStore("targetGlobal")}var na="Failed to obtain exclusive access to the persistence layer. To allow shared access, multi-tab synchronization has to be enabled in all tabs. If you are using `experimentalForceOwningTab:true`, make sure that only one tab has persistence enabled at any given time.",gu=class r{constructor(t,e,n,i,s,a,u,l,d,f,g=17){if(this.allowTabSynchronization=t,this.persistenceKey=e,this.clientId=n,this.ui=s,this.window=a,this.document=u,this.ci=d,this.li=f,this.hi=g,this.Qr=null,this.Kr=!1,this.isPrimary=!1,this.networkEnabled=!0,this.Pi=null,this.inForeground=!1,this.Ii=null,this.Ti=null,this.Ei=Number.NEGATIVE_INFINITY,this.di=_=>Promise.resolve(),!r.D())throw new x(P.UNIMPLEMENTED,"This platform is either missing IndexedDB or is known to have an incomplete implementation. Offline persistence has been disabled.");this.referenceDelegate=new nu(this,i),this.Ai=e+"main",this.serializer=new _s(l),this.Ri=new ke(this.Ai,this.hi,new mu(this.serializer)),this.$r=new Ga,this.Ur=new Xa(this.referenceDelegate,this.serializer),this.remoteDocumentCache=zf(this.serializer),this.Gr=new ja,this.window&&this.window.localStorage?this.Vi=this.window.localStorage:(this.Vi=null,f===!1&&dt("IndexedDbPersistence","LocalStorage is unavailable. As a result, persistence may not work reliably. In particular enablePersistence() could fail immediately after refreshing the page."))}start(){return this.mi().then(()=>{if(!this.isPrimary&&!this.allowTabSynchronization)throw new x(P.FAILED_PRECONDITION,na);return this.fi(),this.gi(),this.pi(),this.runTransaction("getHighestListenSequenceNumber","readonly",t=>this.Ur.getHighestSequenceNumber(t))}).then(t=>{this.Qr=new qt(t,this.ci)}).then(()=>{this.Kr=!0}).catch(t=>(this.Ri&&this.Ri.close(),Promise.reject(t)))}yi(t){return this.di=e=>V(this,null,function*(){if(this.started)return t(e)}),t(this.isPrimary)}setDatabaseDeletedListener(t){this.Ri.L(e=>V(this,null,function*(){e.newVersion===null&&(yield t())}))}setNetworkEnabled(t){this.networkEnabled!==t&&(this.networkEnabled=t,this.ui.enqueueAndForget(()=>V(this,null,function*(){this.started&&(yield this.mi())})))}mi(){return this.runTransaction("updateClientMetadataAndTryBecomePrimary","readwrite",t=>Hi(t).put({clientId:this.clientId,updateTimeMs:Date.now(),networkEnabled:this.networkEnabled,inForeground:this.inForeground}).next(()=>{if(this.isPrimary)return this.wi(t).next(e=>{e||(this.isPrimary=!1,this.ui.enqueueRetryable(()=>this.di(!1)))})}).next(()=>this.Si(t)).next(e=>this.isPrimary&&!e?this.bi(t).next(()=>!1):!!e&&this.Di(t).next(()=>!0))).catch(t=>{if(ze(t))return C("IndexedDbPersistence","Failed to extend owner lease: ",t),this.isPrimary;if(!this.allowTabSynchronization)throw t;return C("IndexedDbPersistence","Releasing owner lease after error during lease refresh",t),!1}).then(t=>{this.isPrimary!==t&&this.ui.enqueueRetryable(()=>this.di(t)),this.isPrimary=t})}wi(t){return Ur(t).get("owner").next(e=>b.resolve(this.vi(e)))}Ci(t){return Hi(t).delete(this.clientId)}Fi(){return V(this,null,function*(){if(this.isPrimary&&!this.Mi(this.Ei,18e5)){this.Ei=Date.now();let t=yield this.runTransaction("maybeGarbageCollectMultiClientState","readwrite-primary",e=>{let n=It(e,"clientMetadata");return n.U().next(i=>{let s=this.xi(i,18e5),a=i.filter(u=>s.indexOf(u)===-1);return b.forEach(a,u=>n.delete(u.clientId)).next(()=>a)})}).catch(()=>[]);if(this.Vi)for(let e of t)this.Vi.removeItem(this.Oi(e.clientId))}})}pi(){this.Ti=this.ui.enqueueAfterDelay("client_metadata_refresh",4e3,()=>this.mi().then(()=>this.Fi()).then(()=>this.pi()))}vi(t){return!!t&&t.ownerId===this.clientId}Si(t){return this.li?b.resolve(!0):Ur(t).get("owner").next(e=>{if(e!==null&&this.Mi(e.leaseTimestampMs,5e3)&&!this.Ni(e.ownerId)){if(this.vi(e)&&this.networkEnabled)return!0;if(!this.vi(e)){if(!e.allowTabSynchronization)throw new x(P.FAILED_PRECONDITION,na);return!1}}return!(!this.networkEnabled||!this.inForeground)||Hi(t).U().next(n=>this.xi(n,5e3).find(i=>{if(this.clientId!==i.clientId){let s=!this.networkEnabled&&i.networkEnabled,a=!this.inForeground&&i.inForeground,u=this.networkEnabled===i.networkEnabled;if(s||a&&u)return!0}return!1})===void 0)}).next(e=>(this.isPrimary!==e&&C("IndexedDbPersistence",`Client ${e?"is":"is not"} eligible for a primary lease.`),e))}shutdown(){return V(this,null,function*(){this.Kr=!1,this.Li(),this.Ti&&(this.Ti.cancel(),this.Ti=null),this.Bi(),this.ki(),yield this.Ri.runTransaction("shutdown","readwrite",["owner","clientMetadata"],t=>{let e=new Jr(t,qt.oe);return this.bi(e).next(()=>this.Ci(e))}),this.Ri.close(),this.qi()})}xi(t,e){return t.filter(n=>this.Mi(n.updateTimeMs,e)&&!this.Ni(n.clientId))}Qi(){return this.runTransaction("getActiveClients","readonly",t=>Hi(t).U().next(e=>this.xi(e,18e5).map(n=>n.clientId)))}get started(){return this.Kr}getGlobalsCache(){return this.$r}getMutationQueue(t,e){return Es.lt(t,this.serializer,e,this.referenceDelegate)}getTargetCache(){return this.Ur}getRemoteDocumentCache(){return this.remoteDocumentCache}getIndexManager(t){return new Ya(t,this.serializer.ct.databaseId)}getDocumentOverlayCache(t){return ws.lt(this.serializer,t)}getBundleCache(){return this.Gr}runTransaction(t,e,n){C("IndexedDbPersistence","Starting transaction:",t);let i=e==="readonly"?"readonly":"readwrite",s=function(l){return l===17?mp:l===16?fp:l===15?uc:l===14?Jd:l===13?Hd:l===12?dp:l===11?Wd:void L()}(this.hi),a;return this.Ri.runTransaction(t,i,s,u=>(a=new Jr(u,this.Qr?this.Qr.next():qt.oe),e==="readwrite-primary"?this.wi(a).next(l=>!!l||this.Si(a)).next(l=>{if(!l)throw dt(`Failed to obtain primary lease for action '${t}'.`),this.isPrimary=!1,this.ui.enqueueRetryable(()=>this.di(!1)),new x(P.FAILED_PRECONDITION,zd);return n(a)}).next(l=>this.Di(a).next(()=>l)):this.Ki(a).next(()=>n(a)))).then(u=>(a.raiseOnCommittedEvent(),u))}Ki(t){return Ur(t).get("owner").next(e=>{if(e!==null&&this.Mi(e.leaseTimestampMs,5e3)&&!this.Ni(e.ownerId)&&!this.vi(e)&&!(this.li||this.allowTabSynchronization&&e.allowTabSynchronization))throw new x(P.FAILED_PRECONDITION,na)})}Di(t){let e={ownerId:this.clientId,allowTabSynchronization:this.allowTabSynchronization,leaseTimestampMs:Date.now()};return Ur(t).put("owner",e)}static D(){return ke.D()}bi(t){let e=Ur(t);return e.get("owner").next(n=>this.vi(n)?(C("IndexedDbPersistence","Releasing primary lease."),e.delete("owner")):b.resolve())}Mi(t,e){let n=Date.now();return!(t<n-e)&&(!(t>n)||(dt(`Detected an update time that is in the future: ${t} > ${n}`),!1))}fi(){this.document!==null&&typeof this.document.addEventListener=="function"&&(this.Ii=()=>{this.ui.enqueueAndForget(()=>(this.inForeground=this.document.visibilityState==="visible",this.mi()))},this.document.addEventListener("visibilitychange",this.Ii),this.inForeground=this.document.visibilityState==="visible")}Bi(){this.Ii&&(this.document.removeEventListener("visibilitychange",this.Ii),this.Ii=null)}gi(){var t;typeof((t=this.window)===null||t===void 0?void 0:t.addEventListener)=="function"&&(this.Pi=()=>{this.Li();let e=/(?:Version|Mobile)\/1[456]/;Ko()&&(navigator.appVersion.match(e)||navigator.userAgent.match(e))&&this.ui.enterRestrictedMode(!0),this.ui.enqueueAndForget(()=>this.shutdown())},this.window.addEventListener("pagehide",this.Pi))}ki(){this.Pi&&(this.window.removeEventListener("pagehide",this.Pi),this.Pi=null)}Ni(t){var e;try{let n=((e=this.Vi)===null||e===void 0?void 0:e.getItem(this.Oi(t)))!==null;return C("IndexedDbPersistence",`Client '${t}' ${n?"is":"is not"} zombied in LocalStorage`),n}catch(n){return dt("IndexedDbPersistence","Failed to get zombied client id.",n),!1}}Li(){if(this.Vi)try{this.Vi.setItem(this.Oi(this.clientId),String(Date.now()))}catch(t){dt("Failed to set zombie client id.",t)}}qi(){if(this.Vi)try{this.Vi.removeItem(this.Oi(this.clientId))}catch{}}Oi(t){return`firestore_zombie_${this.persistenceKey}_${t}`}};function Ur(r){return It(r,"owner")}function Hi(r){return It(r,"clientMetadata")}function _c(r,t){let e=r.projectId;return r.isDefaultDatabase||(e+="."+r.database),"firestore/"+t+"/"+e+"/"}var pu=class r{constructor(t,e,n,i){this.targetId=t,this.fromCache=e,this.$i=n,this.Ui=i}static Wi(t,e){let n=$(),i=$();for(let s of e.docChanges)switch(s.type){case 0:n=n.add(s.doc.key);break;case 1:i=i.add(s.doc.key)}return new r(t,e.fromCache,n,i)}};var _u=class{constructor(){this._documentReadCount=0}get documentReadCount(){return this._documentReadCount}incrementDocumentReadCount(t){this._documentReadCount+=t}};var Ps=class{constructor(){this.Gi=!1,this.zi=!1,this.ji=100,this.Hi=function(){return Ko()?8:Kd(Fr())>0?6:4}()}initialize(t,e){this.Ji=t,this.indexManager=e,this.Gi=!0}getDocumentsMatchingQuery(t,e,n,i){let s={result:null};return this.Yi(t,e).next(a=>{s.result=a}).next(()=>{if(!s.result)return this.Zi(t,e,i,n).next(a=>{s.result=a})}).next(()=>{if(s.result)return;let a=new _u;return this.Xi(t,e,a).next(u=>{if(s.result=u,this.zi)return this.es(t,e,a,u.size)})}).next(()=>s.result)}es(t,e,n,i){return n.documentReadCount<this.ji?(Dn()<=Xt.DEBUG&&C("QueryEngine","SDK will not create cache indexes for query:",Nn(e),"since it only creates cache indexes for collection contains","more than or equal to",this.ji,"documents"),b.resolve()):(Dn()<=Xt.DEBUG&&C("QueryEngine","Query:",Nn(e),"scans",n.documentReadCount,"local documents and returns",i,"documents as results."),n.documentReadCount>this.Hi*i?(Dn()<=Xt.DEBUG&&C("QueryEngine","The SDK decides to create cache indexes for query:",Nn(e),"as using cache indexes may help improve performance."),this.indexManager.createTargetIndexes(t,Ft(e))):b.resolve())}Yi(t,e){if(Yh(e))return b.resolve(null);let n=Ft(e);return this.indexManager.getIndexType(t,n).next(i=>i===0?null:(e.limit!==null&&i===1&&(e=fs(e,null,"F"),n=Ft(e)),this.indexManager.getDocumentsMatchingTarget(t,n).next(s=>{let a=$(...s);return this.Ji.getDocuments(t,a).next(u=>this.indexManager.getMinOffset(t,n).next(l=>{let d=this.ts(e,u);return this.ns(e,d,a,l.readTime)?this.Yi(t,fs(e,null,"F")):this.rs(t,d,e,l)}))})))}Zi(t,e,n,i){return Yh(e)||i.isEqual(B.min())?b.resolve(null):this.Ji.getDocuments(t,n).next(s=>{let a=this.ts(e,s);return this.ns(e,a,n,i)?b.resolve(null):(Dn()<=Xt.DEBUG&&C("QueryEngine","Re-using previous result from %s to execute query: %s",i.toString(),Nn(e)),this.rs(t,a,e,jd(i,-1)).next(u=>u))})}ts(t,e){let n=new nt(hf(t));return e.forEach((i,s)=>{yi(t,s)&&(n=n.add(s))}),n}ns(t,e,n,i){if(t.limit===null)return!1;if(n.size!==e.size)return!0;let s=t.limitType==="F"?e.last():e.first();return!!s&&(s.hasPendingWrites||s.version.compareTo(i)>0)}Xi(t,e,n){return Dn()<=Xt.DEBUG&&C("QueryEngine","Using full collection scan to execute query:",Nn(e)),this.Ji.getDocumentsMatchingQuery(t,e,Gt.min(),n)}rs(t,e,n,i){return this.Ji.getDocumentsMatchingQuery(t,n,i).next(s=>(e.forEach(a=>{s=s.insert(a.key,a)}),s))}};var yu=class{constructor(t,e,n,i){this.persistence=t,this.ss=e,this.serializer=i,this.os=new st(z),this._s=new oe(s=>un(s),pi),this.us=new Map,this.cs=t.getRemoteDocumentCache(),this.Ur=t.getTargetCache(),this.Gr=t.getBundleCache(),this.ls(n)}ls(t){this.documentOverlayCache=this.persistence.getDocumentOverlayCache(t),this.indexManager=this.persistence.getIndexManager(t),this.mutationQueue=this.persistence.getMutationQueue(t,this.indexManager),this.localDocuments=new Ss(this.cs,this.mutationQueue,this.documentOverlayCache,this.indexManager),this.cs.setIndexManager(this.indexManager),this.ss.initialize(this.localDocuments,this.indexManager)}collectGarbage(t){return this.persistence.runTransaction("Collect garbage","readwrite-primary",e=>t.collect(e,this.os))}};function Kf(r,t,e,n){return new yu(r,t,e,n)}function $f(r,t){return V(this,null,function*(){let e=O(r);return yield e.persistence.runTransaction("Handle user change","readonly",n=>{let i;return e.mutationQueue.getAllMutationBatches(n).next(s=>(i=s,e.ls(t),e.mutationQueue.getAllMutationBatches(n))).next(s=>{let a=[],u=[],l=$();for(let d of i){a.push(d.batchId);for(let f of d.mutations)l=l.add(f.key)}for(let d of s){u.push(d.batchId);for(let f of d.mutations)l=l.add(f.key)}return e.localDocuments.getDocuments(n,l).next(d=>({hs:d,removedBatchIds:a,addedBatchIds:u}))})})})}function Qp(r,t){let e=O(r);return e.persistence.runTransaction("Acknowledge batch","readwrite-primary",n=>{let i=t.batch.keys(),s=e.cs.newChangeBuffer({trackRemovals:!0});return function(u,l,d,f){let g=d.batch,_=g.keys(),S=b.resolve();return _.forEach(N=>{S=S.next(()=>f.getEntry(l,N)).next(k=>{let D=d.docVersions.get(N);q(D!==null),k.version.compareTo(D)<0&&(g.applyToRemoteDocument(k,d),k.isValidDocument()&&(k.setReadTime(d.commitVersion),f.addEntry(k)))})}),S.next(()=>u.mutationQueue.removeMutationBatch(l,g))}(e,n,t,s).next(()=>s.apply(n)).next(()=>e.mutationQueue.performConsistencyCheck(n)).next(()=>e.documentOverlayCache.removeOverlaysForBatchId(n,i,t.batch.batchId)).next(()=>e.localDocuments.recalculateAndSaveOverlaysForDocumentKeys(n,function(u){let l=$();for(let d=0;d<u.mutationResults.length;++d)u.mutationResults[d].transformResults.length>0&&(l=l.add(u.batch.mutations[d].key));return l}(t))).next(()=>e.localDocuments.getDocuments(n,i))})}function Qf(r){let t=O(r);return t.persistence.runTransaction("Get last remote snapshot version","readonly",e=>t.Ur.getLastRemoteSnapshotVersion(e))}function Wp(r,t){let e=O(r),n=t.snapshotVersion,i=e.os;return e.persistence.runTransaction("Apply remote event","readwrite-primary",s=>{let a=e.cs.newChangeBuffer({trackRemovals:!0});i=e.os;let u=[];t.targetChanges.forEach((f,g)=>{let _=i.get(g);if(!_)return;u.push(e.Ur.removeMatchingKeys(s,f.removedDocuments,g).next(()=>e.Ur.addMatchingKeys(s,f.addedDocuments,g)));let S=_.withSequenceNumber(s.currentSequenceNumber);t.targetMismatches.get(g)!==null?S=S.withResumeToken(gt.EMPTY_BYTE_STRING,B.min()).withLastLimboFreeSnapshotVersion(B.min()):f.resumeToken.approximateByteSize()>0&&(S=S.withResumeToken(f.resumeToken,n)),i=i.insert(g,S),function(k,D,j){return k.resumeToken.approximateByteSize()===0||D.snapshotVersion.toMicroseconds()-k.snapshotVersion.toMicroseconds()>=3e8?!0:j.addedDocuments.size+j.modifiedDocuments.size+j.removedDocuments.size>0}(_,S,f)&&u.push(e.Ur.updateTargetData(s,S))});let l=Mt(),d=$();if(t.documentUpdates.forEach(f=>{t.resolvedLimboDocuments.has(f)&&u.push(e.persistence.referenceDelegate.updateLimboDocument(s,f))}),u.push(Wf(s,a,t.documentUpdates).next(f=>{l=f.Ps,d=f.Is})),!n.isEqual(B.min())){let f=e.Ur.getLastRemoteSnapshotVersion(s).next(g=>e.Ur.setTargetsMetadata(s,s.currentSequenceNumber,n));u.push(f)}return b.waitFor(u).next(()=>a.apply(s)).next(()=>e.localDocuments.getLocalViewOfDocuments(s,l,d)).next(()=>l)}).then(s=>(e.os=i,s))}function Wf(r,t,e){let n=$(),i=$();return e.forEach(s=>n=n.add(s)),t.getEntries(r,n).next(s=>{let a=Mt();return e.forEach((u,l)=>{let d=s.get(u);l.isFoundDocument()!==d.isFoundDocument()&&(i=i.add(u)),l.isNoDocument()&&l.version.isEqual(B.min())?(t.removeEntry(u,l.readTime),a=a.insert(u,l)):!d.isValidDocument()||l.version.compareTo(d.version)>0||l.version.compareTo(d.version)===0&&d.hasPendingWrites?(t.addEntry(l),a=a.insert(u,l)):C("LocalStore","Ignoring outdated watch update for ",u,". Current version:",d.version," Watch version:",l.version)}),{Ps:a,Is:i}})}function Hp(r,t){let e=O(r);return e.persistence.runTransaction("Get next mutation batch","readonly",n=>(t===void 0&&(t=-1),e.mutationQueue.getNextMutationBatchAfterBatchId(n,t)))}function Jn(r,t){let e=O(r);return e.persistence.runTransaction("Allocate target","readwrite",n=>{let i;return e.Ur.getTargetData(n,t).next(s=>s?(i=s,b.resolve(i)):e.Ur.allocateTargetId(n).next(a=>(i=new Wn(t,a,"TargetPurposeListen",n.currentSequenceNumber),e.Ur.addTargetData(n,i).next(()=>i))))}).then(n=>{let i=e.os.get(n.targetId);return(i===null||n.snapshotVersion.compareTo(i.snapshotVersion)>0)&&(e.os=e.os.insert(n.targetId,n),e._s.set(t,n.targetId)),n})}function Yn(r,t,e){return V(this,null,function*(){let n=O(r),i=n.os.get(t),s=e?"readwrite":"readwrite-primary";try{e||(yield n.persistence.runTransaction("Release target",s,a=>n.persistence.referenceDelegate.removeTarget(a,i)))}catch(a){if(!ze(a))throw a;C("LocalStore",`Failed to update sequence numbers for target ${t}: ${a}`)}n.os=n.os.remove(t),n._s.delete(i.target)})}function Vs(r,t,e){let n=O(r),i=B.min(),s=$();return n.persistence.runTransaction("Execute query","readwrite",a=>function(l,d,f){let g=O(l),_=g._s.get(f);return _!==void 0?b.resolve(g.os.get(_)):g.Ur.getTargetData(d,f)}(n,a,Ft(t)).next(u=>{if(u)return i=u.lastLimboFreeSnapshotVersion,n.Ur.getMatchingKeysForTargetId(a,u.targetId).next(l=>{s=l})}).next(()=>n.ss.getDocumentsMatchingQuery(a,t,e?i:B.min(),e?s:$())).next(u=>(Yf(n,lf(t),u),{documents:u,Ts:s})))}function Hf(r,t){let e=O(r),n=O(e.Ur),i=e.os.get(t);return i?Promise.resolve(i.target):e.persistence.runTransaction("Get target data","readonly",s=>n.ot(s,t).next(a=>a?a.target:null))}function Jf(r,t){let e=O(r),n=e.us.get(t)||B.min();return e.persistence.runTransaction("Get new document changes","readonly",i=>e.cs.getAllFromCollectionGroup(i,t,jd(n,-1),Number.MAX_SAFE_INTEGER)).then(i=>(Yf(e,t,i),i))}function Yf(r,t,e){let n=r.us.get(t)||B.min();e.forEach((i,s)=>{s.readTime.compareTo(n)>0&&(n=s.readTime)}),r.us.set(t,n)}function Jp(r,t,e,n){return V(this,null,function*(){let i=O(r),s=$(),a=Mt();for(let d of e){let f=t.Es(d.metadata.name);d.document&&(s=s.add(f));let g=t.ds(d);g.setReadTime(t.As(d.metadata.readTime)),a=a.insert(f,g)}let u=i.cs.newChangeBuffer({trackRemovals:!0}),l=yield Jn(i,function(f){return Ft(sr(Y.fromString(`__bundle__/docs/${f}`)))}(n));return i.persistence.runTransaction("Apply bundle documents","readwrite",d=>Wf(d,u,a).next(f=>(u.apply(d),f)).next(f=>i.Ur.removeMatchingKeysForTargetId(d,l.targetId).next(()=>i.Ur.addMatchingKeys(d,s,l.targetId)).next(()=>i.localDocuments.getLocalViewOfDocuments(d,f.Ps,f.Is)).next(()=>f.Ps)))})}function Yp(n,i){return V(this,arguments,function*(r,t,e=$()){let s=yield Jn(r,Ft(gc(t.bundledQuery))),a=O(r);return a.persistence.runTransaction("Save named query","readwrite",u=>{let l=mt(t.readTime);if(s.snapshotVersion.compareTo(l)>=0)return a.Gr.saveNamedQuery(u,t);let d=s.withResumeToken(gt.EMPTY_BYTE_STRING,l);return a.os=a.os.insert(d.targetId,d),a.Ur.updateTargetData(u,d).next(()=>a.Ur.removeMatchingKeysForTargetId(u,s.targetId)).next(()=>a.Ur.addMatchingKeys(u,e,s.targetId)).next(()=>a.Gr.saveNamedQuery(u,t))})})}function Sd(r,t){return`firestore_clients_${r}_${t}`}function bd(r,t,e){let n=`firestore_mutations_${r}_${e}`;return t.isAuthenticated()&&(n+=`_${t.uid}`),n}function ra(r,t){return`firestore_targets_${r}_${t}`}var xs=class r{constructor(t,e,n,i){this.user=t,this.batchId=e,this.state=n,this.error=i}static Rs(t,e,n){let i=JSON.parse(n),s,a=typeof i=="object"&&["pending","acknowledged","rejected"].indexOf(i.state)!==-1&&(i.error===void 0||typeof i.error=="object");return a&&i.error&&(a=typeof i.error.message=="string"&&typeof i.error.code=="string",a&&(s=new x(i.error.code,i.error.message))),a?new r(t,e,i.state,s):(dt("SharedClientState",`Failed to parse mutation state for ID '${e}': ${n}`),null)}Vs(){let t={state:this.state,updateTimeMs:Date.now()};return this.error&&(t.error={code:this.error.code,message:this.error.message}),JSON.stringify(t)}},$r=class r{constructor(t,e,n){this.targetId=t,this.state=e,this.error=n}static Rs(t,e){let n=JSON.parse(e),i,s=typeof n=="object"&&["not-current","current","rejected"].indexOf(n.state)!==-1&&(n.error===void 0||typeof n.error=="object");return s&&n.error&&(s=typeof n.error.message=="string"&&typeof n.error.code=="string",s&&(i=new x(n.error.code,n.error.message))),s?new r(t,n.state,i):(dt("SharedClientState",`Failed to parse target state for ID '${t}': ${e}`),null)}Vs(){let t={state:this.state,updateTimeMs:Date.now()};return this.error&&(t.error={code:this.error.code,message:this.error.message}),JSON.stringify(t)}},Cs=class r{constructor(t,e){this.clientId=t,this.activeTargetIds=e}static Rs(t,e){let n=JSON.parse(e),i=typeof n=="object"&&n.activeTargetIds instanceof Array,s=dc();for(let a=0;i&&a<n.activeTargetIds.length;++a)i=$d(n.activeTargetIds[a]),s=s.add(n.activeTargetIds[a]);return i?new r(t,s):(dt("SharedClientState",`Failed to parse client data for instance '${t}': ${e}`),null)}},wu=class r{constructor(t,e){this.clientId=t,this.onlineState=e}static Rs(t){let e=JSON.parse(t);return typeof e=="object"&&["Unknown","Online","Offline"].indexOf(e.onlineState)!==-1&&typeof e.clientId=="string"?new r(e.clientId,e.onlineState):(dt("SharedClientState",`Failed to parse online state: ${t}`),null)}},ci=class{constructor(){this.activeTargetIds=dc()}fs(t){this.activeTargetIds=this.activeTargetIds.add(t)}gs(t){this.activeTargetIds=this.activeTargetIds.delete(t)}Vs(){let t={activeTargetIds:this.activeTargetIds.toArray(),updateTimeMs:Date.now()};return JSON.stringify(t)}},Qr=class{constructor(t,e,n,i,s){this.window=t,this.ui=e,this.persistenceKey=n,this.ps=i,this.syncEngine=null,this.onlineStateHandler=null,this.sequenceNumberHandler=null,this.ys=this.ws.bind(this),this.Ss=new st(z),this.started=!1,this.bs=[];let a=n.replace(/[.*+?^${}()|[\]\\]/g,"\\$&");this.storage=this.window.localStorage,this.currentUser=s,this.Ds=Sd(this.persistenceKey,this.ps),this.vs=function(l){return`firestore_sequence_number_${l}`}(this.persistenceKey),this.Ss=this.Ss.insert(this.ps,new ci),this.Cs=new RegExp(`^firestore_clients_${a}_([^_]*)$`),this.Fs=new RegExp(`^firestore_mutations_${a}_(\\d+)(?:_(.*))?$`),this.Ms=new RegExp(`^firestore_targets_${a}_(\\d+)$`),this.xs=function(l){return`firestore_online_state_${l}`}(this.persistenceKey),this.Os=function(l){return`firestore_bundle_loaded_v2_${l}`}(this.persistenceKey),this.window.addEventListener("storage",this.ys)}static D(t){return!(!t||!t.localStorage)}start(){return V(this,null,function*(){let t=yield this.syncEngine.Qi();for(let n of t){if(n===this.ps)continue;let i=this.getItem(Sd(this.persistenceKey,n));if(i){let s=Cs.Rs(n,i);s&&(this.Ss=this.Ss.insert(s.clientId,s))}}this.Ns();let e=this.storage.getItem(this.xs);if(e){let n=this.Ls(e);n&&this.Bs(n)}for(let n of this.bs)this.ws(n);this.bs=[],this.window.addEventListener("pagehide",()=>this.shutdown()),this.started=!0})}writeSequenceNumber(t){this.setItem(this.vs,JSON.stringify(t))}getAllActiveQueryTargets(){return this.ks(this.Ss)}isActiveQueryTarget(t){let e=!1;return this.Ss.forEach((n,i)=>{i.activeTargetIds.has(t)&&(e=!0)}),e}addPendingMutation(t){this.qs(t,"pending")}updateMutationState(t,e,n){this.qs(t,e,n),this.Qs(t)}addLocalQueryTarget(t,e=!0){let n="not-current";if(this.isActiveQueryTarget(t)){let i=this.storage.getItem(ra(this.persistenceKey,t));if(i){let s=$r.Rs(t,i);s&&(n=s.state)}}return e&&this.Ks.fs(t),this.Ns(),n}removeLocalQueryTarget(t){this.Ks.gs(t),this.Ns()}isLocalQueryTarget(t){return this.Ks.activeTargetIds.has(t)}clearQueryState(t){this.removeItem(ra(this.persistenceKey,t))}updateQueryState(t,e,n){this.$s(t,e,n)}handleUserChange(t,e,n){e.forEach(i=>{this.Qs(i)}),this.currentUser=t,n.forEach(i=>{this.addPendingMutation(i)})}setOnlineState(t){this.Us(t)}notifyBundleLoaded(t){this.Ws(t)}shutdown(){this.started&&(this.window.removeEventListener("storage",this.ys),this.removeItem(this.Ds),this.started=!1)}getItem(t){let e=this.storage.getItem(t);return C("SharedClientState","READ",t,e),e}setItem(t,e){C("SharedClientState","SET",t,e),this.storage.setItem(t,e)}removeItem(t){C("SharedClientState","REMOVE",t),this.storage.removeItem(t)}ws(t){let e=t;if(e.storageArea===this.storage){if(C("SharedClientState","EVENT",e.key,e.newValue),e.key===this.Ds)return void dt("Received WebStorage notification for local change. Another client might have garbage-collected our state");this.ui.enqueueRetryable(()=>V(this,null,function*(){if(this.started){if(e.key!==null){if(this.Cs.test(e.key)){if(e.newValue==null){let n=this.Gs(e.key);return this.zs(n,null)}{let n=this.js(e.key,e.newValue);if(n)return this.zs(n.clientId,n)}}else if(this.Fs.test(e.key)){if(e.newValue!==null){let n=this.Hs(e.key,e.newValue);if(n)return this.Js(n)}}else if(this.Ms.test(e.key)){if(e.newValue!==null){let n=this.Ys(e.key,e.newValue);if(n)return this.Zs(n)}}else if(e.key===this.xs){if(e.newValue!==null){let n=this.Ls(e.newValue);if(n)return this.Bs(n)}}else if(e.key===this.vs){let n=function(s){let a=qt.oe;if(s!=null)try{let u=JSON.parse(s);q(typeof u=="number"),a=u}catch(u){dt("SharedClientState","Failed to read sequence number from WebStorage",u)}return a}(e.newValue);n!==qt.oe&&this.sequenceNumberHandler(n)}else if(e.key===this.Os){let n=this.Xs(e.newValue);yield Promise.all(n.map(i=>this.syncEngine.eo(i)))}}}else this.bs.push(e)}))}}get Ks(){return this.Ss.get(this.ps)}Ns(){this.setItem(this.Ds,this.Ks.Vs())}qs(t,e,n){let i=new xs(this.currentUser,t,e,n),s=bd(this.persistenceKey,this.currentUser,t);this.setItem(s,i.Vs())}Qs(t){let e=bd(this.persistenceKey,this.currentUser,t);this.removeItem(e)}Us(t){let e={clientId:this.ps,onlineState:t};this.storage.setItem(this.xs,JSON.stringify(e))}$s(t,e,n){let i=ra(this.persistenceKey,t),s=new $r(t,e,n);this.setItem(i,s.Vs())}Ws(t){let e=JSON.stringify(Array.from(t));this.setItem(this.Os,e)}Gs(t){let e=this.Cs.exec(t);return e?e[1]:null}js(t,e){let n=this.Gs(t);return Cs.Rs(n,e)}Hs(t,e){let n=this.Fs.exec(t),i=Number(n[1]),s=n[2]!==void 0?n[2]:null;return xs.Rs(new yt(s),i,e)}Ys(t,e){let n=this.Ms.exec(t),i=Number(n[1]);return $r.Rs(i,e)}Ls(t){return wu.Rs(t)}Xs(t){return JSON.parse(t)}Js(t){return V(this,null,function*(){if(t.user.uid===this.currentUser.uid)return this.syncEngine.no(t.batchId,t.state,t.error);C("SharedClientState",`Ignoring mutation for non-active user ${t.user.uid}`)})}Zs(t){return this.syncEngine.ro(t.targetId,t.state,t.error)}zs(t,e){let n=e?this.Ss.insert(t,e):this.Ss.remove(t),i=this.ks(this.Ss),s=this.ks(n),a=[],u=[];return s.forEach(l=>{i.has(l)||a.push(l)}),i.forEach(l=>{s.has(l)||u.push(l)}),this.syncEngine.io(a,u).then(()=>{this.Ss=n})}Bs(t){this.Ss.get(t.clientId)&&this.onlineStateHandler(t.onlineState)}ks(t){let e=dc();return t.forEach((n,i)=>{e=e.unionWith(i.activeTargetIds)}),e}},Ds=class{constructor(){this.so=new ci,this.oo={},this.onlineStateHandler=null,this.sequenceNumberHandler=null}addPendingMutation(t){}updateMutationState(t,e,n){}addLocalQueryTarget(t,e=!0){return e&&this.so.fs(t),this.oo[t]||"not-current"}updateQueryState(t,e,n){this.oo[t]=e}removeLocalQueryTarget(t){this.so.gs(t)}isLocalQueryTarget(t){return this.so.activeTargetIds.has(t)}clearQueryState(t){delete this.oo[t]}getAllActiveQueryTargets(){return this.so.activeTargetIds}isActiveQueryTarget(t){return this.so.activeTargetIds.has(t)}start(){return this.so=new ci,Promise.resolve()}handleUserChange(t,e,n){}setOnlineState(t){}shutdown(){}writeSequenceNumber(t){}notifyBundleLoaded(t){}};var vu=class{_o(t){}shutdown(){}};var Ns=class{constructor(){this.ao=()=>this.uo(),this.co=()=>this.lo(),this.ho=[],this.Po()}_o(t){this.ho.push(t)}shutdown(){window.removeEventListener("online",this.ao),window.removeEventListener("offline",this.co)}Po(){window.addEventListener("online",this.ao),window.addEventListener("offline",this.co)}uo(){C("ConnectivityMonitor","Network connectivity changed: AVAILABLE");for(let t of this.ho)t(0)}lo(){C("ConnectivityMonitor","Network connectivity changed: UNAVAILABLE");for(let t of this.ho)t(1)}static D(){return typeof window<"u"&&window.addEventListener!==void 0&&window.removeEventListener!==void 0}};var Ji=null;function ia(){return Ji===null?Ji=function(){return 268435456+Math.round(2147483648*Math.random())}():Ji++,"0x"+Ji.toString(16)}var Xp={BatchGetDocuments:"batchGet",Commit:"commit",RunQuery:"runQuery",RunAggregationQuery:"runAggregationQuery"};var Iu=class{constructor(t){this.Io=t.Io,this.To=t.To}Eo(t){this.Ao=t}Ro(t){this.Vo=t}mo(t){this.fo=t}onMessage(t){this.po=t}close(){this.To()}send(t){this.Io(t)}yo(){this.Ao()}wo(){this.Vo()}So(t){this.fo(t)}bo(t){this.po(t)}};var xt="WebChannelConnection",Tu=class extends class{constructor(e){this.databaseInfo=e,this.databaseId=e.databaseId;let n=e.ssl?"https":"http",i=encodeURIComponent(this.databaseId.projectId),s=encodeURIComponent(this.databaseId.database);this.Do=n+"://"+e.host,this.vo=`projects/${i}/databases/${s}`,this.Co=this.databaseId.database==="(default)"?`project_id=${i}`:`project_id=${i}&database_id=${s}`}get Fo(){return!1}Mo(e,n,i,s,a){let u=ia(),l=this.xo(e,n.toUriEncodedString());C("RestConnection",`Sending RPC '${e}' ${u}:`,l,i);let d={"google-cloud-resource-prefix":this.vo,"x-goog-request-params":this.Co};return this.Oo(d,s,a),this.No(e,l,d,i).then(f=>(C("RestConnection",`Received RPC '${e}' ${u}: `,f),f),f=>{throw Qt("RestConnection",`RPC '${e}' ${u} failed with error: `,f,"url: ",l,"request:",i),f})}Lo(e,n,i,s,a,u){return this.Mo(e,n,i,s,a)}Oo(e,n,i){e["X-Goog-Api-Client"]=function(){return"gl-js/ fire/"+ir}(),e["Content-Type"]="text/plain",this.databaseInfo.appId&&(e["X-Firebase-GMPID"]=this.databaseInfo.appId),n&&n.headers.forEach((s,a)=>e[a]=s),i&&i.headers.forEach((s,a)=>e[a]=s)}xo(e,n){let i=Xp[e];return`${this.Do}/v1/${n}:${i}`}terminate(){}}{constructor(t){super(t),this.forceLongPolling=t.forceLongPolling,this.autoDetectLongPolling=t.autoDetectLongPolling,this.useFetchStreams=t.useFetchStreams,this.longPollingOptions=t.longPollingOptions}No(t,e,n,i){let s=ia();return new Promise((a,u)=>{let l=new Jo;l.setWithCredentials(!0),l.listenOnce(Yo.COMPLETE,()=>{try{switch(l.getLastErrorCode()){case Or.NO_ERROR:let f=l.getResponseJson();C(xt,`XHR for RPC '${t}' ${s} received:`,JSON.stringify(f)),a(f);break;case Or.TIMEOUT:C(xt,`RPC '${t}' ${s} timed out`),u(new x(P.DEADLINE_EXCEEDED,"Request time out"));break;case Or.HTTP_ERROR:let g=l.getStatus();if(C(xt,`RPC '${t}' ${s} failed with status:`,g,"response text:",l.getResponseText()),g>0){let _=l.getResponseJson();Array.isArray(_)&&(_=_[0]);let S=_?.error;if(S&&S.status&&S.message){let N=function(D){let j=D.toLowerCase().replace(/_/g,"-");return Object.values(P).indexOf(j)>=0?j:P.UNKNOWN}(S.status);u(new x(N,S.message))}else u(new x(P.UNKNOWN,"Server responded with status "+l.getStatus()))}else u(new x(P.UNAVAILABLE,"Connection failed."));break;default:L()}}finally{C(xt,`RPC '${t}' ${s} completed.`)}});let d=JSON.stringify(i);C(xt,`RPC '${t}' ${s} sending request:`,i),l.send(e,"POST",d,n,15)})}Bo(t,e,n){let i=ia(),s=[this.Do,"/","google.firestore.v1.Firestore","/",t,"/channel"],a=ta(),u=Zo(),l={httpSessionIdParam:"gsessionid",initMessageHeaders:{},messageUrlParams:{database:`projects/${this.databaseId.projectId}/databases/${this.databaseId.database}`},sendRawJson:!0,supportsCrossDomainXhr:!0,internalChannelParams:{forwardChannelRequestTimeoutMs:6e5},forceLongPolling:this.forceLongPolling,detectBufferingProxy:this.autoDetectLongPolling},d=this.longPollingOptions.timeoutSeconds;d!==void 0&&(l.longPollingTimeout=Math.round(1e3*d)),this.useFetchStreams&&(l.useFetchStreams=!0),this.Oo(l.initMessageHeaders,e,n),l.encodeInitMessageHeaders=!0;let f=s.join("");C(xt,`Creating RPC '${t}' stream ${i}: ${f}`,l);let g=a.createWebChannel(f,l),_=!1,S=!1,N=new Iu({Io:D=>{S?C(xt,`Not sending because RPC '${t}' stream ${i} is closed:`,D):(_||(C(xt,`Opening RPC '${t}' stream ${i} transport.`),g.open(),_=!0),C(xt,`RPC '${t}' stream ${i} sending:`,D),g.send(D))},To:()=>g.close()}),k=(D,j,G)=>{D.listen(j,U=>{try{G(U)}catch(Q){setTimeout(()=>{throw Q},0)}})};return k(g,Rn.EventType.OPEN,()=>{S||(C(xt,`RPC '${t}' stream ${i} transport opened.`),N.yo())}),k(g,Rn.EventType.CLOSE,()=>{S||(S=!0,C(xt,`RPC '${t}' stream ${i} transport closed`),N.So())}),k(g,Rn.EventType.ERROR,D=>{S||(S=!0,Qt(xt,`RPC '${t}' stream ${i} transport errored:`,D),N.So(new x(P.UNAVAILABLE,"The operation could not be completed")))}),k(g,Rn.EventType.MESSAGE,D=>{var j;if(!S){let G=D.data[0];q(!!G);let U=G,Q=U.error||((j=U[0])===null||j===void 0?void 0:j.error);if(Q){C(xt,`RPC '${t}' stream ${i} received error:`,Q);let H=Q.status,K=function(w){let I=pt[w];if(I!==void 0)return Af(I)}(H),v=Q.message;K===void 0&&(K=P.INTERNAL,v="Unknown error status: "+H+" with message "+Q.message),S=!0,N.So(new x(K,v)),g.close()}else C(xt,`RPC '${t}' stream ${i} received:`,G),N.bo(G)}}),k(u,Xo.STAT_EVENT,D=>{D.stat===$i.PROXY?C(xt,`RPC '${t}' stream ${i} detected buffering proxy`):D.stat===$i.NOPROXY&&C(xt,`RPC '${t}' stream ${i} detected no buffering proxy`)}),setTimeout(()=>{N.wo()},0),N}};function Xf(){return typeof window<"u"?window:null}function es(){return typeof document<"u"?document:null}function wi(r){return new Ma(r,!0)}var li=class{constructor(t,e,n=1e3,i=1.5,s=6e4){this.ui=t,this.timerId=e,this.ko=n,this.qo=i,this.Qo=s,this.Ko=0,this.$o=null,this.Uo=Date.now(),this.reset()}reset(){this.Ko=0}Wo(){this.Ko=this.Qo}Go(t){this.cancel();let e=Math.floor(this.Ko+this.zo()),n=Math.max(0,Date.now()-this.Uo),i=Math.max(0,e-n);i>0&&C("ExponentialBackoff",`Backing off for ${i} ms (base delay: ${this.Ko} ms, delay with jitter: ${e} ms, last attempt: ${n} ms ago)`),this.$o=this.ui.enqueueAfterDelay(this.timerId,i,()=>(this.Uo=Date.now(),t())),this.Ko*=this.qo,this.Ko<this.ko&&(this.Ko=this.ko),this.Ko>this.Qo&&(this.Ko=this.Qo)}jo(){this.$o!==null&&(this.$o.skipDelay(),this.$o=null)}cancel(){this.$o!==null&&(this.$o.cancel(),this.$o=null)}zo(){return(Math.random()-.5)*this.Ko}};var ks=class{constructor(t,e,n,i,s,a,u,l){this.ui=t,this.Ho=n,this.Jo=i,this.connection=s,this.authCredentialsProvider=a,this.appCheckCredentialsProvider=u,this.listener=l,this.state=0,this.Yo=0,this.Zo=null,this.Xo=null,this.stream=null,this.e_=0,this.t_=new li(t,e)}n_(){return this.state===1||this.state===5||this.r_()}r_(){return this.state===2||this.state===3}start(){this.e_=0,this.state!==4?this.auth():this.i_()}stop(){return V(this,null,function*(){this.n_()&&(yield this.close(0))})}s_(){this.state=0,this.t_.reset()}o_(){this.r_()&&this.Zo===null&&(this.Zo=this.ui.enqueueAfterDelay(this.Ho,6e4,()=>this.__()))}a_(t){this.u_(),this.stream.send(t)}__(){return V(this,null,function*(){if(this.r_())return this.close(0)})}u_(){this.Zo&&(this.Zo.cancel(),this.Zo=null)}c_(){this.Xo&&(this.Xo.cancel(),this.Xo=null)}close(t,e){return V(this,null,function*(){this.u_(),this.c_(),this.t_.cancel(),this.Yo++,t!==4?this.t_.reset():e&&e.code===P.RESOURCE_EXHAUSTED?(dt(e.toString()),dt("Using maximum backoff delay to prevent overloading the backend."),this.t_.Wo()):e&&e.code===P.UNAUTHENTICATED&&this.state!==3&&(this.authCredentialsProvider.invalidateToken(),this.appCheckCredentialsProvider.invalidateToken()),this.stream!==null&&(this.l_(),this.stream.close(),this.stream=null),this.state=t,yield this.listener.mo(e)})}l_(){}auth(){this.state=1;let t=this.h_(this.Yo),e=this.Yo;Promise.all([this.authCredentialsProvider.getToken(),this.appCheckCredentialsProvider.getToken()]).then(([n,i])=>{this.Yo===e&&this.P_(n,i)},n=>{t(()=>{let i=new x(P.UNKNOWN,"Fetching auth token failed: "+n.message);return this.I_(i)})})}P_(t,e){let n=this.h_(this.Yo);this.stream=this.T_(t,e),this.stream.Eo(()=>{n(()=>this.listener.Eo())}),this.stream.Ro(()=>{n(()=>(this.state=2,this.Xo=this.ui.enqueueAfterDelay(this.Jo,1e4,()=>(this.r_()&&(this.state=3),Promise.resolve())),this.listener.Ro()))}),this.stream.mo(i=>{n(()=>this.I_(i))}),this.stream.onMessage(i=>{n(()=>++this.e_==1?this.E_(i):this.onNext(i))})}i_(){this.state=5,this.t_.Go(()=>V(this,null,function*(){this.state=0,this.start()}))}I_(t){return C("PersistentStream",`close with error: ${t}`),this.stream=null,this.close(4,t)}h_(t){return e=>{this.ui.enqueueAndForget(()=>this.Yo===t?e():(C("PersistentStream","stream callback skipped by getCloseGuardedDispatcher."),Promise.resolve()))}}},Eu=class extends ks{constructor(t,e,n,i,s,a){super(t,"listen_stream_connection_backoff","listen_stream_idle","health_check_timeout",e,n,i,a),this.serializer=s}T_(t,e){return this.connection.Bo("Listen",t,e)}E_(t){return this.onNext(t)}onNext(t){this.t_.reset();let e=Op(this.serializer,t),n=function(s){if(!("targetChange"in s))return B.min();let a=s.targetChange;return a.targetIds&&a.targetIds.length?B.min():a.readTime?mt(a.readTime):B.min()}(t);return this.listener.d_(e,n)}A_(t){let e={};e.database=Ua(this.serializer),e.addTarget=function(s,a){let u,l=a.target;if(u=hs(l)?{documents:Df(s,l)}:{query:Nf(s,l)._t},u.targetId=a.targetId,a.resumeToken.approximateByteSize()>0){u.resumeToken=bf(s,a.resumeToken);let d=La(s,a.expectedCount);d!==null&&(u.expectedCount=d)}else if(a.snapshotVersion.compareTo(B.min())>0){u.readTime=Qn(s,a.snapshotVersion.toTimestamp());let d=La(s,a.expectedCount);d!==null&&(u.expectedCount=d)}return u}(this.serializer,t);let n=Lp(this.serializer,t);n&&(e.labels=n),this.a_(e)}R_(t){let e={};e.database=Ua(this.serializer),e.removeTarget=t,this.a_(e)}},Au=class extends ks{constructor(t,e,n,i,s,a){super(t,"write_stream_connection_backoff","write_stream_idle","health_check_timeout",e,n,i,a),this.serializer=s}get V_(){return this.e_>0}start(){this.lastStreamToken=void 0,super.start()}l_(){this.V_&&this.m_([])}T_(t,e){return this.connection.Bo("Write",t,e)}E_(t){return q(!!t.streamToken),this.lastStreamToken=t.streamToken,q(!t.writeResults||t.writeResults.length===0),this.listener.f_()}onNext(t){q(!!t.streamToken),this.lastStreamToken=t.streamToken,this.t_.reset();let e=Mp(t.writeResults,t.commitTime),n=mt(t.commitTime);return this.listener.g_(n,e)}p_(){let t={};t.database=Ua(this.serializer),this.a_(t)}m_(t){let e={streamToken:this.lastStreamToken,writes:t.map(n=>oi(this.serializer,n))};this.a_(e)}};var Su=class extends class{}{constructor(t,e,n,i){super(),this.authCredentials=t,this.appCheckCredentials=e,this.connection=n,this.serializer=i,this.y_=!1}w_(){if(this.y_)throw new x(P.FAILED_PRECONDITION,"The client has already been terminated.")}Mo(t,e,n,i){return this.w_(),Promise.all([this.authCredentials.getToken(),this.appCheckCredentials.getToken()]).then(([s,a])=>this.connection.Mo(t,qa(e,n),i,s,a)).catch(s=>{throw s.name==="FirebaseError"?(s.code===P.UNAUTHENTICATED&&(this.authCredentials.invalidateToken(),this.appCheckCredentials.invalidateToken()),s):new x(P.UNKNOWN,s.toString())})}Lo(t,e,n,i,s){return this.w_(),Promise.all([this.authCredentials.getToken(),this.appCheckCredentials.getToken()]).then(([a,u])=>this.connection.Lo(t,qa(e,n),i,a,u,s)).catch(a=>{throw a.name==="FirebaseError"?(a.code===P.UNAUTHENTICATED&&(this.authCredentials.invalidateToken(),this.appCheckCredentials.invalidateToken()),a):new x(P.UNKNOWN,a.toString())})}terminate(){this.y_=!0,this.connection.terminate()}},bu=class{constructor(t,e){this.asyncQueue=t,this.onlineStateHandler=e,this.state="Unknown",this.S_=0,this.b_=null,this.D_=!0}v_(){this.S_===0&&(this.C_("Unknown"),this.b_=this.asyncQueue.enqueueAfterDelay("online_state_timeout",1e4,()=>(this.b_=null,this.F_("Backend didn't respond within 10 seconds."),this.C_("Offline"),Promise.resolve())))}M_(t){this.state==="Online"?this.C_("Unknown"):(this.S_++,this.S_>=1&&(this.x_(),this.F_(`Connection failed 1 times. Most recent error: ${t.toString()}`),this.C_("Offline")))}set(t){this.x_(),this.S_=0,t==="Online"&&(this.D_=!1),this.C_(t)}C_(t){t!==this.state&&(this.state=t,this.onlineStateHandler(t))}F_(t){let e=`Could not reach Cloud Firestore backend. ${t}
This typically indicates that your device does not have a healthy Internet connection at the moment. The client will operate in offline mode until it is able to successfully connect to the backend.`;this.D_?(dt(e),this.D_=!1):C("OnlineStateTracker",e)}x_(){this.b_!==null&&(this.b_.cancel(),this.b_=null)}};var Ru=class{constructor(t,e,n,i,s){this.localStore=t,this.datastore=e,this.asyncQueue=n,this.remoteSyncer={},this.O_=[],this.N_=new Map,this.L_=new Set,this.B_=[],this.k_=s,this.k_._o(a=>{n.enqueueAndForget(()=>V(this,null,function*(){Ke(this)&&(C("RemoteStore","Restarting streams for network reachability change."),yield function(l){return V(this,null,function*(){let d=O(l);d.L_.add(4),yield or(d),d.q_.set("Unknown"),d.L_.delete(4),yield vi(d)})}(this))}))}),this.q_=new bu(n,i)}};function vi(r){return V(this,null,function*(){if(Ke(r))for(let t of r.B_)yield t(!0)})}function or(r){return V(this,null,function*(){for(let t of r.B_)yield t(!1)})}function eo(r,t){let e=O(r);e.N_.has(t.targetId)||(e.N_.set(t.targetId,t),vc(e)?wc(e):ur(e).r_()&&yc(e,t))}function Xn(r,t){let e=O(r),n=ur(e);e.N_.delete(t),n.r_()&&Zf(e,t),e.N_.size===0&&(n.r_()?n.o_():Ke(e)&&e.q_.set("Unknown"))}function yc(r,t){if(r.Q_.xe(t.targetId),t.resumeToken.approximateByteSize()>0||t.snapshotVersion.compareTo(B.min())>0){let e=r.remoteSyncer.getRemoteKeysForTarget(t.targetId).size;t=t.withExpectedCount(e)}ur(r).A_(t)}function Zf(r,t){r.Q_.xe(t),ur(r).R_(t)}function wc(r){r.Q_=new Oa({getRemoteKeysForTarget:t=>r.remoteSyncer.getRemoteKeysForTarget(t),ot:t=>r.N_.get(t)||null,tt:()=>r.datastore.serializer.databaseId}),ur(r).start(),r.q_.v_()}function vc(r){return Ke(r)&&!ur(r).n_()&&r.N_.size>0}function Ke(r){return O(r).L_.size===0}function tm(r){r.Q_=void 0}function Zp(r){return V(this,null,function*(){r.q_.set("Online")})}function t_(r){return V(this,null,function*(){r.N_.forEach((t,e)=>{yc(r,t)})})}function e_(r,t){return V(this,null,function*(){tm(r),vc(r)?(r.q_.M_(t),wc(r)):r.q_.set("Unknown")})}function n_(r,t,e){return V(this,null,function*(){if(r.q_.set("Online"),t instanceof gs&&t.state===2&&t.cause)try{yield function(i,s){return V(this,null,function*(){let a=s.cause;for(let u of s.targetIds)i.N_.has(u)&&(yield i.remoteSyncer.rejectListen(u,a),i.N_.delete(u),i.Q_.removeTarget(u))})}(r,t)}catch(n){C("RemoteStore","Failed to remove targets %s: %s ",t.targetIds.join(","),n),yield Fs(r,n)}else if(t instanceof Un?r.Q_.Ke(t):t instanceof ms?r.Q_.He(t):r.Q_.We(t),!e.isEqual(B.min()))try{let n=yield Qf(r.localStore);e.compareTo(n)>=0&&(yield function(s,a){let u=s.Q_.rt(a);return u.targetChanges.forEach((l,d)=>{if(l.resumeToken.approximateByteSize()>0){let f=s.N_.get(d);f&&s.N_.set(d,f.withResumeToken(l.resumeToken,a))}}),u.targetMismatches.forEach((l,d)=>{let f=s.N_.get(l);if(!f)return;s.N_.set(l,f.withResumeToken(gt.EMPTY_BYTE_STRING,f.snapshotVersion)),Zf(s,l);let g=new Wn(f.target,l,d,f.sequenceNumber);yc(s,g)}),s.remoteSyncer.applyRemoteEvent(u)}(r,e))}catch(n){C("RemoteStore","Failed to raise snapshot:",n),yield Fs(r,n)}})}function Fs(r,t,e){return V(this,null,function*(){if(!ze(t))throw t;r.L_.add(1),yield or(r),r.q_.set("Offline"),e||(e=()=>Qf(r.localStore)),r.asyncQueue.enqueueRetryable(()=>V(this,null,function*(){C("RemoteStore","Retrying IndexedDB access"),yield e(),r.L_.delete(1),yield vi(r)}))})}function em(r,t){return t().catch(e=>Fs(r,e,t))}function ar(r){return V(this,null,function*(){let t=O(r),e=je(t),n=t.O_.length>0?t.O_[t.O_.length-1].batchId:-1;for(;r_(t);)try{let i=yield Hp(t.localStore,n);if(i===null){t.O_.length===0&&e.o_();break}n=i.batchId,i_(t,i)}catch(i){yield Fs(t,i)}nm(t)&&rm(t)})}function r_(r){return Ke(r)&&r.O_.length<10}function i_(r,t){r.O_.push(t);let e=je(r);e.r_()&&e.V_&&e.m_(t.mutations)}function nm(r){return Ke(r)&&!je(r).n_()&&r.O_.length>0}function rm(r){je(r).start()}function s_(r){return V(this,null,function*(){je(r).p_()})}function o_(r){return V(this,null,function*(){let t=je(r);for(let e of r.O_)t.m_(e.mutations)})}function a_(r,t,e){return V(this,null,function*(){let n=r.O_.shift(),i=Na.from(n,t,e);yield em(r,()=>r.remoteSyncer.applySuccessfulWrite(i)),yield ar(r)})}function u_(r,t){return V(this,null,function*(){t&&je(r).V_&&(yield function(n,i){return V(this,null,function*(){if(function(a){return Ef(a)&&a!==P.ABORTED}(i.code)){let s=n.O_.shift();je(n).s_(),yield em(n,()=>n.remoteSyncer.rejectFailedWrite(s.batchId,i)),yield ar(n)}})}(r,t)),nm(r)&&rm(r)})}function Rd(r,t){return V(this,null,function*(){let e=O(r);e.asyncQueue.verifyOperationInProgress(),C("RemoteStore","RemoteStore received new credentials");let n=Ke(e);e.L_.add(3),yield or(e),n&&e.q_.set("Unknown"),yield e.remoteSyncer.handleCredentialChange(t),e.L_.delete(3),yield vi(e)})}function Pu(r,t){return V(this,null,function*(){let e=O(r);t?(e.L_.delete(2),yield vi(e)):t||(e.L_.add(2),yield or(e),e.q_.set("Unknown"))})}function ur(r){return r.K_||(r.K_=function(e,n,i){let s=O(e);return s.w_(),new Eu(n,s.connection,s.authCredentials,s.appCheckCredentials,s.serializer,i)}(r.datastore,r.asyncQueue,{Eo:Zp.bind(null,r),Ro:t_.bind(null,r),mo:e_.bind(null,r),d_:n_.bind(null,r)}),r.B_.push(t=>V(this,null,function*(){t?(r.K_.s_(),vc(r)?wc(r):r.q_.set("Unknown")):(yield r.K_.stop(),tm(r))}))),r.K_}function je(r){return r.U_||(r.U_=function(e,n,i){let s=O(e);return s.w_(),new Au(n,s.connection,s.authCredentials,s.appCheckCredentials,s.serializer,i)}(r.datastore,r.asyncQueue,{Eo:()=>Promise.resolve(),Ro:s_.bind(null,r),mo:u_.bind(null,r),f_:o_.bind(null,r),g_:a_.bind(null,r)}),r.B_.push(t=>V(this,null,function*(){t?(r.U_.s_(),yield ar(r)):(yield r.U_.stop(),r.O_.length>0&&(C("RemoteStore",`Stopping write stream with ${r.O_.length} pending writes`),r.O_=[]))}))),r.U_}var Vu=class r{constructor(t,e,n,i,s){this.asyncQueue=t,this.timerId=e,this.targetTimeMs=n,this.op=i,this.removalCallback=s,this.deferred=new vt,this.then=this.deferred.promise.then.bind(this.deferred.promise),this.deferred.promise.catch(a=>{})}get promise(){return this.deferred.promise}static createAndSchedule(t,e,n,i,s){let a=Date.now()+n,u=new r(t,e,a,i,s);return u.start(n),u}start(t){this.timerHandle=setTimeout(()=>this.handleDelayElapsed(),t)}skipDelay(){return this.handleDelayElapsed()}cancel(t){this.timerHandle!==null&&(this.clearTimeout(),this.deferred.reject(new x(P.CANCELLED,"Operation cancelled"+(t?": "+t:""))))}handleDelayElapsed(){this.asyncQueue.enqueueAndForget(()=>this.timerHandle!==null?(this.clearTimeout(),this.op().then(t=>this.deferred.resolve(t))):Promise.resolve())}clearTimeout(){this.timerHandle!==null&&(this.removalCallback(this),clearTimeout(this.timerHandle),this.timerHandle=null)}};function cr(r,t){if(dt("AsyncQueue",`${t}: ${r}`),ze(r))return new x(P.UNAVAILABLE,`${t}: ${r}`);throw r}var Os=class r{constructor(t){this.comparator=t?(e,n)=>t(e,n)||M.comparator(e.key,n.key):(e,n)=>M.comparator(e.key,n.key),this.keyedMap=Br(),this.sortedSet=new st(this.comparator)}static emptySet(t){return new r(t.comparator)}has(t){return this.keyedMap.get(t)!=null}get(t){return this.keyedMap.get(t)}first(){return this.sortedSet.minKey()}last(){return this.sortedSet.maxKey()}isEmpty(){return this.sortedSet.isEmpty()}indexOf(t){let e=this.keyedMap.get(t);return e?this.sortedSet.indexOf(e):-1}get size(){return this.sortedSet.size}forEach(t){this.sortedSet.inorderTraversal((e,n)=>(t(e),!1))}add(t){let e=this.delete(t.key);return e.copy(e.keyedMap.insert(t.key,t),e.sortedSet.insert(t,null))}delete(t){let e=this.get(t);return e?this.copy(this.keyedMap.remove(t),this.sortedSet.remove(e)):this}isEqual(t){if(!(t instanceof r)||this.size!==t.size)return!1;let e=this.sortedSet.getIterator(),n=t.sortedSet.getIterator();for(;e.hasNext();){let i=e.getNext().key,s=n.getNext().key;if(!i.isEqual(s))return!1}return!0}toString(){let t=[];return this.forEach(e=>{t.push(e.toString())}),t.length===0?"DocumentSet ()":`DocumentSet (
  `+t.join(`  
`)+`
)`}copy(t,e){let n=new r;return n.comparator=this.comparator,n.keyedMap=t,n.sortedSet=e,n}};var Ms=class{constructor(){this.W_=new st(M.comparator)}track(t){let e=t.doc.key,n=this.W_.get(e);n?t.type!==0&&n.type===3?this.W_=this.W_.insert(e,t):t.type===3&&n.type!==1?this.W_=this.W_.insert(e,{type:n.type,doc:t.doc}):t.type===2&&n.type===2?this.W_=this.W_.insert(e,{type:2,doc:t.doc}):t.type===2&&n.type===0?this.W_=this.W_.insert(e,{type:0,doc:t.doc}):t.type===1&&n.type===0?this.W_=this.W_.remove(e):t.type===1&&n.type===2?this.W_=this.W_.insert(e,{type:1,doc:n.doc}):t.type===0&&n.type===1?this.W_=this.W_.insert(e,{type:2,doc:t.doc}):L():this.W_=this.W_.insert(e,t)}G_(){let t=[];return this.W_.inorderTraversal((e,n)=>{t.push(n)}),t}},Zn=class r{constructor(t,e,n,i,s,a,u,l,d){this.query=t,this.docs=e,this.oldDocs=n,this.docChanges=i,this.mutatedKeys=s,this.fromCache=a,this.syncStateChanged=u,this.excludesMetadataChanges=l,this.hasCachedResults=d}static fromInitialDocuments(t,e,n,i,s){let a=[];return e.forEach(u=>{a.push({type:0,doc:u})}),new r(t,e,Os.emptySet(e),a,n,i,!0,!1,s)}get hasPendingWrites(){return!this.mutatedKeys.isEmpty()}isEqual(t){if(!(this.fromCache===t.fromCache&&this.hasCachedResults===t.hasCachedResults&&this.syncStateChanged===t.syncStateChanged&&this.mutatedKeys.isEqual(t.mutatedKeys)&&_i(this.query,t.query)&&this.docs.isEqual(t.docs)&&this.oldDocs.isEqual(t.oldDocs)))return!1;let e=this.docChanges,n=t.docChanges;if(e.length!==n.length)return!1;for(let i=0;i<e.length;i++)if(e[i].type!==n[i].type||!e[i].doc.isEqual(n[i].doc))return!1;return!0}};var xu=class{constructor(){this.z_=void 0,this.j_=[]}H_(){return this.j_.some(t=>t.J_())}},Cu=class{constructor(){this.queries=Pd(),this.onlineState="Unknown",this.Y_=new Set}terminate(){(function(e,n){let i=O(e),s=i.queries;i.queries=Pd(),s.forEach((a,u)=>{for(let l of u.j_)l.onError(n)})})(this,new x(P.ABORTED,"Firestore shutting down"))}};function Pd(){return new oe(r=>cf(r),_i)}function Ic(r,t){return V(this,null,function*(){let e=O(r),n=3,i=t.query,s=e.queries.get(i);s?!s.H_()&&t.J_()&&(n=2):(s=new xu,n=t.J_()?0:1);try{switch(n){case 0:s.z_=yield e.onListen(i,!0);break;case 1:s.z_=yield e.onListen(i,!1);break;case 2:yield e.onFirstRemoteStoreListen(i)}}catch(a){let u=cr(a,`Initialization of query '${Nn(t.query)}' failed`);return void t.onError(u)}e.queries.set(i,s),s.j_.push(t),t.Z_(e.onlineState),s.z_&&t.X_(s.z_)&&Ec(e)})}function Tc(r,t){return V(this,null,function*(){let e=O(r),n=t.query,i=3,s=e.queries.get(n);if(s){let a=s.j_.indexOf(t);a>=0&&(s.j_.splice(a,1),s.j_.length===0?i=t.J_()?0:1:!s.H_()&&t.J_()&&(i=2))}switch(i){case 0:return e.queries.delete(n),e.onUnlisten(n,!0);case 1:return e.queries.delete(n),e.onUnlisten(n,!1);case 2:return e.onLastRemoteStoreUnlisten(n);default:return}})}function c_(r,t){let e=O(r),n=!1;for(let i of t){let s=i.query,a=e.queries.get(s);if(a){for(let u of a.j_)u.X_(i)&&(n=!0);a.z_=i}}n&&Ec(e)}function l_(r,t,e){let n=O(r),i=n.queries.get(t);if(i)for(let s of i.j_)s.onError(e);n.queries.delete(t)}function Ec(r){r.Y_.forEach(t=>{t.next()})}var Du,Vd;(Vd=Du||(Du={})).ea="default",Vd.Cache="cache";var hi=class{constructor(t,e,n){this.query=t,this.ta=e,this.na=!1,this.ra=null,this.onlineState="Unknown",this.options=n||{}}X_(t){if(!this.options.includeMetadataChanges){let n=[];for(let i of t.docChanges)i.type!==3&&n.push(i);t=new Zn(t.query,t.docs,t.oldDocs,n,t.mutatedKeys,t.fromCache,t.syncStateChanged,!0,t.hasCachedResults)}let e=!1;return this.na?this.ia(t)&&(this.ta.next(t),e=!0):this.sa(t,this.onlineState)&&(this.oa(t),e=!0),this.ra=t,e}onError(t){this.ta.error(t)}Z_(t){this.onlineState=t;let e=!1;return this.ra&&!this.na&&this.sa(this.ra,t)&&(this.oa(this.ra),e=!0),e}sa(t,e){if(!t.fromCache||!this.J_())return!0;let n=e!=="Offline";return(!this.options._a||!n)&&(!t.docs.isEmpty()||t.hasCachedResults||e==="Offline")}ia(t){if(t.docChanges.length>0)return!0;let e=this.ra&&this.ra.hasPendingWrites!==t.hasPendingWrites;return!(!t.syncStateChanged&&!e)&&this.options.includeMetadataChanges===!0}oa(t){t=Zn.fromInitialDocuments(t.query,t.docs,t.mutatedKeys,t.fromCache,t.hasCachedResults),this.na=!0,this.ta.next(t)}J_(){return this.options.source!==Du.Cache}};var Nu=class{constructor(t,e){this.aa=t,this.byteLength=e}ua(){return"metadata"in this.aa}};var Ls=class{constructor(t){this.serializer=t}Es(t){return ne(this.serializer,t)}ds(t){return t.metadata.exists?Cf(this.serializer,t.document,!1):wt.newNoDocument(this.Es(t.metadata.name),this.As(t.metadata.readTime))}As(t){return mt(t)}},ku=class{constructor(t,e,n){this.ca=t,this.localStore=e,this.serializer=n,this.queries=[],this.documents=[],this.collectionGroups=new Set,this.progress=im(t)}la(t){this.progress.bytesLoaded+=t.byteLength;let e=this.progress.documentsLoaded;if(t.aa.namedQuery)this.queries.push(t.aa.namedQuery);else if(t.aa.documentMetadata){this.documents.push({metadata:t.aa.documentMetadata}),t.aa.documentMetadata.exists||++e;let n=Y.fromString(t.aa.documentMetadata.name);this.collectionGroups.add(n.get(n.length-2))}else t.aa.document&&(this.documents[this.documents.length-1].document=t.aa.document,++e);return e!==this.progress.documentsLoaded?(this.progress.documentsLoaded=e,Object.assign({},this.progress)):null}ha(t){let e=new Map,n=new Ls(this.serializer);for(let i of t)if(i.metadata.queries){let s=n.Es(i.metadata.name);for(let a of i.metadata.queries){let u=(e.get(a)||$()).add(s);e.set(a,u)}}return e}complete(){return V(this,null,function*(){let t=yield Jp(this.localStore,new Ls(this.serializer),this.documents,this.ca.id),e=this.ha(this.documents);for(let n of this.queries)yield Yp(this.localStore,n,e.get(n.name));return this.progress.taskState="Success",{progress:this.progress,Pa:this.collectionGroups,Ia:t}})}};function im(r){return{taskState:"Running",documentsLoaded:0,bytesLoaded:0,totalDocuments:r.totalDocuments,totalBytes:r.totalBytes}}var qs=class{constructor(t){this.key=t}},Us=class{constructor(t){this.key=t}},Bs=class{constructor(t,e){this.query=t,this.Ta=e,this.Ea=null,this.hasCachedResults=!1,this.current=!1,this.da=$(),this.mutatedKeys=$(),this.Aa=hf(t),this.Ra=new Os(this.Aa)}get Va(){return this.Ta}ma(t,e){let n=e?e.fa:new Ms,i=e?e.Ra:this.Ra,s=e?e.mutatedKeys:this.mutatedKeys,a=i,u=!1,l=this.query.limitType==="F"&&i.size===this.query.limit?i.last():null,d=this.query.limitType==="L"&&i.size===this.query.limit?i.first():null;if(t.inorderTraversal((f,g)=>{let _=i.get(f),S=yi(this.query,g)?g:null,N=!!_&&this.mutatedKeys.has(_.key),k=!!S&&(S.hasLocalMutations||this.mutatedKeys.has(S.key)&&S.hasCommittedMutations),D=!1;_&&S?_.data.isEqual(S.data)?N!==k&&(n.track({type:3,doc:S}),D=!0):this.ga(_,S)||(n.track({type:2,doc:S}),D=!0,(l&&this.Aa(S,l)>0||d&&this.Aa(S,d)<0)&&(u=!0)):!_&&S?(n.track({type:0,doc:S}),D=!0):_&&!S&&(n.track({type:1,doc:_}),D=!0,(l||d)&&(u=!0)),D&&(S?(a=a.add(S),s=k?s.add(f):s.delete(f)):(a=a.delete(f),s=s.delete(f)))}),this.query.limit!==null)for(;a.size>this.query.limit;){let f=this.query.limitType==="F"?a.last():a.first();a=a.delete(f.key),s=s.delete(f.key),n.track({type:1,doc:f})}return{Ra:a,fa:n,ns:u,mutatedKeys:s}}ga(t,e){return t.hasLocalMutations&&e.hasCommittedMutations&&!e.hasLocalMutations}applyChanges(t,e,n,i){let s=this.Ra;this.Ra=t.Ra,this.mutatedKeys=t.mutatedKeys;let a=t.fa.G_();a.sort((f,g)=>function(S,N){let k=D=>{switch(D){case 0:return 1;case 2:case 3:return 2;case 1:return 0;default:return L()}};return k(S)-k(N)}(f.type,g.type)||this.Aa(f.doc,g.doc)),this.pa(n),i=i!=null&&i;let u=e&&!i?this.ya():[],l=this.da.size===0&&this.current&&!i?1:0,d=l!==this.Ea;return this.Ea=l,a.length!==0||d?{snapshot:new Zn(this.query,t.Ra,s,a,t.mutatedKeys,l===0,d,!1,!!n&&n.resumeToken.approximateByteSize()>0),wa:u}:{wa:u}}Z_(t){return this.current&&t==="Offline"?(this.current=!1,this.applyChanges({Ra:this.Ra,fa:new Ms,mutatedKeys:this.mutatedKeys,ns:!1},!1)):{wa:[]}}Sa(t){return!this.Ta.has(t)&&!!this.Ra.has(t)&&!this.Ra.get(t).hasLocalMutations}pa(t){t&&(t.addedDocuments.forEach(e=>this.Ta=this.Ta.add(e)),t.modifiedDocuments.forEach(e=>{}),t.removedDocuments.forEach(e=>this.Ta=this.Ta.delete(e)),this.current=t.current)}ya(){if(!this.current)return[];let t=this.da;this.da=$(),this.Ra.forEach(n=>{this.Sa(n.key)&&(this.da=this.da.add(n.key))});let e=[];return t.forEach(n=>{this.da.has(n)||e.push(new Us(n))}),this.da.forEach(n=>{t.has(n)||e.push(new qs(n))}),e}ba(t){this.Ta=t.Ts,this.da=$();let e=this.ma(t.documents);return this.applyChanges(e,!0)}Da(){return Zn.fromInitialDocuments(this.query,this.Ra,this.mutatedKeys,this.Ea===0,this.hasCachedResults)}},Fu=class{constructor(t,e,n){this.query=t,this.targetId=e,this.view=n}},Ou=class{constructor(t){this.key=t,this.va=!1}},Mu=class{constructor(t,e,n,i,s,a){this.localStore=t,this.remoteStore=e,this.eventManager=n,this.sharedClientState=i,this.currentUser=s,this.maxConcurrentLimboResolutions=a,this.Ca={},this.Fa=new oe(u=>cf(u),_i),this.Ma=new Map,this.xa=new Set,this.Oa=new st(M.comparator),this.Na=new Map,this.La=new ui,this.Ba={},this.ka=new Map,this.qa=Hn.kn(),this.onlineState="Unknown",this.Qa=void 0}get isPrimaryClient(){return this.Qa===!0}};function h_(r,t,e=!0){return V(this,null,function*(){let n=no(r),i,s=n.Fa.get(t);return s?(n.sharedClientState.addLocalQueryTarget(s.targetId),i=s.view.Da()):i=yield sm(n,t,e,!0),i})}function d_(r,t){return V(this,null,function*(){let e=no(r);yield sm(e,t,!0,!1)})}function sm(r,t,e,n){return V(this,null,function*(){let i=yield Jn(r.localStore,Ft(t)),s=i.targetId,a=r.sharedClientState.addLocalQueryTarget(s,e),u;return n&&(u=yield Ac(r,t,s,a==="current",i.resumeToken)),r.isPrimaryClient&&e&&eo(r.remoteStore,i),u})}function Ac(r,t,e,n,i){return V(this,null,function*(){r.Ka=(g,_,S)=>function(k,D,j,G){return V(this,null,function*(){let U=D.view.ma(j);U.ns&&(U=yield Vs(k.localStore,D.query,!1).then(({documents:v})=>D.view.ma(v,U)));let Q=G&&G.targetChanges.get(D.targetId),H=G&&G.targetMismatches.get(D.targetId)!=null,K=D.view.applyChanges(U,k.isPrimaryClient,Q,H);return Lu(k,D.targetId,K.wa),K.snapshot})}(r,g,_,S);let s=yield Vs(r.localStore,t,!0),a=new Bs(t,s.Ts),u=a.ma(s.documents),l=ii.createSynthesizedTargetChangeForCurrentChange(e,n&&r.onlineState!=="Offline",i),d=a.applyChanges(u,r.isPrimaryClient,l);Lu(r,e,d.wa);let f=new Fu(t,e,a);return r.Fa.set(t,f),r.Ma.has(e)?r.Ma.get(e).push(t):r.Ma.set(e,[t]),d.snapshot})}function f_(r,t,e){return V(this,null,function*(){let n=O(r),i=n.Fa.get(t),s=n.Ma.get(i.targetId);if(s.length>1)return n.Ma.set(i.targetId,s.filter(a=>!_i(a,t))),void n.Fa.delete(t);n.isPrimaryClient?(n.sharedClientState.removeLocalQueryTarget(i.targetId),n.sharedClientState.isActiveQueryTarget(i.targetId)||(yield Yn(n.localStore,i.targetId,!1).then(()=>{n.sharedClientState.clearQueryState(i.targetId),e&&Xn(n.remoteStore,i.targetId),tr(n,i.targetId)}).catch(Ge))):(tr(n,i.targetId),yield Yn(n.localStore,i.targetId,!0))})}function m_(r,t){return V(this,null,function*(){let e=O(r),n=e.Fa.get(t),i=e.Ma.get(n.targetId);e.isPrimaryClient&&i.length===1&&(e.sharedClientState.removeLocalQueryTarget(n.targetId),Xn(e.remoteStore,n.targetId))})}function g_(r,t,e){return V(this,null,function*(){let n=Pc(r);try{let i=yield function(a,u){let l=O(a),d=at.now(),f=u.reduce((S,N)=>S.add(N.key),$()),g,_;return l.persistence.runTransaction("Locally write mutations","readwrite",S=>{let N=Mt(),k=$();return l.cs.getEntries(S,f).next(D=>{N=D,N.forEach((j,G)=>{G.isValidDocument()||(k=k.add(j))})}).next(()=>l.localDocuments.getOverlayedDocuments(S,N)).next(D=>{g=D;let j=[];for(let G of u){let U=Vp(G,g.get(G.key).overlayedDocument);U!=null&&j.push(new Ht(G.key,U,ef(U.value.mapValue),ht.exists(!0)))}return l.mutationQueue.addMutationBatch(S,d,j,u)}).next(D=>{_=D;let j=D.applyToLocalDocumentSet(g,k);return l.documentOverlayCache.saveOverlays(S,D.batchId,j)})}).then(()=>({batchId:_.batchId,changes:ff(g)}))}(n.localStore,t);n.sharedClientState.addPendingMutation(i.batchId),function(a,u,l){let d=a.Ba[a.currentUser.toKey()];d||(d=new st(z)),d=d.insert(u,l),a.Ba[a.currentUser.toKey()]=d}(n,i.batchId,e),yield ve(n,i.changes),yield ar(n.remoteStore)}catch(i){let s=cr(i,"Failed to persist write");e.reject(s)}})}function om(r,t){return V(this,null,function*(){let e=O(r);try{let n=yield Wp(e.localStore,t);t.targetChanges.forEach((i,s)=>{let a=e.Na.get(s);a&&(q(i.addedDocuments.size+i.modifiedDocuments.size+i.removedDocuments.size<=1),i.addedDocuments.size>0?a.va=!0:i.modifiedDocuments.size>0?q(a.va):i.removedDocuments.size>0&&(q(a.va),a.va=!1))}),yield ve(e,n,t)}catch(n){yield Ge(n)}})}function xd(r,t,e){let n=O(r);if(n.isPrimaryClient&&e===0||!n.isPrimaryClient&&e===1){let i=[];n.Fa.forEach((s,a)=>{let u=a.view.Z_(t);u.snapshot&&i.push(u.snapshot)}),function(a,u){let l=O(a);l.onlineState=u;let d=!1;l.queries.forEach((f,g)=>{for(let _ of g.j_)_.Z_(u)&&(d=!0)}),d&&Ec(l)}(n.eventManager,t),i.length&&n.Ca.d_(i),n.onlineState=t,n.isPrimaryClient&&n.sharedClientState.setOnlineState(t)}}function p_(r,t,e){return V(this,null,function*(){let n=O(r);n.sharedClientState.updateQueryState(t,"rejected",e);let i=n.Na.get(t),s=i&&i.key;if(s){let a=new st(M.comparator);a=a.insert(s,wt.newNoDocument(s,B.min()));let u=$().add(s),l=new ri(B.min(),new Map,new st(z),a,u);yield om(n,l),n.Oa=n.Oa.remove(s),n.Na.delete(t),Rc(n)}else yield Yn(n.localStore,t,!1).then(()=>tr(n,t,e)).catch(Ge)})}function __(r,t){return V(this,null,function*(){let e=O(r),n=t.batch.batchId;try{let i=yield Qp(e.localStore,t);bc(e,n,null),Sc(e,n),e.sharedClientState.updateMutationState(n,"acknowledged"),yield ve(e,i)}catch(i){yield Ge(i)}})}function y_(r,t,e){return V(this,null,function*(){let n=O(r);try{let i=yield function(a,u){let l=O(a);return l.persistence.runTransaction("Reject batch","readwrite-primary",d=>{let f;return l.mutationQueue.lookupMutationBatch(d,u).next(g=>(q(g!==null),f=g.keys(),l.mutationQueue.removeMutationBatch(d,g))).next(()=>l.mutationQueue.performConsistencyCheck(d)).next(()=>l.documentOverlayCache.removeOverlaysForBatchId(d,f,u)).next(()=>l.localDocuments.recalculateAndSaveOverlaysForDocumentKeys(d,f)).next(()=>l.localDocuments.getDocuments(d,f))})}(n.localStore,t);bc(n,t,e),Sc(n,t),n.sharedClientState.updateMutationState(t,"rejected",e),yield ve(n,i)}catch(i){yield Ge(i)}})}function w_(r,t){return V(this,null,function*(){let e=O(r);Ke(e.remoteStore)||C("SyncEngine","The network is disabled. The task returned by 'awaitPendingWrites()' will not complete until the network is enabled.");try{let n=yield function(a){let u=O(a);return u.persistence.runTransaction("Get highest unacknowledged batch id","readonly",l=>u.mutationQueue.getHighestUnacknowledgedBatchId(l))}(e.localStore);if(n===-1)return void t.resolve();let i=e.ka.get(n)||[];i.push(t),e.ka.set(n,i)}catch(n){let i=cr(n,"Initialization of waitForPendingWrites() operation failed");t.reject(i)}})}function Sc(r,t){(r.ka.get(t)||[]).forEach(e=>{e.resolve()}),r.ka.delete(t)}function bc(r,t,e){let n=O(r),i=n.Ba[n.currentUser.toKey()];if(i){let s=i.get(t);s&&(e?s.reject(e):s.resolve(),i=i.remove(t)),n.Ba[n.currentUser.toKey()]=i}}function tr(r,t,e=null){r.sharedClientState.removeLocalQueryTarget(t);for(let n of r.Ma.get(t))r.Fa.delete(n),e&&r.Ca.$a(n,e);r.Ma.delete(t),r.isPrimaryClient&&r.La.gr(t).forEach(n=>{r.La.containsKey(n)||am(r,n)})}function am(r,t){r.xa.delete(t.path.canonicalString());let e=r.Oa.get(t);e!==null&&(Xn(r.remoteStore,e),r.Oa=r.Oa.remove(t),r.Na.delete(e),Rc(r))}function Lu(r,t,e){for(let n of e)n instanceof qs?(r.La.addReference(n.key,t),v_(r,n)):n instanceof Us?(C("SyncEngine","Document no longer in limbo: "+n.key),r.La.removeReference(n.key,t),r.La.containsKey(n.key)||am(r,n.key)):L()}function v_(r,t){let e=t.key,n=e.path.canonicalString();r.Oa.get(e)||r.xa.has(n)||(C("SyncEngine","New document in limbo: "+e),r.xa.add(n),Rc(r))}function Rc(r){for(;r.xa.size>0&&r.Oa.size<r.maxConcurrentLimboResolutions;){let t=r.xa.values().next().value;r.xa.delete(t);let e=new M(Y.fromString(t)),n=r.qa.next();r.Na.set(n,new Ou(e)),r.Oa=r.Oa.insert(e,n),eo(r.remoteStore,new Wn(Ft(sr(e.path)),n,"TargetPurposeLimboResolution",qt.oe))}}function ve(r,t,e){return V(this,null,function*(){let n=O(r),i=[],s=[],a=[];n.Fa.isEmpty()||(n.Fa.forEach((u,l)=>{a.push(n.Ka(l,t,e).then(d=>{var f;if((d||e)&&n.isPrimaryClient){let g=d?!d.fromCache:(f=e?.targetChanges.get(l.targetId))===null||f===void 0?void 0:f.current;n.sharedClientState.updateQueryState(l.targetId,g?"current":"not-current")}if(d){i.push(d);let g=pu.Wi(l.targetId,d);s.push(g)}}))}),yield Promise.all(a),n.Ca.d_(i),yield function(l,d){return V(this,null,function*(){let f=O(l);try{yield f.persistence.runTransaction("notifyLocalViewChanges","readwrite",g=>b.forEach(d,_=>b.forEach(_.$i,S=>f.persistence.referenceDelegate.addReference(g,_.targetId,S)).next(()=>b.forEach(_.Ui,S=>f.persistence.referenceDelegate.removeReference(g,_.targetId,S)))))}catch(g){if(!ze(g))throw g;C("LocalStore","Failed to update sequence numbers: "+g)}for(let g of d){let _=g.targetId;if(!g.fromCache){let S=f.os.get(_),N=S.snapshotVersion,k=S.withLastLimboFreeSnapshotVersion(N);f.os=f.os.insert(_,k)}}})}(n.localStore,s))})}function I_(r,t){return V(this,null,function*(){let e=O(r);if(!e.currentUser.isEqual(t)){C("SyncEngine","User change. New user:",t.toKey());let n=yield $f(e.localStore,t);e.currentUser=t,function(s,a){s.ka.forEach(u=>{u.forEach(l=>{l.reject(new x(P.CANCELLED,a))})}),s.ka.clear()}(e,"'waitForPendingWrites' promise is rejected due to a user change."),e.sharedClientState.handleUserChange(t,n.removedBatchIds,n.addedBatchIds),yield ve(e,n.hs)}})}function T_(r,t){let e=O(r),n=e.Na.get(t);if(n&&n.va)return $().add(n.key);{let i=$(),s=e.Ma.get(t);if(!s)return i;for(let a of s){let u=e.Fa.get(a);i=i.unionWith(u.view.Va)}return i}}function E_(r,t){return V(this,null,function*(){let e=O(r),n=yield Vs(e.localStore,t.query,!0),i=t.view.ba(n);return e.isPrimaryClient&&Lu(e,t.targetId,i.wa),i})}function A_(r,t){return V(this,null,function*(){let e=O(r);return Jf(e.localStore,t).then(n=>ve(e,n))})}function S_(r,t,e,n){return V(this,null,function*(){let i=O(r),s=yield function(u,l){let d=O(u),f=O(d.mutationQueue);return d.persistence.runTransaction("Lookup mutation documents","readonly",g=>f.Mn(g,l).next(_=>_?d.localDocuments.getDocuments(g,_):b.resolve(null)))}(i.localStore,t);s!==null?(e==="pending"?yield ar(i.remoteStore):e==="acknowledged"||e==="rejected"?(bc(i,t,n||null),Sc(i,t),function(u,l){O(O(u).mutationQueue).On(l)}(i.localStore,t)):L(),yield ve(i,s)):C("SyncEngine","Cannot apply mutation batch with id: "+t)})}function b_(r,t){return V(this,null,function*(){let e=O(r);if(no(e),Pc(e),t===!0&&e.Qa!==!0){let n=e.sharedClientState.getAllActiveQueryTargets(),i=yield Cd(e,n.toArray());e.Qa=!0,yield Pu(e.remoteStore,!0);for(let s of i)eo(e.remoteStore,s)}else if(t===!1&&e.Qa!==!1){let n=[],i=Promise.resolve();e.Ma.forEach((s,a)=>{e.sharedClientState.isLocalQueryTarget(a)?n.push(a):i=i.then(()=>(tr(e,a),Yn(e.localStore,a,!0))),Xn(e.remoteStore,a)}),yield i,yield Cd(e,n),function(a){let u=O(a);u.Na.forEach((l,d)=>{Xn(u.remoteStore,d)}),u.La.pr(),u.Na=new Map,u.Oa=new st(M.comparator)}(e),e.Qa=!1,yield Pu(e.remoteStore,!1)}})}function Cd(r,t,e){return V(this,null,function*(){let n=O(r),i=[],s=[];for(let a of t){let u,l=n.Ma.get(a);if(l&&l.length!==0){u=yield Jn(n.localStore,Ft(l[0]));for(let d of l){let f=n.Fa.get(d),g=yield E_(n,f);g.snapshot&&s.push(g.snapshot)}}else{let d=yield Hf(n.localStore,a);u=yield Jn(n.localStore,d),yield Ac(n,um(d),a,!1,u.resumeToken)}i.push(u)}return n.Ca.d_(s),i})}function um(r){return uf(r.path,r.collectionGroup,r.orderBy,r.filters,r.limit,"F",r.startAt,r.endAt)}function R_(r){return function(e){return O(O(e).persistence).Qi()}(O(r).localStore)}function P_(r,t,e,n){return V(this,null,function*(){let i=O(r);if(i.Qa)return void C("SyncEngine","Ignoring unexpected query state notification.");let s=i.Ma.get(t);if(s&&s.length>0)switch(e){case"current":case"not-current":{let a=yield Jf(i.localStore,lf(s[0])),u=ri.createSynthesizedRemoteEventForCurrentChange(t,e==="current",gt.EMPTY_BYTE_STRING);yield ve(i,a,u);break}case"rejected":yield Yn(i.localStore,t,!0),tr(i,t,n);break;default:L()}})}function V_(r,t,e){return V(this,null,function*(){let n=no(r);if(n.Qa){for(let i of t){if(n.Ma.has(i)&&n.sharedClientState.isActiveQueryTarget(i)){C("SyncEngine","Adding an already active target "+i);continue}let s=yield Hf(n.localStore,i),a=yield Jn(n.localStore,s);yield Ac(n,um(s),a.targetId,!1,a.resumeToken),eo(n.remoteStore,a)}for(let i of e)n.Ma.has(i)&&(yield Yn(n.localStore,i,!1).then(()=>{Xn(n.remoteStore,i),tr(n,i)}).catch(Ge))}})}function no(r){let t=O(r);return t.remoteStore.remoteSyncer.applyRemoteEvent=om.bind(null,t),t.remoteStore.remoteSyncer.getRemoteKeysForTarget=T_.bind(null,t),t.remoteStore.remoteSyncer.rejectListen=p_.bind(null,t),t.Ca.d_=c_.bind(null,t.eventManager),t.Ca.$a=l_.bind(null,t.eventManager),t}function Pc(r){let t=O(r);return t.remoteStore.remoteSyncer.applySuccessfulWrite=__.bind(null,t),t.remoteStore.remoteSyncer.rejectFailedWrite=y_.bind(null,t),t}function x_(r,t,e){let n=O(r);(function(s,a,u){return V(this,null,function*(){try{let l=yield a.getMetadata();if(yield function(S,N){let k=O(S),D=mt(N.createTime);return k.persistence.runTransaction("hasNewerBundle","readonly",j=>k.Gr.getBundleMetadata(j,N.id)).then(j=>!!j&&j.createTime.compareTo(D)>=0)}(s.localStore,l))return yield a.close(),u._completeWith(function(S){return{taskState:"Success",documentsLoaded:S.totalDocuments,bytesLoaded:S.totalBytes,totalDocuments:S.totalDocuments,totalBytes:S.totalBytes}}(l)),Promise.resolve(new Set);u._updateProgress(im(l));let d=new ku(l,s.localStore,a.serializer),f=yield a.Ua();for(;f;){let _=yield d.la(f);_&&u._updateProgress(_),f=yield a.Ua()}let g=yield d.complete();return yield ve(s,g.Ia,void 0),yield function(S,N){let k=O(S);return k.persistence.runTransaction("Save bundle","readwrite",D=>k.Gr.saveBundleMetadata(D,N))}(s.localStore,l),u._completeWith(g.progress),Promise.resolve(g.Pa)}catch(l){return Qt("SyncEngine",`Loading bundle failed with ${l}`),u._failWith(l),Promise.resolve(new Set)}})})(n,t,e).then(i=>{n.sharedClientState.notifyBundleLoaded(i)})}var qu=(()=>{class r{constructor(){this.kind="memory",this.synchronizeTabs=!1}initialize(e){return V(this,null,function*(){this.serializer=wi(e.databaseInfo.databaseId),this.sharedClientState=this.Wa(e),this.persistence=this.Ga(e),yield this.persistence.start(),this.localStore=this.za(e),this.gcScheduler=this.ja(e,this.localStore),this.indexBackfillerScheduler=this.Ha(e,this.localStore)})}ja(e,n){return null}Ha(e,n){return null}za(e){return Kf(this.persistence,new Ps,e.initialUser,this.serializer)}Ga(e){return new bs(Rs.Zr,this.serializer)}Wa(e){return new Ds}terminate(){return V(this,null,function*(){var e,n;(e=this.gcScheduler)===null||e===void 0||e.stop(),(n=this.indexBackfillerScheduler)===null||n===void 0||n.stop(),this.sharedClientState.shutdown(),yield this.persistence.shutdown()})}}return r.provider={build:()=>new r},r})();var js=class r extends qu{constructor(t,e,n){super(),this.Ja=t,this.cacheSizeBytes=e,this.forceOwnership=n,this.kind="persistent",this.synchronizeTabs=!1}initialize(t){return V(this,null,function*(){yield jo(r.prototype,this,"initialize").call(this,t),yield this.Ja.initialize(this,t),yield Pc(this.Ja.syncEngine),yield ar(this.Ja.remoteStore),yield this.persistence.yi(()=>(this.gcScheduler&&!this.gcScheduler.started&&this.gcScheduler.start(),this.indexBackfillerScheduler&&!this.indexBackfillerScheduler.started&&this.indexBackfillerScheduler.start(),Promise.resolve()))})}za(t){return Kf(this.persistence,new Ps,t.initialUser,this.serializer)}ja(t,e){let n=this.persistence.referenceDelegate.garbageCollector;return new tu(n,t.asyncQueue,e)}Ha(t,e){let n=new _a(e,this.persistence);return new pa(t.asyncQueue,n)}Ga(t){let e=_c(t.databaseInfo.databaseId,t.databaseInfo.persistenceKey),n=this.cacheSizeBytes!==void 0?jt.withCacheSize(this.cacheSizeBytes):jt.DEFAULT;return new gu(this.synchronizeTabs,e,t.clientId,n,t.asyncQueue,Xf(),es(),this.serializer,this.sharedClientState,!!this.forceOwnership)}Wa(t){return new Ds}},Uu=class r extends js{constructor(t,e){super(t,e,!1),this.Ja=t,this.cacheSizeBytes=e,this.synchronizeTabs=!0}initialize(t){return V(this,null,function*(){yield jo(r.prototype,this,"initialize").call(this,t);let e=this.Ja.syncEngine;this.sharedClientState instanceof Qr&&(this.sharedClientState.syncEngine={no:S_.bind(null,e),ro:P_.bind(null,e),io:V_.bind(null,e),Qi:R_.bind(null,e),eo:A_.bind(null,e)},yield this.sharedClientState.start()),yield this.persistence.yi(n=>V(this,null,function*(){yield b_(this.Ja.syncEngine,n),this.gcScheduler&&(n&&!this.gcScheduler.started?this.gcScheduler.start():n||this.gcScheduler.stop()),this.indexBackfillerScheduler&&(n&&!this.indexBackfillerScheduler.started?this.indexBackfillerScheduler.start():n||this.indexBackfillerScheduler.stop())}))})}Wa(t){let e=Xf();if(!Qr.D(e))throw new x(P.UNIMPLEMENTED,"IndexedDB persistence is only available on platforms that support LocalStorage.");let n=_c(t.databaseInfo.databaseId,t.databaseInfo.persistenceKey);return new Qr(e,t.asyncQueue,n,t.clientId,t.initialUser)}},Vc=(()=>{class r{initialize(e,n){return V(this,null,function*(){this.localStore||(this.localStore=e.localStore,this.sharedClientState=e.sharedClientState,this.datastore=this.createDatastore(n),this.remoteStore=this.createRemoteStore(n),this.eventManager=this.createEventManager(n),this.syncEngine=this.createSyncEngine(n,!e.synchronizeTabs),this.sharedClientState.onlineStateHandler=i=>xd(this.syncEngine,i,1),this.remoteStore.remoteSyncer.handleCredentialChange=I_.bind(null,this.syncEngine),yield Pu(this.remoteStore,this.syncEngine.isPrimaryClient))})}createEventManager(e){return function(){return new Cu}()}createDatastore(e){let n=wi(e.databaseInfo.databaseId),i=function(a){return new Tu(a)}(e.databaseInfo);return function(a,u,l,d){return new Su(a,u,l,d)}(e.authCredentials,e.appCheckCredentials,i,n)}createRemoteStore(e){return function(i,s,a,u,l){return new Ru(i,s,a,u,l)}(this.localStore,this.datastore,e.asyncQueue,n=>xd(this.syncEngine,n,0),function(){return Ns.D()?new Ns:new vu}())}createSyncEngine(e,n){return function(s,a,u,l,d,f,g){let _=new Mu(s,a,u,l,d,f);return g&&(_.Qa=!0),_}(this.localStore,this.remoteStore,this.eventManager,this.sharedClientState,e.initialUser,e.maxConcurrentLimboResolutions,n)}terminate(){return V(this,null,function*(){var e,n;yield function(s){return V(this,null,function*(){let a=O(s);C("RemoteStore","RemoteStore shutting down."),a.L_.add(5),yield or(a),a.k_.shutdown(),a.q_.set("Unknown")})}(this.remoteStore),(e=this.datastore)===null||e===void 0||e.terminate(),(n=this.eventManager)===null||n===void 0||n.terminate()})}}return r.provider={build:()=>new r},r})();function Dd(r,t=10240){let e=0;return{read(){return V(this,null,function*(){if(e<r.byteLength){let i={value:r.slice(e,e+t),done:!1};return e+=t,i}return{done:!0}})},cancel(){return V(this,null,function*(){})},releaseLock(){},closed:Promise.resolve()}}var er=class{constructor(t){this.observer=t,this.muted=!1}next(t){this.muted||this.observer.next&&this.Ya(this.observer.next,t)}error(t){this.muted||(this.observer.error?this.Ya(this.observer.error,t):dt("Uncaught Error in snapshot listener:",t.toString()))}Za(){this.muted=!0}Ya(t,e){setTimeout(()=>{this.muted||t(e)},0)}};var Bu=class{constructor(t,e){this.Xa=t,this.serializer=e,this.metadata=new vt,this.buffer=new Uint8Array,this.eu=function(){return new TextDecoder("utf-8")}(),this.tu().then(n=>{n&&n.ua()?this.metadata.resolve(n.aa.metadata):this.metadata.reject(new Error(`The first element of the bundle is not a metadata, it is
             ${JSON.stringify(n?.aa)}`))},n=>this.metadata.reject(n))}close(){return this.Xa.cancel()}getMetadata(){return V(this,null,function*(){return this.metadata.promise})}Ua(){return V(this,null,function*(){return yield this.getMetadata(),this.tu()})}tu(){return V(this,null,function*(){let t=yield this.nu();if(t===null)return null;let e=this.eu.decode(t),n=Number(e);isNaN(n)&&this.ru(`length string (${e}) is not valid number`);let i=yield this.iu(n);return new Nu(JSON.parse(i),t.length+n)})}su(){return this.buffer.findIndex(t=>t===123)}nu(){return V(this,null,function*(){for(;this.su()<0&&!(yield this.ou()););if(this.buffer.length===0)return null;let t=this.su();t<0&&this.ru("Reached the end of bundle when a length string is expected.");let e=this.buffer.slice(0,t);return this.buffer=this.buffer.slice(t),e})}iu(t){return V(this,null,function*(){for(;this.buffer.length<t;)(yield this.ou())&&this.ru("Reached the end of bundle when more is expected.");let e=this.eu.decode(this.buffer.slice(0,t));return this.buffer=this.buffer.slice(t),e})}ru(t){throw this.Xa.cancel(),new Error(`Invalid bundle format: ${t}`)}ou(){return V(this,null,function*(){let t=yield this.Xa.read();if(!t.done){let e=new Uint8Array(this.buffer.length+t.value.length);e.set(this.buffer),e.set(t.value,this.buffer.length),this.buffer=e}return t.done})}};var ju=class{constructor(t){this.datastore=t,this.readVersions=new Map,this.mutations=[],this.committed=!1,this.lastTransactionError=null,this.writtenDocs=new Set}lookup(t){return V(this,null,function*(){if(this.ensureCommitNotCalled(),this.mutations.length>0)throw this.lastTransactionError=new x(P.INVALID_ARGUMENT,"Firestore transactions require all reads to be executed before all writes."),this.lastTransactionError;let e=yield function(i,s){return V(this,null,function*(){let a=O(i),u={documents:s.map(g=>si(a.serializer,g))},l=yield a.Lo("BatchGetDocuments",a.serializer.databaseId,Y.emptyPath(),u,s.length),d=new Map;l.forEach(g=>{let _=Fp(a.serializer,g);d.set(_.key.toString(),_)});let f=[];return s.forEach(g=>{let _=d.get(g.toString());q(!!_),f.push(_)}),f})}(this.datastore,t);return e.forEach(n=>this.recordVersion(n)),e})}set(t,e){this.write(e.toMutation(t,this.precondition(t))),this.writtenDocs.add(t.toString())}update(t,e){try{this.write(e.toMutation(t,this.preconditionForUpdate(t)))}catch(n){this.lastTransactionError=n}this.writtenDocs.add(t.toString())}delete(t){this.write(new Be(t,this.precondition(t))),this.writtenDocs.add(t.toString())}commit(){return V(this,null,function*(){if(this.ensureCommitNotCalled(),this.lastTransactionError)throw this.lastTransactionError;let t=this.readVersions;this.mutations.forEach(e=>{t.delete(e.key.toString())}),t.forEach((e,n)=>{let i=M.fromPath(n);this.mutations.push(new ti(i,this.precondition(i)))}),yield function(n,i){return V(this,null,function*(){let s=O(n),a={writes:i.map(u=>oi(s.serializer,u))};yield s.Mo("Commit",s.serializer.databaseId,Y.emptyPath(),a)})}(this.datastore,this.mutations),this.committed=!0})}recordVersion(t){let e;if(t.isFoundDocument())e=t.version;else{if(!t.isNoDocument())throw L();e=B.min()}let n=this.readVersions.get(t.key.toString());if(n){if(!e.isEqual(n))throw new x(P.ABORTED,"Document version changed between two reads.")}else this.readVersions.set(t.key.toString(),e)}precondition(t){let e=this.readVersions.get(t.toString());return!this.writtenDocs.has(t.toString())&&e?e.isEqual(B.min())?ht.exists(!1):ht.updateTime(e):ht.none()}preconditionForUpdate(t){let e=this.readVersions.get(t.toString());if(!this.writtenDocs.has(t.toString())&&e){if(e.isEqual(B.min()))throw new x(P.INVALID_ARGUMENT,"Can't update a document that doesn't exist.");return ht.updateTime(e)}return ht.exists(!0)}write(t){this.ensureCommitNotCalled(),this.mutations.push(t)}ensureCommitNotCalled(){}};var Gu=class{constructor(t,e,n,i,s){this.asyncQueue=t,this.datastore=e,this.options=n,this.updateFunction=i,this.deferred=s,this._u=n.maxAttempts,this.t_=new li(this.asyncQueue,"transaction_retry")}au(){this._u-=1,this.uu()}uu(){this.t_.Go(()=>V(this,null,function*(){let t=new ju(this.datastore),e=this.cu(t);e&&e.then(n=>{this.asyncQueue.enqueueAndForget(()=>t.commit().then(()=>{this.deferred.resolve(n)}).catch(i=>{this.lu(i)}))}).catch(n=>{this.lu(n)})}))}cu(t){try{let e=this.updateFunction(t);return!gi(e)&&e.catch&&e.then?e:(this.deferred.reject(Error("Transaction callback must return a Promise")),null)}catch(e){return this.deferred.reject(e),null}}lu(t){this._u>0&&this.hu(t)?(this._u-=1,this.asyncQueue.enqueueAndForget(()=>(this.uu(),Promise.resolve()))):this.deferred.reject(t)}hu(t){if(t.name==="FirebaseError"){let e=t.code;return e==="aborted"||e==="failed-precondition"||e==="already-exists"||!Ef(e)}return!1}};var zu=class{constructor(t,e,n,i,s){this.authCredentials=t,this.appCheckCredentials=e,this.asyncQueue=n,this.databaseInfo=i,this.user=yt.UNAUTHENTICATED,this.clientId=rs.newId(),this.authCredentialListener=()=>Promise.resolve(),this.appCheckCredentialListener=()=>Promise.resolve(),this._uninitializedComponentsProvider=s,this.authCredentials.start(n,a=>V(this,null,function*(){C("FirestoreClient","Received user=",a.uid),yield this.authCredentialListener(a),this.user=a})),this.appCheckCredentials.start(n,a=>(C("FirestoreClient","Received new app check token=",a),this.appCheckCredentialListener(a,this.user)))}get configuration(){return{asyncQueue:this.asyncQueue,databaseInfo:this.databaseInfo,clientId:this.clientId,authCredentials:this.authCredentials,appCheckCredentials:this.appCheckCredentials,initialUser:this.user,maxConcurrentLimboResolutions:100}}setCredentialChangeListener(t){this.authCredentialListener=t}setAppCheckTokenChangeListener(t){this.appCheckCredentialListener=t}terminate(){this.asyncQueue.enterRestrictedMode();let t=new vt;return this.asyncQueue.enqueueAndForgetEvenWhileRestricted(()=>V(this,null,function*(){try{this._onlineComponents&&(yield this._onlineComponents.terminate()),this._offlineComponents&&(yield this._offlineComponents.terminate()),this.authCredentials.shutdown(),this.appCheckCredentials.shutdown(),t.resolve()}catch(e){let n=cr(e,"Failed to shutdown persistence");t.reject(n)}})),t.promise}};function sa(r,t){return V(this,null,function*(){r.asyncQueue.verifyOperationInProgress(),C("FirestoreClient","Initializing OfflineComponentProvider");let e=r.configuration;yield t.initialize(e);let n=e.initialUser;r.setCredentialChangeListener(i=>V(this,null,function*(){n.isEqual(i)||(yield $f(t.localStore,i),n=i)})),t.persistence.setDatabaseDeletedListener(()=>r.terminate()),r._offlineComponents=t})}function Nd(r,t){return V(this,null,function*(){r.asyncQueue.verifyOperationInProgress();let e=yield xc(r);C("FirestoreClient","Initializing OnlineComponentProvider"),yield t.initialize(e,r.configuration),r.setCredentialChangeListener(n=>Rd(t.remoteStore,n)),r.setAppCheckTokenChangeListener((n,i)=>Rd(t.remoteStore,i)),r._onlineComponents=t})}function xc(r){return V(this,null,function*(){if(!r._offlineComponents)if(r._uninitializedComponentsProvider){C("FirestoreClient","Using user provided OfflineComponentProvider");try{yield sa(r,r._uninitializedComponentsProvider._offline)}catch(t){let e=t;if(!function(i){return i.name==="FirebaseError"?i.code===P.FAILED_PRECONDITION||i.code===P.UNIMPLEMENTED:!(typeof DOMException<"u"&&i instanceof DOMException)||i.code===22||i.code===20||i.code===11}(e))throw e;Qt("Error using user provided cache. Falling back to memory cache: "+e),yield sa(r,new qu)}}else C("FirestoreClient","Using default OfflineComponentProvider"),yield sa(r,new qu);return r._offlineComponents})}function ro(r){return V(this,null,function*(){return r._onlineComponents||(r._uninitializedComponentsProvider?(C("FirestoreClient","Using user provided OnlineComponentProvider"),yield Nd(r,r._uninitializedComponentsProvider._online)):(C("FirestoreClient","Using default OnlineComponentProvider"),yield Nd(r,new Vc))),r._onlineComponents})}function cm(r){return xc(r).then(t=>t.persistence)}function Cc(r){return xc(r).then(t=>t.localStore)}function lm(r){return ro(r).then(t=>t.remoteStore)}function Dc(r){return ro(r).then(t=>t.syncEngine)}function C_(r){return ro(r).then(t=>t.datastore)}function nr(r){return V(this,null,function*(){let t=yield ro(r),e=t.eventManager;return e.onListen=h_.bind(null,t.syncEngine),e.onUnlisten=f_.bind(null,t.syncEngine),e.onFirstRemoteStoreListen=d_.bind(null,t.syncEngine),e.onLastRemoteStoreUnlisten=m_.bind(null,t.syncEngine),e})}function D_(r){return r.asyncQueue.enqueue(()=>V(this,null,function*(){let t=yield cm(r),e=yield lm(r);return t.setNetworkEnabled(!0),function(i){let s=O(i);return s.L_.delete(0),vi(s)}(e)}))}function N_(r){return r.asyncQueue.enqueue(()=>V(this,null,function*(){let t=yield cm(r),e=yield lm(r);return t.setNetworkEnabled(!1),function(i){return V(this,null,function*(){let s=O(i);s.L_.add(0),yield or(s),s.q_.set("Offline")})}(e)}))}function k_(r,t){let e=new vt;return r.asyncQueue.enqueueAndForget(()=>V(this,null,function*(){return function(i,s,a){return V(this,null,function*(){try{let u=yield function(d,f){let g=O(d);return g.persistence.runTransaction("read document","readonly",_=>g.localDocuments.getDocument(_,f))}(i,s);u.isFoundDocument()?a.resolve(u):u.isNoDocument()?a.resolve(null):a.reject(new x(P.UNAVAILABLE,"Failed to get document from cache. (However, this document may exist on the server. Run again without setting 'source' in the GetOptions to attempt to retrieve the document from the server.)"))}catch(u){let l=cr(u,`Failed to get document '${s} from cache`);a.reject(l)}})}(yield Cc(r),t,e)})),e.promise}function hm(r,t,e={}){let n=new vt;return r.asyncQueue.enqueueAndForget(()=>V(this,null,function*(){return function(s,a,u,l,d){let f=new er({next:_=>{f.Za(),a.enqueueAndForget(()=>Tc(s,g));let S=_.docs.has(u);!S&&_.fromCache?d.reject(new x(P.UNAVAILABLE,"Failed to get document because the client is offline.")):S&&_.fromCache&&l&&l.source==="server"?d.reject(new x(P.UNAVAILABLE,'Failed to get document from server. (However, this document does exist in the local cache. Run again without setting source to "server" to retrieve the cached document.)')):d.resolve(_)},error:_=>d.reject(_)}),g=new hi(sr(u.path),f,{includeMetadataChanges:!0,_a:!0});return Ic(s,g)}(yield nr(r),r.asyncQueue,t,e,n)})),n.promise}function F_(r,t){let e=new vt;return r.asyncQueue.enqueueAndForget(()=>V(this,null,function*(){return function(i,s,a){return V(this,null,function*(){try{let u=yield Vs(i,s,!0),l=new Bs(s,u.Ts),d=l.ma(u.documents),f=l.applyChanges(d,!1);a.resolve(f.snapshot)}catch(u){let l=cr(u,`Failed to execute query '${s} against cache`);a.reject(l)}})}(yield Cc(r),t,e)})),e.promise}function dm(r,t,e={}){let n=new vt;return r.asyncQueue.enqueueAndForget(()=>V(this,null,function*(){return function(s,a,u,l,d){let f=new er({next:_=>{f.Za(),a.enqueueAndForget(()=>Tc(s,g)),_.fromCache&&l.source==="server"?d.reject(new x(P.UNAVAILABLE,'Failed to get documents from server. (However, these documents may exist in the local cache. Run again without setting source to "server" to retrieve the cached documents.)')):d.resolve(_)},error:_=>d.reject(_)}),g=new hi(u,f,{includeMetadataChanges:!0,_a:!0});return Ic(s,g)}(yield nr(r),r.asyncQueue,t,e,n)})),n.promise}function O_(r,t){let e=new er(t);return r.asyncQueue.enqueueAndForget(()=>V(this,null,function*(){return function(i,s){O(i).Y_.add(s),s.next()}(yield nr(r),e)})),()=>{e.Za(),r.asyncQueue.enqueueAndForget(()=>V(this,null,function*(){return function(i,s){O(i).Y_.delete(s)}(yield nr(r),e)}))}}function M_(r,t,e,n){let i=function(a,u){let l;return l=typeof a=="string"?Sf().encode(a):a,function(f,g){return new Bu(f,g)}(function(f,g){if(f instanceof Uint8Array)return Dd(f,g);if(f instanceof ArrayBuffer)return Dd(new Uint8Array(f),g);if(f instanceof ReadableStream)return f.getReader();throw new Error("Source of `toByteStreamReader` has to be a ArrayBuffer or ReadableStream")}(l),u)}(e,wi(t));r.asyncQueue.enqueueAndForget(()=>V(this,null,function*(){x_(yield Dc(r),i,n)}))}function L_(r,t){return r.asyncQueue.enqueue(()=>V(this,null,function*(){return function(n,i){let s=O(n);return s.persistence.runTransaction("Get named query","readonly",a=>s.Gr.getNamedQuery(a,i))}(yield Cc(r),t)}))}function fm(r){let t={};return r.timeoutSeconds!==void 0&&(t.timeoutSeconds=r.timeoutSeconds),t}var kd=new Map;function Nc(r,t,e){if(!e)throw new x(P.INVALID_ARGUMENT,`Function ${r}() cannot be called with an empty ${t}.`)}function kc(r,t,e,n){if(t===!0&&n===!0)throw new x(P.INVALID_ARGUMENT,`${r} and ${e} cannot be used together.`)}function Fd(r){if(!M.isDocumentKey(r))throw new x(P.INVALID_ARGUMENT,`Invalid document reference. Document references must have an even number of segments, but ${r} has ${r.length}.`)}function Od(r){if(M.isDocumentKey(r))throw new x(P.INVALID_ARGUMENT,`Invalid collection reference. Collection references must have an odd number of segments, but ${r} has ${r.length}.`)}function io(r){if(r===void 0)return"undefined";if(r===null)return"null";if(typeof r=="string")return r.length>20&&(r=`${r.substring(0,20)}...`),JSON.stringify(r);if(typeof r=="number"||typeof r=="boolean")return""+r;if(typeof r=="object"){if(r instanceof Array)return"an array";{let t=function(n){return n.constructor?n.constructor.name:null}(r);return t?`a custom ${t} object`:"an object"}}return typeof r=="function"?"a function":L()}function X(r,t){if("_delegate"in r&&(r=r._delegate),!(r instanceof t)){if(t.name===r.constructor.name)throw new x(P.INVALID_ARGUMENT,"Type does not match the expected instance. Did you pass a reference from a different Firestore SDK?");{let e=io(r);throw new x(P.INVALID_ARGUMENT,`Expected type '${t.name}', but it was: ${e}`)}}return r}function mm(r,t){if(t<=0)throw new x(P.INVALID_ARGUMENT,`Function ${r}() requires a positive number, but it was: ${t}.`)}var Gs=class{constructor(t){var e,n;if(t.host===void 0){if(t.ssl!==void 0)throw new x(P.INVALID_ARGUMENT,"Can't provide ssl option if host option is not set");this.host="firestore.googleapis.com",this.ssl=!0}else this.host=t.host,this.ssl=(e=t.ssl)===null||e===void 0||e;if(this.credentials=t.credentials,this.ignoreUndefinedProperties=!!t.ignoreUndefinedProperties,this.localCache=t.localCache,t.cacheSizeBytes===void 0)this.cacheSizeBytes=41943040;else{if(t.cacheSizeBytes!==-1&&t.cacheSizeBytes<1048576)throw new x(P.INVALID_ARGUMENT,"cacheSizeBytes must be at least 1048576");this.cacheSizeBytes=t.cacheSizeBytes}kc("experimentalForceLongPolling",t.experimentalForceLongPolling,"experimentalAutoDetectLongPolling",t.experimentalAutoDetectLongPolling),this.experimentalForceLongPolling=!!t.experimentalForceLongPolling,this.experimentalForceLongPolling?this.experimentalAutoDetectLongPolling=!1:t.experimentalAutoDetectLongPolling===void 0?this.experimentalAutoDetectLongPolling=!0:this.experimentalAutoDetectLongPolling=!!t.experimentalAutoDetectLongPolling,this.experimentalLongPollingOptions=fm((n=t.experimentalLongPollingOptions)!==null&&n!==void 0?n:{}),function(s){if(s.timeoutSeconds!==void 0){if(isNaN(s.timeoutSeconds))throw new x(P.INVALID_ARGUMENT,`invalid long polling timeout: ${s.timeoutSeconds} (must not be NaN)`);if(s.timeoutSeconds<5)throw new x(P.INVALID_ARGUMENT,`invalid long polling timeout: ${s.timeoutSeconds} (minimum allowed value is 5)`);if(s.timeoutSeconds>30)throw new x(P.INVALID_ARGUMENT,`invalid long polling timeout: ${s.timeoutSeconds} (maximum allowed value is 30)`)}}(this.experimentalLongPollingOptions),this.useFetchStreams=!!t.useFetchStreams}isEqual(t){return this.host===t.host&&this.ssl===t.ssl&&this.credentials===t.credentials&&this.cacheSizeBytes===t.cacheSizeBytes&&this.experimentalForceLongPolling===t.experimentalForceLongPolling&&this.experimentalAutoDetectLongPolling===t.experimentalAutoDetectLongPolling&&function(n,i){return n.timeoutSeconds===i.timeoutSeconds}(this.experimentalLongPollingOptions,t.experimentalLongPollingOptions)&&this.ignoreUndefinedProperties===t.ignoreUndefinedProperties&&this.useFetchStreams===t.useFetchStreams}},dn=class{constructor(t,e,n,i){this._authCredentials=t,this._appCheckCredentials=e,this._databaseId=n,this._app=i,this.type="firestore-lite",this._persistenceKey="(lite)",this._settings=new Gs({}),this._settingsFrozen=!1,this._terminateTask="notTerminated"}get app(){if(!this._app)throw new x(P.FAILED_PRECONDITION,"Firestore was not initialized using the Firebase SDK. 'app' is not available");return this._app}get _initialized(){return this._settingsFrozen}get _terminated(){return this._terminateTask!=="notTerminated"}_setSettings(t){if(this._settingsFrozen)throw new x(P.FAILED_PRECONDITION,"Firestore has already been started and its settings can no longer be changed. You can only modify settings before calling any other methods on a Firestore object.");this._settings=new Gs(t),t.credentials!==void 0&&(this._authCredentials=function(n){if(!n)return new oa;switch(n.type){case"firstParty":return new la(n.sessionIndex||"0",n.iamToken||null,n.authTokenFactory||null);case"provider":return n.client;default:throw new x(P.INVALID_ARGUMENT,"makeAuthCredentialsProvider failed due to invalid credential type")}}(t.credentials))}_getSettings(){return this._settings}_freezeSettings(){return this._settingsFrozen=!0,this._settings}_delete(){return this._terminateTask==="notTerminated"&&(this._terminateTask=this._terminate()),this._terminateTask}_restart(){return V(this,null,function*(){this._terminateTask==="notTerminated"?yield this._terminate():this._terminateTask="notTerminated"})}toJSON(){return{app:this._app,databaseId:this._databaseId,settings:this._settings}}_terminate(){return function(e){let n=kd.get(e);n&&(C("ComponentProvider","Removing Datastore"),kd.delete(e),n.terminate())}(this),Promise.resolve()}};function Fc(r,t,e,n={}){var i;let s=(r=X(r,dn))._getSettings(),a=`${t}:${e}`;if(s.host!=="firestore.googleapis.com"&&s.host!==a&&Qt("Host has been set in both settings() and connectFirestoreEmulator(), emulator host will be used."),r._setSettings(Object.assign(Object.assign({},s),{host:a,ssl:!1})),n.mockUserToken){let u,l;if(typeof n.mockUserToken=="string")u=n.mockUserToken,l=yt.MOCK_USER;else{u=dh(n.mockUserToken,(i=r._app)===null||i===void 0?void 0:i.options.projectId);let d=n.mockUserToken.sub||n.mockUserToken.user_id;if(!d)throw new x(P.INVALID_ARGUMENT,"mockUserToken must contain 'sub' or 'user_id' field!");l=new yt(d)}r._authCredentials=new aa(new ns(u,l))}}var At=class r{constructor(t,e,n){this.converter=e,this._query=n,this.type="query",this.firestore=t}withConverter(t){return new r(this.firestore,t,this._query)}},rt=class r{constructor(t,e,n){this.converter=e,this._key=n,this.type="document",this.firestore=t}get _path(){return this._key.path}get id(){return this._key.path.lastSegment()}get path(){return this._key.path.canonicalString()}get parent(){return new re(this.firestore,this.converter,this._key.path.popLast())}withConverter(t){return new r(this.firestore,t,this._key)}},re=class r extends At{constructor(t,e,n){super(t,e,sr(n)),this._path=n,this.type="collection"}get id(){return this._query.path.lastSegment()}get path(){return this._query.path.canonicalString()}get parent(){let t=this._path.popLast();return t.isEmpty()?null:new rt(this.firestore,null,new M(t))}withConverter(t){return new r(this.firestore,t,this._path)}};function Oc(r,t,...e){if(r=lt(r),Nc("collection","path",t),r instanceof dn){let n=Y.fromString(t,...e);return Od(n),new re(r,null,n)}{if(!(r instanceof rt||r instanceof re))throw new x(P.INVALID_ARGUMENT,"Expected first argument to collection() to be a CollectionReference, a DocumentReference or FirebaseFirestore");let n=r._path.child(Y.fromString(t,...e));return Od(n),new re(r.firestore,null,n)}}function gm(r,t){if(r=X(r,dn),Nc("collectionGroup","collection id",t),t.indexOf("/")>=0)throw new x(P.INVALID_ARGUMENT,`Invalid collection ID '${t}' passed to function collectionGroup(). Collection IDs must not contain '/'.`);return new At(r,null,function(n){return new Wt(Y.emptyPath(),n)}(t))}function Ii(r,t,...e){if(r=lt(r),arguments.length===1&&(t=rs.newId()),Nc("doc","path",t),r instanceof dn){let n=Y.fromString(t,...e);return Fd(n),new rt(r,null,new M(n))}{if(!(r instanceof rt||r instanceof re))throw new x(P.INVALID_ARGUMENT,"Expected first argument to collection() to be a CollectionReference, a DocumentReference or FirebaseFirestore");let n=r._path.child(Y.fromString(t,...e));return Fd(n),new rt(r.firestore,r instanceof re?r.converter:null,new M(n))}}function Mc(r,t){return r=lt(r),t=lt(t),(r instanceof rt||r instanceof re)&&(t instanceof rt||t instanceof re)&&r.firestore===t.firestore&&r.path===t.path&&r.converter===t.converter}function Lc(r,t){return r=lt(r),t=lt(t),r instanceof At&&t instanceof At&&r.firestore===t.firestore&&_i(r._query,t._query)&&r.converter===t.converter}var zs=class{constructor(t=Promise.resolve()){this.Pu=[],this.Iu=!1,this.Tu=[],this.Eu=null,this.du=!1,this.Au=!1,this.Ru=[],this.t_=new li(this,"async_queue_retry"),this.Vu=()=>{let n=es();n&&C("AsyncQueue","Visibility state changed to "+n.visibilityState),this.t_.jo()},this.mu=t;let e=es();e&&typeof e.addEventListener=="function"&&e.addEventListener("visibilitychange",this.Vu)}get isShuttingDown(){return this.Iu}enqueueAndForget(t){this.enqueue(t)}enqueueAndForgetEvenWhileRestricted(t){this.fu(),this.gu(t)}enterRestrictedMode(t){if(!this.Iu){this.Iu=!0,this.Au=t||!1;let e=es();e&&typeof e.removeEventListener=="function"&&e.removeEventListener("visibilitychange",this.Vu)}}enqueue(t){if(this.fu(),this.Iu)return new Promise(()=>{});let e=new vt;return this.gu(()=>this.Iu&&this.Au?Promise.resolve():(t().then(e.resolve,e.reject),e.promise)).then(()=>e.promise)}enqueueRetryable(t){this.enqueueAndForget(()=>(this.Pu.push(t),this.pu()))}pu(){return V(this,null,function*(){if(this.Pu.length!==0){try{yield this.Pu[0](),this.Pu.shift(),this.t_.reset()}catch(t){if(!ze(t))throw t;C("AsyncQueue","Operation failed with retryable error: "+t)}this.Pu.length>0&&this.t_.Go(()=>this.pu())}})}gu(t){let e=this.mu.then(()=>(this.du=!0,t().catch(n=>{this.Eu=n,this.du=!1;let i=function(a){let u=a.message||"";return a.stack&&(u=a.stack.includes(a.message)?a.stack:a.message+`
`+a.stack),u}(n);throw dt("INTERNAL UNHANDLED ERROR: ",i),n}).then(n=>(this.du=!1,n))));return this.mu=e,e}enqueueAfterDelay(t,e,n){this.fu(),this.Ru.indexOf(t)>-1&&(e=0);let i=Vu.createAndSchedule(this,t,e,n,s=>this.yu(s));return this.Tu.push(i),i}fu(){this.Eu&&L()}verifyOperationInProgress(){}wu(){return V(this,null,function*(){let t;do t=this.mu,yield t;while(t!==this.mu)})}Su(t){for(let e of this.Tu)if(e.timerId===t)return!0;return!1}bu(t){return this.wu().then(()=>{this.Tu.sort((e,n)=>e.targetTimeMs-n.targetTimeMs);for(let e of this.Tu)if(e.skipDelay(),t!=="all"&&e.timerId===t)break;return this.wu()})}Du(t){this.Ru.push(t)}yu(t){let e=this.Tu.indexOf(t);this.Tu.splice(e,1)}};function Ku(r){return function(e,n){if(typeof e!="object"||e===null)return!1;let i=e;for(let s of n)if(s in i&&typeof i[s]=="function")return!0;return!1}(r,["next","error","complete"])}var $u=class{constructor(){this._progressObserver={},this._taskCompletionResolver=new vt,this._lastProgress={taskState:"Running",totalBytes:0,totalDocuments:0,bytesLoaded:0,documentsLoaded:0}}onProgress(t,e,n){this._progressObserver={next:t,error:e,complete:n}}catch(t){return this._taskCompletionResolver.promise.catch(t)}then(t,e){return this._taskCompletionResolver.promise.then(t,e)}_completeWith(t){this._updateProgress(t),this._progressObserver.complete&&this._progressObserver.complete(),this._taskCompletionResolver.resolve(t)}_failWith(t){this._lastProgress.taskState="Error",this._progressObserver.next&&this._progressObserver.next(this._lastProgress),this._progressObserver.error&&this._progressObserver.error(t),this._taskCompletionResolver.reject(t)}_updateProgress(t){this._lastProgress=t,this._progressObserver.next&&this._progressObserver.next(t)}};var pm=-1,ut=class extends dn{constructor(t,e,n,i){super(t,e,n,i),this.type="firestore",this._queue=new zs,this._persistenceKey=i?.name||"[DEFAULT]"}_terminate(){return V(this,null,function*(){if(this._firestoreClient){let t=this._firestoreClient.terminate();this._queue=new zs(t),this._firestoreClient=void 0,yield t}})}};function yy(r,t){let e=typeof r=="object"?r:wh(),n=typeof r=="string"?r:t||"(default)",i=_h(e,"firestore").getImmediate({identifier:n});if(!i._initialized){let s=hh("firestore");s&&Fc(i,...s)}return i}function St(r){if(r._terminated)throw new x(P.FAILED_PRECONDITION,"The client has already been terminated.");return r._firestoreClient||_m(r),r._firestoreClient}function _m(r){var t,e,n;let i=r._freezeSettings(),s=function(u,l,d,f){return new ya(u,l,d,f.host,f.ssl,f.experimentalForceLongPolling,f.experimentalAutoDetectLongPolling,fm(f.experimentalLongPollingOptions),f.useFetchStreams)}(r._databaseId,((t=r._app)===null||t===void 0?void 0:t.options.appId)||"",r._persistenceKey,i);r._componentsProvider||!((e=i.localCache)===null||e===void 0)&&e._offlineComponentProvider&&(!((n=i.localCache)===null||n===void 0)&&n._onlineComponentProvider)&&(r._componentsProvider={_offline:i.localCache._offlineComponentProvider,_online:i.localCache._onlineComponentProvider}),r._firestoreClient=new zu(r._authCredentials,r._appCheckCredentials,r._queue,s,r._componentsProvider&&function(u){let l=u?._online.build();return{_offline:u?._offline.build(l),_online:l}}(r._componentsProvider))}function ym(r,t){Qt("enableIndexedDbPersistence() will be deprecated in the future, you can use `FirestoreSettings.cache` instead.");let e=r._freezeSettings();return vm(r,Vc.provider,{build:n=>new js(n,e.cacheSizeBytes,t?.forceOwnership)}),Promise.resolve()}function wm(r){return V(this,null,function*(){Qt("enableMultiTabIndexedDbPersistence() will be deprecated in the future, you can use `FirestoreSettings.cache` instead.");let t=r._freezeSettings();vm(r,Vc.provider,{build:e=>new Uu(e,t.cacheSizeBytes)})})}function vm(r,t,e){if((r=X(r,ut))._firestoreClient||r._terminated)throw new x(P.FAILED_PRECONDITION,"Firestore has already been started and persistence can no longer be enabled. You can only enable persistence before calling any other methods on a Firestore object.");if(r._componentsProvider||r._getSettings().localCache)throw new x(P.FAILED_PRECONDITION,"SDK cache is already specified.");r._componentsProvider={_online:t,_offline:e},_m(r)}function Im(r){if(r._initialized&&!r._terminated)throw new x(P.FAILED_PRECONDITION,"Persistence can only be cleared before a Firestore instance is initialized or after it is terminated.");let t=new vt;return r._queue.enqueueAndForgetEvenWhileRestricted(()=>V(this,null,function*(){try{yield function(n){return V(this,null,function*(){if(!ke.D())return Promise.resolve();let i=n+"main";yield ke.delete(i)})}(_c(r._databaseId,r._persistenceKey)),t.resolve()}catch(e){t.reject(e)}})),t.promise}function Tm(r){return function(e){let n=new vt;return e.asyncQueue.enqueueAndForget(()=>V(this,null,function*(){return w_(yield Dc(e),n)})),n.promise}(St(r=X(r,ut)))}function Em(r){return D_(St(r=X(r,ut)))}function Am(r){return N_(St(r=X(r,ut)))}function Sm(r,t){let e=St(r=X(r,ut)),n=new $u;return M_(e,r._databaseId,t,n),n}function bm(r,t){return L_(St(r=X(r,ut)),t).then(e=>e?new At(r,null,e.query):null)}var ae=class r{constructor(t){this._byteString=t}static fromBase64String(t){try{return new r(gt.fromBase64String(t))}catch(e){throw new x(P.INVALID_ARGUMENT,"Failed to construct data from Base64 string: "+e)}}static fromUint8Array(t){return new r(gt.fromUint8Array(t))}toBase64(){return this._byteString.toBase64()}toUint8Array(){return this._byteString.toUint8Array()}toString(){return"Bytes(base64: "+this.toBase64()+")"}isEqual(t){return this._byteString.isEqual(t._byteString)}};var Jt=class{constructor(...t){for(let e=0;e<t.length;++e)if(t[e].length===0)throw new x(P.INVALID_ARGUMENT,"Invalid field name at argument $(i + 1). Field names must not be empty.");this._internalPath=new ft(t)}isEqual(t){return this._internalPath.isEqual(t._internalPath)}};var ye=class{constructor(t){this._methodName=t}};var fn=class{constructor(t,e){if(!isFinite(t)||t<-90||t>90)throw new x(P.INVALID_ARGUMENT,"Latitude must be a number between -90 and 90, but was: "+t);if(!isFinite(e)||e<-180||e>180)throw new x(P.INVALID_ARGUMENT,"Longitude must be a number between -180 and 180, but was: "+e);this._lat=t,this._long=e}get latitude(){return this._lat}get longitude(){return this._long}isEqual(t){return this._lat===t._lat&&this._long===t._long}toJSON(){return{latitude:this._lat,longitude:this._long}}_compareTo(t){return z(this._lat,t._lat)||z(this._long,t._long)}};var di=class{constructor(t){this._values=(t||[]).map(e=>e)}toArray(){return this._values.map(t=>t)}isEqual(t){return function(n,i){if(n.length!==i.length)return!1;for(let s=0;s<n.length;++s)if(n[s]!==i[s])return!1;return!0}(this._values,t._values)}};var q_=/^__.*__$/,Qu=class{constructor(t,e,n){this.data=t,this.fieldMask=e,this.fieldTransforms=n}toMutation(t,e){return this.fieldMask!==null?new Ht(t,this.data,this.fieldMask,e,this.fieldTransforms):new Ue(t,this.data,e,this.fieldTransforms)}},Ks=class{constructor(t,e,n){this.data=t,this.fieldMask=e,this.fieldTransforms=n}toMutation(t,e){return new Ht(t,this.data,this.fieldMask,e,this.fieldTransforms)}};function Rm(r){switch(r){case 0:case 2:case 1:return!0;case 3:case 4:return!1;default:throw L()}}var $s=class r{constructor(t,e,n,i,s,a){this.settings=t,this.databaseId=e,this.serializer=n,this.ignoreUndefinedProperties=i,s===void 0&&this.vu(),this.fieldTransforms=s||[],this.fieldMask=a||[]}get path(){return this.settings.path}get Cu(){return this.settings.Cu}Fu(t){return new r(Object.assign(Object.assign({},this.settings),t),this.databaseId,this.serializer,this.ignoreUndefinedProperties,this.fieldTransforms,this.fieldMask)}Mu(t){var e;let n=(e=this.path)===null||e===void 0?void 0:e.child(t),i=this.Fu({path:n,xu:!1});return i.Ou(t),i}Nu(t){var e;let n=(e=this.path)===null||e===void 0?void 0:e.child(t),i=this.Fu({path:n,xu:!1});return i.vu(),i}Lu(t){return this.Fu({path:void 0,xu:!0})}Bu(t){return Qs(t,this.settings.methodName,this.settings.ku||!1,this.path,this.settings.qu)}contains(t){return this.fieldMask.find(e=>t.isPrefixOf(e))!==void 0||this.fieldTransforms.find(e=>t.isPrefixOf(e.field))!==void 0}vu(){if(this.path)for(let t=0;t<this.path.length;t++)this.Ou(this.path.get(t))}Ou(t){if(t.length===0)throw this.Bu("Document fields must not be empty");if(Rm(this.Cu)&&q_.test(t))throw this.Bu('Document fields cannot begin and end with "__"')}},Wu=class{constructor(t,e,n){this.databaseId=t,this.ignoreUndefinedProperties=e,this.serializer=n||wi(t)}Qu(t,e,n,i=!1){return new $s({Cu:t,methodName:e,qu:n,path:ft.emptyPath(),xu:!1,ku:i},this.databaseId,this.serializer,this.ignoreUndefinedProperties)}};function _n(r){let t=r._freezeSettings(),e=wi(r._databaseId);return new Wu(r._databaseId,!!t.ignoreUndefinedProperties,e)}function so(r,t,e,n,i,s={}){let a=r.Qu(s.merge||s.mergeFields?2:0,t,e,i);Bc("Data must be an object, but it was:",a,n);let u=xm(n,a),l,d;if(s.merge)l=new Ut(a.fieldMask),d=a.fieldTransforms;else if(s.mergeFields){let f=[];for(let g of s.mergeFields){let _=Zu(t,g,e);if(!a.contains(_))throw new x(P.INVALID_ARGUMENT,`Field '${_}' is specified in your field mask but missing from your input data.`);Dm(f,_)||f.push(_)}l=new Ut(f),d=a.fieldTransforms.filter(g=>l.covers(g.field))}else l=null,d=a.fieldTransforms;return new Qu(new Ct(u),l,d)}var fi=class r extends ye{_toFieldTransform(t){if(t.Cu!==2)throw t.Cu===1?t.Bu(`${this._methodName}() can only appear at the top level of your update data`):t.Bu(`${this._methodName}() cannot be used with set() unless you pass {merge:true}`);return t.fieldMask.push(t.path),null}isEqual(t){return t instanceof r}};function Pm(r,t,e){return new $s({Cu:3,qu:t.settings.qu,methodName:r._methodName,xu:e},t.databaseId,t.serializer,t.ignoreUndefinedProperties)}var Hu=class r extends ye{_toFieldTransform(t){return new cn(t.path,new Le)}isEqual(t){return t instanceof r}},Ju=class r extends ye{constructor(t,e){super(t),this.Ku=e}_toFieldTransform(t){let e=Pm(this,t,!0),n=this.Ku.map(s=>yn(s,e)),i=new pe(n);return new cn(t.path,i)}isEqual(t){return t instanceof r&&$o(this.Ku,t.Ku)}},Yu=class r extends ye{constructor(t,e){super(t),this.Ku=e}_toFieldTransform(t){let e=Pm(this,t,!0),n=this.Ku.map(s=>yn(s,e)),i=new _e(n);return new cn(t.path,i)}isEqual(t){return t instanceof r&&$o(this.Ku,t.Ku)}},Xu=class r extends ye{constructor(t,e){super(t),this.$u=e}_toFieldTransform(t){let e=new qe(t.serializer,pf(t.serializer,this.$u));return new cn(t.path,e)}isEqual(t){return t instanceof r&&this.$u===t.$u}};function qc(r,t,e,n){let i=r.Qu(1,t,e);Bc("Data must be an object, but it was:",i,n);let s=[],a=Ct.empty();pn(n,(l,d)=>{let f=jc(t,l,e);d=lt(d);let g=i.Nu(f);if(d instanceof fi)s.push(f);else{let _=yn(d,g);_!=null&&(s.push(f),a.set(f,_))}});let u=new Ut(s);return new Ks(a,u,i.fieldTransforms)}function Uc(r,t,e,n,i,s){let a=r.Qu(1,t,e),u=[Zu(t,n,e)],l=[i];if(s.length%2!=0)throw new x(P.INVALID_ARGUMENT,`Function ${t}() needs to be called with an even number of arguments that alternate between field names and values.`);for(let _=0;_<s.length;_+=2)u.push(Zu(t,s[_])),l.push(s[_+1]);let d=[],f=Ct.empty();for(let _=u.length-1;_>=0;--_)if(!Dm(d,u[_])){let S=u[_],N=l[_];N=lt(N);let k=a.Nu(S);if(N instanceof fi)d.push(S);else{let D=yn(N,k);D!=null&&(d.push(S),f.set(S,D))}}let g=new Ut(d);return new Ks(f,g,a.fieldTransforms)}function Vm(r,t,e,n=!1){return yn(e,r.Qu(n?4:3,t))}function yn(r,t){if(Cm(r=lt(r)))return Bc("Unsupported field value:",t,r),xm(r,t);if(r instanceof ye)return function(n,i){if(!Rm(i.Cu))throw i.Bu(`${n._methodName}() can only be used with update() and set()`);if(!i.path)throw i.Bu(`${n._methodName}() is not currently supported inside arrays`);let s=n._toFieldTransform(i);s&&i.fieldTransforms.push(s)}(r,t),null;if(r===void 0&&t.ignoreUndefinedProperties)return null;if(t.path&&t.fieldMask.push(t.path),r instanceof Array){if(t.settings.xu&&t.Cu!==4)throw t.Bu("Nested arrays are not supported");return function(n,i){let s=[],a=0;for(let u of n){let l=yn(u,i.Lu(a));l==null&&(l={nullValue:"NULL_VALUE"}),s.push(l),a++}return{arrayValue:{values:s}}}(r,t)}return function(n,i){if((n=lt(n))===null)return{nullValue:"NULL_VALUE"};if(typeof n=="number")return pf(i.serializer,n);if(typeof n=="boolean")return{booleanValue:n};if(typeof n=="string")return{stringValue:n};if(n instanceof Date){let s=at.fromDate(n);return{timestampValue:Qn(i.serializer,s)}}if(n instanceof at){let s=new at(n.seconds,1e3*Math.floor(n.nanoseconds/1e3));return{timestampValue:Qn(i.serializer,s)}}if(n instanceof fn)return{geoPointValue:{latitude:n.latitude,longitude:n.longitude}};if(n instanceof ae)return{bytesValue:bf(i.serializer,n._byteString)};if(n instanceof rt){let s=i.databaseId,a=n.firestore._databaseId;if(!a.isEqual(s))throw i.Bu(`Document reference is for database ${a.projectId}/${a.database} but should be for database ${s.projectId}/${s.database}`);return{referenceValue:mc(n.firestore._databaseId||i.databaseId,n._key.path)}}if(n instanceof di)return function(a,u){return{mapValue:{fields:{__type__:{stringValue:"__vector__"},value:{arrayValue:{values:a.toArray().map(l=>{if(typeof l!="number")throw u.Bu("VectorValues must only contain numeric values.");return fc(u.serializer,l)})}}}}}}(n,i);throw i.Bu(`Unsupported field value: ${io(n)}`)}(r,t)}function xm(r,t){let e={};return Yd(r)?t.path&&t.path.length>0&&t.fieldMask.push(t.path):pn(r,(n,i)=>{let s=yn(i,t.Mu(n));s!=null&&(e[n]=s)}),{mapValue:{fields:e}}}function Cm(r){return!(typeof r!="object"||r===null||r instanceof Array||r instanceof Date||r instanceof at||r instanceof fn||r instanceof ae||r instanceof rt||r instanceof ye||r instanceof di)}function Bc(r,t,e){if(!Cm(e)||!function(i){return typeof i=="object"&&i!==null&&(Object.getPrototypeOf(i)===Object.prototype||Object.getPrototypeOf(i)===null)}(e)){let n=io(e);throw n==="an object"?t.Bu(r+" a custom object"):t.Bu(r+" "+n)}}function Zu(r,t,e){if((t=lt(t))instanceof Jt)return t._internalPath;if(typeof t=="string")return jc(r,t);throw Qs("Field path arguments must be of type string or ",r,!1,void 0,e)}var U_=new RegExp("[~\\*/\\[\\]]");function jc(r,t,e){if(t.search(U_)>=0)throw Qs(`Invalid field path (${t}). Paths must not contain '~', '*', '/', '[', or ']'`,r,!1,void 0,e);try{return new Jt(...t.split("."))._internalPath}catch{throw Qs(`Invalid field path (${t}). Paths must not be empty, begin with '.', end with '.', or contain '..'`,r,!1,void 0,e)}}function Qs(r,t,e,n,i){let s=n&&!n.isEmpty(),a=i!==void 0,u=`Function ${t}() called with invalid data`;e&&(u+=" (via `toFirestore()`)"),u+=". ";let l="";return(s||a)&&(l+=" (found",s&&(l+=` in field ${n}`),a&&(l+=` in document ${i}`),l+=")"),new x(P.INVALID_ARGUMENT,u+r+l)}function Dm(r,t){return r.some(e=>e.isEqual(t))}var mn=class{constructor(t,e,n,i,s){this._firestore=t,this._userDataWriter=e,this._key=n,this._document=i,this._converter=s}get id(){return this._key.path.lastSegment()}get ref(){return new rt(this._firestore,this._converter,this._key)}exists(){return this._document!==null}data(){if(this._document){if(this._converter){let t=new tc(this._firestore,this._userDataWriter,this._key,this._document,null);return this._converter.fromFirestore(t)}return this._userDataWriter.convertValue(this._document.data.value)}}get(t){if(this._document){let e=this._document.data.field(oo("DocumentSnapshot.get",t));if(e!==null)return this._userDataWriter.convertValue(e)}}},tc=class extends mn{data(){return super.data()}};function oo(r,t){return typeof t=="string"?jc(r,t):t instanceof Jt?t._internalPath:t._delegate._internalPath}function Nm(r){if(r.limitType==="L"&&r.explicitOrderBy.length===0)throw new x(P.UNIMPLEMENTED,"limitToLast() queries require specifying at least one orderBy() clause")}var mi=class{},gn=class extends mi{};function Ie(r,t,...e){let n=[];t instanceof mi&&n.push(t),n=n.concat(e),function(s){let a=s.filter(l=>l instanceof ec).length,u=s.filter(l=>l instanceof Ws).length;if(a>1||a>0&&u>0)throw new x(P.INVALID_ARGUMENT,"InvalidQuery. When using composite filters, you cannot use more than one filter at the top level. Consider nesting the multiple filters within an `and(...)` statement. For example: change `query(query, where(...), or(...))` to `query(query, and(where(...), or(...)))`.")}(n);for(let i of n)r=i._apply(r);return r}var Ws=class r extends gn{constructor(t,e,n){super(),this._field=t,this._op=e,this._value=n,this.type="where"}static _create(t,e,n){return new r(t,e,n)}_apply(t){let e=this._parse(t);return Gm(t._query,e),new At(t.firestore,t.converter,Ca(t._query,e))}_parse(t){let e=_n(t.firestore);return function(s,a,u,l,d,f,g){let _;if(d.isKeyField()){if(f==="array-contains"||f==="array-contains-any")throw new x(P.INVALID_ARGUMENT,`Invalid Query. You can't perform '${f}' queries on documentId().`);if(f==="in"||f==="not-in"){Ld(g,f);let S=[];for(let N of g)S.push(Md(l,s,N));_={arrayValue:{values:S}}}else _=Md(l,s,g)}else f!=="in"&&f!=="not-in"&&f!=="array-contains-any"||Ld(g,f),_=Vm(u,a,g,f==="in"||f==="not-in");return W.create(d,f,_)}(t._query,"where",e,t.firestore._databaseId,this._field,this._op,this._value)}};function km(r,t,e){let n=t,i=oo("where",r);return Ws._create(i,n,e)}var ec=class r extends mi{constructor(t,e){super(),this.type=t,this._queryConstraints=e}static _create(t,e){return new r(t,e)}_parse(t){let e=this._queryConstraints.map(n=>n._parse(t)).filter(n=>n.getFilters().length>0);return e.length===1?e[0]:tt.create(e,this._getOperator())}_apply(t){let e=this._parse(t);return e.getFilters().length===0?t:(function(i,s){let a=i,u=s.getFlattenedFilters();for(let l of u)Gm(a,l),a=Ca(a,l)}(t._query,e),new At(t.firestore,t.converter,Ca(t._query,e)))}_getQueryConstraints(){return this._queryConstraints}_getOperator(){return this.type==="and"?"and":"or"}};var nc=class r extends gn{constructor(t,e){super(),this._field=t,this._direction=e,this.type="orderBy"}static _create(t,e){return new r(t,e)}_apply(t){let e=function(i,s,a){if(i.startAt!==null)throw new x(P.INVALID_ARGUMENT,"Invalid query. You must not call startAt() or startAfter() before calling orderBy().");if(i.endAt!==null)throw new x(P.INVALID_ARGUMENT,"Invalid query. You must not call endAt() or endBefore() before calling orderBy().");return new an(s,a)}(t._query,this._field,this._direction);return new At(t.firestore,t.converter,function(i,s){let a=i.explicitOrderBy.concat([s]);return new Wt(i.path,i.collectionGroup,a,i.filters.slice(),i.limit,i.limitType,i.startAt,i.endAt)}(t._query,e))}};function Fm(r,t="asc"){let e=t,n=oo("orderBy",r);return nc._create(n,e)}var Hs=class r extends gn{constructor(t,e,n){super(),this.type=t,this._limit=e,this._limitType=n}static _create(t,e,n){return new r(t,e,n)}_apply(t){return new At(t.firestore,t.converter,fs(t._query,this._limit,this._limitType))}};function Om(r){return mm("limit",r),Hs._create("limit",r,"F")}function Mm(r){return mm("limitToLast",r),Hs._create("limitToLast",r,"L")}var Js=class r extends gn{constructor(t,e,n){super(),this.type=t,this._docOrFields=e,this._inclusive=n}static _create(t,e,n){return new r(t,e,n)}_apply(t){let e=jm(t,this.type,this._docOrFields,this._inclusive);return new At(t.firestore,t.converter,function(i,s){return new Wt(i.path,i.collectionGroup,i.explicitOrderBy.slice(),i.filters.slice(),i.limit,i.limitType,s,i.endAt)}(t._query,e))}};function Lm(...r){return Js._create("startAt",r,!0)}function qm(...r){return Js._create("startAfter",r,!1)}var Ys=class r extends gn{constructor(t,e,n){super(),this.type=t,this._docOrFields=e,this._inclusive=n}static _create(t,e,n){return new r(t,e,n)}_apply(t){let e=jm(t,this.type,this._docOrFields,this._inclusive);return new At(t.firestore,t.converter,function(i,s){return new Wt(i.path,i.collectionGroup,i.explicitOrderBy.slice(),i.filters.slice(),i.limit,i.limitType,i.startAt,s)}(t._query,e))}};function Um(...r){return Ys._create("endBefore",r,!1)}function Bm(...r){return Ys._create("endAt",r,!0)}function jm(r,t,e,n){if(e[0]=lt(e[0]),e[0]instanceof mn)return function(s,a,u,l,d){if(!l)throw new x(P.NOT_FOUND,`Can't use a DocumentSnapshot that doesn't exist for ${u}().`);let f=[];for(let g of qn(s))if(g.field.isKeyField())f.push(on(a,l.key));else{let _=l.data.field(g.field);if(Zs(_))throw new x(P.INVALID_ARGUMENT,'Invalid query. You are trying to start or end a query using a document for which the field "'+g.field+'" is an uncommitted server timestamp. (Since the value of this field is unknown, you cannot start/end a query with it.)');if(_===null){let S=g.field.canonicalString();throw new x(P.INVALID_ARGUMENT,`Invalid query. You are trying to start or end a query using a document for which the field '${S}' (used as the orderBy) does not exist.`)}f.push(_)}return new se(f,d)}(r._query,r.firestore._databaseId,t,e[0]._document,n);{let i=_n(r.firestore);return function(a,u,l,d,f,g){let _=a.explicitOrderBy;if(f.length>_.length)throw new x(P.INVALID_ARGUMENT,`Too many arguments provided to ${d}(). The number of arguments must be less than or equal to the number of orderBy() clauses`);let S=[];for(let N=0;N<f.length;N++){let k=f[N];if(_[N].field.isKeyField()){if(typeof k!="string")throw new x(P.INVALID_ARGUMENT,`Invalid query. Expected a string for document ID in ${d}(), but got a ${typeof k}`);if(!hc(a)&&k.indexOf("/")!==-1)throw new x(P.INVALID_ARGUMENT,`Invalid query. When querying a collection and ordering by documentId(), the value passed to ${d}() must be a plain document ID, but '${k}' contains a slash.`);let D=a.path.child(Y.fromString(k));if(!M.isDocumentKey(D))throw new x(P.INVALID_ARGUMENT,`Invalid query. When querying a collection group and ordering by documentId(), the value passed to ${d}() must result in a valid document path, but '${D}' is not because it contains an odd number of segments.`);let j=new M(D);S.push(on(u,j))}else{let D=Vm(l,d,k);S.push(D)}}return new se(S,g)}(r._query,r.firestore._databaseId,i,t,e,n)}}function Md(r,t,e){if(typeof(e=lt(e))=="string"){if(e==="")throw new x(P.INVALID_ARGUMENT,"Invalid query. When querying with documentId(), you must provide a valid document ID, but it was an empty string.");if(!hc(t)&&e.indexOf("/")!==-1)throw new x(P.INVALID_ARGUMENT,`Invalid query. When querying a collection by documentId(), you must provide a plain document ID, but '${e}' contains a '/' character.`);let n=t.path.child(Y.fromString(e));if(!M.isDocumentKey(n))throw new x(P.INVALID_ARGUMENT,`Invalid query. When querying a collection group by documentId(), the value provided must result in a valid document path, but '${n}' is not because it has an odd number of segments (${n.length}).`);return on(r,new M(n))}if(e instanceof rt)return on(r,e._key);throw new x(P.INVALID_ARGUMENT,`Invalid query. When querying with documentId(), you must provide a valid string or a DocumentReference, but it was: ${io(e)}.`)}function Ld(r,t){if(!Array.isArray(r)||r.length===0)throw new x(P.INVALID_ARGUMENT,`Invalid Query. A non-empty array is required for '${t.toString()}' filters.`)}function Gm(r,t){let e=function(i,s){for(let a of i)for(let u of a.getFlattenedFilters())if(s.indexOf(u.op)>=0)return u.op;return null}(r.filters,function(i){switch(i){case"!=":return["!=","not-in"];case"array-contains-any":case"in":return["not-in"];case"not-in":return["array-contains-any","in","not-in","!="];default:return[]}}(t.op));if(e!==null)throw e===t.op?new x(P.INVALID_ARGUMENT,`Invalid query. You cannot use more than one '${t.op.toString()}' filter.`):new x(P.INVALID_ARGUMENT,`Invalid query. You cannot use '${t.op.toString()}' filters with '${e.toString()}' filters.`)}var rr=class{convertValue(t,e="none"){switch(sn(t)){case 0:return null;case 1:return t.booleanValue;case 2:return ot(t.integerValue||t.doubleValue);case 3:return this.convertTimestamp(t.timestampValue);case 4:return this.convertServerTimestamp(t,e);case 5:return t.stringValue;case 6:return this.convertBytes(Fe(t.bytesValue));case 7:return this.convertReference(t.referenceValue);case 8:return this.convertGeoPoint(t.geoPointValue);case 9:return this.convertArray(t.arrayValue,e);case 11:return this.convertObject(t.mapValue,e);case 10:return this.convertVectorValue(t.mapValue);default:throw L()}}convertObject(t,e){return this.convertObjectMap(t.fields,e)}convertObjectMap(t,e="none"){let n={};return pn(t,(i,s)=>{n[i]=this.convertValue(s,e)}),n}convertVectorValue(t){var e,n,i;let s=(i=(n=(e=t.fields)===null||e===void 0?void 0:e.value.arrayValue)===null||n===void 0?void 0:n.values)===null||i===void 0?void 0:i.map(a=>ot(a.doubleValue));return new di(s)}convertGeoPoint(t){return new fn(ot(t.latitude),ot(t.longitude))}convertArray(t,e){return(t.values||[]).map(n=>this.convertValue(n,e))}convertServerTimestamp(t,e){switch(e){case"previous":let n=cc(t);return n==null?null:this.convertValue(n,e);case"estimate":return this.convertTimestamp(Yr(t));default:return null}}convertTimestamp(t){let e=ge(t);return new at(e.seconds,e.nanos)}convertDocumentKey(t,e){let n=Y.fromString(t);q(Mf(n));let i=new Oe(n.get(1),n.get(3)),s=new M(n.popFirst(5));return i.isEqual(e)||dt(`Document ${s} contains a document reference within a different database (${i.projectId}/${i.database}) which is not supported. It will be treated as a reference in the current database (${e.projectId}/${e.database}) instead.`),s}};function ao(r,t,e){let n;return n=r?e&&(e.merge||e.mergeFields)?r.toFirestore(t,e):r.toFirestore(t):t,n}var rc=class extends rr{constructor(t){super(),this.firestore=t}convertBytes(t){return new ae(t)}convertReference(t){let e=this.convertDocumentKey(t,this.firestore._databaseId);return new rt(this.firestore,null,e)}};var me=class{constructor(t,e){this.hasPendingWrites=t,this.fromCache=e}isEqual(t){return this.hasPendingWrites===t.hasPendingWrites&&this.fromCache===t.fromCache}},zt=class extends mn{constructor(t,e,n,i,s,a){super(t,e,n,i,a),this._firestore=t,this._firestoreImpl=t,this.metadata=s}exists(){return super.exists()}data(t={}){if(this._document){if(this._converter){let e=new De(this._firestore,this._userDataWriter,this._key,this._document,this.metadata,null);return this._converter.fromFirestore(e,t)}return this._userDataWriter.convertValue(this._document.data.value,t.serverTimestamps)}}get(t,e={}){if(this._document){let n=this._document.data.field(oo("DocumentSnapshot.get",t));if(n!==null)return this._userDataWriter.convertValue(n,e.serverTimestamps)}}},De=class extends zt{data(t={}){return super.data(t)}},Yt=class{constructor(t,e,n,i){this._firestore=t,this._userDataWriter=e,this._snapshot=i,this.metadata=new me(i.hasPendingWrites,i.fromCache),this.query=n}get docs(){let t=[];return this.forEach(e=>t.push(e)),t}get size(){return this._snapshot.docs.size}get empty(){return this.size===0}forEach(t,e){this._snapshot.docs.forEach(n=>{t.call(e,new De(this._firestore,this._userDataWriter,n.key,n,new me(this._snapshot.mutatedKeys.has(n.key),this._snapshot.fromCache),this.query.converter))})}docChanges(t={}){let e=!!t.includeMetadataChanges;if(e&&this._snapshot.excludesMetadataChanges)throw new x(P.INVALID_ARGUMENT,"To include metadata changes with your document changes, you must also pass { includeMetadataChanges:true } to onSnapshot().");return this._cachedChanges&&this._cachedChangesIncludeMetadataChanges===e||(this._cachedChanges=function(i,s){if(i._snapshot.oldDocs.isEmpty()){let a=0;return i._snapshot.docChanges.map(u=>{let l=new De(i._firestore,i._userDataWriter,u.doc.key,u.doc,new me(i._snapshot.mutatedKeys.has(u.doc.key),i._snapshot.fromCache),i.query.converter);return u.doc,{type:"added",doc:l,oldIndex:-1,newIndex:a++}})}{let a=i._snapshot.oldDocs;return i._snapshot.docChanges.filter(u=>s||u.type!==3).map(u=>{let l=new De(i._firestore,i._userDataWriter,u.doc.key,u.doc,new me(i._snapshot.mutatedKeys.has(u.doc.key),i._snapshot.fromCache),i.query.converter),d=-1,f=-1;return u.type!==0&&(d=a.indexOf(u.doc.key),a=a.delete(u.doc.key)),u.type!==1&&(a=a.add(u.doc),f=a.indexOf(u.doc.key)),{type:B_(u.type),doc:l,oldIndex:d,newIndex:f}})}}(this,e),this._cachedChangesIncludeMetadataChanges=e),this._cachedChanges}};function B_(r){switch(r){case 0:return"added";case 2:case 3:return"modified";case 1:return"removed";default:return L()}}function Gc(r,t){return r instanceof zt&&t instanceof zt?r._firestore===t._firestore&&r._key.isEqual(t._key)&&(r._document===null?t._document===null:r._document.isEqual(t._document))&&r._converter===t._converter:r instanceof Yt&&t instanceof Yt&&r._firestore===t._firestore&&Lc(r.query,t.query)&&r.metadata.isEqual(t.metadata)&&r._snapshot.isEqual(t._snapshot)}function zm(r){r=X(r,rt);let t=X(r.firestore,ut);return hm(St(t),r._key).then(e=>Qc(t,r,e))}var we=class extends rr{constructor(t){super(),this.firestore=t}convertBytes(t){return new ae(t)}convertReference(t){let e=this.convertDocumentKey(t,this.firestore._databaseId);return new rt(this.firestore,null,e)}};function Km(r){r=X(r,rt);let t=X(r.firestore,ut),e=St(t),n=new we(t);return k_(e,r._key).then(i=>new zt(t,n,r._key,i,new me(i!==null&&i.hasLocalMutations,!0),r.converter))}function $m(r){r=X(r,rt);let t=X(r.firestore,ut);return hm(St(t),r._key,{source:"server"}).then(e=>Qc(t,r,e))}function Qm(r){r=X(r,At);let t=X(r.firestore,ut),e=St(t),n=new we(t);return Nm(r._query),dm(e,r._query).then(i=>new Yt(t,n,r,i))}function Wm(r){r=X(r,At);let t=X(r.firestore,ut),e=St(t),n=new we(t);return F_(e,r._query).then(i=>new Yt(t,n,r,i))}function Hm(r){r=X(r,At);let t=X(r.firestore,ut),e=St(t),n=new we(t);return dm(e,r._query,{source:"server"}).then(i=>new Yt(t,n,r,i))}function zc(r,t,e){r=X(r,rt);let n=X(r.firestore,ut),i=ao(r.converter,t,e);return lr(n,[so(_n(n),"setDoc",r._key,i,r.converter!==null,e).toMutation(r._key,ht.none())])}function Kc(r,t,e,...n){r=X(r,rt);let i=X(r.firestore,ut),s=_n(i),a;return a=typeof(t=lt(t))=="string"||t instanceof Jt?Uc(s,"updateDoc",r._key,t,e,n):qc(s,"updateDoc",r._key,t),lr(i,[a.toMutation(r._key,ht.exists(!0))])}function Jm(r){return lr(X(r.firestore,ut),[new Be(r._key,ht.none())])}function Ym(r,t){let e=X(r.firestore,ut),n=Ii(r),i=ao(r.converter,t);return lr(e,[so(_n(r.firestore),"addDoc",n._key,i,r.converter!==null,{}).toMutation(n._key,ht.exists(!1))]).then(()=>n)}function $c(r,...t){var e,n,i;r=lt(r);let s={includeMetadataChanges:!1,source:"default"},a=0;typeof t[a]!="object"||Ku(t[a])||(s=t[a],a++);let u={includeMetadataChanges:s.includeMetadataChanges,source:s.source};if(Ku(t[a])){let g=t[a];t[a]=(e=g.next)===null||e===void 0?void 0:e.bind(g),t[a+1]=(n=g.error)===null||n===void 0?void 0:n.bind(g),t[a+2]=(i=g.complete)===null||i===void 0?void 0:i.bind(g)}let l,d,f;if(r instanceof rt)d=X(r.firestore,ut),f=sr(r._key.path),l={next:g=>{t[a]&&t[a](Qc(d,r,g))},error:t[a+1],complete:t[a+2]};else{let g=X(r,At);d=X(g.firestore,ut),f=g._query;let _=new we(d);l={next:S=>{t[a]&&t[a](new Yt(d,_,g,S))},error:t[a+1],complete:t[a+2]},Nm(r._query)}return function(_,S,N,k){let D=new er(k),j=new hi(S,D,N);return _.asyncQueue.enqueueAndForget(()=>V(this,null,function*(){return Ic(yield nr(_),j)})),()=>{D.Za(),_.asyncQueue.enqueueAndForget(()=>V(this,null,function*(){return Tc(yield nr(_),j)}))}}(St(d),f,u,l)}function Xm(r,t){return O_(St(r=X(r,ut)),Ku(t)?t:{next:t})}function lr(r,t){return function(n,i){let s=new vt;return n.asyncQueue.enqueueAndForget(()=>V(this,null,function*(){return g_(yield Dc(n),i,s)})),s.promise}(St(r),t)}function Qc(r,t,e){let n=e.docs.get(t._key),i=new we(r);return new zt(r,i,t._key,n,new me(e.hasPendingWrites,e.fromCache),t.converter)}var j_={maxAttempts:5};var Xs=class{constructor(t,e){this._firestore=t,this._commitHandler=e,this._mutations=[],this._committed=!1,this._dataReader=_n(t)}set(t,e,n){this._verifyNotCommitted();let i=xe(t,this._firestore),s=ao(i.converter,e,n),a=so(this._dataReader,"WriteBatch.set",i._key,s,i.converter!==null,n);return this._mutations.push(a.toMutation(i._key,ht.none())),this}update(t,e,n,...i){this._verifyNotCommitted();let s=xe(t,this._firestore),a;return a=typeof(e=lt(e))=="string"||e instanceof Jt?Uc(this._dataReader,"WriteBatch.update",s._key,e,n,i):qc(this._dataReader,"WriteBatch.update",s._key,e),this._mutations.push(a.toMutation(s._key,ht.exists(!0))),this}delete(t){this._verifyNotCommitted();let e=xe(t,this._firestore);return this._mutations=this._mutations.concat(new Be(e._key,ht.none())),this}commit(){return this._verifyNotCommitted(),this._committed=!0,this._mutations.length>0?this._commitHandler(this._mutations):Promise.resolve()}_verifyNotCommitted(){if(this._committed)throw new x(P.FAILED_PRECONDITION,"A write batch can no longer be used after commit() has been called.")}};function xe(r,t){if((r=lt(r)).firestore!==t)throw new x(P.INVALID_ARGUMENT,"Provided document reference is from a different Firestore instance.");return r}var ic=class extends class{constructor(e,n){this._firestore=e,this._transaction=n,this._dataReader=_n(e)}get(e){let n=xe(e,this._firestore),i=new rc(this._firestore);return this._transaction.lookup([n._key]).then(s=>{if(!s||s.length!==1)return L();let a=s[0];if(a.isFoundDocument())return new mn(this._firestore,i,a.key,a,n.converter);if(a.isNoDocument())return new mn(this._firestore,i,n._key,null,n.converter);throw L()})}set(e,n,i){let s=xe(e,this._firestore),a=ao(s.converter,n,i),u=so(this._dataReader,"Transaction.set",s._key,a,s.converter!==null,i);return this._transaction.set(s._key,u),this}update(e,n,i,...s){let a=xe(e,this._firestore),u;return u=typeof(n=lt(n))=="string"||n instanceof Jt?Uc(this._dataReader,"Transaction.update",a._key,n,i,s):qc(this._dataReader,"Transaction.update",a._key,n),this._transaction.update(a._key,u),this}delete(e){let n=xe(e,this._firestore);return this._transaction.delete(n._key),this}}{constructor(t,e){super(t,e),this._firestore=t}get(t){let e=xe(t,this._firestore),n=new we(this._firestore);return super.get(t).then(i=>new zt(this._firestore,n,e._key,i._document,new me(!1,!1),e.converter))}};function Zm(r,t,e){r=X(r,ut);let n=Object.assign(Object.assign({},j_),e);return function(s){if(s.maxAttempts<1)throw new x(P.INVALID_ARGUMENT,"Max attempts must be at least 1")}(n),function(s,a,u){let l=new vt;return s.asyncQueue.enqueueAndForget(()=>V(this,null,function*(){let d=yield C_(s);new Gu(s.asyncQueue,d,u,a,l).au()})),l.promise}(St(r),i=>t(new ic(r,i)),n)}function tg(){return new fi("deleteField")}function eg(){return new Hu("serverTimestamp")}function ng(...r){return new Ju("arrayUnion",r)}function rg(...r){return new Yu("arrayRemove",r)}function ig(r){return new Xu("increment",r)}(function(t,e=!0){(function(i){ir=i})(yh),ph(new zi("firestore",(n,{instanceIdentifier:i,options:s})=>{let a=n.getProvider("app").getImmediate(),u=new ut(new ua(n.getProvider("auth-internal")),new da(n.getProvider("app-check-internal")),function(d,f){if(!Object.prototype.hasOwnProperty.apply(d.options,["projectId"]))throw new x(P.INVALID_ARGUMENT,'"projectId" not provided in firebase.initializeApp.');return new Oe(d.options.projectId,f)}(a,i),a);return s=Object.assign({useFetchStreams:e},s),u._setSettings(s),u},"PUBLIC").setMultipleInstances(!0)),Qo(Oh,"4.7.3",t),Qo(Oh,"4.7.3","esm2017")})();var G_="@firebase/firestore-compat",z_="0.3.38";function Zc(r,t){if(t===void 0)return{merge:!1};if(t.mergeFields!==void 0&&t.merge!==void 0)throw new x("invalid-argument",`Invalid options passed to function ${r}(): You cannot specify both "merge" and "mergeFields".`);return t}function sg(){if(typeof Uint8Array>"u")throw new x("unimplemented","Uint8Arrays are not available in this environment.")}function og(){if(!Xd())throw new x("unimplemented","Blobs are unavailable in Firestore in this environment.")}var uo=class r{constructor(t){this._delegate=t}static fromBase64String(t){return og(),new r(ae.fromBase64String(t))}static fromUint8Array(t){return sg(),new r(ae.fromUint8Array(t))}toBase64(){return og(),this._delegate.toBase64()}toUint8Array(){return sg(),this._delegate.toUint8Array()}isEqual(t){return this._delegate.isEqual(t._delegate)}toString(){return"Blob(base64: "+this.toBase64()+")"}};function Wc(r){return K_(r,["next","error","complete"])}function K_(r,t){if(typeof r!="object"||r===null)return!1;let e=r;for(let n of t)if(n in e&&typeof e[n]=="function")return!0;return!1}var Hc=class{enableIndexedDbPersistence(t,e){return ym(t._delegate,{forceOwnership:e})}enableMultiTabIndexedDbPersistence(t){return wm(t._delegate)}clearIndexedDbPersistence(t){return Im(t._delegate)}},co=class{constructor(t,e,n){this._delegate=e,this._persistenceProvider=n,this.INTERNAL={delete:()=>this.terminate()},t instanceof Oe||(this._appCompat=t)}get _databaseId(){return this._delegate._databaseId}settings(t){let e=this._delegate._getSettings();!t.merge&&e.host!==t.host&&Qt("You are overriding the original host. If you did not intend to override your settings, use {merge: true}."),t.merge&&(t=Object.assign(Object.assign({},e),t),delete t.merge),this._delegate._setSettings(t)}useEmulator(t,e,n={}){Fc(this._delegate,t,e,n)}enableNetwork(){return Em(this._delegate)}disableNetwork(){return Am(this._delegate)}enablePersistence(t){let e=!1,n=!1;return t&&(e=!!t.synchronizeTabs,n=!!t.experimentalForceOwningTab,kc("synchronizeTabs",e,"experimentalForceOwningTab",n)),e?this._persistenceProvider.enableMultiTabIndexedDbPersistence(this):this._persistenceProvider.enableIndexedDbPersistence(this,n)}clearPersistence(){return this._persistenceProvider.clearIndexedDbPersistence(this)}terminate(){return this._appCompat&&(this._appCompat._removeServiceInstance("firestore-compat"),this._appCompat._removeServiceInstance("firestore")),this._delegate._delete()}waitForPendingWrites(){return Tm(this._delegate)}onSnapshotsInSync(t){return Xm(this._delegate,t)}get app(){if(!this._appCompat)throw new x("failed-precondition","Firestore was not initialized using the Firebase SDK. 'app' is not available");return this._appCompat}collection(t){try{return new fr(this,Oc(this._delegate,t))}catch(e){throw Ot(e,"collection()","Firestore.collection()")}}doc(t){try{return new ue(this,Ii(this._delegate,t))}catch(e){throw Ot(e,"doc()","Firestore.doc()")}}collectionGroup(t){try{return new Tn(this,gm(this._delegate,t))}catch(e){throw Ot(e,"collectionGroup()","Firestore.collectionGroup()")}}runTransaction(t){return Zm(this._delegate,e=>t(new lo(this,e)))}batch(){return St(this._delegate),new ho(new Xs(this._delegate,t=>lr(this._delegate,t)))}loadBundle(t){return Sm(this._delegate,t)}namedQuery(t){return bm(this._delegate,t).then(e=>e?new Tn(this,e):null)}},hr=class extends rr{constructor(t){super(),this.firestore=t}convertBytes(t){return new uo(new ae(t))}convertReference(t){let e=this.convertDocumentKey(t,this.firestore._databaseId);return ue.forKey(e,this.firestore,null)}};function $_(r){qd(r)}var lo=class{constructor(t,e){this._firestore=t,this._delegate=e,this._userDataWriter=new hr(t)}get(t){let e=wn(t);return this._delegate.get(e).then(n=>new vn(this._firestore,new zt(this._firestore._delegate,this._userDataWriter,n._key,n._document,n.metadata,e.converter)))}set(t,e,n){let i=wn(t);return n?(Zc("Transaction.set",n),this._delegate.set(i,e,n)):this._delegate.set(i,e),this}update(t,e,n,...i){let s=wn(t);return arguments.length===2?this._delegate.update(s,e):this._delegate.update(s,e,n,...i),this}delete(t){let e=wn(t);return this._delegate.delete(e),this}},ho=class{constructor(t){this._delegate=t}set(t,e,n){let i=wn(t);return n?(Zc("WriteBatch.set",n),this._delegate.set(i,e,n)):this._delegate.set(i,e),this}update(t,e,n,...i){let s=wn(t);return arguments.length===2?this._delegate.update(s,e):this._delegate.update(s,e,n,...i),this}delete(t){let e=wn(t);return this._delegate.delete(e),this}commit(){return this._delegate.commit()}},dr=class r{constructor(t,e,n){this._firestore=t,this._userDataWriter=e,this._delegate=n}fromFirestore(t,e){let n=new De(this._firestore._delegate,this._userDataWriter,t._key,t._document,t.metadata,null);return this._delegate.fromFirestore(new In(this._firestore,n),e??{})}toFirestore(t,e){return e?this._delegate.toFirestore(t,e):this._delegate.toFirestore(t)}static getInstance(t,e){let n=r.INSTANCES,i=n.get(t);i||(i=new WeakMap,n.set(t,i));let s=i.get(e);return s||(s=new r(t,new hr(t),e),i.set(e,s)),s}};dr.INSTANCES=new WeakMap;var ue=class r{constructor(t,e){this.firestore=t,this._delegate=e,this._userDataWriter=new hr(t)}static forPath(t,e,n){if(t.length%2!==0)throw new x("invalid-argument",`Invalid document reference. Document references must have an even number of segments, but ${t.canonicalString()} has ${t.length}`);return new r(e,new rt(e._delegate,n,new M(t)))}static forKey(t,e,n){return new r(e,new rt(e._delegate,n,t))}get id(){return this._delegate.id}get parent(){return new fr(this.firestore,this._delegate.parent)}get path(){return this._delegate.path}collection(t){try{return new fr(this.firestore,Oc(this._delegate,t))}catch(e){throw Ot(e,"collection()","DocumentReference.collection()")}}isEqual(t){return t=lt(t),t instanceof rt?Mc(this._delegate,t):!1}set(t,e){e=Zc("DocumentReference.set",e);try{return e?zc(this._delegate,t,e):zc(this._delegate,t)}catch(n){throw Ot(n,"setDoc()","DocumentReference.set()")}}update(t,e,...n){try{return arguments.length===1?Kc(this._delegate,t):Kc(this._delegate,t,e,...n)}catch(i){throw Ot(i,"updateDoc()","DocumentReference.update()")}}delete(){return Jm(this._delegate)}onSnapshot(...t){let e=ag(t),n=ug(t,i=>new vn(this.firestore,new zt(this.firestore._delegate,this._userDataWriter,i._key,i._document,i.metadata,this._delegate.converter)));return $c(this._delegate,e,n)}get(t){let e;return t?.source==="cache"?e=Km(this._delegate):t?.source==="server"?e=$m(this._delegate):e=zm(this._delegate),e.then(n=>new vn(this.firestore,new zt(this.firestore._delegate,this._userDataWriter,n._key,n._document,n.metadata,this._delegate.converter)))}withConverter(t){return new r(this.firestore,t?this._delegate.withConverter(dr.getInstance(this.firestore,t)):this._delegate.withConverter(null))}};function Ot(r,t,e){return r.message=r.message.replace(t,e),r}function ag(r){for(let t of r)if(typeof t=="object"&&!Wc(t))return t;return{}}function ug(r,t){var e,n;let i;return Wc(r[0])?i=r[0]:Wc(r[1])?i=r[1]:typeof r[0]=="function"?i={next:r[0],error:r[1],complete:r[2]}:i={next:r[1],error:r[2],complete:r[3]},{next:s=>{i.next&&i.next(t(s))},error:(e=i.error)===null||e===void 0?void 0:e.bind(i),complete:(n=i.complete)===null||n===void 0?void 0:n.bind(i)}}var vn=class{constructor(t,e){this._firestore=t,this._delegate=e}get ref(){return new ue(this._firestore,this._delegate.ref)}get id(){return this._delegate.id}get metadata(){return this._delegate.metadata}get exists(){return this._delegate.exists()}data(t){return this._delegate.data(t)}get(t,e){return this._delegate.get(t,e)}isEqual(t){return Gc(this._delegate,t._delegate)}},In=class extends vn{data(t){let e=this._delegate.data(t);return this._delegate._converter||Ud(e!==void 0,"Document in a QueryDocumentSnapshot should exist"),e}},Tn=class r{constructor(t,e){this.firestore=t,this._delegate=e,this._userDataWriter=new hr(t)}where(t,e,n){try{return new r(this.firestore,Ie(this._delegate,km(t,e,n)))}catch(i){throw Ot(i,/(orderBy|where)\(\)/,"Query.$1()")}}orderBy(t,e){try{return new r(this.firestore,Ie(this._delegate,Fm(t,e)))}catch(n){throw Ot(n,/(orderBy|where)\(\)/,"Query.$1()")}}limit(t){try{return new r(this.firestore,Ie(this._delegate,Om(t)))}catch(e){throw Ot(e,"limit()","Query.limit()")}}limitToLast(t){try{return new r(this.firestore,Ie(this._delegate,Mm(t)))}catch(e){throw Ot(e,"limitToLast()","Query.limitToLast()")}}startAt(...t){try{return new r(this.firestore,Ie(this._delegate,Lm(...t)))}catch(e){throw Ot(e,"startAt()","Query.startAt()")}}startAfter(...t){try{return new r(this.firestore,Ie(this._delegate,qm(...t)))}catch(e){throw Ot(e,"startAfter()","Query.startAfter()")}}endBefore(...t){try{return new r(this.firestore,Ie(this._delegate,Um(...t)))}catch(e){throw Ot(e,"endBefore()","Query.endBefore()")}}endAt(...t){try{return new r(this.firestore,Ie(this._delegate,Bm(...t)))}catch(e){throw Ot(e,"endAt()","Query.endAt()")}}isEqual(t){return Lc(this._delegate,t._delegate)}get(t){let e;return t?.source==="cache"?e=Wm(this._delegate):t?.source==="server"?e=Hm(this._delegate):e=Qm(this._delegate),e.then(n=>new Ti(this.firestore,new Yt(this.firestore._delegate,this._userDataWriter,this._delegate,n._snapshot)))}onSnapshot(...t){let e=ag(t),n=ug(t,i=>new Ti(this.firestore,new Yt(this.firestore._delegate,this._userDataWriter,this._delegate,i._snapshot)));return $c(this._delegate,e,n)}withConverter(t){return new r(this.firestore,t?this._delegate.withConverter(dr.getInstance(this.firestore,t)):this._delegate.withConverter(null))}},Jc=class{constructor(t,e){this._firestore=t,this._delegate=e}get type(){return this._delegate.type}get doc(){return new In(this._firestore,this._delegate.doc)}get oldIndex(){return this._delegate.oldIndex}get newIndex(){return this._delegate.newIndex}},Ti=class{constructor(t,e){this._firestore=t,this._delegate=e}get query(){return new Tn(this._firestore,this._delegate.query)}get metadata(){return this._delegate.metadata}get size(){return this._delegate.size}get empty(){return this._delegate.empty}get docs(){return this._delegate.docs.map(t=>new In(this._firestore,t))}docChanges(t){return this._delegate.docChanges(t).map(e=>new Jc(this._firestore,e))}forEach(t,e){this._delegate.forEach(n=>{t.call(e,new In(this._firestore,n))})}isEqual(t){return Gc(this._delegate,t._delegate)}},fr=class r extends Tn{constructor(t,e){super(t,e),this.firestore=t,this._delegate=e}get id(){return this._delegate.id}get path(){return this._delegate.path}get parent(){let t=this._delegate.parent;return t?new ue(this.firestore,t):null}doc(t){try{return t===void 0?new ue(this.firestore,Ii(this._delegate)):new ue(this.firestore,Ii(this._delegate,t))}catch(e){throw Ot(e,"doc()","CollectionReference.doc()")}}add(t){return Ym(this._delegate,t).then(e=>new ue(this.firestore,e))}isEqual(t){return Mc(this._delegate,t._delegate)}withConverter(t){return new r(this.firestore,t?this._delegate.withConverter(dr.getInstance(this.firestore,t)):this._delegate.withConverter(null))}};function wn(r){return X(r,rt)}var Yc=class r{constructor(...t){this._delegate=new Jt(...t)}static documentId(){return new r(ft.keyField().canonicalString())}isEqual(t){return t=lt(t),t instanceof Jt?this._delegate._internalPath.isEqual(t._internalPath):!1}};var Xc=class r{constructor(t){this._delegate=t}static serverTimestamp(){let t=eg();return t._methodName="FieldValue.serverTimestamp",new r(t)}static delete(){let t=tg();return t._methodName="FieldValue.delete",new r(t)}static arrayUnion(...t){let e=ng(...t);return e._methodName="FieldValue.arrayUnion",new r(e)}static arrayRemove(...t){let e=rg(...t);return e._methodName="FieldValue.arrayRemove",new r(e)}static increment(t){let e=ig(t);return e._methodName="FieldValue.increment",new r(e)}isEqual(t){return this._delegate.isEqual(t._delegate)}};var Q_={Firestore:co,GeoPoint:fn,Timestamp:at,Blob:uo,Transaction:lo,WriteBatch:ho,DocumentReference:ue,DocumentSnapshot:vn,Query:Tn,QueryDocumentSnapshot:In,QuerySnapshot:Ti,CollectionReference:fr,FieldPath:Yc,FieldValue:Xc,setLogLevel:$_,CACHE_SIZE_UNLIMITED:pm};function W_(r,t){r.INTERNAL.registerComponent(new zi("firestore-compat",e=>{let n=e.getProvider("app-compat").getImmediate(),i=e.getProvider("firestore").getImmediate();return t(n,i)},"PUBLIC").setServiceProps(Object.assign({},Q_)))}function H_(r){W_(r,(t,e)=>new co(t,e,new Hc)),r.registerVersion(G_,z_)}H_(Wo);function J_(r,t=sh){return new ih(e=>{let n;return t!=null?t.schedule(()=>{n=r.onSnapshot({includeMetadataChanges:!0},e)}):n=r.onSnapshot({includeMetadataChanges:!0},e),()=>{n?.()}})}function cg(r,t){return J_(r,t)}function Y_(r,t){return cg(r,t).pipe(Gi(void 0),Bi(),$t(e=>{let[n,i]=e;return i.exists?n?.exists?{payload:i,type:"modified"}:{payload:i,type:"added"}:{payload:i,type:"removed"}}))}function nl(r,t){return cg(r,t).pipe($t(e=>({payload:e,type:"query"})))}var fo=class{ref;afs;constructor(t,e){this.ref=t,this.afs=e}set(t,e){return this.ref.set(t,e)}update(t){return this.ref.update(t)}delete(){return this.ref.delete()}collection(t,e){let n=this.ref.collection(t),{ref:i,query:s}=dg(n,e);return new go(i,s,this.afs)}snapshotChanges(){return Y_(this.ref,this.afs.schedulers.outsideAngular).pipe(Bt)}valueChanges(t={}){return this.snapshotChanges().pipe($t(({payload:e})=>t.idField?Bo(Ui({},e.data()),{[t.idField]:e.id}):e.data()))}get(t){return Nr(this.ref.get(t)).pipe(Bt)}};function mo(r,t){return nl(r,t).pipe(Gi(void 0),Bi(),$t(e=>{let[n,i]=e,s=i.payload.docChanges(),a=s.map(u=>({type:u.type,payload:u}));return n&&JSON.stringify(n.payload.metadata)!==JSON.stringify(i.payload.metadata)&&i.payload.docs.forEach((u,l)=>{let d=s.find(g=>g.doc.ref.isEqual(u.ref)),f=n?.payload.docs.find(g=>g.ref.isEqual(u.ref));d&&JSON.stringify(d.doc.metadata)===JSON.stringify(u.metadata)||!d&&f&&JSON.stringify(f.metadata)===JSON.stringify(u.metadata)||a.push({type:"modified",payload:{oldIndex:l,newIndex:l,type:"modified",doc:u}})}),a}))}function lg(r,t,e){return mo(r,e).pipe(ji((n,i)=>X_(n,i.map(s=>s.payload),t),[]),oh(),$t(n=>n.map(i=>({type:i.type,payload:i}))))}function X_(r,t,e){return t.forEach(n=>{e.indexOf(n.type)>-1&&(r=Z_(r,n))}),r}function tl(r,t,e,...n){let i=r.slice();return i.splice(t,e,...n),i}function Z_(r,t){switch(t.type){case"added":if(!(r[t.newIndex]&&r[t.newIndex].doc.ref.isEqual(t.doc.ref)))return tl(r,t.newIndex,0,t);break;case"modified":if(r[t.oldIndex]==null||r[t.oldIndex].doc.ref.isEqual(t.doc.ref))if(t.oldIndex!==t.newIndex){let e=r.slice();return e.splice(t.oldIndex,1),e.splice(t.newIndex,0,t),e}else return tl(r,t.newIndex,1,t);break;case"removed":if(r[t.oldIndex]&&r[t.oldIndex].doc.ref.isEqual(t.doc.ref))return tl(r,t.oldIndex,1);break}return r}function hg(r){return(!r||r.length===0)&&(r=["added","removed","modified"]),r}var go=class{ref;query;afs;constructor(t,e,n){this.ref=t,this.query=e,this.afs=n}stateChanges(t){let e=mo(this.query,this.afs.schedulers.outsideAngular);return t&&t.length>0&&(e=e.pipe($t(n=>n.filter(i=>t.indexOf(i.type)>-1)))),e.pipe(Gi(void 0),Bi(),zo(([n,i])=>i.length>0||!n),$t(([,n])=>n),Bt)}auditTrail(t){return this.stateChanges(t).pipe(ji((e,n)=>[...e,...n],[]))}snapshotChanges(t){let e=hg(t);return lg(this.query,e,this.afs.schedulers.outsideAngular).pipe(Bt)}valueChanges(t={}){return nl(this.query,this.afs.schedulers.outsideAngular).pipe($t(e=>e.payload.docs.map(n=>t.idField?Bo(Ui({},n.data()),{[t.idField]:n.id}):n.data())),Bt)}get(t){return Nr(this.query.get(t)).pipe(Bt)}add(t){return this.ref.add(t)}doc(t){return new fo(this.ref.doc(t),this.afs)}},el=class{query;afs;constructor(t,e){this.query=t,this.afs=e}stateChanges(t){return!t||t.length===0?mo(this.query,this.afs.schedulers.outsideAngular).pipe(Bt):mo(this.query,this.afs.schedulers.outsideAngular).pipe($t(e=>e.filter(n=>t.indexOf(n.type)>-1)),zo(e=>e.length>0),Bt)}auditTrail(t){return this.stateChanges(t).pipe(ji((e,n)=>[...e,...n],[]))}snapshotChanges(t){let e=hg(t);return lg(this.query,e,this.afs.schedulers.outsideAngular).pipe(Bt)}valueChanges(t={}){return nl(this.query,this.afs.schedulers.outsideAngular).pipe($t(n=>n.payload.docs.map(i=>t.idField?Ui({[t.idField]:i.id},i.data()):i.data())),Bt)}get(t){return Nr(this.query.get(t)).pipe(Bt)}},ty=new kr("angularfire2.enableFirestorePersistence"),ey=new kr("angularfire2.firestore.persistenceSettings"),ny=new kr("angularfire2.firestore.settings"),ry=new kr("angularfire2.firestore.use-emulator");function dg(r,t=e=>e){return{query:t(r),ref:r}}var Hy=(()=>{class r{schedulers;firestore;persistenceEnabled$;constructor(e,n,i,s,a,u,l,d,f,g,_,S,N,k,D,j,G){this.schedulers=l;let U=Ah(e,u,n),Q=f;g&&Dh(U,u,_,N,k,D,S,j),[this.firestore,this.persistenceEnabled$]=Sh(`${U.name}.firestore`,"AngularFirestore",U.name,()=>{let H=u.runOutsideAngular(()=>U.firestore());if(s&&H.settings(s),Q&&H.useEmulator(...Q),i&&!lh(a)){let K=()=>{try{return Nr(H.enablePersistence(d||void 0).then(()=>!0,()=>!1))}catch(v){return typeof console<"u"&&console.warn(v),Go(!1)}};return[H,u.runOutsideAngular(K)]}else return[H,Go(!1)]},[s,Q,i])}collection(e,n){let i;typeof e=="string"?i=this.firestore.collection(e):i=e;let{ref:s,query:a}=dg(i,n),u=this.schedulers.ngZone.run(()=>s);return new go(u,a,this)}collectionGroup(e,n){let i=n||(a=>a),s=this.firestore.collectionGroup(e);return new el(i(s),this)}doc(e){let n;typeof e=="string"?n=this.firestore.doc(e):n=e;let i=this.schedulers.ngZone.run(()=>n);return new fo(i,this)}createId(){return this.firestore.collection("_").doc().id}static \u0275fac=function(n){return new(n||r)(Tt(Th),Tt(Eh,8),Tt(ty,8),Tt(ny,8),Tt(ch),Tt(uh),Tt(Ih),Tt(ey,8),Tt(ry,8),Tt(Nh,8),Tt(bh,8),Tt(Rh,8),Tt(Ph,8),Tt(Vh,8),Tt(xh,8),Tt(Ch,8),Tt(vh,8))};static \u0275prov=ah({token:r,factory:r.\u0275fac,providedIn:"any"})}return r})();export{yy as a,ny as b,Hy as c};
